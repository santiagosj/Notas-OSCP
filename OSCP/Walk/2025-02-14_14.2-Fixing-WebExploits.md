# Walk: Fixing Web Exploits

## Fecha: 14/02/2025
## Host: Debian
## IP: 192.168.xxx.45
## Objetivo
Entender, corregir y adaptar a nuestras necesidades el **Exploit** web _**44976**_
## Herramientas
1. **nano/vim**
2. **curl**
## Procedimiento y comandos
>Este exploit aprovecha una vulnerabilidad autenticada de ejecuci칩n remota de comandos (RCE) en _CMS Made Simple 2.2.5_, identificada como _CVE-2018-1000094_.
#### Paso 1:  游늷 **An치lisis del funcionamiento del exploit:**
1.  **Autenticaci칩n:**  
    Usa el endpoint `/login.php` para autenticarse con el usuario y contrase침a proporcionados. Si la respuesta devuelve un estado `302` (redirecci칩n exitosa tras autenticaci칩n), extrae la cookie de sesi칩n y el token _**CSRF**_ para futuras solicitudes.
    游늷 **Clave del ataque:** Requiere credenciales v치lidas, lo que sugiere un ataque post-compromiso o uso de credenciales filtradas.
    
2.  **Carga de un archivo de texto con payload PHP:**  
    Sube un archivo llamado `cmsmsrce.txt` que contiene un payload PHP simple:
	`<?php system($_GET['cmd']);?>`
	Este payload permite ejecutar comandos arbitrarios pasando el par치metro `cmd` en la URL.
    游꿢 **Objetivo:** Inyectar una webshell que permita ejecutar comandos usando `?cmd=<comando>` en la URL.
3.   **Renombrado y ejecuci칩n:**  
    Usa una funcionalidad vulnerable en el **_File Manager_** para copiar el archivo `.txt` al archivo `shell.php`, habilitando as칤 su ejecuci칩n como un script PHP.
    
4. **Acceso remoto:**  
    Una vez cargado y renombrado, se accede a la web para ejecutar comandos con algo como:
    `http://192.168.1.10/uploads/shell.php?cmd=whoami`
#### Paso 2:  丘멆잺 **Modificaciones y correcciones:**
1. **Cambio en la URL Base**

	-   **Antes:** `http://192.168.1.10/cmsms/admin`
	-   **Despu칠s:** `https://192.168.227.45/admin`  
	    **Motivo:** El objetivo cambi칩 a una nueva direcci칩n IP y se est치 utilizando HTTPS en lugar de HTTP.

2.  **Credenciales est치ticas:**
    
    -   **Antes:** `username: admin`, `password: password`
    -   **Despu칠s:** `username: admin`, `password: HUYfaw763`  
        **Motivo:** Uso de contrase침as d칠biles. Se cambia a una m치s robusta para reflejar una configuraci칩n m치s realista.
3. **Deshabilitar la Verificaci칩n de Certificados SSL:**
	-   Se a침adi칩 el par치metro `verify=False` a todas las solicitudes `requests.post`.
	-  **Antes:** `response = requests.post(url, data=data, cookies=cookies)`
	- **Despu칠s:** `response = requests.post(url, data=data, cookies=cookies, verify=False)` 
	**Motivo:** El servidor utiliza un certificado no confiable (autogenerado), por lo que es necesario deshabilitar su validaci칩n para que las solicitudes se completen correctamente. Al navegar por el sitio obtenemos un error: **[SEC_ERROR_UNKNOWN_ISSUER](https://support.mozilla.org/en-US/kb/error-codes-secure-websites?as=u&utm_source=inproduct)**.
	El error **`SEC_ERROR_UNKNOWN_ISSUER`** indica que el navegador o la librer칤a de Python (en este caso, `requests`) no puede verificar la identidad del servidor porque el certificado SSL fue emitido por una entidad desconocida o no confiable. La documentacion de **Request** aclara lo siguiente:
	>Requests can also ignore verifying the SSL certificate if you set `verify` to False:
requests.get('https://kennethreitz.org', verify=False)
<Response [200]>
Note that when `verify` is set to `False`, requests will accept any TLS certificate presented by the server, and will ignore hostname mismatches and/or expired certificates, which will make your application vulnerable to man-in-the-middle (MitM) attacks. Setting verify to `False` may be useful during local development or testing.
By default, `verify` is set to True. Option `verify` only applies to host certs.

4.  **Par치metro CSRF:**
    -   **Antes:** `__c`
    -   **Despu칠s:** `_sk_`  
        **Motivo:** Los par치metros sensibles cambian en actualizaciones del CMS; el ajuste refleja esta modificaci칩n. Al hacer una simple peticion vemos el cambio impreso en la url.

    
## 游꿢 **Resumen:** 
Este exploit aprovecha una vulnerabilidad en **CMS Made Simple 2.2.5** que permite a un usuario autenticado cargar y ejecutar archivos maliciosos, logrando as칤 la ejecuci칩n remota de comandos (RCE).

### 游댌 **Concepto General**

1.  **Autenticaci칩n Inicial:** Se ingresa al sistema con credenciales v치lidas, lo que indica que el atacante ya tiene acceso o ha obtenido estas credenciales previamente.
2.  **Manipulaci칩n del Gestor de Archivos:** Se utiliza el m칩dulo FileManager para subir un archivo `.txt` que contiene un payload PHP.
3.  **Evasi칩n y Renombrado:** Se copia y renombra el archivo `.txt` a `.php` para ejecutar comandos de sistema.
4.  **Ejecuci칩n de Comandos Remotos:** Al acceder al archivo con el par치metro `?cmd=`, el atacante puede ejecutar comandos arbitrarios en el servidor.

**En esencia:** El atacante usa un acceso leg칤timo, explota una funci칩n mal protegida del gestor de archivos y convierte un archivo inofensivo en una puerta trasera para ejecutar comandos en el servidor.
